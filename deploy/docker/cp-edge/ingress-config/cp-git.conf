 server {
    listen                      8181 ssl;
    server_name                 ${CP_GITLAB_EXTERNAL_HOST};
    absolute_redirect           off;

    # SSL
    ssl_certificate             /opt/edge/pki/ssl-public-cert.pem;
    ssl_certificate_key         /opt/edge/pki/ssl-private-key.pem;

    # Recommendations from https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html
    ssl_protocols               TLSv1.1 TLSv1.2;
    ssl_ciphers                 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
    ssl_prefer_server_ciphers   on;
    ssl_session_cache           shared:SSL:10m;

    location / {
        resolver         ${CP_EDGE_CLUSTER_RESOLVER} valid=${CP_EDGE_CLUSTER_RESOLVER_TIMEOUT_SEC}s ipv6=off;
        set              ${CP_DOLLAR}cp_git_backend "https://${CP_GITLAB_INTERNAL_HOST}:${CP_GITLAB_INTERNAL_PORT}";
        proxy_pass       ${CP_DOLLAR}cp_git_backend;
        proxy_set_header Host ${CP_DOLLAR}http_host;
    }
}
