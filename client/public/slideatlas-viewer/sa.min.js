!function(){"use strict";function t(t){var e=this;this.ZTime=0,this.ActivatedCallback=void 0,this.SelectionChangeCallback=void 0,this.ModifiedCallback=void 0,this.Active=!1,this.Visibility=!0,this.ActiveWidget=null,this.Parent=t,this.LoadCallbacks=[],this.LayerDiv=$("<div>").appendTo(t).css({position:"absolute",left:"0px",top:"0px","border-width":"0px",width:"100%",height:"100%","z-index":"1","box-sizing":"border-box"}).addClass("sa-resize"),this.LayerDiv.saOnResize(function(){e.UpdateSize()}),SAM.DebugLayer=this,this.AnnotationView=new SAM.View(this.LayerDiv),this.AnnotationView.Canvas.saOnResize(function(){e.UpdateCanvasSize()}),this.WidgetList=[],this.ScaleWidget=new SAM.ScaleWidget(this)}window.SAM=window.SAM||{},window.SAM.ImagePathUrl="not set",window.SAM.MOBILE_DEVICE=!1,SAM.ConstructWidget=function(t,e){var i;switch(t.type){case"lasso":i=new SAM.LassoWidget(e);break;case"pencil":i=new SAM.PencilWidget(e);break;case"text":i=new SAM.TextWidget(e);break;case"arrow":i=new SAM.ArrowWidget(e);break;case"circle":i=new SAM.CircleWidget(e);break;case"polyline":i=new SAM.PolylineWidget(e);break;case"rectangle":i=new SAM.RectWidget(e);break;case"rect_set":i=new SAM.RectSetWidget(e);break;case"grid":i=new SAM.GridWidget(e)}if(i.Load(t),"sections"!==i.Type||!i.IsEmpty())return i},SAM.detectMobile=function(){return SAM.MOBILE_DEVICE?SAM.MOBILE_DEVICE:(SAM.MOBILE_DEVICE=!1,navigator.userAgent.match(/Android/i)&&(SAM.MOBILE_DEVICE="Andriod"),navigator.userAgent.match(/webOS/i)&&(SAM.MOBILE_DEVICE="webOS"),navigator.userAgent.match(/iPhone/i)&&(SAM.MOBILE_DEVICE="iPhone"),navigator.userAgent.match(/iPad/i)&&(SAM.MOBILE_DEVICE="iPad"),navigator.userAgent.match(/iPod/i)&&(SAM.MOBILE_DEVICE="iPod"),navigator.userAgent.match(/BlackBerry/i)&&(SAM.MOBILE_DEVICE="BlackBerry"),navigator.userAgent.match(/Windows Phone/i)&&(SAM.MOBILE_DEVICE="Windows Phone"),SAM.MOBILE_DEVICE)},SAM.areaSequence=function(t,e,i){for(var o=new SAM.Polyline,s=SA.RootNote.ViewerRecords,n=[],a=0;a<s.length;++a){for(var r=0,h=s[a].Annotations,l=0;l<h.length;++l){var d=h[l];"polyline"===d.type&&Math.round(255*d.outlinecolor[0])===t&&Math.round(255*d.outlinecolor[1])===e&&Math.round(255*d.outlinecolor[2])===i&&(0!==r&&console.log("Found more than one in a section"),o.Points=d.points,r+=.25*o.ComputeArea()*.25,r=Math.round(100*r)/100)}n.push(r)}return n},SAM.ConvertColor=function(t){if("string"==typeof t&&"#"!==t[0]){if("rgba("===t.slice(0,5))return t=t.slice(5,-1).split(","),t[0]=t[0]/255,t[1]=t[1]/255,t[2]=t[1]/255,t;var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};void 0!==e[t.toLowerCase()]?t=e[t.toLowerCase()]:alert("Unknown color "+t)}if("string"==typeof t&&7===t.length&&"#"===t[0]){for(var i=[],o=1,s=0;s<3;++s){var n=(16*SAM.HexDigitToInt(t[o++])+SAM.HexDigitToInt(t[o++]))/255;i.push(n)}return i}if("string"==typeof t){console.error("Cannot decode color "+t);var a=new Array(3);return a.fill(0),a}return t.slice()},SAM.ConvertColorToHex=function(t){if("string"==typeof t){if("rgba("===t.slice(0,5))return t;if("#"===(t=SAM.ConvertColorNameToHex(t)).substring(0,1))return t;if("rgb"===t.substring(0,3)){var e=t.substring(4,t.length-1).split(",");t=[parseInt(e[0])/255,parseInt(e[1])/255,parseInt(e[2])/255]}}for(var i="#",o=0;o<3;++o)for(var s=t[o],n=0;n<2;++n){s*=16;var a=Math.floor(s);a<0&&(a=0),a>15&&(a=15),s-=a,i+="0123456789abcdef".charAt(a)}return i},SAM.HexDigitToInt=function(t){return"1"===t?1:"2"===t?2:"3"===t?3:"4"===t?4:"5"===t?5:"6"===t?6:"7"===t?7:"8"===t?8:"9"===t?9:"a"===t||"A"===t?10:"b"===t||"B"===t?11:"c"===t||"C"===t?12:"d"===t||"D"===t?13:"e"===t||"E"===t?14:"f"===t||"F"===t?15:0},SAM.ConvertColorNameToHex=function(t){if("string"==typeof t&&"#"!==t[0]){var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c","indigo ":"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};void 0!==e[t=t.toLowerCase()]&&(t=e[t])}return t},window.SAM.DistanceToString=function(t){var e="";return e+=t<.001?(1e6*t).toFixed(2)+" µm":t<.01?(1e3*t).toFixed(2)+" mm":t<1?(100*t).toFixed(2)+" cm":t<1e3?t.toFixed(2)+" m":t.toFixed(2)+" km"},window.SAM.StringToDistance=function(t){var e=0,i=(t=t.trim()).length;return"µm"===t.substring(i-2,i)?e=parseFloat(t.substring(0,i-2))/1e6:"mm"===t.substring(i-2,i)?e=parseFloat(t.substring(0,i-2))/1e3:"cm"===t.substring(i-2,i)?e=parseFloat(t.substring(0,i-2))/100:" m"===t.substring(i-2,i)?e=parseFloat(t.substring(0,i-2)):"km"===t.substring(i-2,i)&&(e=1e3*parseFloat(t.substring(0,i-2))),e},window.SAM.ConvertToMeters=function(t){return t.units&&"Units"!==t.units?"nm"===t.units.toLowerCase()?(t.units="m",t.value*=1e-9,t.value):"µm"===t.units.toLowerCase()?(t.units="m",t.value*=1e-6,t.value):"mm"===t.units.toLowerCase()?(t.units="m",t.value*=.001,t.value):"cm"===t.units.toLowerCase()?(t.units="m",t.value*=.01,t.value):"dm"===t.units.toLowerCase()?(t.units="m",t.value*=.1,t.value):"m"===t.units.toLowerCase()?(t.units="m",t.value):"km"===t.units.toLowerCase()?(t.units="m",t.value*=1e3,t.value):(console.log("Unknown units: "+t.units),t.value):t.value},window.SAM.ConvertForGui=function(t){if(t.units){if(SAM.ConvertToMeters(t),t.value>1e3)return t.value=t.value/1e3,void(t.units="km");if(t.value>1)return t.value=t.value,void(t.units="m");if(t.value>.01)return t.value=100*t.value,void(t.units="cm");if(t.value>.001)return t.value=1e3*t.value,void(t.units="mm");if(t.value>1e-7)return t.value=1e6*t.value,void(t.units="µm");t.value=1e9*t.value,t.units="nm"}else t.units="Units"},t.prototype.Remove=function(){this.LayerDiv.remove(),this.Parent=void 0},t.prototype.SetActivatedCallback=function(t){this.ActivatedCallback=t},t.prototype.SetActive=function(t){t!==this.Active&&(this.Active=t,t&&this.ActivatedCallback&&this.ActivatedCallback(this))},t.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},t.prototype.Modified=function(){this.ModifiedCallback&&this.ModifiedCallback(this)},t.prototype.SetSelectionChangeCallback=function(t){this.SelectionChangeCallback=t},t.prototype.SetSelected=function(t){for(var e=!1,i=0;i<this.WidgetList.length;++i){var o=this.WidgetList[i];o.SetSelected&&o.SetSelected(t)&&(e=!0)}return e&&this.SelectionChangeCallback&&this.SelectionChangeCallback(this),e},t.prototype.IsEmpty=function(){for(var t=0;t<this.WidgetList.length;++t)if(!this.WidgetList[t].IsEmpty())return!1;return!0},t.prototype.InactivateAll=function(){for(var t=0;t<this.WidgetList.length;++t){var e=this.WidgetList[t];e.SetActive(!1)&&e.SetActive(!1)}return!0},t.prototype.UnselectAll=function(){for(var t=0;t<this.WidgetList.length;++t){var e=this.WidgetList[t];e.SetSelected&&e.SetSelected(!1)}},t.prototype.DeleteSelected=function(){for(var t=!1,e=[],i=0;i<this.WidgetList.length;++i){var o=this.WidgetList[i];o.DeleteSelected()?(t=!0,o.IsEmpty()||e.push(o)):e.push(o)}return this.WidgetList.length!==e.length&&(this.WidgetList=e),t},t.prototype.GetVisibility=function(){return this.Visibility},t.prototype.SetVisibility=function(t){if(t!==this.Visibility){this.Visibility=t;for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];i.SetVisibility&&i.SetVisibility(t)}this.EventuallyDraw()}},t.prototype.GetCamera=function(){return this.AnnotationView.GetCamera()},t.prototype.SetCamera=function(t){return this.AnnotationView.SetCamera(t)},t.prototype.GetViewport=function(){return this.AnnotationView.Viewport},t.prototype.UpdateCanvasSize=function(){this.AnnotationView.UpdateCanvasSize()},t.prototype.Clear=function(){this.AnnotationView.Clear()},t.prototype.GetParent=function(){return this.Parent},t.prototype.GetPixelsPerUnit=function(){return this.AnnotationView.GetPixelsPerUnit()},t.prototype.GetMetersPerUnit=function(){return this.AnnotationView.GetMetersPerUnit()},t.prototype.Draw=function(){if(this.AnnotationView.Clear(),this.Visibility)for(var t=0;t<this.WidgetList.length;++t)this.WidgetList[t].Draw(this)},t.prototype.GetView=function(){return this.AnnotationView},t.prototype.EventuallyDraw=function(){if(!this.RenderPending){this.RenderPending=!0;var t=this;window.requestAnimationFrame(function(){t.RenderPending=!1,t.Draw()})}},t.prototype.Focus=function(){this.LayerDiv.focus()},t.prototype.GetViewer=function(){return this.Viewer},t.prototype.SetViewer=function(t){this.Viewer=t},t.prototype.LoadAnnotations=function(t){for(var e=0;e<t.length;++e)this.LoadWidget(t[e])||(t.splice(e,1),--e);if(this.LoadCallback&&this.LoadCallback(),this.LoadCallbacks)for(e=0;e<this.LoadCallbacks.length;++e)this.LoadCallbacks[e]()},t.prototype.LoadWidget=function(t){var e=SAM.ConstructWidget(t,this);return e&&this.AddWidget(e),e},t.prototype.Reset=function(){this.Clear(),this.WidgetList=[]},t.prototype.GetMouseWorld=function(){return this.MouseWorld},t.prototype.ComputeMouseWorld=function(t){return this.MouseWorld=this.GetCamera().ConvertPointViewerToWorld(t.offsetX,t.offsetY),t.worldX=this.MouseWorld[0],t.worldY=this.MouseWorld[1],this.MouseWorld},t.prototype.InitializeTouch=function(t,e){this.OriginalEvent=t;var i=(new Date).getTime();if(i-this.Time<20&&!e)return!1;this.LastTime=this.Time,this.Time=i,this.LastTouches=this.Touches,this.Touches=[];for(var o=0;o<t.targetTouches.length;++o){var s=this.AnnotationView.Canvas.offset(),n=t.targetTouches[o].pageX-s.left,a=t.targetTouches[o].pageY-s.top;this.Touches.push([n,a])}this.LastMouseX=this.MouseX,this.LastMouseY=this.MouseY;var r=this.Touches.length;for(this.MouseX=this.MouseY=0,o=0;o<r;++o)this.MouseX+=this.Touches[o][0],this.MouseY+=this.Touches[o][1];return this.MouseX=this.MouseX/r,this.MouseY=this.MouseY/r,this.offsetX=this.MouseX,this.offsetY=this.MouseY,!0},t.prototype.HandleTouchStart=function(t){if(!this.GetVisibility())return!0;if(this.Event=t,this.InitializeTouch(t,!0),t.pencil){console.log("ipad pencil start");var e=this.GetIPadPencilWidget();return e.SetStateToDrawing(),e.HandleTouchStart(this),!1}for(var i=0;i<this.WidgetList.length;++i){var o=this.WidgetList[i];if(o.HandleTouchStart&&!o.HandleTouchStart(this))return!1}},t.prototype.HandleTouchMove=function(t){if(!this.GetVisibility())return!0;if(this.InitializeTouch(t,!1)){if(event.pencil)return console.log("ipad pencil move"),this.GetIPadPencilWidget().HandleTouchMove(this),!1;for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.HandleTouchMove&&!i.HandleTouchMove(this))return!1}return 1===this.Touches.length?this.HandleTouchPan(this):2===this.Touches.length?this.HandleTouchPinch(this):void 0}},t.prototype.HandleTouchPan=function(t){return!this.GetVisibility()||(!this.ActiveWidget||!this.ActiveWidget.HandleTouchPan||(this.Event=t,this.ActiveWidget.HandleTouchPan(this)))},t.prototype.HandleTouchPinch=function(t){return!this.GetVisibility()||(this.Event=t,!this.ActiveWidget||!this.ActiveWidget.HandleTouchPinch||this.ActiveWidget.HandleTouchPinch(this))},t.prototype.HandleTouchEnd=function(t){if(!this.GetVisibility())return!0;if(this.Event=t,this.Pencil&&this.Pencil.IsStateDrawingDown()&&(t.pencil=!0),t.pencil){var e=this.GetIPadPencilWidget();return e.HandleTouchEnd(this),e.SetActive(!1),this.Modified(),this.SelectionChangedCallback&&this.SelectionChangedCallback(this),!1}for(var i=0;i<this.WidgetList.length;++i){var o=this.WidgetList[i];if(o.HandleTouchEnd&&!o.HandleTouchEnd(this))return!1}return!0},t.prototype.SetMousePositionFromEvent=function(t){t.MouseX&&t.MouseY?(this.MouseX=t.MouseX,this.MouseY=t.MouseY):t.offsetX&&t.offsetY?(this.MouseX=t.offsetX,this.MouseY=t.offsetY):t.layerX&&t.layerY&&(this.MouseX=t.layerX,this.MouseY=t.layerY,t.offsetX=t.layerX,t.offsetY=t.layerY),this.MouseTime=(new Date).getTime()},t.prototype.IsSelected=function(){for(var t=0;t<this.WidgetList.length;++t)if(this.WidgetList[t].IsSelected())return!0},t.prototype.HandleSelect=function(t){if(this.GetVisibility()){this.Event=t,this.SetMousePositionFromEvent(t);for(var e=!1,i=[],o=0;o<this.WidgetList.length;++o){var s=this.WidgetList[o],n=s.IsSelected();t.shiftKey&&n||s.HandleSelect&&s.HandleSelect(this)&&i.push(s),n!==s.IsSelected()&&(e=!0)}return i.length>0&&!this.Active&&this.SetActive(!0),e&&(this.SelectionChangeCallback&&this.SelectionChangeCallback(this),this.EventuallyDraw()),i}},t.prototype.HasSelections=function(){return!!this.GetASelectedWidget()},t.prototype.GetASelectedWidget=function(t){for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.IsSelected&&i.IsSelected()&&(void 0===t||t===i.Type))return this.WidgetList[e]}},t.prototype.HandleMouseDown=function(t){if(!this.GetVisibility())return!0;if(this.Event=t,this.LastMouseDownTime=this.MouseDownTime||1,this.SetMousePositionFromEvent(t),this.ComputeMouseWorld(t),this.MouseDownX=this.MouseX,this.MouseDownY=this.MouseY,this.MouseDownTime=this.MouseTime,this.LastMouseDownTime&&this.MouseDownTime-this.LastMouseDownTime<200)return delete this.LastMouseDownTime,this.HandleDoubleClick(this);for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.HandleMouseDown&&!i.HandleMouseDown(this))return!1}return!0},t.prototype.HandleDoubleClick=function(t){return!this.GetVisibility()||(!this.ActiveWidget||!this.ActiveWidget.HandleDoubleClick||(this.Event=t,this.ActiveWidget.HandleDoubleClick(this)))},t.prototype.HandleMouseClick=function(t){if(!this.GetVisibility())return!0;for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.HandleMouseClick&&!i.HandleMouseClick(this))return!1}return!0},t.prototype.HandleMouseUp=function(t){if(!this.GetVisibility())return!0;for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.HandleMouseUp&&!i.HandleMouseUp(this))return!1}return!0},t.prototype.HandleMouseMove=function(t){if(!this.GetVisibility())return!0;this.Event=t,this.SetMousePositionFromEvent(t),this.ComputeMouseWorld(t),t.which=t.buttons,2===t.which?t.which=3:3===t.which&&(t.which=2);for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.HandleMouseMove&&!i.HandleMouseMove(this))return!1}return!0},t.prototype.HandleMouseWheel=function(t){return!this.GetVisibility()||(!this.ActiveWidget||!this.ActiveWidget.HandleMouseWheel||(this.Event=t,this.ActiveWidget.HandleMouseWheel(this)))},t.prototype.HandleKeyDown=function(t){if(!this.GetVisibility())return!0;if(77===t.keyCode){for(var e=[],i=0;i<this.WidgetList.length;++i){var o=this.WidgetList[i];o.IsSelected()&&e.push(o)}if(e.length>1){var s=e[0].Shapes.Shapes[0],n=e[1].Shapes.Shapes[0],a=s.Points[s.Points.length-1],r=n.Points[0],h=r[0]-a[0],l=r[1]-a[1],d=Math.sqrt(h*h+l*l);a=s.Points[0],h=(r=n.Points[n.Points.length-1])[0]-a[0],l=r[1]-a[1];var u=Math.sqrt(h*h+l*l);return s.Points=d<u?s.Points.concat(n.Points):n.Points.concat(s.Points),s.UpdateBuffers(this.AnnotationView),this.RemoveWidget(e[1]),this.EventuallyDraw(),!1}}for(this.Event=t,i=0;i<this.WidgetList.length;++i){var p=this.WidgetList[i];if(p.HandleKeyDown&&!p.HandleKeyDown(this))return!1}return!0},t.prototype.HandleKeyUp=function(t){if(!this.GetVisibility())return!0;if(46===t.keyCode)return t.preventDefault(),!1;for(var e=0;e<this.WidgetList.length;++e){var i=this.WidgetList[e];if(i.HandleKeyDown&&!i.HandleKeyDown(this))return!1}return!0},t.prototype.GetNumberOfWidgets=function(){return this.WidgetList.length},t.prototype.GetWidget=function(t){return this.WidgetList[t]},t.prototype.GetWidgets=function(){return this.WidgetList},t.prototype.AddWidget=function(t){var e=this;this.WidgetList.push(t),t.SetModifiedCallback&&t.SetModifiedCallback(function(t){e.WidgetModifiedCallback(t)}),t.UpdateBuffers&&t.UpdateBuffers(this)},t.prototype.WidgetModifiedCallback=function(t){this.Modified()},t.prototype.ActivateWidget=function(t){t!==this.ActiveWidget&&(this.LayerDiv.focus(),this.ActiveWidget=t,this.SelectionChangedCallback&&this.SelectionChangedCallback(this))},t.prototype.DeactivateWidget=function(t){this.ActiveWidget===t&&null!==t&&(this.LayerDiv.css({cursor:""}),this.EventuallyDraw(),this.ActiveWidget=null,t.SetActive(!1))},t.prototype.Deactivate=function(){for(var t=0;t<this.WidgetList.length;++t)this.WidgetList[t].SetActive(!1)},t.prototype.GetActiveWidget=function(){return this.ActiveWidget},t.prototype.RemoveWidget=function(t){if(null!==t.Layer){this.ActiveWidget===t&&(this.ActiveWidget=void 0),t.Layer=null;var e=this.WidgetList.indexOf(t);-1!==e&&(this.WidgetList.splice(e,1),this.Modified())}},t.prototype.LoadGirderItem=function(t){var e={itemId:"564e42fe3f24e538e9a20eb9",limit:50,offset:0,sort:"lowerName",sortdir:1};girder.rest.restRequest({type:"get",url:"annotation",data:JSON.stringify(e),success:function(t,e){console.log("success")},error:function(){alert("AJAX - error() : annotation get")}});girder.rest.restRequest({url:"annotation/572be29d3f24e53573aa8e91",method:"GET",contentType:"application/json"}).done(function(t){console.log("done")})},t.prototype.SaveGirderItem=function(t){var e={name:"Test3",elements:[{type:"circle",lineColor:"#FFFF00",lineWidth:20,center:[5e3,5e3,0],radius:2e3}]};girder.rest.restRequest({type:"post",url:"annotation",data:JSON.stringify(e),success:function(t,e){console.log("success")},error:function(){alert("AJAX - error() : annotation get")}}),e={name:"Test",elements:[{type:"polyline",points:[[6500,6600,0],[3300,5600,0],[10600,500,6]],closed:!0,fillColor:"rgba(0, 255, 0, 1)"}]},girder.rest.restRequest({type:"put",url:"annotation/572be29d3f24e53573aa8e91",data:JSON.stringify(e),success:function(t,e){console.log("success2")},error:function(){alert("AJAX - error() : annotation get")}})},t.prototype.UpdateSize=function(){return!!this.AnnotationView&&(!!this.AnnotationView.UpdateCanvasSize()&&(this.EventuallyDraw(),!0))},t.prototype.Test=function(){for(var t=0;t<this.WidgetList.length;++t){var e=this.WidgetList[t];"polyline"===e.Type&&e.ColorByHandedness(),this.EventuallyDraw()}},t.prototype.GetIPadPencilWidget=function(){if(this.Pencil&&this.Pencil.IsSelected())return this.Pencil;for(var t=0;t<this.WidgetList.length;++t){var e=this.WidgetList[t];if(e.StylusOnly&&(this.Pencil=e),"pencil"===e.Type&&e.IsSelected())return this.Pencil=e,e}return this.Pencil?this.Pencil:(this.Pencil=new SAM.PencilWidget(this,!1),this.Pencil.StylusOnly=!0,this.WidgetList.push(this.Pencil),this.Pencil)},SAM.AnnotationLayer=t}(),function(){"use strict";function t(){this.WorldToImage1=mat3.create(),this.Image1ToWorld=mat3.create(),this.WorldToImage2=mat3.create(),this.Image2ToWorld=mat3.create()}t.prototype.M2Invert=function(t){var e=t[0]*t[3]-t[1]*t[2];return[t[3]/e,-t[1]/e,-t[2]/e,t[0]/e]},t.prototype.M2Multiply=function(t,e){return[t[0]*e[0]+t[1]*e[2],t[0]*e[1]+t[1]*e[3],t[2]*e[0]+t[3]*e[2],t[2]*e[1]+t[3]*e[3]]},t.prototype.InitializeWithPoints=function(t,e,i,o,s,n){var a=mat3.create(),r=mat3.create();mat3.identity(a),mat3.identity(r),a[2]=t[0],a[5]=t[1],r[2]=e[0],r[5]=e[1];var h=[i[0]-t[0],s[0]-t[0],i[1]-t[1],s[1]-t[1]],l=[o[0]-e[0],n[0]-e[0],o[1]-e[1],n[1]-e[1]],d=this.M2Multiply(l,this.M2Invert(h));r[0]=d[0],r[1]=d[1],r[3]=d[2],r[4]=d[3],this.Initialize(a,r)},t.prototype.Initialize=function(t,e){mat3.set(t,this.WorldToImage1),mat3.set(e,this.WorldToImage2);var i=mat4.create(),o=mat4.create();mat3.toMat4(this.WorldToImage1,i),mat4.inverse(i,o),mat4.toMat3(o,this.Image1ToWorld),mat3.toMat4(this.WorldToImage2,i),mat4.inverse(i,o),mat4.toMat3(o,this.Image2ToWorld)},t.prototype.ForwardTransformPoint=function(t){var e=this.Image1ToWorld,i=t[0]*e[0]+t[1]*e[1]+e[2],o=t[0]*e[3]+t[1]*e[4]+e[5],s=t[0]*e[6]+t[1]*e[7]+e[8],n=i*(e=this.WorldToImage2)[0]+o*e[1]+s*e[2],a=i*e[3]+o*e[4]+s*e[5],r=i*e[6]+o*e[7]+s*e[8];return[n/r,a/r]},t.prototype.ReverseTransformPoint=function(t){var e=this.Image2ToWorld,i=t[0]*e[0]+t[1]*e[1]+e[2],o=t[0]*e[3]+t[1]*e[4]+e[5],s=t[0]*e[6]+t[1]*e[7]+e[8],n=i*(e=this.WorldToImage1)[0]+o*e[1]+s*e[2],a=i*e[3]+o*e[4]+s*e[5],r=i*e[6]+o*e[7]+s*e[8];return[n/r,a/r]},t.prototype.ForwardTransformCamera=function(t,e){var i=t.GetWorldFocalPoint(),o=e.GetWorldFocalPoint(),s=[i[0]+1,i[1]],n=this.ForwardTransformPoint(i);o[0]=n[0],o[1]=n[1];var a=this.ForwardTransformPoint(s);a[0]-=o[0],a[1]-=o[1];var r=Math.sqrt(a[0]*a[0]+a[1]*a[1]);e.SetHeight(t.GetHeight()*r),e.SetWorldRoll(t.GetWorldRoll()),e.ComputeMatrix()},t.prototype.ReverseTransformCamera=function(t,e){var i=t.GetWorldFocalPoint(),o=e.GetWorldFocalPoint(),s=[i[0]+1,i[1]],n=this.ReverseTransformPoint(i);o[0]=n[0],o[1]=n[1];var a=this.ReverseTransformPoint(s);a[0]-=o[0],a[1]-=o[1];var r=Math.sqrt(a[0]*a[0]+a[1]*a[1]);e.SetHeight(t.GetHeight()*r),e.SetWorldRoll(t.GetWorldRoll()),e.ComputeMatrix()},SAM.MatrixTransformation=t}(),function(){"use strict";function t(){this.Orientation=0,this.PositionCoordinateSystem=t.SLIDE,this.Origin=new Array(2),this.Origin.fill(1e4),this.FixedSize=!1,this.FixedOrientation=!1,this.LineWidth=0,this.Visibility=!0,this.Selected=!1,this.SelectedColor=[1,1,0],this.ZOffset=.1,this.Children={}}t.prototype.GetLineWidth=function(){return this.LineWidth},t.prototype.GetOrigin=function(){return this.Origin},t.prototype.GetOrientation=function(){return this.Orientation},t.prototype.GetRotation=function(){return this.Orientation*Math.PI/180},t.prototype.Modified=function(){this.Matrix=void 0},t.prototype.DeleteSelected=function(){for(var t in this.Children)this.Children[t].DeleteSelected()&&delete this.Children[t];return!!this.IsSelected()&&(this.PointBuffer=void 0,!0)},t.prototype.IsEmpty=function(){return void 0===this.PointBuffer},t.SLIDE=0,t.VIEWER=1,t.prototype.destructor=function(){},t.prototype.SetSelected=function(t){if(t===this.Selected)return!1;this.Selected=t;for(var e in this.Children)this.Children[e].SetSelected(t);return!0},t.prototype.IsSelected=function(){return this.Selected},t.prototype.Draw=function(e){if(this.Visibility&&(void 0===this.Matrix&&this.UpdateBuffers(e),!this.IsEmpty())){var i,o,s,n;if(e.gl){var a=mat4.create();if(mat4.identity(a),this.FixedSize){var r=e.Camera.ZRange[0]+.01;a[0]=2/e.Viewport[2],a[12]=-1,a[5]=-2/e.Viewport[3],a[13]=1,a[14]=r}i=3.1415926536*this.Orientation/180,this.Matrix[0]=Math.cos(i),this.Matrix[1]=-Math.sin(i),this.Matrix[4]=Math.sin(i),this.Matrix[5]=Math.cos(i),s=this.Origin[0],n=this.Origin[1],this.FixedSize&&(o=e.Camera.Matrix,s=(this.Origin[0]*o[0]+this.Origin[1]*o[4]+o[12])/o[15],n=(this.Origin[0]*o[1]+this.Origin[1]*o[5]+o[13])/o[15],s=e.Viewport[2]*(.5*(1+s)),n=e.Viewport[3]*(.5*(1-n))),this.Matrix[12]=s,this.Matrix[13]=n,this.Matrix[14]=this.ZOffset;var h=SA.polyProgram;e.gl.useProgram(h),e.gl.disable(e.gl.BLEND),e.gl.enable(e.gl.DEPTH_TEST),e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.VertexPositionBuffer),e.gl.vertexAttribPointer(h.vertexPositionAttribute,this.VertexPositionBuffer.itemSize,e.gl.FLOAT,!1,0,0),e.gl.viewport(e.Viewport[0],e.Viewport[1],e.Viewport[2],e.Viewport[3]),e.gl.uniformMatrix4fv(h.mvMatrixUniform,!1,this.Matrix),this.FixedSize?e.gl.uniformMatrix4fv(h.pMatrixUniform,!1,a):e.gl.uniformMatrix4fv(h.pMatrixUniform,!1,e.Camera.GetImageMatrix()),void 0!==this.FillColor&&(this.Selected?e.gl.uniform3f(h.colorUniform,this.SelectedColor[0],this.SelectedColor[1],this.SelectedColor[2]):e.gl.uniform3f(h.colorUniform,this.FillColor[0],this.FillColor[1],this.FillColor[2]),e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),e.gl.drawElements(e.gl.TRIANGLES,this.CellBuffer.numItems,e.gl.UNSIGNED_SHORT,0)),void 0!==this.OutlineColor&&(this.Selected?e.gl.uniform3f(h.colorUniform,this.SelectedColor[0],this.SelectedColor[1],this.SelectedColor[2]):e.gl.uniform3f(h.colorUniform,this.OutlineColor[0],this.OutlineColor[1],this.OutlineColor[2]),0===this.LineWidth?this.WireFrame?(e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),e.gl.drawElements(e.gl.LINE_LOOP,this.CellBuffer.numItems,e.gl.UNSIGNED_SHORT,0)):e.gl.drawArrays(e.gl.LINE_STRIP,0,this.VertexPositionBuffer.numItems):(e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this.LineCellBuffer),e.gl.drawElements(e.gl.TRIANGLES,this.LineCellBuffer.numItems,e.gl.UNSIGNED_SHORT,0)))}else{e.Context2d.save(),e.Context2d.setTransform(1,0,0,1,0,0);var l;if(this.PositionCoordinateSystem===t.SLIDE?(i=3.1415926536*this.Orientation/180,this.FixedSize||(i-=e.Camera.GetImageRoll()),this.Matrix[0]=Math.cos(i),this.Matrix[1]=-Math.sin(i),this.Matrix[4]=Math.sin(i),this.Matrix[5]=Math.cos(i),s=this.Origin[0],n=this.Origin[1],l=1,this.FixedSize||(l=e.Viewport[3]/e.Camera.GetHeight()),o=e.Camera.GetImageMatrix(),s=(this.Origin[0]*o[0]+this.Origin[1]*o[4]+o[12])/o[15],n=(this.Origin[0]*o[1]+this.Origin[1]*o[5]+o[13])/o[15],s=e.Viewport[2]*(.5*(1+s)),n=e.Viewport[3]*(.5*(1-n)),e.Context2d.transform(this.Matrix[0],this.Matrix[1],this.Matrix[4],this.Matrix[5],s,n)):this.PositionCoordinateSystem===t.VIEWER&&(i=3.1415926536*this.Orientation/180,this.Matrix[0]=Math.cos(i),this.Matrix[1]=-Math.sin(i),this.Matrix[4]=Math.sin(i),this.Matrix[5]=Math.cos(i),s=this.Origin[0],n=this.Origin[1],l=1,e.Context2d.transform(this.Matrix[0],this.Matrix[1],this.Matrix[4],this.Matrix[5],s,n)),this.Image&&this.Image.complete&&this.Width&&this.Height){e.Context2d.save();var d=this.Width*l/this.Image.width,u=this.Height*l/this.Image.height,p=-this.Width*l/2,c=-this.Height*l/2;e.Context2d.transform(d,0,0,u,p,c),e.Context2d.drawImage(this.Image,0,0),e.Context2d.restore()}var f=this.PointBuffer[0],g=this.PointBuffer[1];e.Context2d.beginPath(),e.Context2d.moveTo(f*l,g*l);for(var v=3;v<this.PointBuffer.length;){var S=this.PointBuffer[v],y=this.PointBuffer[v+1];e.Context2d.lineTo(S*l,y*l),v+=3}if(void 0!==this.OutlineColor){var m=this.LineWidth*l;0===m&&(m=1),e.Context2d.lineWidth=m,this.Selected?e.Context2d.strokeStyle=SAM.ConvertColorToHex(this.SelectedColor):e.Context2d.strokeStyle=SAM.ConvertColorToHex(this.OutlineColor),e.Context2d.stroke()}void 0!==this.FillColor&&(this.Selected?e.Context2d.fillStyle=SAM.ConvertColorToHex(this.SelectedColor):e.Context2d.fillStyle=SAM.ConvertColorToHex(this.FillColor),e.Context2d.fill()),e.Context2d.restore()}for(var w in this.Children)this.Children[w]&&this.Children[w].Draw&&this.Children[w].Draw(e)}},t.prototype.ChooseOutlineColor=function(){this.FillColor&&(this.OutlineColor=[1-this.FillColor[0],1-this.FillColor[1],1-this.FillColor[2]])},t.prototype.SetOrigin=function(t){this.Origin=t.slice()},t.prototype.SetOutlineColor=function(t){this.OutlineColor=SAM.ConvertColor(t)},t.prototype.GetOutlineColor=function(t){return this.OutlineColor},t.prototype.SetFillColor=function(t){this.FillColor=SAM.ConvertColor(t)},t.prototype.HandleMouseMove=function(t,e,i){return!1},t.prototype.IntersectPointLine=function(t,e,i,o){var s=t[0]-e[0],n=t[1]-e[1],a=i[0]-e[0],r=i[1]-e[1],h=Math.sqrt(a*a+r*r);if(0!==h){var l=s*(a/=h)-n*(r=-r/h),d=s*r+n*a;if(!(Math.abs(d)>o||l<0||l>h))return l/h}},SAM.Shape=t}(),function(){"use strict";function t(){this.Shapes=[],this.Bounds=[0,-1,0,-1]}t.prototype.UpdateBuffers=function(t){for(var e=1;e<this.Shapes.length;++e){var i=this.Shapes[e];i.UpdateBuffers&&i.UpdateBuffers(t)}},t.prototype.GetBounds=function(){return this.Bounds},t.prototype.ContainedInBounds=function(t){if(0===this.Shapes.length)return 0;for(var e=this.Shapes[0].ContainedInBounds(t),i=1;i<this.Shapes.length;++i){if(1===e)return e;var o=this.Shapes[i].ContainedInBounds(t);0===e&&0!==o&&(e=1),2===e&&2!==o&&(e=1)}return e},t.prototype.HandleSelect=function(t,e){for(var i,o=0;o<this.Shapes.length;++o){var s=this.Shapes[o];i||!s.PointOnShape(t,e)?SAM.ShiftKey||s.SetSelected(!1):(s.SetSelected(!0),i=s)}return i},t.prototype.PointOnShape=function(t,e){for(var i=0;i<this.Shapes.length;++i)if(this.Shapes[i].PointOnShape(t,e))return i;return-1},t.prototype.Modified=function(){for(var t=0;t<this.Shapes.length;++t)this.Shapes.Modified()},t.prototype.DeleteSelected=function(){for(var t=!1,e=[],i=0;i<this.Shapes.length;++i){var o=this.Shapes[i];this.Shapes[i].DeleteSelected()&&(t=!0),o.IsEmpty()||e.push(this.Shapes[i])}return e.length<this.Shapes.length&&(this.Shapes=e),t},t.prototype.IsEmpty=function(){for(var t=0;t<this.Shapes.length;++t)if(!this.Shapes[t].IsEmpty())return!1;return!0},t.prototype.FindPopupPoint=function(t){if(0!==this.Shapes.length){for(var e=t.GetWorldRoll(),i=Math.sin(e+.25*Math.PI),o=Math.cos(e+.25*Math.PI),s=this.Shapes[0].FindPopupPoint(t),n=o*s[0]-i*s[1],a=1;a<this.Shapes.length;++a){var r=this.Shapes[a].FindPopupPoint(t),h=o*r[0]-i*r[1];h>n&&(n=h,s=r)}return s}},t.prototype.Draw=function(t){for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].Draw(t)},t.prototype.AddShape=function(t){this.Shapes.push(t)},t.prototype.GetNumberOfShapes=function(){return this.Shapes.length},t.prototype.GetShape=function(t){return this.Shapes[t]},t.prototype.PopShape=function(){return this.Shapes.pop()},t.prototype.DeleteChild=function(t){return this.Shapes.splice(t,1)},t.prototype.SetSelected=function(t){for(var e=!1,i=0;i<this.Shapes.length;++i)this.Shapes[i].SetSelected(t)&&(e=!0);return e},t.prototype.SetSelectedChild=function(t,e){this.Shapes[t].SetSelected(e)},t.prototype.IsSelected=function(){for(var t=0;t<this.Shapes.length;++t)if(this.Shapes[t].IsSelected())return!0;return!1},t.prototype.SetLineWidth=function(t){for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].LineWidth=t},t.prototype.GetLineWidth=function(){return 0!==this.Shapes.length?this.Shapes[0].GetLineWidth():0},t.prototype.SetOutlineColor=function(t){for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].OutlineColor=t},t.prototype.GetOutlineColor=function(){return 0!==this.Shapes.length?this.Shapes[0].OutlineColor:[0,0,0]},t.prototype.SetOrigin=function(t){for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].SetOrigin(t)},t.prototype.ResetOrigin=function(){for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].ResetOrigin()},t.prototype.GetOrigin=function(){return 0!==this.Shapes.length?this.Shapes[0].Origin:[0,0,0]},SAM.ShapeGroup=t}(),function(){"use strict";function t(t,e){this.Viewer=e;var i=this.Layer.GetCamera(),o=i.GetWorldFocalPoint(),s=i.Height/4;this.Bounds=[o[0]-s,o[0]+s,o[1]-s,o[1]+s],this.DragBounds=[o[0]-s,o[0]+s,o[1]-s,o[1]+s],this.Layer.AddWidget(this),this.Viewer.EventuallyRender(),this.Active=0;var n=this;this.Div=$("<div>").appendTo(t).addClass("sa-view-cutout-div"),$("<button>").appendTo(this.Div).text("Cancel").addClass("sa-view-cutout-button").click(function(){n.Cancel()}),$("<button>").appendTo(this.Div).text("Download").addClass("sa-view-cutout-button").click(function(){n.Accept()}),this.Select=$("<select>").appendTo(this.Div),$("<option>").appendTo(this.Select).attr("value",0).text("tif"),$("<option>").appendTo(this.Select).attr("value",1).text("jpeg"),$("<option>").appendTo(this.Select).attr("value",2).text("png"),$("<option>").appendTo(this.Select).attr("value",3).text("svs"),this.Label=$("<div>").addClass("sa-view-cutout-label").appendTo(this.Div),this.UpdateBounds(),this.HandleMouseUp()}t.prototype.Accept=function(){this.Deactivate();var t=["tif","jpeg","png","svs"],e=this.Viewer.GetCache().Image;window.location="/cutout/"+e.database+"/"+e._id+"/image."+t[this.Select.val()]+"?bounds="+JSON.stringify(this.Bounds)},t.prototype.Cancel=function(){this.Deactivate()},t.prototype.Serialize=function(){return!1},t.prototype.Draw=function(t){var e=[.5*(this.DragBounds[0]+this.DragBounds[1]),.5*(this.DragBounds[2]+this.DragBounds[3])],i=t.Camera;if(t.gl)alert("webGL cutout not supported");else{var o=t.Context2d;o.save(),o.setTransform(1,0,0,1,0,0),this.DrawRectangle(o,this.Bounds,i,"#00A",1,0),this.DrawRectangle(o,this.DragBounds,i,"#000",2,this.Active),this.DrawCenter(o,e,i,"#000"),o.restore()}},t.prototype.DrawRectangle=function(t,e,i,o,s,n){var a=i.ConvertPointWorldToViewer(e[0],e[2]),r=i.ConvertPointWorldToViewer(e[1],e[2]),h=i.ConvertPointWorldToViewer(e[1],e[3]),l=i.ConvertPointWorldToViewer(e[0],e[3]);t.lineWidth=s,t.beginPath(),t.strokeStyle=4&n?"#FF0":o,t.moveTo(a[0],a[1]),t.lineTo(r[0],r[1]),t.stroke(),t.beginPath(),t.strokeStyle=2&n?"#FF0":o,t.moveTo(r[0],r[1]),t.lineTo(h[0],h[1]),t.stroke(),t.beginPath(),t.strokeStyle=8&n?"#FF0":o,t.moveTo(h[0],h[1]),t.lineTo(l[0],l[1]),t.stroke(),t.beginPath(),t.strokeStyle=1&n?"#FF0":o,t.moveTo(l[0],l[1]),t.lineTo(a[0],a[1]),t.stroke()},t.prototype.DrawCenter=function(t,e,i,o){var s=i.ConvertPointWorldToViewer(e[0],e[1]);t.strokeStyle=16&this.Active?"#FF0":o,t.lineWidth=1,t.beginPath(),t.moveTo(s[0]-5,s[1]),t.lineTo(s[0]+5,s[1]),t.moveTo(s[0],s[1]-5),t.lineTo(s[0],s[1]+5),t.stroke()},t.prototype.HandleKeyPress=function(t,e){return 67===event.keyCode&&alert("Accept"),67===event.keyCode&&alert("Cancel"),!0},t.prototype.HandleDoubleClick=function(t){return!0},t.prototype.HandleMouseDown=function(t){return 1===t.which},t.prototype.HandleMouseUp=function(){var t;this.Bounds[0]>this.Bounds[1]&&(t=this.Bounds[0],this.Bounds[0]=this.Bounds[1],this.Bounds[1]=t),this.Bounds[2]>this.Bounds[3]&&(t=this.Bounds[2],this.Bounds[2]=this.Bounds[3],this.Bounds[3]=t),this.DragBounds=this.Bounds.slice(0),this.Viewer.EventuallyRender()},t.prototype.HandleMouseMove=function(t){if(0!==t.which){if(this.Active){var e=this.Layer.GetCamera().ConvertPointViewerToWorld(t.offsetX,t.offsetY);if(1&this.Active&&(this.DragBounds[0]=e[0]),2&this.Active&&(this.DragBounds[1]=e[0]),4&this.Active&&(this.DragBounds[2]=e[1]),8&this.Active&&(this.DragBounds[3]=e[1]),16&this.Active){var i=e[0]-.5*(this.DragBounds[0]+this.DragBounds[1]),o=e[1]-.5*(this.DragBounds[2]+this.DragBounds[3]);this.DragBounds[0]+=i,this.DragBounds[1]+=i,this.DragBounds[2]+=o,this.DragBounds[3]+=o}return this.UpdateBounds(),this.Viewer.EventuallyRender(),!0}return!1}this.CheckActive(t)},t.prototype.UpdateBounds=function(t){var e=this.Viewer.GetCache(),i=e.Image.TileWidth,o=e.Image.TileHeight,s=[0,0,0,0];s[0]=Math.round(this.DragBounds[0]/i)*i,s[1]=Math.round(this.DragBounds[1]/i)*i,s[2]=Math.round(this.DragBounds[2]/o)*o,s[3]=Math.round(this.DragBounds[3]/o)*o;var n=e.Image.bounds;s[0]<n[0]&&(s[0]=n[0]),s[1]<n[0]&&(s[1]=n[0]),s[2]<n[2]&&(s[2]=n[2]),s[3]<n[2]&&(s[3]=n[2]),s[0]>n[1]&&(s[0]=n[1]),s[1]>n[1]&&(s[1]=n[1]),s[2]>n[3]&&(s[2]=n[3]),s[3]>n[3]&&(s[3]=n[3]),s[0]!==s[1]&&(this.Bounds[0]=s[0],this.Bounds[1]=s[1]),s[2]!==s[3]&&(this.Bounds[2]=s[2],this.Bounds[3]=s[3]);var a=[this.Bounds[1]-this.Bounds[0],this.Bounds[3]-this.Bounds[2]];this.Label.text(a[0]+" x "+a[1]+" = "+this.FormatPixels(a[0]*a[1])+"pixels")},t.prototype.FormatPixels=function(t){return t>1e9?Math.round(t/1e9)+"G":t>1e6?Math.round(t/1e6)+"M":t>1e3?Math.round(t/1e3)+"k":t},t.prototype.HandleTouchPan=function(t){},t.prototype.HandleTouchPinch=function(t){},t.prototype.HandleTouchEnd=function(t){},t.prototype.CheckActive=function(t){var e=this.Layer.GetCamera(),i=e.Height/200,o=e.ConvertPointViewerToWorld(t.offsetX,t.offsetY),s=0,n=this.DragBounds[0]-i<o[0]&&o[0]<this.DragBounds[1]+i,a=this.DragBounds[2]-i<o[1]&&o[1]<this.DragBounds[3]+i;a&&Math.abs(o[0]-this.DragBounds[0])<i&&(s|=1),a&&Math.abs(o[0]-this.DragBounds[1])<i&&(s|=2),n&&Math.abs(o[1]-this.DragBounds[2])<i&&(s|=4),n&&Math.abs(o[1]-this.DragBounds[3])<i&&(s|=8);var r=[.5*(this.DragBounds[0]+this.DragBounds[1]),.5*(this.DragBounds[2]+this.DragBounds[3])];return i*=2,Math.abs(o[0]-r[0])<i&&Math.abs(o[1]-r[1])<i&&(s|=16),s!==this.Active&&(this.SetActive(s),this.Viewewr.EventuallyRender()),!1},t.prototype.GetActive=function(){return this.Active},t.prototype.Deactivate=function(){this.Div.remove(),null!==this.Layer&&(this.Layer.DeactivateWidget(this),this.Layer.RemoveWidget(this),this.Viewer.EventuallyRender())},t.prototype.SetActive=function(t){this.Active!==t&&(this.Active=t,0!==t?this.Layer.ActivateWidget(this):this.Layer.DeactivateWidget(this),this.Viewer.EventuallyRender())},SAM.CutoutWidget=t}(),function(){"use strict";function t(){this.Color=[0,.1,.5],this.FontSize=12,this.Position=[100,100],this.Orientation=0,this.Offset=[0,0],this.Selected=!1,this.String="",this.PixelBounds=[0,0,0,0],this.BackgroundFlag=!1}function e(t,e,i,o,s,n){void 0===n&&(n=2),t.fillStyle="#fff",t.fillRect(e,i,o,s)}var i=[[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[900,17,30,98],[791,119,28,95],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[260,18,32,97],[292,18,32,97],[0,413,50,98],[0,413,50,98],[635,120,25,36],[783,17,37,57],[662,121,25,34],[687,121,46,96],[822,214,58,98],[881,214,50,98],[932,214,56,98],[0,114,53,98],[54,114,54,98],[109,114,54,98],[164,114,57,98],[222,114,49,98],[272,114,57,98],[330,114,56,98],[554,18,25,76],[579,121,28,73],[0,413,50,98],[412,120,62,69],[0,413,50,98],[733,10,53,106],[0,413,50,98],[263,314,67,98],[331,314,55,98],[387,314,59,98],[447,314,66,98],[514,314,52,98],[566,314,49,98],[616,314,67,98],[684,314,67,98],[752,314,24,98],[777,314,36,98],[814,314,58,98],[873,314,45,98],[919,314,88,98],[0,214,66,98],[69,214,72,98],[142,214,54,98],[197,214,76,98],[274,214,53,98],[328,214,49,98],[378,214,55,98],[434,214,66,98],[501,214,63,98],[565,214,96,98],[662,214,55,98],[718,214,53,98],[772,214,49,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[51,413,56,98],[108,413,50,98],[154,413,50,98],[210,413,50,98],[263,413,39,98],[301,413,50,98],[350,413,54,98],[406,413,22,98],[427,413,34,98],[458,413,50,98],[508,413,24,98],[532,413,88,98],[619,413,57,98],[675,413,60,98],[734,413,57,98],[790,413,57,98],[847,413,40,98],[886,413,42,98],[925,413,41,98],[966,413,56,98],[0,314,49,98],[50,314,77,98],[127,314,48,98],[173,314,52,98],[224,314,42,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98],[0,413,50,98]];t.prototype.DeleteSelected=function(){if(this.IsSelected())return this.SetString(""),!0},t.prototype.IsEmpty=function(){return void 0===this.String||""===this.String},t.prototype.SetString=function(t){this.String=t},t.prototype.GetString=function(){return this.String},t.prototype.Draw=function(t){var i=this.Position[0],o=this.Position[1];if(this.PositionCoordinateSystem!==SAM.Shape.VIEWER){var s=t.Camera.GetImageMatrix();i=(this.Position[0]*s[0]+this.Position[1]*s[4]+s[12])/s[15],o=(this.Position[0]*s[1]+this.Position[1]*s[5]+s[13])/s[15],i=t.Viewport[2]*(.5*(1+i)),o=t.Viewport[3]*(.5*(1-o))}(Math.abs(this.Offset[0])>1e3||Math.abs(this.Offset[1])>1e3)&&(this.Offset=[-50,0]);var n=this.String.split("\n"),a=t.Context2d;a.save();var r=this.Orientation*Math.PI/180,h=Math.sin(r),l=Math.cos(r);a.setTransform(l,-h,h,l,i,o),i=-this.Offset[0],o=-this.Offset[1],a.font=this.FontSize+"pt Calibri";var d=this.PixelBounds[1],u=this.PixelBounds[3];if(this.BackgroundFlag){var p=this.FontSize/4;e(a,i-p,o-p,d+2*p,u+2*p,p)}this.Selected?a.fillStyle="#FF0":a.fillStyle=SAM.ConvertColorToHex(this.Color),o+=this.FontSize;for(var c=0;c<n.length;++c)a.fillText(n[c],i,o),o+=1.3*this.FontSize;a.restore()},t.prototype.UpdateBuffers=function(t){var e;if(!t.gl){var o=this.String.split("\n"),s=1.3*this.FontSize*o.length,n=0,a=t.Context2d;for(a.save(),a.setTransform(1,0,0,1,0,0),a.font=this.FontSize+"pt Calibri",e=0;e<o.length;++e){var r=a.measureText(o[e]).width;r>n&&(n=r)}return this.PixelBounds=[0,n,0,s],void a.restore()}var h=[],l=[],d=[],u=0,p=0,c=0;for(this.PixelBounds=[0,0,0,this.FontSize],e=0;e<this.String.length;++e){var f=this.String.charCodeAt(e);if(10===f||13===f)u=0,p+=this.FontSize;else{var g=i[f],v=g[0]/1024,S=(g[0]+g[2])/1024,y=g[1]/512,m=(g[1]+g[3])/512,w=u+g[2]*this.FontSize/98,C=p+g[3]*this.FontSize/98;this.PixelBounds[0]>u&&(this.PixelBounds[0]=u),this.PixelBounds[1]<w&&(this.PixelBounds[1]=w),this.PixelBounds[2]>p&&(this.PixelBounds[2]=p),this.PixelBounds[3]<C&&(this.PixelBounds[3]=C),l.push(v),l.push(y),h.push(u),h.push(C),h.push(0),l.push(S),l.push(y),h.push(w),h.push(C),h.push(0),l.push(v),l.push(m),h.push(u),h.push(p),h.push(0),l.push(S),l.push(m),h.push(w),h.push(p),h.push(0),u=w,d.push(0+c),d.push(1+c),d.push(2+c),d.push(2+c),d.push(1+c),d.push(3+c),c+=4}}this.VertexTextureCoordBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexTextureCoordBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(l),t.gl.STATIC_DRAW),this.VertexTextureCoordBuffer.itemSize=2,this.VertexTextureCoordBuffer.numItems=l.length/2,this.VertexPositionBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexPositionBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(h),t.gl.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=h.length/3,this.CellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(d),t.gl.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=d.length},t.prototype.PointInText=function(t,e){if(!this.Visibility)return!1;var i=this.PixelBounds.slice(0);if(this.BackgroundFlag){var o=this.FontSize/4;i[0]-=o,i[1]+=o,i[2]-=o,i[3]+=o}return t>i[0]&&t<i[1]&&e>i[2]&&e<i[3]},t.prototype.SetColor=function(t){this.Color=SAM.ConvertColor(t)},t.prototype.GetColor=function(){return this.Color},t.prototype.SetFontSize=function(t){this.FontSize=t},t.prototype.GetFontSize=function(){return this.FontSize},t.prototype.SetBackgroundFlag=function(t){this.BackgroundFlag=t},t.prototype.GetBackgroundFlag=function(){return this.BackgroundFlag},t.prototype.IsSelected=function(){return this.Selected},t.prototype.SetSelected=function(t){return t!==this.Selected&&(this.Selected=t,!0)},SAM.Text=t}(),function(){"use strict";function t(t){this.Layer=t,this.Type="text",this.Text=new SAM.Text,this.Text.BackgroundFlag=!0,this.Arrow=new SAM.Arrow,this.ArrowModified=!0,this.State=e,this.VisibilityMode=i,this.ModifiedCallback=void 0,this.StateChangeCallback=void 0,this.SelectedCallback=void 0,this.Uninitialized=!0}var e=0,i=0;t.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},t.prototype.SetSelectedCallback=function(t){this.SelectedCallback=t},t.prototype.ApplySelect=function(t){var e=this.Text.PixelBounds,i=this.Layer.GetCamera().ConvertPointWorldToViewer(this.Text.Position[0],this.Text.Position[1]);return t.ViewerPointInSelection(i[0]+e[0],i[1]+e[2])&&t.ViewerPointInSelection(i[0]+e[0],i[1]+e[3])&&t.ViewerPointInSelection(i[0]+e[1],i[1]+e[2])&&t.ViewerPointInSelection(i[0]+e[1],i[1]+e[3])?(this.Text.SetSelected(!0),this.Arrow.SetSelected(!0),!0):(this.Text.SetSelected(!1),this.Arrow.SetSelected(!1),!1)},t.prototype.SetCreationCamera=function(t){this.CreationCamera=t.Serialize()},t.prototype.SetStateChangeCallback=function(t){this.StateChangeCallback=t},t.prototype.StateChanged=function(){this.StateChangeCallback&&this.StateChangeCallback(this)},t.prototype.Modified=function(){this.ModifiedCallback&&this.ModifiedCallback(this)},t.prototype.SetActive=function(t){t&&1!==this.State&&(this.State=2,this.StateChanged()),t||this.State===e||(this.State=e,this.StateChanged(),this.Text.SetSelected(!1),this.Arrow.SetSelected(!1)),this.Layer.EventuallyDraw()},t.prototype.SetSelected=function(t){this.Text.SetSelected(t),this.Arrow.SetSelected(t),t&&this.SelectedCallback&&this.SelectedCallback(this),t||this.SetActive(!1)},t.prototype.SetStateToDialog=function(){3!==this.State&&(this.Dialog||this.InitializeDialog(),this.State=3,this.WidgetPropertiesToDialog(),this.StateChanged(),this.ShowPropertiesDialog())},t.prototype.IsEmpty=function(){return this.Text.IsEmpty()},t.prototype.IsSelected=function(){return this.Text.IsSelected()||this.Arrow.IsSelected()},t.prototype.SetPositionToDefault=function(){var t=this.Layer.GetView();this.Text.UpdateBuffers(t);var e=[.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),-this.Text.PixelBounds[3]],o=[.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),.5*(this.Text.PixelBounds[2]+this.Text.PixelBounds[3])];this.VisibilityMode===i?(this.Text.Offset=o,this.SavedTextOffset=e):(this.Text.Offset=e,this.SavedTextOffset=e);var s=this.Layer.GetCamera().GetWorldFocalPoint();this.Text.Position=[s[0],s[1],0],this.ArrowModified=!0,this.Uninitialized=!1},t.prototype.Draw=function(){if(3!==this.State){this.Uninitialized&&this.SetPositionToDefault();var t=this.Layer.GetView();0===this.Text.PixelBounds[1]&&(this.Text.UpdateBuffers(t),this.ArrowModified=!0),this.ArrowModified&&this.UpdateArrow(),0!==this.VisibilityMode&&this.Arrow.Draw(t),this.Text.Draw(t),this.Text.Visibility=!0}},t.prototype.PasteCallback=function(t,e){this.Load(t),this.Text.Position[0]=e[0],this.Text.Position[1]=e[1],this.ArrowModified=!0,this.Layer.EventuallyDraw(),this.Modified()},t.prototype.Serialize=function(){if(void 0===this.Text)return null;var t={};return t.type="text",t.user_note_flag=this.UserNoteFlag,t.color=this.Text.Color,t.size=this.Text.FontSize,t.offset=[-this.Text.Offset[0],-this.Text.Offset[1]],t.position=this.Text.Position,t.string=this.Text.String,t.visibility=this.VisibilityMode,t.backgroundFlag=this.Text.BackgroundFlag,t.creation_camera=this.CreationCamera,t},t.prototype.Load=function(t){this.UserNoteFlag=t.user_note_flag,this.Text.String=t.string;var e=[parseFloat(t.color[0]),parseFloat(t.color[1]),parseFloat(t.color[2])];this.Text.SetColor(e),this.Text.SetFontSize(parseFloat(t.size)),void 0!==t.backgroundFlag&&(this.Text.BackgroundFlag=t.backgroundFlag),this.Text.Position=[parseFloat(t.position[0]),parseFloat(t.position[1]),parseFloat(t.position[2])],t.offset&&this.SetTextOffset(parseFloat(t.offset[0]),parseFloat(t.offset[1])),void 0!==t.creation_camera&&(this.CreationCamera=t.creation_camera),void 0!==t.visibility&&(this.VisibilityMode=t.visibility),this.Arrow.SetFillColor(e),this.Arrow.ChooseOutlineColor(),this.ArrowModified=!0,this.Uninitialized=!1},t.prototype.SetTextOffset=function(t,e){this.SavedTextOffset=[-t,-e],this.Text.Offset=this.SavedTextOffset.slice(0),this.ArrowModified=!0},t.prototype.SetPosition=function(t,e){this.Text.Position=[t,e,0],this.ArrowModified=!0},t.prototype.SetVisibilityMode=function(t){t!==this.VisibilityMode&&(this.ArrowModified=!0,t===i&&(this.SavedTextOffset=this.Text.Offset.slice(0),this.Text.Offset=[.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),.5*(this.Text.PixelBounds[2]+this.Text.PixelBounds[3])]),this.VisibilityMode===i&&(this.SavedTextOffset?this.Text.Offset=this.SavedTextOffset.slice(0):this.Text.Offset=[.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),-this.Text.PixelBounds[3]]),this.VisibilityMode=t)},t.prototype.UpdateArrow=function(){if(0!==this.Text.PixelBounds[3]){this.Arrow.Origin=this.Text.Position;var t=.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),e=.5*(this.Text.PixelBounds[2]+this.Text.PixelBounds[3]),i=.5*(this.Text.PixelBounds[1]-this.Text.PixelBounds[0]),o=.5*(this.Text.PixelBounds[3]-this.Text.PixelBounds[2]),s=this.Text.Offset[0]-t,n=this.Text.Offset[1]-e;this.Arrow.Orientation=-(180+180*Math.atan2(n,s)/Math.PI);var a,r=Math.sqrt(s*s+n*n),h=r;0!==n&&h>(a=Math.abs(r*o/n))&&(h=a),0!==s&&h>(a=Math.abs(r*i/s))&&(h=a),(r=r-h-5)<5&&(r=5),this.Arrow.Length=r,this.Arrow.UpdateBuffers(this.Layer.GetView()),this.ArrowModified=!1}},t.prototype.HandleSelect=function(){if(3!==this.State){var t=this.Layer.Event,e=this.ScreenPixelToTextPixelPoint(t.offsetX,t.offsetY);if(this.Text.PointInText(e[0],e[1]))return this.Text.SetSelected(!0),this.Arrow.SetSelected(!1),this.Layer.GetParent().css({cursor:"move"}),this.State=2,this;var i=this.Text.Offset;if(this.Arrow.PointInShape(e[0]-i[0],e[1]-i[1]))return this.Text.SetSelected(!0),this.Arrow.SetSelected(!0),this.Layer.GetParent().css({cursor:"move"}),this.State=5,this;this.SetActive(!1)}},t.prototype.DeleteSelected=function(){return this.Text.DeleteSelected()},t.prototype.HandleKeyDown=function(){if(3===this.State)return!1;var t=this.Layer.Event;if(67===t.keyCode&&t.ctrlKey){var e={Type:"TextWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(e),!1}return!0},t.prototype.HandleMouseDown=function(){if(this.State===e)return!0;var t=this.Layer.Event;if(1===t.which){var o=t.offsetX,s=t.offsetY;this.LastMouse=[o,s],2===this.State&&(this.Arrow.IsSelected()?this.State=5:this.Text.IsSelected()&&(this.VisibilityMode===i?this.State=5:this.State=4))}return 1===this.State},t.prototype.HandleMouseUp=function(){return this.State===e||(4!==this.State&&5!==this.State||(this.SetActive(!0),this.Modified()),!1)},t.prototype.ScreenPixelToTextPixelPoint=function(t,e){var i=this.Layer.GetCamera().ConvertPointWorldToViewer(this.Text.Position[0],this.Text.Position[1]);return t=t-i[0]+this.Text.Offset[0],e=e-i[1]+this.Text.Offset[1],[t,e]},t.prototype.HandleMouseMove=function(){if(this.State===e)return!0;var t=this.Layer.Event,i=t.offsetX,o=t.offsetY;if(1===this.State||2===this.State){var s="",n=this.ScreenPixelToTextPixelPoint(i,o),a=this.Text.Offset;this.Text.IsSelected()&&this.Text.PointInText(n[0],n[1])?(s="move",this.State=2):this.Arrow.IsSelected()&&this.Arrow.PointInShape(n[0]-a[0],n[1]-a[1])?(s="move",this.State=2):this.State=1,this.Layer.GetParent().css({cursor:s})}if(0===this.VisibilityMode&&4===this.State||5===this.State){var r=this.Layer.GetCamera(),h=r.ConvertPointViewerToWorld(this.LastMouse[0],this.LastMouse[1]),l=r.ConvertPointViewerToWorld(i,o),d=l[0]-h[0],u=l[1]-h[1];return this.Text.Position[0]+=d,this.Text.Position[1]+=u,this.ArrowModified=!0,this.Layer.EventuallyDraw(),this.LastMouse=[i,o],!1}if(4===this.State){var p=t.offsetX-this.LastMouse[0],c=t.offsetY-this.LastMouse[1];return this.LastMouse=[t.offsetX,t.offsetY],this.Text.Offset[0]-=p,this.Text.Offset[1]-=c,this.ArrowModified=!0,this.Layer.EventuallyDraw(),!1}return!0},t.prototype.HandleTouchPan=function(){return this.State===e||(this.Layer.MouseDeltaX=this.Layer.MouseX-this.Layer.LastMouseX,this.Layer.MouseDeltaY=this.Layer.MouseY-this.Layer.LastMouseY,this.HandleMouseMove(),!1)},t.prototype.HandleTouchEnd=function(){return this.State===e||(this.Modified(),!1)},t.prototype.GetActive=function(){return this.State!==e},t.prototype.InitializeDialog=function(){this.Dialog=new SAM.Dialog(this.Layer.GetParent().parent()),this.Dialog.Title.text("Text Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.TextInput=$("<textarea>").appendTo(this.Dialog.Body).css({width:"87%",height:"8em"}),this.Dialog.FontDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.FontLabel=$("<div>").appendTo(this.Dialog.FontDiv).text("Font (px):").css({display:"table-cell","text-align":"left"}),this.Dialog.FontInput=$('<input type="number">').appendTo(this.Dialog.FontDiv).val("12").css({display:"table-cell"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.VisibilityModeDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.VisibilityModeLabel=$("<div>").appendTo(this.Dialog.VisibilityModeDiv).text("Visibility:").css({display:"table-cell","text-align":"left"}),this.Dialog.VisibilityModeInputButtons=$("<div>").appendTo(this.Dialog.VisibilityModeDiv).css({display:"table-cell"}),this.Dialog.VisibilityModeInputs=[],this.Dialog.VisibilityModeInputs[i]=$('<input type="radio" name="visibilityoptions" value="0">Text only</input>').appendTo(this.Dialog.VisibilityModeInputButtons),$("<br>").appendTo(this.Dialog.VisibilityModeInputButtons),this.Dialog.VisibilityModeInputs[1]=$('<input type="radio" name="visibilityoptions" value="1">Arrow only, text on hover</input>').appendTo(this.Dialog.VisibilityModeInputButtons),$("<br>").appendTo(this.Dialog.VisibilityModeInputButtons),this.Dialog.VisibilityModeInputs[2]=$('<input type="radio" name="visibilityoptions" value="2">Arrow and text visible</input>').appendTo(this.Dialog.VisibilityModeInputButtons),this.Dialog.VisibilityModeInputs[i].attr("checked","true"),this.Dialog.BackgroundDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BackgroundLabel=$("<div>").appendTo(this.Dialog.BackgroundDiv).text("Background:").css({display:"table-cell","text-align":"left"}),this.Dialog.BackgroundInput=$('<input type="checkbox">').appendTo(this.Dialog.BackgroundDiv).css({display:"table-cell"}),this.VisibilityMode=i,this.Dialog.BackgroundInput.prop("checked",!0);var t=SAM.ConvertColorToHex(this.Dialog.ColorInput.val());if(localStorage.TextWidgetDefaults){var e=JSON.parse(localStorage.TextWidgetDefaults);e.Color?(t=SAM.ConvertColorToHex(e.Color),this.Text.SetColor(t),this.Arrow.SetFillColor(t)):this.Arrow.SetFillColor(this.Text.Color),e.FontSize&&this.Text.SetFontSize(parseFloat(e.FontSize)),void 0!==e.BackgroundFlag&&(this.Text.BackgroundFlag=e.BackgroundFlag),void 0!==e.VisibilityMode&&(this.VisibilityMode=e.VisibilityMode,this.Dialog.VisibilityModeInputs[this.VisibilityMode].attr("checked","true"))}},t.prototype.ShowPropertiesDialog=function(){var t=this;this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.SetCloseCallback(function(){t.DialogCloseCallback()}),this.Dialog.Show(!0),this.Dialog.TextInput.focus()},t.prototype.DialogApplyCallback=function(){this.DialogPropertiesToWidget(),this.Layer&&(this.SetActive(!1),this.Layer.EventuallyDraw())},t.prototype.DialogCloseCallback=function(){if(this.Uninitialized&&this.Text.SetString(""),this.IsEmpty())return this.Layer.EventuallyDraw(),this.Layer.RemoveWidget(this),void this.StateChanged();this.SetActive(!1),this.Layer.EventuallyDraw()},t.prototype.WidgetPropertiesToDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Text.Color)),this.Dialog.FontInput.val(this.Text.GetFontSize().toFixed(0)),this.Dialog.BackgroundInput.prop("checked",this.Text.BackgroundFlag),this.Dialog.TextInput.val(this.Text.String)},t.prototype.DialogPropertiesToWidget=function(){var t=!1;this.ApplyLineBreaks();var e=this.Dialog.TextInput.val();if(""===(e=e.trim()))return this.Layer.EventuallyDraw(),this.Layer.RemoveWidget(this),void this.StateChanged();e!==this.Text.GetString()&&(t=!0),this.Text.SetString(e);var o=SAM.ConvertColorToHex(this.Dialog.ColorInput.val());o!==this.Text.GetColor()&&(t=!0,this.Text.SetColor(o),this.Arrow.SetFillColor(o),this.Arrow.ChooseOutlineColor(),this.ArrowModified=!0);var s=parseFloat(this.Dialog.FontInput.val());s!==this.Text.GetFontSize()&&(t=!0),this.Text.SetFontSize(s);var n=i;this.Dialog.VisibilityModeInputs[i].prop("checked")?(this.VisibilityMode!==i&&(t=!0),n=i):this.Dialog.VisibilityModeInputs[1].prop("checked")?(1!==this.VisibilityMode&&(t=!0),n=1):(2!==this.VisibilityMode&&(t=!0),n=2),this.VisibilityMode!==n&&(this.SetVisibilityMode(n),t=!0);var a=this.Dialog.BackgroundInput.prop("checked");a!==this.Text.GetBackgroundFlag()&&(t=!0,this.Text.SetBackgroundFlag(a)),localStorage.TextWidgetDefaults=JSON.stringify({Color:o,FontSize:this.Text.GetFontSize(),VisibilityMode:this.VisibilityMode,BackgroundFlag:a}),t&&this.Modified()},t.prototype.ApplyLineBreaks=function(){var t=this.Dialog.TextInput[0];t.setAttribute("wrap","off");var e=t.value;t.value="";for(var i=t.scrollWidth,o=-1,s=0;s<e.length;s++){var n=e.charAt(s);if(" "!==n&&"-"!==n&&"+"!==n||(o=s),t.value+=n,t.scrollWidth>i){var a="";if(o>=0){for(var r=o+1;r<s;r++)a+=e.charAt(r);o=-1}a+=n,t.value=t.value.substr(0,t.value.length-a.length),t.value+="\n"+a}}t.setAttribute("wrap","")},SAM.TextWidget=t}(),function(){"use strict";function t(){SAM.Shape.call(this),this.Origin=[0,0],this.Points=[],this.Closed=!1,this.Bounds=[0,-1,0,-1]}(t.prototype=new SAM.Shape).IsEmpty=function(){return this.Points.length<2},t.prototype.DeleteSelected=function(){return!!this.IsSelected()&&(this.Points=[],!0)},t.prototype.SetLineWidth=function(t){this.LineWidth=t},t.prototype.GetLineWidth=function(){return this.LineWidth},t.prototype.GetEdgeLength=function(t){if(t<0||t>this.Points.length-2)return 0;var e=this.Points[t+1][0]-this.Points[t][0],i=this.Points[t+1][1]-this.Points[t][1];return Math.sqrt(e*e+i*i)},t.prototype.GetNumberOfPoints=function(){return this.Points.length},t.prototype.GetBounds=function(){var t=this.Bounds.slice(0);return t[0]+=this.Origin[0],t[1]+=this.Origin[0],t[2]+=this.Origin[1],t[3]+=this.Origin[1],t},t.prototype.ContainedInBounds=function(t){var e=this.GetBounds();return t[1]<e[0]||t[0]>e[1]||t[3]<e[2]||t[2]>e[3]?0:t[1]>=e[0]&&t[0]<=e[1]&&t[3]>=e[2]&&t[2]<=e[3]?2:1},t.prototype.SetOrigin=function(t){this.Origin=t.slice(0)},t.prototype.ResetOrigin=function(t){for(var e=0;e<this.Points.length;++e){var i=this.Points[e];i[0]+=this.Origin[0],i[1]+=this.Origin[1]}this.Origin[0]=0,this.Origin[1]=0,this.UpdateBuffers(t)},t.prototype.PointOnVertex=function(t,e){e*=e;for(var i=0;i<this.Points.length;++i){var o=this.Points[i][0]-t[0],s=this.Points[i][1]-t[1];if(o*o+s*s<e)return i}return-1},t.prototype.PointOnShape=function(t,e){if(t=t.slice(0),t[0]-=this.Origin[0],t[1]-=this.Origin[1],!(t[0]+e<this.Bounds[0]||t[0]-e>this.Bounds[1]||t[1]+e<this.Bounds[2]||t[1]-e>this.Bounds[3])){for(var i,o=1;o<this.Points.length;++o)if(void 0!==(i=this.IntersectPointLine(t,this.Points[o-1],this.Points[o],e)))return[o-1,o,i];return this.Closed&&void 0!==(i=this.IntersectPointLine(t,this.Points[this.Points.length-1],this.Points[0],e))?[this.Points.length-1,0,i]:void 0}},t.prototype.FindPopupPoint=function(t){if(0!==this.Points.length){for(var e=t.GetWorldRoll(),i=Math.sin(e+.25*Math.PI),o=Math.cos(e+.25*Math.PI),s=this.Points[0],n=o*s[0]-i*s[1],a=1;a<this.Points.length;++a){var r=this.Points[a],h=o*r[0]-i*r[1];h>n&&(n=h,s=r)}return s[0]+=this.Origin[0],s[1]+=this.Origin[1],s}},t.prototype.ComputeArea=function(){if(this.Points.length<3)return 0;for(var t=0,e=0,i=0;i<this.Points.length;++i)t+=this.Points[i][0],e+=this.Points[i][1];t/=this.Points.length,e/=this.Points.length;var o=0,s=this.Points.length-1,n=this.Points[s][0]-t,a=this.Points[s][1]-e;for(i=0;i<this.Points.length;++i){var r=n,h=a;o+=(n=this.Points[i][0]-t)*h-r*(a=this.Points[i][1]-e)}return o},t.prototype.MergePoints=function(t,e){t*=t;for(var i=!1,o=1;o<this.Points.length;++o){var s=this.Points[o][0]-this.Points[o-1][0],n=this.Points[o][1]-this.Points[o-1][1];s*s+n*n<t&&(this.Points.splice(o,1),--o,i=!0)}i&&this.UpdateBuffers(e)},t.prototype.Decimate=function(t,e){for(var i=!0;i;){i=!1;var o=[];o.push(this.Points[0]);for(var s=3;s<this.Points.length;){var n=this.Points[s],a=this.Points[s-1],r=this.Points[s-2],h=this.Points[s-3],l=.5*(a[0]+r[0]),d=.5*(a[1]+r[1]),u=n[1]-h[1],p=-(n[0]-h[0]),c=Math.sqrt(u*u+p*p);u/=c,p/=c,c=Math.abs(u*(l-this.Points[s-3][0])+p*(d-this.Points[s-3][1]));var f=(n[0]-a[0])*(h[0]-a[0])+(n[1]-a[1])*(h[1]-a[1]),g=(n[0]-r[0])*(h[0]-r[0])+(n[1]-r[1])*(h[1]-r[1]);c<t&&f<0&&g<0?(o.push([l,d,0]),i=!0,s+=2):(o.push(this.Points[s-2]),++s)}for(s-=2;s<this.Points.length;)o.push(this.Points[s]),++s;this.Points=o}this.UpdateBuffers(e)},t.prototype.AddPointToBounds=function(t,e){t[0]-e<this.Bounds[0]&&(this.Bounds[0]=t[0]-e),t[0]+e>this.Bounds[1]&&(this.Bounds[1]=t[0]+e),t[1]-e<this.Bounds[2]&&(this.Bounds[2]=t[1]-e),t[1]+e>this.Bounds[3]&&(this.Bounds[3]=t[1]+e)},t.prototype.UpdateBuffers=function(t){t=t||{};var e=this.Points.slice(0);this.Closed&&e.length>2&&e.push(e[0]),this.PointBuffer=[];var i=[],o=[];if(this.Matrix=mat4.create(),mat4.identity(this.Matrix),0!==this.Points.length){this.Bounds=[e[0][0],e[0][0],e[0][1],e[0][1]];var s;if(0!==this.LineWidth&&t.gl){var n,a,r,h=[],l=e.length-1;for(s=0;s<l;++s)a=e[s+1][0]-e[s][0],r=e[s+1][1]-e[s][1],n=Math.sqrt(a*a+r*r),h.push([-r/n,a/n]);if(l>0){var d=this.LineWidth/2,u=h[0][0]*d,p=h[0][1]*d;for(this.PointBuffer.push(e[0][0]-u),this.PointBuffer.push(e[0][1]-p),this.PointBuffer.push(0),this.PointBuffer.push(e[0][0]+u),this.PointBuffer.push(e[0][1]+p),this.PointBuffer.push(0),this.AddPointToBounds(e[s],d),s=1;s<l;++s)this.PointBuffer.push(e[s][0]-u),this.PointBuffer.push(e[s][1]-p),this.PointBuffer.push(0),this.PointBuffer.push(e[s][0]+u),this.PointBuffer.push(e[s][1]+p),this.PointBuffer.push(0),u=h[s][0]*d,p=h[s][1]*d,this.PointBuffer.push(e[s][0]-u),this.PointBuffer.push(e[s][1]-p),this.PointBuffer.push(0),this.PointBuffer.push(e[s][0]+u),this.PointBuffer.push(e[s][1]+p),this.PointBuffer.push(0);this.PointBuffer.push(e[l][0]-u),this.PointBuffer.push(e[l][1]-p),this.PointBuffer.push(0),this.PointBuffer.push(e[l][0]+u),this.PointBuffer.push(e[l][1]+p),this.PointBuffer.push(0)}for(s=0;s<l;++s)o.push(0+4*s),o.push(1+4*s),o.push(3+4*s),o.push(0+4*s),o.push(3+4*s),o.push(2+4*s);for(s=2;s<e.length;++s)i.push(0),i.push(2*s-1),i.push(2*s)}else{for(s=0;s<e.length;++s)this.PointBuffer.push(e[s][0]),this.PointBuffer.push(e[s][1]),this.PointBuffer.push(0),this.AddPointToBounds(e[s],0);for(s=2;s<e.length;++s)i.push(0),i.push(s-1),i.push(s)}t.gl&&(this.VertexPositionBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexPositionBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(this.PointBuffer),t.gl.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),t.gl.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=i.length,0!==this.LineWidth&&(this.LineCellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.LineCellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),t.gl.STATIC_DRAW),this.LineCellBuffer.itemSize=1,this.LineCellBuffer.numItems=o.length))}};var e=2*Math.PI*0/24;t.prototype.SampleEdge=function(t,e,i,o,s){var n=t.GetCamera(),a=n.GetHeight()/n.ViewportHeight;i*=a;var r=t.GetCache(),h=[e,e],l=i/2;this.RecursiveSampleEdge(this.Points.length-1,0,l,i,o,r,h,a,s)},t.prototype.RecursiveSampleEdge=function(t,i,o,s,n,a,r,h,l){var d=this.Points[t],u=this.Points[i],p=u[0]-d[0],c=u[1]-d[1],f=Math.sqrt(p*p+c*c);if(o>f)o-=f,t=i,(i+=1)<this.Points.length?this.RecursiveSampleEdge(t,i,o,s,n,a,r,h,l):l();else{var g=this,v=-Math.atan2(c,p)+e,S=o/f,y=d[0]+S*(u[0]-d[0]),m=d[1]+S*(u[1]-d[1]),w=-c,C=p,A=Math.sqrt(w*w+C*C);w=w/A*0*h,C=C/A*0*h,SA.GetCutoutImage(a,r,[y+w,m+C],h,v,"edge"+n+".png",function(){setTimeout(function(){++n,o+=s,g.RecursiveSampleEdge(t,i,o,s,n,a,r,h,l)},200)})}},t.prototype.SetSelected=function(t){return this.Selected!==t&&(this.Selected=t,!0)},t.prototype.IsSelected=function(){return this.Selected},SAM.Polyline=t}(),function(){"use strict";function t(t,o){if(void 0!==t){if(this.UserNoteFlag=!SA.Edit,this.Type="polyline",this.Circle=new SAM.Circle,this.Polyline=new SAM.Polyline,this.InitializeDialog(t),this.LineWidth=10,this.Polyline.Closed=!1,localStorage.PolylineWidgetDefaults){var s=JSON.parse(localStorage.PolylineWidgetDefaults);s.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(s.Color)),s.LineWidth&&(this.LineWidth=s.LineWidth,this.Dialog.LineWidthInput.val(this.LineWidth))}this.Circle.FillColor=[1,1,.2],this.Circle.OutlineColor=[0,0,0],this.Circle.FixedSize=!1,this.Circle.ZOffset=-.05,this.Polyline.OutlineColor=[0,0,0],this.Polyline.SetOutlineColor(this.Dialog.ColorInput.val()),this.Polyline.FixedSize=!1,t.AddWidget(this),this.Polyline.LineWidth=this.LineWidth,this.Circle.Radius=this.LineWidth,this.Circle.UpdateBuffers(t.AnnotationView),this.ActiveVertex=-1,this.ActiveEdge=void 0,this.DrawingVertex=-1,o?(this.State=e,this.SetCursorToDrawing(t),t.ActivateWidget(this)):(this.State=i,this.Circle.Visibility=!1),this.CreationCamera=t.GetCamera().Serialize(),this.MinLine=1,t.EventuallyDraw(!1)}}var e=0,i=2;t.prototype.InitializeDialog=function(t){var e=this;this.Dialog=new SAM.Dialog(function(){e.DialogApplyCallback(t)}),this.Dialog.Title.text("Lasso Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.ClosedDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ClosedLabel=$("<div>").appendTo(this.Dialog.ClosedDiv).text("Closed:").css({display:"table-cell","text-align":"left"}),this.Dialog.ClosedInput=$('<input type="checkbox">').appendTo(this.Dialog.ClosedDiv).attr("checked","false").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Dialog.LengthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LengthLabel=$("<div>").appendTo(this.Dialog.LengthDiv).text("Length:").css({display:"table-cell","text-align":"left"}),this.Dialog.Length=$("<div>").appendTo(this.Dialog.LengthDiv).css({display:"table-cell"}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").css({display:"table-cell","text-align":"left"}),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).css({display:"table-cell"})},t.prototype.Draw=function(t){var e=t.GetCamera();this.MinLine=e.GetSpacing(),this.LineWidth<this.MinLine?this.Polyline.LineWidth=0:this.Polyline.LineWidth=this.LineWidth,this.Polyline.Draw(t),this.Circle.Draw(t),this.Text&&(this.PositionText(),this.Text.Draw(t))},t.prototype.PasteCallback=function(t,e,i){this.Load(t);var o=this.Polyline.GetBounds();if(o){for(var s=i[0]-(o[0]+o[1])/2,n=i[1]-(o[2]+o[3])/2,a=0;a<this.Polyline.GetNumberOfPoints();++a)this.Polyline.Points[a][0]+=s,this.Polyline.Points[a][1]+=n;this.Polyline.UpdateBuffers(e.AnnotationView),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),e.EventuallyDraw(!0)}else console.log("Warining: Pasting empty polyline")},t.prototype.Serialize=function(){if(void 0===this.Polyline)return null;var t={};t.type="polyline",t.user_note_flag=this.UserNoteFlag,t.lineColor=SAM.ConvertColorToHex(this.Polyline.OutlineColor),t.lineWidth=this.LineWidth,t.points=[];for(var e=0;e<this.Polyline.GetNumberOfPoints();++e)t.points.push([this.Polyline.Points[e][0],this.Polyline.Points[e][1]]);return t.creation_camera=this.CreationCamera,t.closedloop=this.Polyline.Closed,this.Text&&(t.text=this.Text.String),t},t.prototype.InitializeText=function(t){this.Text||(this.Text=new SAM.Text,this.Text.String="Hello",this.Text.UpdateBuffers(t.AnnotationView),this.Text.Color=[0,0,1],this.Text.Anchor=[.5*(this.Text.PixelBounds[0]+this.Text.PixelBounds[1]),.5*(this.Text.PixelBounds[2]+this.Text.PixelBounds[3])],this.Text.Position=[100,100,0],this.Text.BackgroundFlag=!1)},t.prototype.PositionText=function(){var t=this.Polyline.GetBounds(),e=(t[0]+t[1])/2,i=t[2];this.Text.Position=[e,i-40,0]},t.prototype.Load=function(t,e){t.lineColor&&(this.Polyline.OutlineColor=SAM.ConvertColor(t.lineColor)),void 0!==t.lineWidth&&(this.LineWidth=parseFloat(t.lineWidth),this.Polyline.LineWidth=this.LineWidth),this.Polyline.Points=[];for(var i=0;i<t.points.length;i++)this.Polyline.Points[i]=[parseFloat(t.points[i][0]),parseFloat(t.points[i][1])];void 0!==t.closedloop&&(this.Polyline.Closed=t.closedloop),this.Polyline.UpdateBuffers(e.AnnotationView),t.text&&(this.Text||this.InitializeText(e),this.Text.String=t.text),void 0!==t.view_height&&(this.CreationCamera=t.creation_camera)},t.prototype.CityBlockDistance=function(t,e){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])},t.prototype.HandleKeyDown=function(t){var e=t.Event;if(82===e.keyCode&&(this.Polyline.Points.reverse(),this.ColorByHandedness(t),t.EventuallyDraw(!0)),67===e.keyCode&&e.ctrlKey){var i={Type:"PolylineWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(i),!1}return 27!==e.keyCode&&32!==e.keyCode&&13!==e.keyCode||(t.DeactivateWidget(this),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),window.SA&&SA.RecordState(),!1)},t.prototype.HandleDoubleClick=function(t){if(this.State===e||1===this.State)return this.Polyline.MergePoints(this.Circle.Radius),t.DeactivateWidget(this),!1;var i=t.Event;if(5===this.State){var o=i.offsetX,s=i.offsetY,n=t.GetCamera().ConvertPointViewerToWorld(o,s);if(-1!==this.ActiveVertex)this.Polyline.Points[this.ActiveVertex]=n,this.DrawingVertex=this.ActiveVertex,this.ActiveVertex=-1;else{if(!this.ActiveEdge)return console.log("No vertex or edge is active."),!1;this.Polyline.Points.splice(this.ActiveEdge[1],0,n),this.DrawingVertex=this.ActiveEdge[1],this.ActiveEdge=void 0}return this.Polyline.UpdateBuffers(t.AnnotationView),this.SetCursorToDrawing(t),this.State=e,t.EventuallyDraw(!1),!1}},t.prototype.HandleMouseDown=function(t){return 1===t.Event.which&&5===this.State&&(this.Circle.FillColor=this.Polyline.OutlineColor,this.Circle.Active=!1),!1},t.prototype.HandleClick=function(t){var e=t.Event;this.HandleMouseUp(e)},t.prototype.HandleMouseUp=function(t){var i=t.Event;if(3===i.which)return this.State=6,this.ShowPropertiesDialog(),!1;if(1!==i.which)return!1;if(5===this.State)return this.Polyline.MergePoints(this.Circle.Radius),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),window.SA&&SA.RecordState(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),!1;var o=i.offsetX,s=i.offsetY,n=t.GetCamera().ConvertPointViewerToWorld(o,s);if(this.State===e){if(this.Polyline.GetNumberOfPoints()>0)return!1;this.Polyline.Points.push(n),this.DrawingVertex=this.Polyline.GetNumberOfPoints()-1,this.State=1}return 1===this.State?this.Polyline.GetNumberOfPoints()>2&&0===this.ActiveVertex?(this.Polyline.Points.pop(),this.Polyline.Closed=!0,t.DeactivateWidget(this),window.SA&&SA.RecordState(),!1):(this.DrawingVertex+=1,this.Polyline.Points.splice(this.DrawingVertex,0,n),this.Polyline.UpdateBuffers(t.AnnotationView),t.EventuallyDraw(!0),!1):(this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),!1)},t.prototype.HandleDrag=function(t,e){if(this.ActiveEdge){var i=this.Polyline.Points[this.ActiveEdge[0]],o=this.Polyline.Points[this.ActiveEdge[1]],s=i[0]+this.ActiveEdge[2]*(o[0]-i[0]),n=i[1]+this.ActiveEdge[2]*(o[1]-i[1]);this.Polyline.Points.splice(this.ActiveEdge[1],0,[s,n]),this.ActiveVertex=this.ActiveEdge[1],this.ActiveEdge=void 0,this.HighlightVertex(this.ActiveVertex,e),this.Circle.Active=!1}if(-1===this.ActiveVertex)return!1;this.Circle.Active=!1,this.Polyline.Points[this.ActiveVertex]=t,this.ActiveVertex>0&&this.Polyline.GetEdgeLength(this.ActiveVertex-1)<this.Circle.Radius&&(this.Circle.Active=!0,t=this.Polyline.Points[this.ActiveVertex-1].slice(0)),this.ActiveVertex<this.Polyline.GetNumberOfPoints()-1&&this.Polyline.GetEdgeLength(this.ActiveVertex)<this.Circle.Radius&&(this.Circle.Active=!0,t=this.Polyline.Points[this.ActiveVertex+1].slice(0)),this.Polyline.Points[this.ActiveVertex]=t,this.Circle.Origin=t,this.Polyline.UpdateBuffers(e.AnnotationView),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),e.EventuallyDraw(!0)},t.prototype.StartDrawing=function(t){if(0!==this.Polyline.GetNumberOfPoints()){if(0===this.DrawingVertex&&(this.Polyline.Points.reverse(),this.DrawingVertex=this.Polyline.GetNumberOfPoints()-1),this.DrawingVertex===this.Polyline.GetNumberOfPoints()-1)return this.Polyline.Points.push(t),this.DrawingVertex+=1,void(this.State=1);var e=this.Polyline.Points[this.DrawingVertex-1],i=this.Polyline.Points[this.DrawingVertex],o=this.Polyline.Points[this.DrawingVertex+1],s=t[0]-i[0],n=t[1]-i[1],a=[e[0]-i[0],e[1]-i[1]],r=Math.sqrt(a[0]*a[0]+a[1]*a[1]);r=(s*a[0]+n*a[1])/r;var h=[o[0]-i[0],o[1]-i[1]],l=Math.sqrt(h[0]*h[0]+h[1]*h[1]);return l=(s*h[0]+n*h[1])/r,r>l&&(this.Polyline.Points.reverse(),this.DrawingVertex=this.Polyline.GetNumberOfPoints()-this.DrawingVertex-1),this.DrawingVertex+=1,this.Polyline.Points.splice(this.DrawingVertex,0,t),this.State=1,!1}},t.prototype.HandleMouseMove=function(t){var i=t.Event,o=i.offsetX,s=i.offsetY,n=t.GetCamera().ConvertPointViewerToWorld(o,s);if(this.State===e)return this.StartDrawing(n),!1;if(1===this.State){this.Polyline.Points[this.DrawingVertex]=n,this.Polyline.UpdateBuffers(t.AnnotationView);var a=this.Polyline.PointOnVertex(n,this.Circle.Radius);return this.DrawingVertex===this.Polyline.GetNumberOfPoints()-1&&0===a?this.HighlightVertex(0,t):this.HighlightVertex(-1,t),!1}if(5===this.State){if(0===i.which)return!1;5===this.State&&1===i.which&&this.HandleDrag(n,t)}},t.prototype.CheckActive=function(t){return!1},t.prototype.HighlightVertex=function(t,e){t<0||t>=this.Polyline.GetNumberOfPoints()?this.Circle.Visibility=!1:(this.Circle.Visibility=!0,this.Circle.Active=!0,this.Circle.Radius=8/e.GetPixelsPerUnit(),this.CircleRadius=Math.max(this.CircleRadius,1.5*this.Polyline.GetLineWidth()),this.Circle.UpdateBuffers(e.AnnotationView),this.Circle.Origin=this.Polyline.Points[t]),this.ActiveVertex=t,e.EventuallyDraw(!0)},t.prototype.UpdateActiveCircle=function(t){if(-1===this.ActiveVertex){if(this.ActiveEdge){this.Circle.Visibility=!0,this.Circle.Active=!0,this.Circle.Radius=4/t.GetPixelsPerUnit(),this.CircleRadius=Math.max(this.CircleRadius,this.Polyline.GetLineWidth());var e=this.Polyline.Points[this.ActiveEdge[0]],i=this.Polyline.Points[this.ActiveEdge[1]],o=e[0]+this.ActiveEdge[2]*(i[0]-e[0]),s=e[1]+this.ActiveEdge[2]*(i[1]-e[1]);this.Circle.Origin=[o,s,0],this.Circle.UpdateBuffers(t.AnnotationView)}else this.Circle.Visibility=!1;t.EventuallyDraw(!1)}else this.HighlightVertex(this.ActiveVertex,t)},t.prototype.GetActive=function(){return this.State!==i},t.prototype.SetActive=function(t,e){t!==this.GetActive()&&(t?(this.State=5,this.UpdateActiveCircle(e)):(this.State=i,this.DrawingVertex=-1,this.ActiveVertex=-1,this.ActiveEdge=void 0,this.Circle.Visibility=!1,this.DeactivateCallback&&this.DeactivateCallback(),this.Polyline.GetNumberOfPoints()<2&&e&&e.RemoveWidget(this)),e.EventuallyDraw(!1))},t.prototype.SetCursorToDrawing=function(t){t.GetParent().css({cursor:"url("+SAM.ImagePathUrl+"dotCursor8.png) 4 4,crosshair"}),t.EventuallyDraw()},t.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Polyline.OutlineColor)),this.Dialog.ClosedInput.prop("checked",this.Polyline.Closed),this.Dialog.LineWidthInput.val(this.Polyline.LineWidth.toFixed(2));var t=.25*this.ComputeLength(),e="";if(this.Polyline.FixedSize?(e+=t.toFixed(2),e+=" px"):e+=t>1e3?(t/1e3).toFixed(2)+" mm":t.toFixed(2)+" µm",this.Dialog.Length.text(e),this.Polyline.Closed){this.Dialog.AreaDiv.show();var i=Math.abs(.25*this.ComputeArea()*.25),o="";this.Polyline.FixedSize?(o+=i.toFixed(2),o+=" pixels^2"):o+=i>1e6?(i/1e6).toFixed(2)+" mm^2":i.toFixed(2)+" µm^2",this.Dialog.Area.text(o)}else this.Dialog.AreaDiv.hide();this.Dialog.Show(!0)},t.prototype.DialogApplyCallback=function(t){var e=this.Dialog.ColorInput.val();this.Polyline.SetOutlineColor(e),this.Polyline.Closed=this.Dialog.ClosedInput.prop("checked"),this.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Polyline.UpdateBuffers(t.AnnotationView),this.SetActive(!1,t),window.SA&&SA.RecordState(),t.EventuallyDraw(!1),localStorage.PolylineWidgetDefaults=JSON.stringify({Color:e,ClosedLoop:this.Polyline.Closed,LineWidth:this.LineWidth}),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote()},t.prototype.ComputeLength=function(){if(this.Polyline.GetNumberOfPoints()<2)return 0;for(var t=0,e=this.Polyline.Points[0][0],i=this.Polyline.Points[0][1],o=1;o<this.Polyline.GetNumberOfPoints();++o){var s=this.Polyline.Points[o][0],n=this.Polyline.Points[o][1],a=s-e,r=n-i;e=s,i=n,t+=Math.sqrt(a*a+r*r)}return t},t.prototype.PointInside=function(t,e){if(!1===this.Polyline.Closed)return!1;var i,o=this.Polyline.GetNumberOfPoints()-1,s=0,n=0,a=this.Polyline.Points[o];a=[a[0]-t,a[1]-e];for(var r=0;r<=o;++r){var h,l=this.Polyline.Points[r];0!==(h=(l=[l[0]-t,l[1]-e])[1]-a[1])&&(h=-a[1]/h)>0&&h<=1&&((i=a[0]+h*(l[0]-a[0]))>0&&(s+=1),i<0&&(n+=1)),a=l}return!!(s%2&&n%2)},t.prototype.Sample=function(t,e,i,o,s,n){for(var a=this.Polyline.GetBounds(),r=n.Context2d,h=a[2];h<a[3];h+=i)for(var l=a[0];l<a[1];l+=i)if(this.PointInside(l,h)){var d=n.GetCamera().ConvertPointWorldToViewer(l,h);d[0]=Math.round(d[0]-t/2),d[1]=Math.round(d[1]-t/2);var u=r.getImageData(d[0],d[1],t,t);SA.DownloadImageData(u,o+"_"+s+".png"),++s}},t.prototype.ColorByHandedness=function(t){var e=this.Polyline.ComputeArea();this.Polyline.OutlineColor=e>0?[1,0,0]:[0,0,1],t.EventuallyDraw(!0)},SAM.PolylineWidget=t}(),function(){"use strict";function t(t){this.Layer=t,this.State=e,this.ModifiedCallback=void 0,this.StateChangeCallback=void 0,this.SelectedCallback=void 0,this.Type="pencil",this.StylusOnly=!1,this.LineWidth=0,this.Mode=i,this.Color="#00c",this.LoadDefaults(),this.Shapes=new SAM.ShapeGroup,this.Circle=new SAM.Circle,this.Circle.Radius=5,this.Circle.FixedSize=!0,this.Circle.UpdateBuffers(t.AnnotationView)}var e=0,i=0;t.prototype.LoadDefaults=function(){if(localStorage.PencilWidgetDefaults){var t=JSON.parse(localStorage.PencilWidgetDefaults);t.Color&&(this.Color=t.Color),void 0!==t.LineWidth&&(this.LineWidth=t.LineWidth),void 0!==t.Mode&&("open"===t.Mode?this.Mode=i:this.Mode=1)}},t.prototype.InitializeDialog=function(){this.Dialog=new SAM.Dialog(this.Layer.GetParent().parent());var t=this;this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.Title.text("Pencil Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val(this.Color).css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).val(this.LineWidth).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Dialog.ClosedDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ClosedLabel=$("<div>").appendTo(this.Dialog.ClosedDiv).text("Closed:").css({display:"table-cell","text-align":"left"}),this.Dialog.ClosedInput=$('<input type="checkbox">').appendTo(this.Dialog.ClosedDiv).attr("checked","false").css({display:"table-cell"})},t.prototype.SetStateChangeCallback=function(t){this.StateChangeCallback=t},t.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},t.prototype.SetSelectedCallback=function(t){this.SelectedCallback=t},t.prototype.StateChanged=function(){this.StateChangeCallback&&this.StateChangeCallback(this)},t.prototype.Modified=function(){this.ModifiedCallback&&this.ModifiedCallback(this)},t.prototype.SelectionChanged=function(){this.SelectedCallback&&this.SelectedCallback(this)},t.prototype.IsEmpty=function(){return this.Shapes.IsEmpty()},t.prototype.SetModeToOpen=function(){this.Mode=i;for(var t=0;t<this.Shapes.GetNumberOfShapes();++t){var e=this.Shapes.GetShape(t);e.IsSelected()&&(!0===e.Closed&&this.Modified(),e.Closed=!1,e.UpdateBuffers(this.Layer.AnnotationView),e.Modified())}this.SaveDefaults()},t.prototype.SetModeToClosed=function(){this.Mode=1;for(var t=0;t<this.Shapes.GetNumberOfShapes();++t){var e=this.Shapes.GetShape(t);e.IsSelected()&&(!1===e.Closed&&this.Modified(),e.Closed=!0,e.UpdateBuffers(this.Layer.AnnotationView),e.Modified())}this.SaveDefaults()},t.prototype.IsModeClosed=function(){return 1===this.Mode},t.prototype.SetCreationCamera=function(t){this.CreationCamera=t.Serialize()},t.prototype.GetActive=function(){return this.State!==e},t.prototype.SetActive=function(t){t&&this.State===e&&(this.State=2,this.StateChanged()),t||this.State===e||(this.State=e,this.StateChanged()),t||this.Layer.GetParent().css({cursor:""})},t.prototype.IsStateDrawingDown=function(){return 3===this.State},t.prototype.SetStateToDrawing=function(){2!==this.State&&3!==this.State&&(this.State=2,this.StateChanged(),this.StylusOnly||this.Layer.GetParent().css({cursor:"url("+SAM.ImagePathUrl+"Pencil-icon.png) 0 24,crosshair"}),this.Layer.EventuallyDraw())},t.prototype.Draw=function(){var t=this.Layer.GetView();if(this.Shapes.Draw(t),this.Circle.FillColor=this.Color,void 0!==this.Layer.ZTime&&this.Shapes.Shapes.length>0)for(var e=this.Shapes.Shapes[0].Points,i=0;i<e.length;++i){var o=e[i];if(3===o.length&&o[2]===this.Layer.ZTime){this.Circle.Origin=o;break}}},t.prototype.Serialize=function(){var t={};t.type="pencil",t.shapes=[],t.closedFlags=[];for(var e=0;e<this.Shapes.GetNumberOfShapes();++e){var i=this.Shapes.GetShape(e),o=i.Points.slice(0);t.shapes.push(o),t.closedFlags.push(i.Closed),t.lineColor=SAM.ConvertColorToHex(i.OutlineColor),t.lineWidth=i.LineWidth}return t.creation_camera=this.CreationCamera,t},t.prototype.Load=function(t){this.LineWidth=0,void 0!==t.lineWidth&&(this.LineWidth=parseFloat(t.lineWidth));var e=this.Color;t.lineColor&&(this.Color=t.lineColor);for(var o=0;o<t.shapes.length;o++){var s=t.shapes[o],n=new SAM.Polyline;t.closedFlags&&(n.Closed=t.closedFlags[o],n.Closed?this.Mode=1:this.Mode=i),n.SetOutlineColor(e),n.FixedSize=!1,n.LineWidth=this.LineWidth,1===this.Mode&&(n.Closed=!0),this.Shapes.AddShape(n),n.Points=s.slice(0);for(var a=0;a<n.Points.length;++a){var r=n.Points[a];2===r.length&&(n.Points[a]=[r[0],r[1],0])}}void 0!==t.view_height&&(this.CreationCamera=t.creation_camera)},t.prototype.DeleteSelected=function(){return this.Shapes.DeleteSelected()},t.prototype.HandleKeyDown=function(){return this.State===e||(!!this.StylusOnly||(2!==this.State&&3!==this.State||27!==event.keyCode&&32!==event.keyCode&&13!==event.keyCode||(this.SetActive(!1),!1)))},t.prototype.SetStateToDrawingDown=function(t,e){if(3!==this.State){if(2!==this.State&&this.StateChanged(),this.State=3,this.Mode===i)this.Shapes.GetNumberOfShapes();var o=new SAM.Polyline;o.SetSelected(!0),this.Dialog||this.InitializeDialog(),o.SetOutlineColor(this.Color),o.FixedSize=!1,o.LineWidth=this.LineWidth,o.Closed=!1,this.Shapes.AddShape(o);var s=this.Layer.GetCamera().ConvertPointViewerToWorld(t,e);o.Points.push([s[0],s[1],0])}},t.prototype.HandleSelect=function(){var t=this.Layer.MouseX,e=this.Layer.MouseY,o=this.Layer.GetCamera().ConvertPointViewerToWorld(t,e);if(SAM.ControlKey){if(this.IsSelected()){var s=this.Shapes.Shapes[0],n=s.Points[0],a=s.Points[s.Points.length-1],r=o[0]-n[0],h=o[1]-n[1],l=r*r+h*h,d=(r=o[0]-a[0])*r+(h=o[1]-a[1])*h;return o=[o[0],o[1],this.Layer.ZTime],console.log(o.toString()),d<l?s.Points.push(o):s.Points=[o].concat(s.Points),this.Modified(),s.UpdateBuffers(this.Layer.AnnotationView),this.Layer.EventuallyDraw(),this}return!1}var u=this.Shapes.GetLineWidth(),p=20/this.Layer.GetPixelsPerUnit();u<p&&(u=p);var c=this.Shapes.HandleSelect(o,u);if(c)return c.Closed?this.Mode=1:this.Mode=i,this.SelectionChanged(),c;this.SetActive(!1),this.SelectionChanged()},t.prototype.HandleMouseDown=function(){if(this.State===e)return!0;if(this.StylusOnly)return!0;var t=this.Layer.MouseX,i=this.Layer.MouseY,o=this.Layer.GetCamera();return this.LastMouse=o.ConvertPointViewerToWorld(t,i),!1},t.prototype.HandleTouchStart=function(){if(this.State===e)return!0;if(this.StylusOnly&&!this.Layer.Event.pencil)return!0;if(1!==this.Layer.Touches.length)return!0;if(2===this.State){var t=this.Layer.Touches[0][0],i=this.Layer.Touches[0][1];this.SetStateToDrawingDown(t,i)}return!1},t.prototype.HandleStop=function(){var t=this.Shapes.GetNumberOfShapes()-1;if(3===this.State&&t>=0){var e=this.Layer.GetCamera().GetSpacing(),i=this.Shapes.GetShape(t);if(i.Decimate(.5*e),i.Closed=1===this.Mode,i.length<=1)return i.Points.pop(),!1;this.Modified(),this.State=2,1===this.Mode?this.HandleLassoMerge():this.HandleOpenCut()}return!1},t.prototype.HandleMouseUp=function(){return this.State===e||(!!this.StylusOnly||(2===this.Layer.Event.which?(this.SetActive(!1),!1):this.HandleStop()))},t.prototype.HandleTouchEnd=function(){return!(!this.StylusOnly||this.Layer.Event.pencil)||(3!==this.State||this.HandleStop())},t.prototype.HandleMove=function(t,e){if(2===this.State&&this.SetStateToDrawingDown(t,e),3===this.State){var i=this.Shapes.GetNumberOfShapes()-1,o=this.Shapes.GetShape(i),s=this.Layer.GetCamera().ConvertPointViewerToWorld(t,e);return o.Points.push([s[0],s[1],0]),o.Modified(),this.Layer.EventuallyDraw(),!1}return!0},t.prototype.HandleMouseMove=function(){if(this.State===e)return!0;if(this.StylusOnly)return!0;var t=this.Layer.Event,i=this.Layer.MouseX,o=this.Layer.MouseY;return 1===t.which&&this.HandleMove(i,o),!1},t.prototype.HandleTouchMove=function(){if(this.State===e)return!0;if(this.StylusOnly&&!this.Layer.Event.pencil)return!0;if(1!==this.Layer.Touches.length)return!0;var t=this.Layer.Touches[0][0],i=this.Layer.Touches[0][1];return this.HandleMove(t,i),!1},t.prototype.SetSelected=function(t){var e=this.Shapes.SetSelected(t);return t&&this.SelectionChanged(),t||this.SetActive(!1),e},t.prototype.IsSelected=function(){return this.Shapes.IsSelected()},t.prototype.ApplySelect=function(t){for(var e=!1,i=0;i<this.Shapes.GetNumberOfShapes();++i){var o=this.Shapes.GetShape(i),s=o.GetBounds();t.WorldPointInSelection(s[0],s[2])&&t.WorldPointInSelection(s[0],s[3])&&t.WorldPointInSelection(s[1],s[2])&&t.WorldPointInSelection(s[1],s[3])?(o.SetSelected(!0),e=!0):o.SetSelected(!1)}return e},t.prototype.ShowPropertiesDialog=function(){this.Dialog||this.InitializeDialog(),this.Dialog.ColorInput.val(this.Color),this.Dialog.LineWidthInput.val(this.LineWidth.toFixed(2)),this.Dialog.ClosedInput.prop("checked",1===this.Mode),this.Dialog.Show(!0)},t.prototype.DialogApplyCallback=function(){this.Color=this.Dialog.ColorInput.val(),this.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Dialog.ClosedInput.prop("checked")?this.SetModeToClosed():this.SetModeToOpen(),this.Shapes.SetOutlineColor(this.Color),this.Shapes.SetLineWidth(parseFloat(this.Dialog.LineWidthInput.val())),this.Shapes.UpdateBuffers(this.Layer.AnnotationView),this.SetSelected(!1),window.SA&&SA.RecordState(),this.Layer.EventuallyDraw(),this.Modified(),this.SaveDefaults()},t.prototype.SaveDefaults=function(){var t=this.Color,e="open";1===this.Mode&&(e="closed"),localStorage.PencilWidgetDefaults=JSON.stringify({Color:t,LineWidth:this.LineWidth,Mode:e})},t.prototype.HandleLassoMerge=function(){for(var t=this.Shapes.GetNumberOfShapes()-1,e=this.Shapes.GetShape(t),i=!1,o=0;o<t;++o){var s=this.Shapes.GetShape(o);if(s.IsSelected()){i=!0;break}}if(!i)return e.Closed=!0,e.UpdateBuffers(this.Layer.AnnotationView),this.Layer.EventuallyDraw(),void console.log("first stroke not found");this.CombineStrokes(s,e)?(console.log("stroke merged"),this.Shapes.DeleteChild(t),s.UpdateBuffers(this.Layer.AnnotationView)):(console.log("no intersection"),s.SetSelected(!1),1===this.Mode&&(e.Closed=!0),e.UpdateBuffers(this.Layer.AnnotationView)),this.Layer.EventuallyDraw()},t.prototype.CombineStrokes=function(t,e){var i=t.Points,o=e.Points;i.push(i[0]);for(var s,n,a=1;a<o.length;++a){var r=o[a-1],h=o[a],l=this.FindSegmentLoopIntersections(r,h,i);l.sort(function(t,e){return t.k-e.k});for(var d=0;d<l.length;++d){var u=l[d];l.length>0&&(void 0===s?((s=u).StrokeIdx0=a-1,s.StrokeIdx1=a):((n=u).StrokeIdx0=a-1,n.StrokeIdx1=a))}}if(void 0===n)return i.pop(),!1;var p=[s.Point];(p=p.concat(o.slice(s.StrokeIdx1,n.StrokeIdx1))).push(n.Point);var c,f=!0;n.LoopIdx1<s.LoopIdx1&&(c=s,s=n,n=c,f=!f);var g=i.slice(s.LoopIdx1,n.LoopIdx1);return(c=i.slice(n.LoopIdx1)).pop(),c=c.concat(i.slice(0,s.LoopIdx1)),this.ComputeStrokeLength(c)>this.ComputeStrokeLength(g)&&(g=c,f=!f),f&&p.reverse(),t.Points=g.concat(p),!0},t.prototype.ComputeStrokeLength=function(t){if(0===t.length)return 0;for(var e,i,o,s=t[0],n=0,a=1;a<t.length;++a)i=(e=t[a])[0]-s[0],o=e[1]-s[1],n+=Math.sqrt(i*i+o*o);return n},t.prototype.FindSegmentLoopIntersections=function(t,e,i){var o=[],s=[e[0]-t[0],e[1]-t[1]],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(n<=0)return[];s[0]=s[0]/n,s[1]=s[1]/n;for(var a=i[0],r=[(a[0]-t[0])/n,(a[1]-t[1])/n],h=[r[0]*s[0]+r[1]*s[1],r[1]*s[0]-r[0]*s[1]],l=1;l<i.length;++l){var d=i[l];if(t!==a&&t!==d){var u=[(d[0]-t[0])/n,(d[1]-t[1])/n],p=[u[0]*s[0]+u[1]*s[1],u[1]*s[0]-u[0]*s[1]];if(p[1]>=0&&h[1]<=0||p[1]<=0&&h[1]>=0){var c=h[1]/(h[1]-p[1]),f=h[0]+c*(p[0]-h[0]);if(f>0&&f<=1){var g=[a[0]+c*(d[0]-a[0]),a[1]+c*(d[1]-a[1]),0];o.push({Point:g,LoopIdx0:l-1,LoopIdx1:l,k:f})}}a=d,r=u,h=p}}return o},t.prototype.IsPointInsideLoop=function(t,e,i){for(var o=0,s=i[i.length-1],n=0;n<i.length;++n){var a=i[n],r=[s[0]-t,s[1]-e],h=[a[0]-t,a[1]-e],l=Math.sqrt(r[0]*r[0]+r[1]*r[1]),d=Math.sqrt(h[0]*h[0]+h[1]*h[1]);o+=Math.arcsin((r[0]*h[1]-r[1]*h[0])/(l*d))}return o>3.14||o<-3.14},t.prototype.ComputeSegmentNormal=function(t,e){var i=e[0]-t[0],o=e[1]-t[1],s=Math.sqrt(i*i+o*o);if(0!==s)return[-o/s,i/s]},t.prototype.SegmentToLoop=function(t,e,i){var o=[],s=this.ComputeSegmentNormal(t,e);return s?(o.concat(this.EndCap(t,s,i,8)),o.concat(this.EndCap(e,s,-i,8)),o):(s=[0,1],o.concat(this.EndCap(t,s,i,8)),o.pop(),o.concat(this.EndCap(t,s,-i,8)),o)},t.prototype.EndCap=function(t,e,i,o){for(var s=[],n=0;n<=o;++n){var a=Math.PI*n/o,r=Math.cos(a),h=Math.sin(a),l=t[0]+i*(r*e[0]-h*e[1]),d=t[1]+i*(r*e[1]+h*e[0]);s.push([l,d])}return s},t.prototype.CombineEraserStroke=function(t,e){var i=t.Points,o=e.Points;i.push(i[0]);for(var s,n,a=1;a<o.length;++a){var r=o[a-1],h=o[a],l=this.FindSegmentLoopIntersections(r,h,i);l.sort(function(t,e){return t.k-e.k}),l.length>0&&(void 0===s?((s=l[0]).StrokeIdx0=a-1,s.StrokeIdx1=a):((n=l[l.length-1]).StrokeIdx0=a-1,n.StrokeIdx1=a))}if(void 0===n)return i.pop(),!1;var d=[s.Point];(d=d.concat(o.slice(s.StrokeIdx1,n.StrokeIdx1))).push(n.Point);var u,p=!0;n.LoopIdx1<s.LoopIdx1&&(u=s,s=n,n=u,p=!p);var c=i.slice(s.LoopIdx1,n.LoopIdx1);return(u=i.slice(n.LoopIdx1)).pop(),u=u.concat(i.slice(0,s.LoopIdx1)),this.ComputeStrokeLength(u)>this.ComputeStrokeLength(c)&&(c=u,p=!p),p&&d.reverse(),t.Points=c.concat(d),!0},t.prototype.HandleOpenCut=function(){for(var e=this.Shapes.GetNumberOfShapes()-1,i=this.Shapes.GetShape(e),o=!1,s=0;s<e;++s){var n=this.Shapes.GetShape(s);if(n.IsSelected()){o=!0;break}}if(o){for(var a=1;a<n.Points.length;++a){var r=n.Points[a-1],h=n.Points[a];if(this.FindSegmentLoopIntersections(r,h,i.Points).length>0){var l=n.Points.slice(a),d=n.Points.slice(0,a);if(l.length<2&&(l=d,d=void 0),n.Points=l,n.UpdateBuffers(this.Layer.AnnotationView),this.Shapes.DeleteChild(e),d){i.Points=d,i.UpdateBuffers(this.Layer.AnnotationView);var u=new t(this.Layer);u.Shapes.AddShape(i),u.Color=this.Color,this.Layer.AddWidget(u)}return this.Layer.EventuallyDraw(),void this.SelectionChanged()}}n.SetSelected(!1),this.Layer.EventuallyDraw(),this.SelectionChanged()}},SAM.PencilWidget=t}(),function(){"use strict";function t(t,o){null!==t&&(this.Dialog=new SAM.Dialog(this),this.Dialog.Title.text("Fill Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-fill-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-fill-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-fill-input"),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-fill-div"),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").addClass("sa-view-fill-label"),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).addClass("sa-view-fill-input").keypress(function(t){return 13!==t.keyCode}),this.Popup=new SAM.WidgetPopup(this),this.Viewer=t,this.Viewer.AddWidget(this),this.Cursor=$("<img>").appendTo("body").addClass("sa-view-fill-cursor").attr("type","image").attr("src",SAM.ImagePathUrl+"brush1.jpg"),this.ActiveCenter=[0,0],this.State=e,o||(this.State=i),this.CreationCamera=t.GetCamera().Serialize)}var e=0,i=2;t.prototype.Initialize=function(t){this.Segmentation=new SA.Segmentation(this.Viewer)},t.prototype.Draw=function(t){this.Segmentation.ImageAnnotation.Draw(t)},t.prototype.Serialize=function(){},t.prototype.Load=function(t){},t.prototype.HandleKeyPress=function(t,e){return!1},t.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.Viewer.DeactivateWidget(this),this.State=i,this.DeactivateCallback&&this.DeactivateCallback(),this.Viewer.EventuallyRender()},t.prototype.HandleMouseDown=function(t){var e,i=this.Viewer.MouseX,o=this.Viewer.MouseY;1===t.which&&(e=this.Viewer.ConvertPointViewerToWorld(i,o),this.Cursor.attr("src",SAM.ImagePathUrl+"brush1.jpg"),this.Cursor.show(),this.Segmentation.AddPositive(e)),3===t.which&&(e=this.Viewer.ConvertPointViewerToWorld(i,o),this.Cursor.attr("src",SAM.ImagePathUrl+"eraser1.jpg"),this.Cursor.show(),this.Segmentation.AddNegative(e))},t.prototype.HandleMouseUp=function(t){2===t.which&&this.Deactivate(),1!==t.which&&3!==t.which||(this.Cursor.hide(),this.Segmentation.Update(),this.Segmentation.Draw(),this.Viewer.EventuallyRender())},t.prototype.HandleDoubleClick=function(t){},t.prototype.HandleMouseMove=function(t){var i=this.Viewer.MouseX,o=this.Viewer.MouseY;if(this.Cursor.css({left:i+4,top:o-32}),!0===this.Viewer.MouseDown&&this.State===e){var s;1===t.which&&(s=this.Viewer.ConvertPointViewerToWorld(i,o),this.Segmentation.AddPositive(s)),3===t.which&&(s=this.Viewer.ConvertPointViewerToWorld(i,o),this.Segmentation.AddNegative(s))}},t.prototype.ComputeActiveCenter=function(){},t.prototype.PlacePopup=function(){},t.prototype.CheckActive=function(t){},t.prototype.GetActive=function(){return!1},t.prototype.SetActive=function(t){if(t){this.Viewer.ActivateWidget(this),this.State=1;for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].Active=!0;this.PlacePopup(),this.Viewer.EventuallyRender()}else this.Deactivate(),this.Viewer.DeactivateWidget(this)},t.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget()},t.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Shapes[0].OutlineColor)),this.Dialog.LineWidthInput.val(this.Shapes[0].LineWidth.toFixed(2)),this.Dialog.Show(!0)},t.prototype.DialogApplyCallback=function(){for(var t=this.Dialog.ColorInput.val(),e=0;e<this.Shapes.length;++e)this.Shapes[e].SetOutlineColor(t),this.Shapes[e].LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Shapes[e].UpdateBuffers(this.Viewer.AnnotationView);this.SetActive(!1),window.SA&&SA.RecordState(),this.Viewer.EventuallyRender()},SAM.FillWidget=t}(),function(){"use strict";function t(t,i){if(null!==t){this.UserNoteFlag=!SA.Edit,this.Type="lasso";var o=this;if(this.Dialog=new SAM.Dialog(function(){o.DialogApplyCallback()}),this.Dialog.Title.text("Lasso Annotation Editor"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-annotation-modal-input"),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).addClass("sa-view-annotation-modal-input").keypress(function(t){return 13!==t.keyCode}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).addClass("sa-view-annotation-modal-input"),localStorage.LassoWidgetDefaults){var s=JSON.parse(localStorage.LassoWidgetDefaults);s.Color&&this.Dialog.ColorInput.val(SAM.ConvertColorToHex(s.Color)),s.LineWidth&&this.Dialog.LineWidthInput.val(s.LineWidth)}this.Layer=t,this.Popup=new SAM.WidgetPopup(this),this.Layer.AddWidget(this),this.Loop=new SAM.Polyline,this.Loop.OutlineColor=[0,0,0],this.Loop.SetOutlineColor(this.Dialog.ColorInput.val()),this.Loop.FixedSize=!1,this.Loop.LineWidth=0,this.Loop.Closed=!0,this.Stroke=!1,this.ActiveCenter=[0,0],i?this.SetStateToDrawing():this.State=e}}var e=2;t.prototype.Draw=function(t){this.Loop.Draw(t),this.Stroke&&this.Stroke.Draw(t)},t.prototype.Serialize=function(){var t={};t.type="lasso",t.user_note_flag=this.UserNoteFlag,t.lineColor=SAM.ConvertColorToHex(this.Loop.OutlineColor),t.lineWidth=this.Loop.GetLineWidth(),t.points=[];for(var e=0;e<this.Loop.Points.length;++e)t.points.push([this.Loop.Points[e][0],this.Loop.Points[e][1]]);return t.closedloop=!0,t},t.prototype.Load=function(t){this.UserNoteFlag=t.user_note_flag,void 0!==t.lineColor&&(this.Loop.OutlineColor=SAM.ConvertColor(t.lineColor)),void 0!==t.lineWidth&&(this.Loop.LineWidth=t.lineWidth);var e=[];void 0!==t.points&&(e=t.points),void 0!==t.shape&&(e=t.shapes[0]);for(var i=0;i<e.length;i++)this.Loop.Points[i]=[parseFloat(e[i][0]),parseFloat(e[i][1])];this.ComputeActiveCenter(),this.Loop.UpdateBuffers(this.Layer.AnnotationView)},t.prototype.HandleMouseWheel=function(t){if(0===this.State||1===this.State){if(!this.Loop)return!0;var e=0;t.deltaY?e=t.deltaY:t.wheelDelta&&(e=t.wheelDelta);var i=1/this.Layer.GetPixelsPerUnit(),o=this.Loop.GetLineWidth();return o=o||i,e>0?o*=1.1:e<0&&(o/=1.1),o<=i&&(o=0),this.Dialog.LineWidthInput.val(o),this.Loop.SetLineWidth(o),this.Loop.UpdateBuffers(this.Layer.AnnotationView),this.Layer.EventuallyDraw(),!1}return!0},t.prototype.Deactivate=function(){this.Popup.StartHideTimer(),this.Layer.DeactivateWidget(this),this.State=e,this.Loop.SetActive(!1),this.Stroke&&this.Stroke.SetActive(!1),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},t.prototype.HandleKeyDown=function(t){if(0===this.State&&(27===t.keyCode||32===t.keyCode||13===t.keyCode))return this.Deactivate(),!1},t.prototype.HandleMouseDown=function(t){var e=t.offsetX,i=t.offsetY;if(1===t.which){this.Stroke=new SAM.Polyline,this.Stroke.OutlineColor=[0,0,0],this.Stroke.SetOutlineColor(this.Loop.OutlineColor),this.Stroke.FixedSize=!1,this.Stroke.LineWidth=0;var o=this.Layer.GetCamera().ConvertPointViewerToWorld(e,i);return this.Stroke.Points=[],this.Stroke.Points.push([o[0],o[1]]),!1}return!0},t.prototype.HandleMouseUp=function(t){if(2===t.which&&this.Deactivate(),1===t.which&&0===this.State){var e=this.Layer.GetCamera().GetSpacing();this.Stroke.Decimate(e),this.Loop&&this.Loop.Points.length>0?this.CombineStroke():(this.Stroke.Closed=!0,this.Stroke.UpdateBuffers(this.Layer.AnnotationView),this.Loop=this.Stroke,this.Stroke=!1),this.ComputeActiveCenter(),this.Layer.EventuallyDraw(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),window.SA&&SA.RecordState()}return!1},t.prototype.HandleDoubleClick=function(t){return 0===this.State?(this.Deactivate(),!1):1!==this.State||(this.SetStateToDrawing(),!1)},t.prototype.SetStateToDrawing=function(){this.State=0,this.Loop.SetActive(!1),this.Popup.Hide(),this.Layer.GetParent().css({cursor:"url("+SAM.ImagePathUrl+"select_lasso.png) 5 30,crosshair"}),this.Layer.EventuallyDraw()},t.prototype.HandleMouseMove=function(t){var e=t.offsetX,i=t.offsetY;if(1===t.which&&0===this.State){var o=this.Stroke,s=this.Layer.GetCamera().ConvertPointViewerToWorld(e,i);return o.Points.push([s[0],s[1]]),o.UpdateBuffers(this.Layer.AnnotationView),SA.notesWidget&&!this.UserNoteFlag&&SA.notesWidget.MarkAsModified(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),this.Layer.EventuallyDraw(),!1}return 1!==this.State||0!==t.which||(this.SetActive(this.CheckActive(t)),!1)},t.prototype.ComputeActiveCenter=function(){for(var t=0,e=0,i=this.Loop,o=0;o<i.Points.length;++o)t+=i.Points[o][0],e+=i.Points[o][1];this.ActiveCenter[0]=t/i.Points.length,this.ActiveCenter[1]=e/i.Points.length},t.prototype.PlacePopup=function(){var t=this.Loop.FindPopupPoint(this.Layer.GetCamera());(t=this.Layer.GetCamera().ConvertPointWorldToViewer(t[0],t[1]))[0]+=20,t[1]-=10,this.Popup.Show(t[0],t[1])},t.prototype.CheckActive=function(t){if(0!==this.State){var e=t.offsetX,i=t.offsetY,o=this.Layer.GetCamera().ConvertPointViewerToWorld(e,i),s=this.Loop.GetLineWidth()/2,n=10/this.Layer.GetPixelsPerUnit();return s<n&&(s=n),!!this.Loop.PointOnShape(o,s)}},t.prototype.GetActive=function(){return this.State!==e},t.prototype.SetActive=function(t){t?this.State===e&&(this.State=1,this.Loop.SetActive(!0),this.PlacePopup(),this.Layer.EventuallyDraw()):this.State!==e&&(this.Deactivate(),this.Layer.DeactivateWidget(this)),this.Layer.EventuallyDraw()},t.prototype.RemoveFromLayer=function(){this.Layer&&this.RemoveWidget(this)},t.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Loop.OutlineColor)),this.Dialog.LineWidthInput.val(this.Loop.LineWidth.toFixed(2));var t=""+this.ComputeArea().toFixed(2);this.Loop.FixedSize?t+=" pixels^2":t+=" units^2",this.Dialog.Area.text(t),this.Dialog.Show(!0)},t.prototype.DialogApplyCallback=function(){var t=this.Dialog.ColorInput.val();this.Loop.SetOutlineColor(t),this.Loop.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Loop.UpdateBuffers(this.Layer.AnnotationView),this.SetActive(!1),window.SA&&SA.RecordState(),this.Layer.EventuallyDraw(),localStorage.LassoWidgetDefaults=JSON.stringify({Color:t,LineWidth:this.Loop.LineWidth}),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote()},t.prototype.CombineStroke=function(){this.Loop.Points.push(this.Loop.Points[0]);for(var t,e,i=1;i<this.Stroke.Points.length;++i){var o=this.Stroke.Points[i-1],s=this.Stroke.Points[i],n=this.FindIntersection(o,s);n&&(this.Stroke.Points.splice(i,0,n.Point),void 0===t?(t=n).StrokeIndex=i:(n.LoopIndex<t.LoopIndex&&(t.LoopIndex+=1),(e=n).StrokeIndex=i))}var a=0;if(void 0!==e){var r,h,l=[],d=0,u=[],p=0;for(i=t.StrokeIndex;i<e.StrokeIndex;++i)l.push(this.Stroke.Points[i]),u.push(this.Stroke.Points[i]);for(i=e.LoopIndex;i!==t.LoopIndex;){if(++a>1e6)return void alert("Combine loop 1 is taking too long.");l.push(this.Loop.Points[i]),r=this.Loop.Points[i][0],h=this.Loop.Points[i][1],0==--i&&(i=this.Loop.Points.length-1),r-=this.Loop.Points[i][0],h-=this.Loop.Points[i][1],d+=Math.sqrt(r*r+h*h)}for(l.push(t.Point),i=e.LoopIndex;i!==t.LoopIndex;){if(++a>1e6)return void alert("Combine loop 2 is taking too long.");u.push(this.Loop.Points[i]),r=this.Loop.Points[i][0],h=this.Loop.Points[i][1],++i==this.Loop.Points.length-1&&(i=0),r-=this.Loop.Points[i][0],h-=this.Loop.Points[i][1],p+=Math.sqrt(r*r+h*h)}u.push(t.Point),this.Loop.Points=d>p?l:u,window.SA&&SA.RecordState()}this.Loop.Points.pop(),this.Loop.UpdateBuffers(this.Layer.AnnotationView),this.ComputeActiveCenter(),this.Stroke=!1,this.Layer.EventuallyDraw()},t.prototype.FindIntersection=function(t,e){var i=!1,o=[e[0]-t[0],e[1]-t[1]],s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);if(s<0)return!1;o[0]=o[0]/s,o[1]=o[1]/s;for(var n=this.Loop.Points[0],a=[(n[0]-t[0])/s,(n[1]-t[1])/s],r=[a[0]*o[0]+a[1]*o[1],a[1]*o[0]-a[0]*o[1]],h=1;h<this.Loop.Points.length;++h){var l=this.Loop.Points[h];if(t!==n&&t!==l){var d=[(l[0]-t[0])/s,(l[1]-t[1])/s],u=[d[0]*o[0]+d[1]*o[1],d[1]*o[0]-d[0]*o[1]];if(u[1]>=0&&r[1]<=0||u[1]<=0&&r[1]>=0){var p=r[1]/(r[1]-u[1]),c=r[0]+p*(u[0]-r[0]);if(c>0&&c<=1){var f=[n[0]+p*(l[0]-n[0]),n[1]+p*(l[1]-n[1])];(!i||c<i.k)&&(i={Point:f,LoopIndex:h,k:c})}}n=l,a=d,r=u}}return i&&this.Loop.Points.splice(i.LoopIndex,0,i.Point),i},t.prototype.IsPointInsideLoop=function(t,e){for(var i=0,o=this.Loop.Points[this.Loop.length-1],s=0;s<this.Loop.length;++s){var n=this.Loop.Points[s],a=[o[0]-t,o[1]-e],r=[n[0]-t,n[1]-e],h=Math.sqrt(a[0]*a[0]+a[1]*a[1]),l=Math.sqrt(r[0]*r[0]+r[1]*r[1]);i+=Math.arcsin((a[0]*r[1]-a[1]*r[0])/(h*l))}return i>3.14||i<-3.14},t.prototype.ComputeArea=function(){for(var t=0,e=this.Loop.Points[0][0]-this.ActiveCenter[0],i=this.Loop.Points[0][1]-this.ActiveCenter[1],o=1;o<this.Loop.Points.length;++o){var s=e,n=i;t+=(e=this.Loop.Points[o][0]-this.ActiveCenter[0])*n-s*(i=this.Loop.Points[o][1]-this.ActiveCenter[1])}return t<0&&(t=-t),t},SAM.LassoWidget=t}(),function(){"use strict";function t(t,e){this.Widget=t,this.Visible=!1,this.HideTimerId=0;var i=e.GetParent(),o=this;this.ButtonDiv=$("<div>").appendTo(i).hide().css({position:"absolute","z-index":"1"}).mouseenter(function(){o.CancelHideTimer()}).mouseleave(function(){o.StartHideTimer()}),this.DeleteButton=$("<img>").appendTo(this.ButtonDiv).css({height:"20px"}).attr("src",SA.ImagePathUrl+"deleteSmall.png").on("click touchstart",function(){o.DeleteCallback()}),this.PropertiesButton=$("<img>").appendTo(this.ButtonDiv).css({height:"20px"}).attr("src",SA.ImagePathUrl+"Menu.jpg").on("click touchstart",function(){o.PropertiesCallback()}),this.HideCallback=void 0}t.prototype.SetHideCallback=function(t){this.HideCllback=t},t.prototype.DeleteCallback=function(){this.Widget.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),this.Widget.SetActive(!1),this.Hide(),this.Widget.Layer.EventuallyDraw(),this.Widget.Layer.RemoveWidget(this.Widget),window.SA&&SA.RecordState()},t.prototype.PropertiesCallback=function(){this.Hide(),this.Widget.ShowPropertiesDialog()},t.prototype.Show=function(t,e){this.CancelHideTimer(),this.ButtonDiv.css({left:t+"px",top:e+"px"}).show()},t.prototype.Hide=function(){this.CancelHideTimer(),this.ButtonDiv.hide(),this.HideCallback&&this.HideCallback()},t.prototype.StartHideTimer=function(){if(!this.HideTimerId){var t=this;SAM.detectMobile()?this.HideTimerId=setTimeout(function(){t.HideTimerCallback()},1500):this.HideTimerId=setTimeout(function(){t.HideTimerCallback()},800)}},t.prototype.CancelHideTimer=function(){this.HideTimerId&&(clearTimeout(this.HideTimerId),this.HideTimerId=0)},t.prototype.HideTimerCallback=function(){this.ButtonDiv.hide(),this.HideTimerId=0},SAM.WidgetPopup=t}(),function(){"use strict";function t(){SAM.Shape.call(this),this.Length=50,this.Width=1,this.Origin=[1e4,1e4],this.FillColor=[0,0,0],this.OutlineColor=[1,1,1],this.PointBuffer=[]}(t.prototype=new SAM.Shape).destructor=function(){},t.prototype.UpdateBuffers=function(t){this.PointBuffer=[];var e=[],i=.5*this.Length+.5,o=.5*this.Width+.5;this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.PointBuffer.push(-o),this.PointBuffer.push(-o),this.PointBuffer.push(0),this.PointBuffer.push(-i),this.PointBuffer.push(-o),this.PointBuffer.push(0),this.PointBuffer.push(-i),this.PointBuffer.push(o),this.PointBuffer.push(0),this.PointBuffer.push(-o),this.PointBuffer.push(o),this.PointBuffer.push(0),this.PointBuffer.push(-o),this.PointBuffer.push(i),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(i),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(o),this.PointBuffer.push(0),this.PointBuffer.push(i),this.PointBuffer.push(o),this.PointBuffer.push(0),this.PointBuffer.push(i),this.PointBuffer.push(-o),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(-o),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(-i),this.PointBuffer.push(0),this.PointBuffer.push(-o),this.PointBuffer.push(-i),this.PointBuffer.push(0),this.PointBuffer.push(-o),this.PointBuffer.push(-o),this.PointBuffer.push(0),e.push(1),e.push(2),e.push(7),e.push(1),e.push(7),e.push(8),e.push(4),e.push(5),e.push(10),e.push(4),e.push(10),e.push(11),t.gl&&(this.VertexPositionBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexPositionBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(this.PointBuffer),t.gl.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),t.gl.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=e.length)},SAM.CrossHairs=t}(),function(){"use strict";function t(){SAM.Shape.call(this),this.Width=10,this.Length=50,this.Orientation=45,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.ZOffset=-.1}(t.prototype=new SAM.Shape).destructor=function(){},t.prototype.PointInShape=function(t,e){var i=-this.Orientation*Math.PI/180,o=Math.cos(i),s=Math.sin(i),n=t*o+e*s,a=-t*s+e*o;if(i=this.Width/2,n>0&&n<1.3*this.Length&&a<3*i&&a>3*-i)return!0},t.prototype.UpdateBuffers=function(t){this.PointBuffer=[];var e=[],i=.5*this.Width,o=2*this.Width;this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(this.Width),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(i),this.PointBuffer.push(0),this.PointBuffer.push(this.Length),this.PointBuffer.push(i),this.PointBuffer.push(0),this.PointBuffer.push(this.Length),this.PointBuffer.push(-i),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(-i),this.PointBuffer.push(0),this.PointBuffer.push(o),this.PointBuffer.push(-this.Width),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(0),this.PointBuffer.push(0),t.gl&&(e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(5),e.push(0),e.push(5),e.push(6),e.push(2),e.push(3),e.push(4),e.push(2),e.push(4),e.push(5),this.VertexPositionBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexPositionBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(this.PointBuffer),t.gl.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),t.gl.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=e.length)},t.prototype.SetTailViewer=function(t,e,i){var o,s;if(this.FixedSize){var n=i.ConvertPointWorldToViewer(this.Origin[0],this.Origin[1]);o=t-n[0],s=e-n[1]}else{var a=i.ConvertPointViewerToWorld(t,e);o=a[0]-this.Origin[0],s=a[1]-this.Origin[1]}this.Length=Math.sqrt(o*o+s*s),this.Orientation=180*-Math.atan2(s,o)/Math.PI},t.prototype.GetTailViewer=function(t){var e,i,o=-this.Orientation*Math.PI/180;if(this.FixedSize){var s=t.ConvertPointWorldToViewer(this.Origin[0],this.Origin[1]);return e=s[0]+this.Length*Math.cos(o),i=s[1]+this.Length*Math.sin(o),[e,i]}return e=this.Origin[0]+this.Length*Math.cos(o),i=this.Origin[1]+this.Length*Math.sin(o),t.ConvertPointWorldToViewer(e,i)},SAM.Arrow=t}(),function(){"use strict";function t(t){if(null===t)return null;if(this.Layer=t,this.Type="arrow",this.State=e,this.StateChangeCallback=void 0,this.SelectedCallback=void 0,this.Arrow=new SAM.Arrow,this.Arrow.Origin=[0,0],this.Arrow.SetFillColor([0,0,0]),this.Arrow.OutlineColor=[1,1,1],this.Arrow.Length=50,this.Arrow.Width=8,this.TipPosition=[0,0],this.TipOffset=[0,0],this.CircleTip=new SAM.Circle,this.CircleTip.SetFillColor([1,1,0]),this.CircleTip.SetOutlineColor([0,0,0]),this.CircleTip.Radius=5,this.CircleTip.LineWidth=1,this.CircleTip.PositionCoordinateSystem=1,this.CircleTail=new SAM.Circle,this.CircleTail.SetFillColor([1,1,0]),this.CircleTail.SetOutlineColor([0,0,0]),this.CircleTail.Radius=5,this.CircleTail.PositionCoordinateSystem=1,localStorage.ArrowWidgetDefaults){var i=JSON.parse(localStorage.ArrowWidgetDefaults);i.Color&&this.Arrow.SetFillColor(i.Color),i.Width&&(this.Arrow.Width=i.Width)}}var e=5;t.prototype.SetCreationCamera=function(t){this.CreationCamera=t.Serialize()},t.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},t.prototype.Modified=function(){this.ModifiedCallback&&this.ModifiedCallback(this)},t.prototype.SetSelectedCallback=function(t){this.SelectedCallback=t},t.prototype.SetStateChangeCallback=function(t){this.StateChangeCallback=t},t.prototype.StateChanged=function(){this.StateChangeCallback&&this.StateChangeCallback(this)},t.prototype.SetStateToDrawing=function(){this.State=0},t.prototype.GetActive=function(){return this.State!==e},t.prototype.SetActive=function(t){t!==this.GetActive()&&(this.State=t?6:e,this.StateChanged(),this.Layer.EventuallyDraw())},t.prototype.Draw=function(){var t=this.Layer.GetView();if(this.Arrow.Draw(t),this.State!==e&&0!==this.State&&2!==this.State){var i=this.GetViewPoints();this.CircleTip.Origin=i[0],this.CircleTail.Origin=i[1],this.CircleTip.Draw(t),this.CircleTail.Draw(t)}},t.prototype.Serialize=function(){if(void 0===this.Arrow)return null;var t={};return t.type="arrow",t.origin=this.Arrow.Origin,t.fillColor=SAM.ConvertColorToHex(this.Arrow.FillColor),t.lineColor=SAM.ConvertColorToHex(this.Arrow.OutlineColor),t.length=this.Arrow.Length,t.width=this.Arrow.Width,t.orientation=this.Arrow.Orientation,t.fixedsize=this.Arrow.FixedSize,t.fixedorientation=this.Arrow.FixedOrientation,t},t.prototype.Load=function(t){this.Arrow.Origin=[parseFloat(t.origin[0]),parseFloat(t.origin[1])],this.TipPosition=[parseFloat(t.origin[0]),parseFloat(t.origin[1])],this.Arrow.FillColor=[parseFloat(t.fillcolor[0]),parseFloat(t.fillcolor[1]),parseFloat(t.fillcolor[2])],this.Arrow.OutlineColor=SAM.ConvertColor(t.lineColor),this.Arrow.Length=parseFloat(t.length),this.Arrow.Width=parseFloat(t.width),this.Arrow.Orientation=parseFloat(t.orientation),void 0===t.fixedsize?this.Arrow.FixedSize=!1:this.Arrow.FixedSize="true"===t.fixedsize,void 0===t.fixedorientation?this.Arrow.FixedOrientation=!1:this.Arrow.FixedOrientation="true"===t.fixedorientation,this.Arrow.UpdateBuffers(this.Layer.AnnotationView)},t.prototype.SetFixedSize=function(t){if(this.Arrow.FixedSize!==t){var e=this.Layer.GetPixelsPerUnit();t?(this.Arrow.Length*=e,this.Arrow.Width*=e):(this.Arrow.Length/=e,this.Arrow.Width/=e),this.Arrow.FixedSize=t,this.Arrow.UpdateBuffers(this.Layer.AnnotationView),this.Layer.EventuallyDraw()}},t.prototype.ApplySelect=function(t){var e=this.GetViewPoints();return t.ViewerPointInSelection(e[0][0],e[0][1])&&t.ViewerPointInSelection(e[1][0],e[1][1])?(this.SetSelected(!0),!0):(this.SetSelected(!1),!1)},t.prototype.HandleSelect=function(){if(8!==this.State){var t=this.Layer.Event,e=t.offsetX,i=t.offsetY;if(this.PointViewerInArrow(e,i))return this.Arrow.Selected=!0,this;this.Arrow.Selected=!1}},t.prototype.HandleMouseDown=function(t){if(this.State===e||6===this.State)return!0;var i=t.Event;if(1!==i.which)return!1;if(0===this.State&&(this.TipPosition=[this.Layer.MouseX,this.Layer.MouseY],this.State=1,this.CircleTail.Selected=!0,this.CircleTail.SetFillColor([1,1,0])),7===this.State){this.CircleTip.Selected?this.State=3:this.CircleTail.Selected?this.State=4:this.State=2;var o=i.offsetX,s=i.offsetY,n=this.Layer.GetCamera();this.LastMouseWorld=n.ConvertPointViewerToWorld(o,s)}return!1},t.prototype.HandleMouseUp=function(t){if(this.State===e||6===this.State)return!0;if(1===this.State)return this.State=e,this.StateChanged(),this.Layer.EventuallyDraw(),this.Modified(),!1;var i=t.Event;return 6===this.State&&3===i.which&&this.ShowPropertiesDialog(),this.State=7,this.Modified(),!1},t.prototype.PointViewerInArrow=function(t,e){var i=this.GetViewPoints(),o=i[1][0]-i[0][0],s=i[1][1]-i[0][1],n=Math.sqrt(o*o+s*s),a=o/n,r=s/n,h=t-i[0][0],l=e-i[0][1],d=Math.sqrt(h*h+l*l),u=a*h+r*l,p=h-a*u,c=l-r*u,f=Math.sqrt(p*p+c*c),g=this.Arrow.Width*n/this.Arrow.Length;return!(d>n||f>g/2+2)},t.prototype.HandleMouseMove=function(t){if(this.State===e)return!0;var i=t.Event,o=this.Layer.MouseX,s=this.Layer.MouseY;if(1===i.which&&6===this.State)return!0;if(6===this.State||7===this.State){var n="";this.PointViewerInArrow(o,s)?(n="move",this.State=7):this.State=6;var a=o-this.CircleTip.Origin[0],r=s-this.CircleTip.Origin[1];return a*a+r*r<Math.pow(this.CircleTip.Radius,2)?(this.CircleTip.Selected=!0,n="move",this.State=7):this.CircleTip.Selected=!1,a=o-this.CircleTail.Origin[0],r=s-this.CircleTail.Origin[1],a*a+r*r<Math.pow(this.CircleTail.Radius,2)?(this.CircleTail.Selected=!0,n="move",this.State=7):this.CircleTail.Selected=!1,this.Layer.GetParent().css({cursor:n}),this.Layer.EventuallyDraw(),!1}var h=this.Layer.GetCamera(),l=h.ConvertPointViewerToWorld(o,s);if(0===this.State)return this.Arrow.Origin=l,this.Layer.EventuallyDraw(),!1;if(1!==i.which)return!1;if(2===this.State)a=l[0]-this.LastMouseWorld[0],r=l[1]-this.LastMouseWorld[1],this.Arrow.Origin[0]+=a,this.Arrow.Origin[1]+=r;else if(4===this.State||1===this.State)this.Arrow.SetTailViewer(o,s,h),this.Arrow.UpdateBuffers(this.Layer.AnnotationView);else if(3===this.State){var d=this.GetViewPoints()[1];this.Arrow.Origin=l,this.Arrow.SetTailViewer(d[0],d[1],h),this.Arrow.UpdateBuffers(this.Layer.AnnotationView)}return this.LastMouseWorld=l,this.Layer.EventuallyDraw(),!1},t.prototype.GetViewPoints=function(){var t=this.Layer.GetCamera(),e=this.Arrow.Origin,i=-this.Arrow.Orientation*Math.PI/180,o=this.Arrow.Length*Math.cos(i),s=this.Arrow.Length*Math.sin(i),n=t.ConvertPointWorldToViewer(e[0],e[1]);if(this.Arrow.FixedSize)var a=[n[0]+o,n[1]+s];else{var r=[e[0]+o,e[1]+s];a=t.ConvertPointWorldToViewer(r[0],r[1])}return[n,a]},t.prototype.CheckActive=function(){var t=this.Layer.GetViewport(),e=this.Layer.GetCamera().ImageMatrix,i=this.Arrow.Origin[0],o=this.Arrow.Origin[1],s=i*e[3]+o*e[7]+e[15],n=(i*e[0]+o*e[4]+e[12])/s,a=(i*e[1]+o*e[5]+e[13])/s;n=.5*(n+1)*t[2]+t[0],a=.5*(a+1)*t[3]+t[1],a=t[3]-a,console.log("origin: "+n+", "+a+", mouse: "+this.Layer.MouseX+", "+this.Layer.MouseY),i=this.Layer.MouseX-n,o=this.Layer.MouseY-a;var r=-this.Arrow.Orientation*Math.PI/180,h=Math.cos(r),l=Math.sin(r);n=i*h+o*l,a=-i*l+o*h;var d=this.Arrow.Length,u=this.Arrow.Width/2;if(!this.Arrow.FixedSize){var p=this.Layer.GetPixelsPerUnit();d*=p,u*=p}return this.ActiveTail=!1,n>0&&n<d&&a>-u&&a<u?(this.SetActive(!0),n>d-u&&(this.ActiveTail=!0),!0):(this.SetActive(!1),!1)},t.prototype.DeleteSelected=function(){return this.Arrow.DeleteSelected()},t.prototype.IsEmpty=function(){return 0===this.State||this.Arrow.IsEmpty()},t.prototype.IsSelected=function(){return this.Arrow.Selected},t.prototype.SetSelected=function(t){this.Arrow.SetSelected(t),t&&this.SelectedCallback&&this.SelectedCallback(this)},t.prototype.SetColor=function(t){this.Arrow.SetFillColor(t),this.Layer.EventuallyDraw()},t.prototype.InitPropertiesDialog=function(){var t=this;this.Dialog=new SAM.Dialog(this.Layer.GetParent().parent()),this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.Title.text("Arrow Properties"),this.Dialog.Body.css({margin:"1em 2em"}),this.Dialog.ColorDiv=$("<div>").css({height:"24px"}).appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-annotation-modal-input"),this.Dialog.WidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.WidthLabel=$("<div>").appendTo(this.Dialog.WidthDiv).text("Shaft Width:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.WidthInput=$('<input type="number">').appendTo(this.Dialog.WidthDiv).addClass("sa-view-annotation-modal-input").keypress(function(t){return 13!==t.keyCode})},t.prototype.ShowPropertiesDialog=function(){void 0===this.Dialog&&this.InitPropertiesDialog(),this.WidgetPropertiesToDialog();var t=this;this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.SetCloseCallback(function(){t.DialogCloseCallback()}),this.Dialog.Show(!0),this.State=8},t.prototype.DialogApplyCallback=function(){this.DialogPropertiesToWidget(),this.Layer&&(this.SetActive(!1),this.Layer.EventuallyDraw())},t.prototype.DialogCloseCallback=function(){this.SetActive(!1),this.Layer.EventuallyDraw()},t.prototype.WidgetPropertiesToDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Arrow.FillColor)),this.Dialog.WidthInput.val(this.Arrow.Width.toFixed(2))},t.prototype.DialogPropertiesToWidget=function(){var t=!1,e=SAM.ConvertColorToHex(this.Dialog.ColorInput.val());e!==this.Arrow.FillColor&&(t=!0,this.Arrow.SetFillColor(e),this.Arrow.ChooseOutlineColor(),t=!0);var i=parseFloat(this.Dialog.WidthInput.val());i!==this.Arrow.Width&&(this.Arrow.Width=i,t=!0),t&&(localStorage.ArrowWidgetDefaults=JSON.stringify({Color:e,Width:i}),this.Modified(),this.Arrow.UpdateBuffers(this.Layer.AnnotationView))},SAM.ArrowWidget=t}(),function(){"use strict";function t(){SAM.Shape.call(this),this.Radius=10,this.Origin=[1e4,1e4],this.OutlineColor=new Array(3),this.OutlineColor.fill(0),this.PointBuffer=[]}(t.prototype=new SAM.Shape).destructor=function(){},t.prototype.UpdateBuffers=function(t){this.PointBuffer=[];var e,i,o=[],s=[],n=Math.floor(this.Radius/2)+10;if((n>50||!this.FixedSize)&&(n=50),this.Matrix=mat4.create(),mat4.identity(this.Matrix),t.gl)if(0===this.LineWidth){for(e=0;e<=n;++e)i=2*e*3.14159265359/n,this.PointBuffer.push(this.Radius*Math.cos(i)),this.PointBuffer.push(this.Radius*Math.sin(i)),this.PointBuffer.push(0);for(e=2;e<n;++e)o.push(0),o.push(e-1),o.push(e);this.VertexPositionBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexPositionBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(this.PointBuffer),t.gl.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,this.CellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),t.gl.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=o.length}else{var a=this.Radius,r=this.Radius+this.LineWidth;for(e=0;e<=n;++e)i=2*e*3.14159265359/n,this.PointBuffer.push(a*Math.cos(i)),this.PointBuffer.push(a*Math.sin(i)),this.PointBuffer.push(0),this.PointBuffer.push(r*Math.cos(i)),this.PointBuffer.push(r*Math.sin(i)),this.PointBuffer.push(0);for(this.VertexPositionBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this.VertexPositionBuffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(this.PointBuffer),t.gl.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=this.PointBuffer.length/3,e=2;e<n;++e)o.push(0),o.push(2*(e-1)),o.push(2*e);for(this.CellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.CellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),t.gl.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=o.length,e=0;e<n;++e)s.push(0+2*e),s.push(1+2*e),s.push(2+2*e),s.push(1+2*e),s.push(3+2*e),s.push(2+2*e);this.LineCellBuffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,this.LineCellBuffer),t.gl.bufferData(t.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(s),t.gl.STATIC_DRAW),this.LineCellBuffer.itemSize=1,this.LineCellBuffer.numItems=s.length}else for(e=0;e<=n;++e)i=2*e*3.14159265359/n,this.PointBuffer.push(this.Radius*Math.cos(i)),this.PointBuffer.push(this.Radius*Math.sin(i)),this.PointBuffer.push(0)},SAM.Circle=t}(),function(){"use strict";function t(t){if(this.Layer=t,this.Element={},localStorage.CircleWidgetDefaults?this.Defaults=JSON.parse(localStorage.CircleWidgetDefaults):this.Defaults={},this.ModifiedCallback=void 0,this.StateChangeCallback=void 0,this.SelectedCallback=void 0,this.Type="circle",this.Tolerance=3,SAM.MOBILE_DEVICE&&(this.Tolerance=15),this.Visibility=!0,null!==t){this.CreationCamera=t.GetCamera().Serialize();var o=t.GetCamera(),s=t.GetViewport();if(this.Circle=new SAM.Circle,this.Circle.Origin=new Array(2),this.Circle.Origin.fill(0),this.Circle.OutlineColor=new Array(3),this.Circle.SetOutlineColor("#00ff00"),this.Circle.Radius=50*o.Height/s[3],this.Circle.LineWidth=5*o.Height/s[3],this.Defaults){if(this.Defaults.Color&&(this.Circle.OutlineColor=SAM.ConvertColor(this.Defaults.Color)),void 0!==this.Defaults.LineWidth)if(0===this.Defaults.LineWidth)this.Circle.LineWidth=this.Defaults.LineWidth;else{var n=this.Circle.LineWidth/this.Defaults.LineWidth;Math.max(n,1/n)<10&&(this.Circle.LineWidth=this.Defaults.LineWidth)}this.Defaults.Radius&&(n=this.Circle.Radius/this.Defaults.Radius,Math.max(n,1/n)<10&&(this.Circle.Radius=this.Defaults.Radius))}if(this.Circle.FixedSize=!1,this.Cross=new SAM.Circle,this.Cross.SetFillColor([1,1,0]),this.Cross.SetOutlineColor([0,0,0]),this.Cross.Radius=5,this.Cross.LineWidth=1,this.Cross.PositionCoordinateSystem=1,e){var a=new SAM.Text;a.BackgroundFlag=!1,a.String=e,a.Position=this.Circle.Origin,this.Circle.Children.label=a}this.State=i}}var e,i=6;t.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},t.prototype.SetSelectedCallback=function(t){this.SelectedCallback=t},t.prototype.IsSelected=function(){return this.Circle&&this.Circle.Selected},t.prototype.SetStateChangeCallback=function(t){this.StateChangeCallback=t},t.prototype.StateChanged=function(){this.StateChangeCallback&&this.StateChangeCallback(this)},t.prototype.SetStateToDrawing=function(){this.State=0},t.prototype.Modified=function(){this.SaveDefaults(),this.ModifiedCallback&&this.ModifiedCallback(this)},t.prototype.SelectionChanged=function(){this.SelectedCallback&&this.SelectedCallback(this)},t.prototype.SetCreationCamera=function(t){this.CreationCamera=t.Serialize()},t.prototype.ApplySelect=function(t){if(this.Circle){var e=this.Circle.Radius,i=this.Layer.GetCamera().ConvertPointWorldToViewer(this.Circle.Origin[0],this.Circle.Origin[1]);return t.ViewerPointInSelection(i[0]-e,i[1]-e)&&t.ViewerPointInSelection(i[0]-e,i[1]+e)&&t.ViewerPointInSelection(i[0]+e,i[1]-e)&&t.ViewerPointInSelection(i[0]+e,i[1]+e)?(this.Circle.SetSelected(!0),!0):(this.Circle.SetSelected(!1),!1)}},t.prototype.DeleteSelected=function(){return this.Circle.DeleteSelected()},t.prototype.IsEmpty=function(){return 0===this.State||1===this.State||this.Circle.IsEmpty()},t.prototype.GetActive=function(){return this.State!==i},t.prototype.SetActive=function(t){!1!==t||1!==this.State?(t&&this.State===i&&(this.State=8,this.Layer.GetParent().css({cursor:"move"}),this.StateChanged()),t||this.State===i||(this.State=i,this.StateChanged()),t||this.Layer.GetParent().css({cursor:""}),this.Layer.EventuallyDraw()):this.Cancel()},t.prototype.SetSelected=function(t){this.Circle.SetSelected(t),t&&this.SelectedCallback&&this.SelectedCallback(this),t||this.SetActive(!1)},t.prototype.InitPropertiesDialog=function(t){var e=this;this.Dialog=new SAM.Dialog(this.Layer.GetParent().parent()),this.Dialog.SetApplyCallback(function(){e.DialogApplyCallback()}),this.Dialog.Title.text("Circle Properties"),this.Dialog.Body.css({margin:"1em 2em",height:"14em"}),this.Dialog.RadiusDiv=$("<div>").css({height:"24px"}).appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.RadiusLabel=$("<div>").appendTo(this.Dialog.RadiusDiv).text("Radius:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.RadiusInput=$('<input type="number">').appendTo(this.Dialog.RadiusDiv).val(10).addClass("sa-view-annotation-modal-input"),this.Dialog.CenterDiv=$("<div>").css({height:"24px"}).appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.CenterLabel=$("<div>").appendTo(this.Dialog.CenterDiv).text("Center:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.CenterXInput=$('<input type="number">').appendTo(this.Dialog.CenterDiv).css({width:"30%"}).val(0).addClass("sa-view-annotation-modal-input"),this.Dialog.CenterYInput=$('<input type="number">').appendTo(this.Dialog.CenterDiv).css({width:"30%"}).val(0).addClass("sa-view-annotation-modal-input"),this.Dialog.ColorDiv=$("<div>").css({height:"24px"}).appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").addClass("sa-view-annotation-modal-input"),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).addClass("sa-view-annotation-modal-input").keypress(function(t){return 13!==t.keyCode}),this.Dialog.LabelDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.LabelLabel=$("<div>").appendTo(this.Dialog.LabelDiv).text("Label:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.LabelInput=$('<input type="text">').appendTo(this.Dialog.LabelDiv).addClass("sa-view-annotation-modal-input").keypress(function(t){return 13!==t.keyCode}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).addClass("sa-view-annotation-modal-input")},t.prototype.ShowPropertiesDialog=function(){void 0===this.Dialog&&this.InitPropertiesDialog(),this.WidgetPropertiesToDialog();var t=this;this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.SetCloseCallback(function(){t.DialogCloseCallback()}),this.Dialog.Show(!0),this.State=9},t.prototype.DialogApplyCallback=function(t){this.DialogPropertiesToWidget(),this.Layer&&(this.SetActive(!1),this.Layer.EventuallyDraw(),this.SetActive(!1))},t.prototype.DialogCloseCallback=function(){this.SetActive(!1),this.Layer.EventuallyDraw(),this.SetActive(!1)},t.prototype.WidgetPropertiesToDialog=function(){this.Dialog.RadiusInput.val(Math.round(this.Circle.Radius)),this.Dialog.CenterXInput.val(Math.round(this.Circle.Origin[0])),this.Dialog.CenterYInput.val(Math.round(this.Circle.Origin[1])),this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Circle.OutlineColor)),this.Dialog.LineWidthInput.val(this.Circle.LineWidth.toFixed(2));var t="";this.Circle.Children.label&&this.Circle.Children.label.String&&(t=this.Circle.Children.label.String),this.Dialog.LabelInput.val(t);var e=2*Math.PI*this.Circle.Radius*this.Circle.Radius*.25*.25,i="";this.Circle.FixedSize?(i+=e.toFixed(2),i+=" pixels^2"):e>1e6?(i+=(e/1e6).toFixed(2),i+=" mm^2"):(i+=e.toFixed(2),i+=" um^2"),this.Dialog.Area.text(i)},t.prototype.SetOrigin=function(t){this.Circle.Origin=t,"label"in this.Circle.Children&&(this.Circle.Children.label.Position=t)},t.prototype.DialogPropertiesToWidget=function(){var t=!1,i=parseInt(this.Dialog.RadiusInput.val());i!==this.Circle.Radius&&(this.Circle.Radius=i,t=!0);var o=parseInt(this.Dialog.CenterXInput.val()),s=parseInt(this.Dialog.CenterYInput.val());o===this.Circle.Origin[0]&&s===this.Circle.Origin[1]||(this.Circle.Origin[0]=o,this.Circle.Origin[1]=s,t=!0);var n=SAM.ConvertColorToHex(this.Dialog.ColorInput.val());n!==this.Circle.OutlineColor&&(t=!0,this.Circle.SetOutlineColor(n),t=!0);var a=parseFloat(this.Dialog.LineWidthInput.val());a!==this.Circle.LineWidth&&(this.Circle.LineWidth=a,t=!0);var r=this.Dialog.LabelInput.val();if(""===(r=r.trim()))e=void 0,delete this.Circle.Children.label;else{if(!this.Circle.Children.label){var h=new SAM.Text;h.BackgroundFlag=!1,h.String=r,h.Position=this.Circle.Origin,this.Circle.Children.label=h,e=r}this.Circle.Children.label.String=r,t=!0}t&&(this.Modified(),this.Circle.UpdateBuffers(this.Layer.AnnotationView))},t.prototype.SaveDefaults=function(){this.Defaults.Color=this.Circle.GetOutlineColor(),this.Defaults.LineWidth=this.Circle.LineWidth,this.Defaults.Radius=this.Circle.Radius,localStorage.CircleWidgetDefaults=JSON.stringify(this.Defaults)},t.prototype.Draw=function(){if(this.Visibility&&0!==this.State&&this.Circle){var t=this.Layer.GetView();if(this.Circle.Draw(t),7===this.State||8===this.State){var e=this.Circle.Origin,i=this.Layer.GetCamera().ConvertPointWorldToViewer(e[0],e[1]);this.Cross.Origin=[i[0],i[1]],this.Cross.Draw(t)}}},t.prototype.PasteCallback=function(t,e,i){this.Load(e),this.SetOrigin([i[0],i[1]]),t.EventuallyDraw()},t.prototype.Serialize=function(){if(void 0===this.Circle)return null;var t=this.Element;t.type="circle",t.center=[this.Circle.Origin[0],this.Circle.Origin[1],0],t.lineColor=SAM.ConvertColorToHex(this.Circle.OutlineColor),t.radius=this.Circle.Radius,t.lineWidth=this.Circle.LineWidth,this.Circle.Children.label&&this.Circle.Children.label.String&&(t.label={value:this.Circle.Children.label.String});var e,i;for(e in this.Circle.Children)if("object"==typeof(i=this.Circle.Children[e])&&"Radius"in i){"user"in t||(t.user={});var o=t.user;"keypoints"in o||(o.keypoints=[]);for(var s=o.keypoints,n=0;n<s.length;++n){var a=s[n];a.category===e&&(a.xy=i.Origin)}}return t},t.prototype.Load=function(t){if(this.Element=t,this.Circle.Origin[0]=Math.round(parseFloat(t.center[0])),this.Circle.Origin[1]=Math.round(parseFloat(t.center[1])),void 0!==t.lineColor?this.Circle.OutlineColor=SAM.ConvertColor(t.lineColor):(this.Circle.OutlineColor[0]=0,this.Circle.OutlineColor[1]=1,this.Circle.OutlineColor[2]=1),this.Circle.Radius=Math.round(parseFloat(t.radius)),this.Circle.LineWidth=0,t.lineWidth&&(this.Circle.LineWidth=parseFloat(t.lineWidth)),this.Circle.FixedSize=!1,this.Circle.UpdateBuffers(this.Layer.AnnotationView),void 0!==t.creation_camera&&(this.CreationCamera=t.CreationCamera),"label"in t){var e=t.label.value,i=new SAM.Text;i.BackgroundFlag=!1,i.String=e,i.Position=this.Circle.Origin,this.Circle.Children.label=i}var o,s,n,a;if("user"in t){var r=t.user;if("keypoints"in r)for(a=r.keypoints,n=0;n<a.length;++n)s=a[n],o=new SAM.Circle,"nose"===s.category?o.SetFillColor([0,1,0]):"tail"===s.category?o.SetFillColor([1,0,0]):"left_wingtip"===s.category?o.SetFillColor([1,0,1]):"right_wingtip"===s.category?o.SetFillColor([0,1,1]):o.SetFillColor([.8,.8,1]),o.SetOutlineColor([0,0,0]),o.Radius=2,o.LineWidth=1,o.Origin=s.xy,this.Circle.Children[s.category]=o;else if("network_keypoints"in r)for(a=r.network_keypoints,n=0;n<a.length;++n)s=a[n],o=new SAM.Circle,"nose"===s.keypoint_category?o.SetFillColor([.5,1,.5]):"tail"===s.keypoint_category?o.SetFillColor([1,.5,.5]):o.SetFillColor([.8,.8,1]),o.SetOutlineColor([0,0,0]),o.Radius=2,o.LineWidth=1,o.Origin=s.xy,this.Circle.Children[s.keypoint_category]=o}},t.prototype.Cancel=function(){1===this.State&&(this.State=i,this.Circle.Selected=!0,this.Layer.DeleteSelected()),this.SetActive(!1)},t.prototype.SetVisibility=function(t){this.Visibility=t,this.Layer.EventuallyDraw()},t.prototype.HandleKeyDown=function(t){if(86===t.Event.keyCode)return this.Visibility=!this.Visibility,t.EventuallyDraw(),!0;if(this.State===i)return!0;if(9===this.State)return!1;if(27===event.keyCode)return this.Cancel(),!1;if(67===event.keyCode&&event.ctrlKey){var e={Type:"CircleWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(e),!1}return!0},t.prototype.HandleMouseDown=function(t){if(8!==this.State&&1!==this.State)return!0;if(1!==t.Event.which)return!1;var e=t.GetCamera();if(1===this.State&&(this.OriginViewer=e.ConvertPointWorldToViewer(this.Circle.Origin[0],this.Circle.Origin[1]),this.State=2),8===this.State){var i=this.MouseOverWhichPart(t.Event);"object"==typeof i?(this.State=5,this.KeyPoint=i):3===i?this.State=3:1===i&&(this.OriginViewer=e.ConvertPointWorldToViewer(this.Circle.Origin[0],this.Circle.Origin[1]),this.State=4)}return!1},t.prototype.HandleMouseUp=function(t){if(this.State===i)return!0;2===this.State&&(this.SetActive(!1),this.Modified(),this.Layer.EventuallyDraw()),3!==this.State&&4!==this.State&&5!==this.State||(this.State=8,this.Modified(),this.Layer.EventuallyDraw(),this.KeyPoint=void 0);var e=t.Event;return 8===this.State&&3===e.which&&this.ShowPropertiesDialog(),!1},t.prototype.HandleMouseClick=function(){if(this.State===i)return!0;if(1===this.State||2===this.State){this.SetActive(!1),this.Modified();var t=new SAM.CircleWidget(this.Layer);return this.Layer.AddWidget(t),t.SetCreationCamera(this.Layer.GetCamera()),t.SetStateToDrawing(),!1}return!0},t.prototype.HandleMouseMove=function(t){if(this.State===i)return!0;var e=t.Event,o=this.Layer.MouseX,s=this.Layer.MouseY;if(7===this.State||8===this.State){var n=this.MouseOverWhichPart(t.Event);return void 0!==this.Circle.FillColor&&2===n?(this.State=8,this.Layer.GetParent().css({cursor:"move"}),!1):void 0!==this.Circle.FillColor&&2===n?(this.State=8,this.Layer.GetParent().css({cursor:"move"}),!1):1===n||3===n?(this.State=8,this.Layer.GetParent().css({cursor:"move"}),!1):"object"==typeof n&&"Radius"in n?(this.State=8,this.Layer.GetParent().css({cursor:"move"}),!1):(this.State=7,this.Layer.GetParent().css({cursor:""}),!0)}if(0===e.which&&(2===this.State||4===this.State||3===this.State||5===this.State))return this.HandleMouseUp(t);if(0===e.which&&7===this.State)return this.SetActive(this.CheckActive(e)),!1;var a=t.GetCamera();if(0===this.State&&(this.State=1),1!==this.State&&3!==this.State||(SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.SetOrigin(a.ConvertPointViewerToWorld(o,s)),t.EventuallyDraw()),4===this.State||2===this.State){var r=t.GetViewport();a=t.GetCamera();var h=o-this.OriginViewer[0],l=s-this.OriginViewer[1];this.Circle.Radius=Math.sqrt(h*h+l*l)*a.Height/r[3],this.Circle.UpdateBuffers(t.AnnotationView),SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),t.EventuallyDraw()}return 5===this.State&&(SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),this.KeyPoint.Origin=a.ConvertPointViewerToWorld(o,s),t.EventuallyDraw()),this.State===i&&this.CheckActive(e),!1},t.prototype.HandleTouchPan=function(t){if(this.State===i)return!0;var e=t.Event,o=t.GetCamera(),s=o.ConvertPointViewerToWorld(t.LastMouseX,t.LastMouseY),n=o.ConvertPointViewerToWorld(e.offsetX,e.offsetY),a=n[0]-s[0],r=n[1]-s[1];return this.Circle.Origin[0]+=a,this.Circle.Origin[1]+=r,t.EventuallyDraw(),!1},t.prototype.HandleTouchPinch=function(t){return this.State===i||(this.Circle.Radius*=t.PinchScale,this.Circle.UpdateBuffers(t.AnnotationView),SA&&SA.notesWidget&&SA.notesWidget.MarkAsModified(),t.EventuallyDraw(),!1)},t.prototype.HandleTouchEnd=function(t){return this.State===i||(this.SetActive(!1),!1)},t.prototype.HandleSelect=function(){if(0===this.State||1===this.State||9===this.State)return!1;var t=this.MouseOverWhichPart(this.Layer.Event);return void 0!==this.Circle.FillColor&&2===t?(this.Circle.SetSelectede(!0),this):1===t||3===t?(this.Circle.SetSelected(!0),this):"object"==typeof t?(this.Circle.SetSelected(!0),this):(this.Circle.SetSelected(!1),this.SetActive(!1),!1)},t.prototype.MouseOverWhichPart=function(t){var e,i,o,s,n,a,r,h,l=[t.offsetX,t.offsetY];for(s in this.Circle.Children)if("object"==typeof(o=this.Circle.Children[s])&&"Radius"in o&&(e=o.Origin,i=o.Radius,this.FixedSize||(e=(n=this.Layer.GetCamera()).ConvertPointWorldToViewer(e[0],e[1]),i=n.ConvertScaleWorldToViewer(i)),r=l[0]-e[0],h=l[1]-e[1],a=Math.sqrt(r*r+h*h),Math.abs(a)<i+this.Tolerance))return o;e=this.Circle.Origin,i=this.Circle.Radius;var d=this.Circle.LineWidth;return this.FixedSize||(e=(n=this.Layer.GetCamera()).ConvertPointWorldToViewer(e[0],e[1]),i=n.ConvertScaleWorldToViewer(i),d=n.ConvertScaleWorldToViewer(d)),r=l[0]-e[0],h=l[1]-e[1],a=Math.sqrt(r*r+h*h),Math.abs(a-i)<this.Tolerance+d?1:a<2*this.Tolerance+d?3:a<i?2:0},SAM.CircleWidget=t}(),function(){"use strict";function t(t,e){null!==t&&(this.Viewer=t,this.Viewer.AddWidget(this),this.Widgets=[],this.Active=!1)}t.prototype.Draw=function(t){for(var e=0;e<this.Widgets.length;++e)this.Widgets[e].Draw(t)},t.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},t.prototype.HandleKeyPress=function(t,e){for(var i=0;i<this.Widgets.length;++i){var o=this.Widgets[i];if(o.HandleKeyPress&&!o.HandleKeyPress(t,e))return!1}return!0},t.prototype.HandleMouseDown=function(t){if(1===t.which){for(var e=0;e<this.Widgets.length;++e){var i=this.Widgets[e];if(i.HandleMouseDown&&!i.HandleMouseDown(t))return!1}return!0}},t.prototype.HandleMouseUp=function(t){for(var e=0;e<this.Widgets.length;++e){var i=this.Widgets[e];return i.HandleMouseDown&&i.HandleMouseUp(t),!0}},t.prototype.HandleMouseMove=function(t){for(var e=0;e<this.Widgets.length;++e){var i=this.Widgets[e];if(i.HandleMouseMove&&!i.HandleMouseMove(t))return!1}return!0},t.prototype.CheckActive=function(t){for(var e=0;e<this.Widgets.length;++e){var i=this.Widgets[e];return i.CHeckActive&&i.CheckActive(t)?(this.Active=!0,!0):(this.Active=!1,!1)}},t.prototype.GetActive=function(){return this.Active},t.prototype.SetActive=function(t){alert("GroupWidget.SetActive not handled.")},SAM.GroupWidget=t}(),function(){"use strict";function t(t,o){if(null!==t){if(this.Viewer=t,this.Shape=new SAM.ImageAnnotation,this.Viewer.AddWidget(this),this.Viewer.AddShape(this.Shape),o)return this.State=e,void this.Viewer.ActivateWidget(this);this.State=i}}var e=1,i=3;t.prototype.Draw=function(t){this.Shape.Draw(t)},t.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},t.prototype.HandleKeyPress=function(t,e){return!1},t.prototype.HandleMouseDown=function(t){1===t.which&&(this.State===e&&(this.OriginViewer=this.Viewer.ConvertPointWorldToViewer(this.Shape.Origin[0],this.Shape.Origin[1]),this.State=i),4===this.State&&(this.State=e))},t.prototype.HandleMouseUp=function(t){4===this.State&&3===t.which||this.State===e&&this.SetActive(!1)},t.prototype.HandleMouseMove=function(t){var o=this.Viewer.MouseX,s=this.Viewer.MouseY;if(!1!==this.Viewer.MouseDown||4!==this.State){if(this.State===e){var n=this.Viewer.ConvertPointViewerToWorld(o,s);this.Shape.Origin[0]=n[0],this.Shape.Origin[1]=n[1],this.Viewer.EventuallyRender()}this.State===i&&this.CheckActive(t)}else this.CheckActive(t)},t.prototype.CheckActive=function(t){if(!this.FixedSize){var e=t.worldX-this.Shape.Origin[0],i=t.worldY-this.Shape.Origin[1],o=this.Viewer.GetCamera(),s=this.Viewer.GetViewport()[3]/o.Height;e*=s,i*=s;var n=!1;return Math.sqrt(e*e+i*i)<3&&(n=!0),this.SetActive(n),n}alert("Fixed size not implemented")},t.prototype.GetActive=function(){return this.State!==i},t.prototype.SetActive=function(t){t!==this.GetActive()&&(t?(this.State=4,this.Shape.Active=!0,this.Viewer.ActivateWidget(this),this.Viewer.EventuallyRender()):(this.State=i,this.Shape.Active=!1,this.Viewer.DeactivateWidget(this),this.Viewer.EventuallyRender()))},SAM.ImageWidget=t}(),function(){"use strict";function t(){this.Visibility=!0,this.Origin=[0,0],this.Image=void 0,this.Height=5e3}t.prototype.destructor=function(){},t.prototype.Draw=function(t){if(this.Visibility&&this.Image){var e=t.Context2d;e.save(),e.setTransform(1,0,0,1,0,0),e.transform(.5*t.Viewport[2],0,0,-.5*t.Viewport[3],.5*t.Viewport[2],.5*t.Viewport[3]);var i=t.Camera.GetWorldMatrix(),o=1/i[15];e.transform(i[0]*o,i[1]*o,i[4]*o,i[5]*o,i[12]*o,i[13]*o);var s=this.Height/this.Image.height;e.transform(s,0,0,s,this.Origin[0],this.Origin[1]),e.fillRect(100,100,500,300),e.restore()}},SAM.ImageAnnotation=t}(),function(){"use strict";function t(){SAM.Shape.call(this),this.Width=50,this.Height=50,this.Orientation=0,this.Origin=new Array(2),this.Origin.fill(1e4),this.OutlineColor=new Array(3),this.OutlineColor.fill(0),this.PointBuffer=[]}function e(e){if(null===e)return null;this.Layer=e,this.Type="rect",this.Visibility=!0,this.UserNoteFlag=!SA.Edit,this.StateChangeCallback=void 0,this.SelectedCallback=void 0,this.Tolerance=.05,SAM.detectMobile()&&(this.Tolerance=.1);var a=this.Layer.GetCamera(),r=this.Layer.GetViewport();if(this.Shape=new t,this.Shape.Orientation=a.GetImageRotation(),this.Shape.Origin.fill(0),this.Shape.SetOutlineColor([0,0,0]),s>0?(this.Shape.Height=n,this.Shape.Width=s):(this.Shape.Height=50*a.Height/r[3],this.Shape.Width=50*a.Height/r[3]),this.Shape.LineWidth=0,this.Shape.FixedSize=!1,this.CenterCircle=new SAM.Circle,this.CenterCircle.SetFillColor([1,1,0]),this.CenterCircle.SetOutlineColor([0,0,0]),this.CenterCircle.Radius=5,this.CenterCircle.LineWidth=1,this.CenterCircle.PositionCoordinateSystem=1,this.Rotatable=!0,this.RotateCircle=new SAM.Circle,this.RotateCircle.SetFillColor([1,1,0]),this.RotateCircle.SetOutlineColor([0,0,0]),this.RotateCircle.Radius=5,this.RotateCircle.LineWidth=1,this.RotateCircle.PositionCoordinateSystem=1,localStorage.RectWidgetDefaults){var h=JSON.parse(localStorage.RectWidgetDefaults);h.Color&&this.Shape.SetOutlineColor(h.Color)}if(i){var l=new SAM.Text;l.BackgroundFlag=!1,l.String=i,l.Position=this.Circle.Origin,this.Circle.Children.label=l}this.Layer.GetParent().css({cursor:"default"}),this.State=o,this.WhichDrag=0}var i,o=1,s=-1,n=-1;t.prototype=new SAM.Shape,t.prototype.destructor=function(){},t.prototype.UpdateBuffers=function(t){this.PointBuffer=[],this.Matrix=mat4.create(),mat4.identity(this.Matrix),mat4.rotateZ(this.Matrix,this.Orientation/180*3.14159),this.PointBuffer.push(1*this.Width/2),this.PointBuffer.push(1*this.Height/2),this.PointBuffer.push(0),this.PointBuffer.push(-1*this.Width/2),this.PointBuffer.push(1*this.Height/2),this.PointBuffer.push(0),this.PointBuffer.push(-1*this.Width/2),this.PointBuffer.push(-1*this.Height/2),this.PointBuffer.push(0),this.PointBuffer.push(1*this.Width/2),this.PointBuffer.push(-1*this.Height/2),this.PointBuffer.push(0),this.PointBuffer.push(1*this.Width/2),this.PointBuffer.push(1*this.Height/2),this.PointBuffer.push(0)},e.prototype.SetOrigin=function(t,e){this.Shape.Origin[0]=t,this.Shape.Origin[1]=e,this.Shape.Children.Label&&(this.Shape.Children.Label=this.Shape.Origin)},e.prototype.SetCreationCamera=function(t){this.CreationCamera=t.Serialize()},e.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},e.prototype.Modified=function(){this.ModifiedCallback&&this.ModifiedCallback(this)},e.prototype.SetSelectedCallback=function(t){this.SelectedCallback=t},e.prototype.SetStateChangeCallback=function(t){this.StateChangeCallback=t},e.prototype.StateChanged=function(){this.StateChangeCallback&&this.StateChangeCallback(this)},e.prototype.SetStateToDrawing=function(){this.State=0,this.Shape.Visibility=!1,this.Visibility=!1,this.Layer.GetParent().css({cursor:"move"})},e.prototype.DeleteSelected=function(){return this.Shape.DeleteSelected()},e.prototype.IsEmpty=function(){return 0===this.State||this.Shape.IsEmpty()},e.prototype.IsSelected=function(){return this.Shape.Selected},e.prototype.SetSelected=function(t){this.Shape.SetSelected(t),t&&this.SelectedCallback&&this.SelectedCallback(this),t||this.SetActive(!1)},e.prototype.ApplySelect=function(t){for(var e=this.GetCornerPoints(),i=[e[0][0],e[0][0],e[0][1],e[0][1]],o=1;o<4;++o)i[0]=Math.min(i[0],e[o][0]),i[1]=Math.max(i[1],e[o][0]),i[2]=Math.min(i[2],e[o][1]),i[3]=Math.max(i[3],e[o][1]);return t.ViewerPointInSelection(i[0],i[2])&&t.ViewerPointInSelection(i[0],i[3])&&t.ViewerPointInSelection(i[1],i[2])&&t.ViewerPointInSelection(i[1],i[3])?(this.SetSelected(!0),!0):(this.SetSelected(!1),!1)},e.prototype.GetTolerance=function(){var t=this.Shape.GetLineWidth(),e=20/this.Layer.GetPixelsPerUnit();return t<e&&(t=e),t},e.prototype.HandleSelect=function(){if(5!==this.State){var t=this.Layer.ZTime;return!(this.Shape.Origin.length>2&&this.Shape.Origin[2]!==t)&&(void 0!==this.PointOnWhichPart()?(this.SetSelected(!0),!0):(this.SetSelected(!1),!1))}},e.prototype.SetThreshold=function(t){void 0!==this.confidence&&(this.Visibility=this.confidence>=t)},e.prototype.Draw=function(){if(!1!==this.Visibility){var t=this.Layer.GetView();if(!(void 0!==this.Layer.ZTime&&this.Shape.Origin.length>2&&this.Layer.ZTime!==this.Shape.Origin[2])&&(this.Shape.Draw(t),this.State!==o&&0!==this.State&&4!==this.State)){var e=this.GetCornerPoints();this.CenterCircle.Origin=e[4],this.CenterCircle.Draw(t),this.Rotatable&&(this.RotateCircle.Origin=e[0],this.RotateCircle.Draw(t))}}},e.prototype.PasteCallback=function(t,e,i){this.Load(t),this.SetOrigin(i[0],i[1]),e.EventuallyDraw(),this.Modified()},e.prototype.Serialize=function(){if(void 0===this.Shape)return null;var t={type:"rectangle",center:this.Shape.Origin,width:this.Shape.Width,height:this.Shape.Height,rotation:this.Shape.GetOrientation(),lineWidth:this.Shape.LineWidth,lineColor:SAM.ConvertColorToHex(this.Shape.OutlineColor)};return 2===t.center.length&&t.center.push(0),this.Shape.Children.label&&this.Shape.Children.label.String&&(t.label={value:this.Shape.Children.label.String}),"UserImageUrl"in this.Shape&&(t.user={imageUrl:this.Shape.UserImageUrl}),t},e.prototype.Load=function(t){if(this.UserNoteFlag=t.user_note_flag,this.SetOrigin(parseFloat(t.center[0]),parseFloat(t.center[1])),t.center.length>2&&(this.Shape.Origin[2]=parseFloat(t.center[2])),t.lineColor&&(this.Shape.OutlineColor=SAM.ConvertColor(t.lineColor)),this.Shape.Width=parseFloat(t.width),t.confidence&&(this.confidence=parseFloat(t.confidence)),t.height&&(this.Shape.Height=parseFloat(t.height)),t.rotation&&(this.Shape.Orientation=parseFloat(t.rotation)),void 0!==t.lineWidth&&(this.Shape.LineWidth=parseFloat(t.lineWidth)),this.Shape.FixedSize=!1,this.Shape.UpdateBuffers(this.Layer.AnnotationView),void 0!==t.creation_camera&&(this.CreationCamera=t.CreationCamera),"label"in t){var e=t.label.value;if("test"!==e){var i=new SAM.Text;i.BackgroundFlag=!1,i.String=e,i.Position=this.Shape.Origin,this.Shape.Children.label=i}}if("user"in t){var o=t.user;if("imageUrl"in o){this.Shape.UserImageUrl=o.imageUrl,this.Shape.Image=new Image;var s=this;$(s.Shape.Image).one("load",function(){var t=s.Shape.Image.width,e=s.Shape.Image.height,i=$("<canvas width="+t+"  height="+e+">"),o=i[0].getContext("2d");o.drawImage(s.Shape.Image,0,0),o.beginPath(),o.lineWidth="100",o.strokeStyle="blue",o.arc(500,500,300,0,2*Math.PI),o.stroke(),o.clearRect(200,200,300,300),s.Shape.Image.src=i[0].toDataURL()}),this.Shape.Image.src=o.imageUrl}}},e.prototype.SetVisibility=function(t){this.Visibility=t,this.Layer.EventuallyDraw()},e.prototype.HandleKeyDown=function(t){if(86===t.Event.keyCode)return this.Visibility=!this.Visibility,t.EventuallyDraw(),!0;if(!this.Visibility||this.State===o)return!0;if(5===this.State)return!1;var e=t.Event;if(0===this.State&&(27===e.keyCode||32===e.keyCode||13===e.keyCode))return this.Modified(),this.Deactivate(),this.Layer.RemoveWidget(this),!1;if(67===e.keyCode&&e.ctrlKey){var i={Type:"RectWidget",Data:this.Serialize()};return localStorage.ClipBoard=JSON.stringify(i),!1}return!0},e.prototype.HandleMouseDown=function(t){return!this.Visibility||this.State===o||(0===this.State&&(this.WhichDrag=21),3===this.State&&(this.State=4,this.LastMouse=t.GetMouseWorld()),!1)},e.prototype.HandleMouseMove=function(t){if(this.State===o)return!0;var e=t.Event,i=this.LastMouseWorld,a=this.Layer.GetMouseWorld();void 0===i&&(i=a),this.LastMouseWorld=a;var r=a[0]-i[0],h=a[1]-i[1],l=a[0]-this.Shape.Origin[0],d=a[1]-this.Shape.Origin[1];if(0===e.which){if(0===this.State)return this.Shape.Visibility=!0,this.WhichDrag=64,this.Visibility=!0,this.SetOrigin(a[0],a[1]),this.Layer.EventuallyDraw(),!1;if(2===this.State||3===this.State){var u=this.PointOnWhichPart();if(void 0===u)return this.State=2,this.Layer.GetParent().css({cursor:""}),!1;if(this.State=3,0===u[0])switch(u[1]){case 0:this.Rotatable?(this.Layer.GetParent().css({cursor:"pointer"}),this.WhichDrag=128):(this.Layer.GetParent().css({cursor:"nw-resize"}),this.WhichDrag=5);break;case 1:this.Layer.GetParent().css({cursor:"ne-resize"}),this.WhichDrag=6;break;case 2:this.Layer.GetParent().css({cursor:"se-resize"}),this.WhichDrag=10;break;case 3:this.Layer.GetParent().css({cursor:"sw-resize"}),this.WhichDrag=9;break;case 4:this.Layer.GetParent().css({cursor:"move"}),this.WhichDrag=64}if(1===u[0])switch(u[1]){case 0:this.Layer.GetParent().css({cursor:"ns-resize"}),this.WhichDrag=4;break;case 1:this.Layer.GetParent().css({cursor:"ew-resize"}),this.WhichDrag=2;break;case 2:this.Layer.GetParent().css({cursor:"ns-resize"}),this.WhichDrag=8;break;case 3:this.Layer.GetParent().css({cursor:"ew-resize"}),this.WhichDrag=1}return!1}}if(1!==e.which)return!1;var p=this.Shape.GetRotation(),c=Math.cos(p),f=Math.sin(p);if(0===this.State||4===this.State){if(64&this.WhichDrag)return this.SetOrigin(a[0],a[1]),this.Layer.EventuallyDraw(),this.Modified(),!1;if(128&this.WhichDrag){var g=[-this.Shape.Width,-this.Shape.Height],v=Math.sqrt(g[0]*g[0]+g[1]*g[1]);g[0]=g[0]/v,g[1]=g[1]/v;var S=[l,d];return v=Math.sqrt(S[0]*S[0]+S[1]*S[1]),S[0]=S[0]/v,S[1]=S[1]/v,c=g[0]*S[0]+g[1]*S[1],f=g[0]*S[1]-g[1]*S[0],this.Shape.Orientation=180*-Math.atan2(f,c)/Math.PI,this.Layer.EventuallyDraw(),this.Modified(),!1}if(16&this.WhichDrag){var y=c*l-f*d,m=f*l+c*d;3&this.WhichDrag&&(this.Shape.Width=2*y),12&this.WhichDrag&&(this.Shape.Height=2*m)}else{var w=c*r-f*h,C=f*r+c*h;2&this.WhichDrag?this.Shape.Width+=w:1&this.WhichDrag?this.Shape.Width-=w:w=0,8&this.WhichDrag?this.Shape.Height+=C:4&this.WhichDrag?this.Shape.Height-=C:C=0,r=c*w+f*C,h=-f*w+c*C,this.SetOrigin(this.Shape.Origin[0]+r/2,this.Shape.Origin[1]+h/2)}}return s=this.Shape.Width,n=this.Shape.Height,this.Modified(),this.Shape.UpdateBuffers(),this.Layer.EventuallyDraw(),!1},e.prototype.HandleMouseUp=function(){return!this.Visibility||this.State===o||(0===this.State&&this.SetActive(!1),4===this.State&&(this.State=3),this.Shape.Width=Math.abs(this.Shape.Width),this.Shape.Height=Math.abs(this.Shape.Height),this.Layer.EventuallyDraw(),!1)},e.prototype.HandleMouseClick=function(){return!this.Visibility||this.State===o||(0!==this.State||(this.SetActive(!1),this.Modified(),!1))},e.prototype.GetActive=function(){return this.State!==o},e.prototype.SetActive=function(t){t!==this.GetActive()&&(this.State=t?2:o,this.StateChanged(),this.Layer.EventuallyDraw())},e.prototype.ShowPropertiesDialog=function(){void 0===this.Dialog&&this.InitPropertiesDialog(),this.WidgetPropertiesToDialog();var t=this;this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.SetCloseCallback(function(){t.DialogCloseCallback()}),this.Dialog.Show(!0),this.State=5},e.prototype.DialogApplyCallback=function(){this.DialogPropertiesToWidget(),this.SetActive(!1,this.Layer),this.Layer.EventuallyDraw()},e.prototype.DialogCloseCallback=function(){this.SetActive(!1),this.Layer.EventuallyDraw()},e.prototype.WidgetPropertiesToDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Shape.OutlineColor)),this.Dialog.LineWidthInput.val(this.Shape.LineWidth.toFixed(2));var t="";this.Shape.Children.label&&this.Shape.Children.label.String&&(t=this.Shape.Children.label.String),this.Dialog.LabelInput.val(t);var e=this.Shape.Width*this.Shape.Height,i="";this.Shape.FixedSize?(i+=e.toFixed(2),i+=" pixels^2"):e>1e6?(i+=(e/1e6).toFixed(2),i+=" mm^2"):(i+=e.toFixed(2),i+=" um^2"),this.Dialog.Area.text(i)},e.prototype.DialogPropertiesToWidget=function(){var t=!0,e=this.Dialog.ColorInput.val();this.Shape.SetOutlineColor(e),this.Shape.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Shape.UpdateBuffers(this.Layer.AnnotationView);var o=this.Dialog.LabelInput.val();if(""===(o=o.trim()))i=void 0,delete this.Shape.Children.label;else{if(!this.Shape.Children.label){var s=new SAM.Text;s.BackgroundFlag=!1,s.String=o,s.Position=this.Shape.Origin,this.Shape.Children.label=s,i=o}this.Shape.Children.label.String=o,t=!0}t&&(localStorage.RectWidgetDefaults=JSON.stringify({Color:e,Width:this.Shape.LineWidth}),this.Modified(),this.Shape.UpdateBuffers(this.Layer.AnnotationView))},e.prototype.GetCornerPoints=function(){var t,e,i=this.Layer.GetCamera(),o=this.Shape.GetRotation(),s=Math.cos(o),n=Math.sin(o),a=this.Shape.Origin,r=this.Shape.Width/2,h=this.Shape.Height/2;t=s*r+n*h,e=-n*r+s*h;var l=[a[0]-t,a[1]-e];l=i.ConvertPointWorldToViewer(l[0],l[1]);var d=[a[0]+t,a[1]+e];d=i.ConvertPointWorldToViewer(d[0],d[1]),t=s*(r=-r)+n*h,e=-n*r+s*h;var u=[a[0]-t,a[1]-e];u=i.ConvertPointWorldToViewer(u[0],u[1]);var p=[a[0]+t,a[1]+e];return[l,u,d,p=i.ConvertPointWorldToViewer(p[0],p[1]),[.5*(l[0]+d[0]),.5*(l[1]+d[1])]]},e.prototype.PointOnWhichPart=function(){for(var t,e,i=this.Layer.Event,o=i.offsetX,s=i.offsetY,n=this.Shape.LineWidth+3,a=(n+2)*(n+2),r=this.GetCornerPoints(),h=0;h<5;++h){var l=r[h];if(t=o-l[0],e=s-l[1],t*t+e*e<a)return[0,h]}var d=r[3];for(h=0;h<4;++h){var u=r[h];if(void 0!==this.Shape.IntersectPointLine([o,s],d,u,n))return[1,(h+3)%4];d=u}},e.prototype.InitPropertiesDialog=function(){var t=this;this.Dialog=new SAM.Dialog(this.Layer.GetParent().parent()),this.Dialog.SetApplyCallback(function(){t.DialogApplyCallback()}),this.Dialog.Title.text("Rect Annotation Editor"),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Dialog.LabelDiv=$("<div>").appendTo(this.Dialog.Body).addClass("sa-view-annotation-modal-div"),this.Dialog.LabelLabel=$("<div>").appendTo(this.Dialog.LabelDiv).text("Label:").addClass("sa-view-annotation-modal-input-label"),this.Dialog.LabelInput=$('<input type="text">').appendTo(this.Dialog.LabelDiv).addClass("sa-view-annotation-modal-input").keypress(function(t){return 13!==t.keyCode}),this.Dialog.AreaDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.AreaLabel=$("<div>").appendTo(this.Dialog.AreaDiv).text("Area:").css({display:"table-cell","text-align":"left"}),this.Dialog.Area=$("<div>").appendTo(this.Dialog.AreaDiv).css({display:"table-cell"}),this.Dialog.BoundsDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BoundsLabel=$("<div>").appendTo(this.Dialog.BoundsDiv).text("Bounds:").css({display:"table-cell","text-align":"left"}),this.Dialog.Bounds=$("<div>").appendTo(this.Dialog.BoundsDiv).css({display:"table-cell"})},SAM.Rect=t,SAM.RectWidget=e}(),function(){"use strict";function t(t){this.Layer=t,SAM.Shape.call(this),this.State=e,this.Point1=void 0,this.Point2=void 0,this.Rectangle=$("<div>").css({position:"absolute",border:"1px dashed #FF0"}).hide(),this.FinishCallback=void 0,this.Camera=new SAM.Camera}var e=0;t.prototype.SetFinishCallback=function(t){this.FinishCallback=t},t.prototype.SetStateToDrawing=function(){this.State=1,this.Layer.GetParent().css({cursor:"nw-resize"})},t.prototype.IsEmpty=function(){return!0},t.prototype.SetActive=function(t){t||this.State===e||(this.State=e,this.Layer.GetParent().css({cursor:""})),t&&this.State===e&&(this.State=1,this.Layer.GetParent().css({cursor:"nw-resize"}))},t.prototype.Draw=function(){if(2===this.State){var t=Math.min(this.Point1[0],this.Point2[0]),e=Math.min(this.Point1[1],this.Point2[1]),i=Math.abs(this.Point1[0]-this.Point2[0]),o=Math.abs(this.Point1[1]-this.Point2[1]);this.Rectangle.css({left:t.toString()+"px",top:e.toString()+"px",width:i.toString()+"px",height:o.toString()+"px"}).show()}},t.prototype.HandleMouseDown=function(){if(1!==this.State)return!0;this.State=2,this.Rectangle.appendTo(this.Layer.GetParent());var t=this.Layer.Event,e=t.offsetX,i=t.offsetY;return this.Point1=[e,i],this.Point2=[e,i],this.Draw(),!1},t.prototype.HandleMouseMove=function(){if(2!==this.State)return!0;var t=this.Layer.Event,e=t.offsetX,i=t.offsetY;return this.Point2=[e,i],this.Draw(),!1},t.prototype.HandleMouseUp=function(){if(2!==this.State)return!0;this.State=3,this.Layer.GetParent().css({cursor:""}),this.Rectangle.hide().remove();var t=Math.min(this.Point1[0],this.Point2[0]),e=Math.min(this.Point1[1],this.Point2[1]),i=Math.max(this.Point1[0],this.Point2[0]),o=Math.max(this.Point1[1],this.Point2[1]);return this.Point1=[t,e],this.Point2=[i,o],this.Camera.DeepCopy(this.Layer.GetCamera()),this.FinishCallback&&this.FinishCallback(this),!1},t.prototype.ViewerPointInSelection=function(t,e){return t>this.Point1[0]&&t<this.Point2[0]&&e>this.Point1[1]&&e<this.Point2[1]},t.prototype.WorldPointInSelection=function(t,e){var i=this.Camera.ConvertPointWorldToViewer(t,e);return this.ViewerPointInSelection(i[0],i[1])},SAM.RectSelectWidget=t}(),function(){"use strict";function t(){this.Scale=1,this.Centers=[],this.Widths=[],this.Heights=[],this.Labels=[],this.Confidences=[],this.Vectors=[],this.Visibilities=void 0,this.Threshold=0,this.Metadata=[],this.ActiveIndex=-1}function e(e,i){this.Visibility=!0,this.UserNoteFlag=!SA.Edit,null!==e&&(this.Shape=new t,e&&e.AddWidget(this),this.Active=!1)}t.prototype.GetLength=function(){return this.Widths.length},t.prototype.GetCenter=function(t){return t<<=1,[this.Centers[t],this.Centers[t+1]]},t.prototype.SetCenter=function(t,e){t*=2,this.Centers[t]=e[0],this.Centers[t+1]=e[1]},t.prototype.SetShape=function(t){for(var e=0;e<this.Widths.length;++e)this.Widths[e]=t[0],this.Heights[e]=t[1]},t.prototype.SetScale=function(t){var e=t/this.Scale;this.Scale=t;for(var i=0;i<this.Widths.length;++i)this.Widths[i]*=e,this.Heights[i]*=e},t.prototype.SetMetadata=function(t,e){this.Metadata[t]=e},t.prototype.GetMetadata=function(t){return this.Metadata[t]},t.prototype.CopyRectangle=function(t,e,i){void 0===i&&(i=this.Labels.length);var o=2*e,s=2*i;this.Centers[s]=t.Centers[o],this.Centers[s+1]=t.Centers[o+1],this.Widths[i]=t.Widths[e],this.Heights[i]=t.Heights[e],this.Labels[i]=t.Labels[e],this.Confidences[i]=t.Confidences[e],this.Metadata[i]=t.Metadata[e]},t.prototype.AddRectangle=function(t,e,i){var o=this.Labels.length;return this.Centers[2*o]=t[0],this.Centers[2*o+1]=t[1],this.Widths[o]=e,this.Heights[o]=i,this.Labels[o]="",this.Confidences[o]=1,this.Metadata[o]={},this.Widths.length-1},t.prototype.DeleteRectangle=function(t){t<0||t>=this.Widths.length||(this.Centers.splice(2*t,2),this.Widths.splice(t,1),this.Heights.splice(t,1),this.Labels.splice(t,1),this.Confidences.splice(t,1),this.Metadata.splice(t,1),this.ActiveIndex===t&&(this.ActiveIndex=-1))},t.prototype.SetOutlineColor=function(t){this.Color=SAM.ConvertColorToHex(t)},t.prototype.Draw=function(t){t.Context2d.save();var e=t.GetCamera(),i=e.GetImageToViewerTransform();t.Context2d.setTransform(i[0],i[1],i[2],i[3],i[4],i[5]);var o,s,n,a,r=e.ConvertScaleViewerToImage(1),h=0;t.Context2d.beginPath();for(var l=0;l<this.Vectors.length;++l)(!this.Visibilities||this.Visibilities[l])&&this.Confidences[l]>=this.Threshold?(n=this.Vectors[h],o=this.Centers[h++],a=this.Vectors[h],s=this.Centers[h++],t.Context2d.moveTo(o,s),t.Context2d.lineTo(o+n,s+a)):h+=2;for(t.Context2d.strokeStyle="#ff00ff",t.Context2d.lineWidth=3*r,t.Context2d.stroke(),h=0,t.Context2d.lineWidth=2*r,l=0;l<this.Widths.length;++l)if((!this.Visibilities||this.Visibilities[l])&&this.Confidences[l]>=this.Threshold){var d=this.Widths[l]/2,u=this.Heights[l]/2;if(o=this.Centers[h++],s=this.Centers[h++],t.Context2d.beginPath(),this.LabelColors&&this.LabelColors[this.Labels[l]])t.Context2d.strokeStyle=this.LabelColors[this.Labels[l]];else if(this.Color)t.Context2d.strokeStyle=this.Color;else if(0===this.Confidences[l])t.Context2d.strokeStyle="#ff0000";else{var p=Math.floor(255*this.Confidences[l]);t.Context2d.strokeStyle="#"+p.toString(16)+"ff00"}t.Context2d.moveTo(o-d,s-u),t.Context2d.lineTo(o+d,s-u),t.Context2d.lineTo(o+d,s+u),t.Context2d.lineTo(o-d,s+u),t.Context2d.lineTo(o-d,s-u),t.Context2d.stroke(),l===this.ActiveIndex&&(t.Context2d.beginPath(),t.Context2d.strokeStyle="#00ffff",t.Context2d.moveTo(o-d,s),t.Context2d.lineTo(o-d/2,s),t.Context2d.moveTo(o+d,s),t.Context2d.lineTo(o+d/2,s),t.Context2d.moveTo(o,s-u),t.Context2d.lineTo(o,s-u/2),t.Context2d.moveTo(o,s+u),t.Context2d.lineTo(o,s+u/2),t.Context2d.stroke())}else h+=2;t.Context2d.restore()},e.prototype.GetLength=function(){return this.Shape.Widths.length},e.prototype.IsEmpty=function(){return 0===this.GetLength()},e.prototype.ComputeVisibilities=function(t){var e=this.Shape;if(void 0===e.Visibilities){e.Visibilities=Array(e.Confidences.length),e.Hash=new SAM.SpatialHash;var i=t.GetViewer().GetOverViewBounds();e.Hash.Build(e,i)}var o=e.Visibilities;o.fill(!0);for(var s=0;s<o.length;++s)if(!0===o[s]&&e.Confidences[s]>=e.Threshold)for(var n=e.Widths[s],a=e.Heights[s],r=n*a,h=e.GetCenter(s),l=e.Hash.GetOverlapping(h,n,a,.3),d=0;d<l.length;++d){var u=l[d];u!==s&&o[u]&&e.Confidences[u]>=e.Threshold&&(r<e.Widths[u]*e.Heights[u]?o[s]=!1:o[u]=!1)}},e.prototype.ComputeVisibilitiesConfidence=function(t){var e=this.Shape;if(void 0===e.Visibilities){e.Visibilities=Array(e.Confidences.length),e.Hash=new SAM.SpatialHash;var i=t.GetViewer().GetOverViewBounds();e.Hash.Build(e,i)}var o=e.Visibilities;o.fill(!1);for(var s=0;s<o.length;++s)if(!1===o[s]&&e.Confidences[s]>=e.Threshold){for(var n=e.Widths[s],a=e.Heights[s],r=e.GetCenter(s),h=e.Hash.GetOverlapping(r,n,a,.3),l=!0,d=0;d<h.length;++d){var u=h[d];u<s&&o[u]&&(l=!1)}o[s]=l}},t.prototype.ChangeDetectionVisibilities=function(t,e,i){for(var o=t.Visibilities,s=e.Visibilities,n=0;n<o.length;++n)if(o[n])for(var a=t.GetCenter(n),r=t.Widths[n],h=t.Widths[n],l=e.Hash.GetOverlapping(a,r,h,.3),d=0;d<l.length;++d)s[l[d]]=!1,o[n]=!1},e.prototype.Sort=function(t){var e=new Array(this.Confidences.length),i=1;t&&(i=-1);for(var o=0;o<e.length;++o)e[o]={conf:i*this.Confidences[o],idx:o};e.sort(function(t,e){return t.conf>e.conf?1:t.conf<e.conf?-1:0});var s=new Array(this.Confidences.length),n=new Array(this.Centers.length),a=new Array(this.Centers.length),r=new Array(this.Metadata.length);for(o=0;o<s.length;++o){var h=e[o].idx;a[o]=this.Labels[h],r[o]=this.Metadata[h],s[o]=this.Confidences[h],h*=2,n[2*o]=this.Centers[h],n[2*o+1]=this.Centers[h+1]}this.Centers=n,this.Confidences=s,this.Labels=a,this.Metadata=r},e.prototype.SetThreshold=function(t){this.Shape.Threshold=t},e.prototype.Draw=function(t){this.Visibility&&this.Shape.Draw(t.GetView())},e.prototype.Serialize=function(){if(void 0===this.Shape)return null;var t={type:"rect_set"};void 0!==this.UserNoteFlag&&(t.user_note_flag=this.UserNoteFlag),this.Shape.Color&&(t.color=SAM.ConvertColor(this.Shape.Color)),this.Label&&(t.label=this.Label);var e=this.Shape.Widths.length;t.confidences=new Array(e),t.widths=new Array(e),t.heights=new Array(e),t.labels=new Array(e),t.metadata=new Array(e),t.centers=new Array(2*e);for(var i=0;i<e;++i)t.widths[i]=this.Shape.Widths[i],t.heights[i]=this.Shape.Heights[i],t.confidences[i]=this.Shape.Confidences[i],t.centers[i]=this.Shape.Centers[i],t.centers[i+e]=this.Shape.Centers[i+e],t.labels[i]=this.Shape.Labels[i],t.metadata[i]=this.Shape.Metadata[i];return t},e.prototype.Load=function(t){this.UserNoteFlag=t.user_note_flag,t.label&&(this.Label=t.label),t.color&&(this.Shape.Color=[parseFloat(t.color[0]),parseFloat(t.color[1]),parseFloat(t.color[2])]);var e=t.widths.length;this.Shape.Confidences=new Array(e),this.Shape.Labels=new Array(e),this.Shape.Widths=new Array(e),this.Shape.Heights=new Array(e),this.Shape.Centers=new Array(2*e),t.vectors&&(this.Shape.Vectors=new Array(2*e)),this.Shape.Metadata=new Array(e);for(var i=0;i<e;++i)this.Shape.Widths[i]=parseFloat(t.widths[i]),this.Shape.Heights[i]=parseFloat(t.heights[i]),this.Shape.Confidences[i]=parseFloat(t.confidences[i]),t.labels?this.Shape.Labels[i]=t.labels[i]:this.Shape.Labels[i]="",t.metadata?this.Shape.Metadata[i]=t.metadata[i]:this.Shape.Metadata[i]={},this.Shape.Centers[i]=parseFloat(t.centers[i]),this.Shape.Centers[i+e]=parseFloat(t.centers[i+e]),t.vectors&&(this.Shape.Vectors[i]=parseFloat(t.vectors[i]),this.Shape.Vectors[i+e]=parseFloat(t.vectors[i+e]))},e.prototype.HandleDoubleClick=function(t){return!0},e.prototype.HandleMouseUp=function(t){return!0},e.prototype.HandleMouseMove=function(t){return!0},e.prototype.HandleMouseWheel=function(t){return!0},e.prototype.HandleTouchPan=function(t){return!0},e.prototype.HandleTouchPinch=function(t){return!0},e.prototype.HandleTouchEnd=function(t){return!0},e.prototype.CheckActive=function(t){return this.Active},e.prototype.GetActive=function(){return this.Active},e.prototype.SetActive=function(t,e){this.Visibility||(this.Visibility=!0),t!==this.GetActive()&&(this.Active=t,e.EventuallyDraw())},e.prototype.RemoveFromLayer=function(t){t&&t.RemoveWidget(this),t=null},e.prototype.Deactivate=function(t){},e.prototype.PlacePopup=function(t){},e.prototype.ShowPropertiesDialog=function(t){},SAM.RectSetWidget=e,SAM.RectSet=t}(),function(){"use strict";function t(){SAM.Shape.call(this),this.BinWidth=20,this.BinHeight=20,this.Dimensions=[10,8],this.Orientation=0,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.PointBuffer=[],this.ActiveIndex=void 0}function e(e,o){this.UserNoteFlag=!SA.Edit;var s=this;if(this.Dialog=new SAM.Dialog(function(){s.DialogApplyCallback()}),this.Dialog.Title.text("Grid Annotation Editor"),this.Dialog.BinWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BinWidthLabel=$("<div>").appendTo(this.Dialog.BinWidthDiv).text("Bin Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.BinWidthInput=$("<input>").appendTo(this.Dialog.BinWidthDiv).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Dialog.BinHeightDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.BinHeightLabel=$("<div>").appendTo(this.Dialog.BinHeightDiv).text("Bin Height:").css({display:"table-cell","text-align":"left"}),this.Dialog.BinHeightInput=$("<input>").appendTo(this.Dialog.BinHeightDiv).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Dialog.RotationDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.RotationLabel=$("<div>").appendTo(this.Dialog.RotationDiv).text("Rotation:").css({display:"table-cell","text-align":"left"}),this.Dialog.RotationInput=$("<input>").appendTo(this.Dialog.RotationDiv).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Dialog.ColorDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.ColorLabel=$("<div>").appendTo(this.Dialog.ColorDiv).text("Color:").css({display:"table-cell","text-align":"left"}),this.Dialog.ColorInput=$('<input type="color">').appendTo(this.Dialog.ColorDiv).val("#30ff00").css({display:"table-cell"}),this.Dialog.LineWidthDiv=$("<div>").appendTo(this.Dialog.Body).css({display:"table-row"}),this.Dialog.LineWidthLabel=$("<div>").appendTo(this.Dialog.LineWidthDiv).text("Line Width:").css({display:"table-cell","text-align":"left"}),this.Dialog.LineWidthInput=$('<input type="number">').appendTo(this.Dialog.LineWidthDiv).css({display:"table-cell"}).keypress(function(t){return 13!==t.keyCode}),this.Tolerance=.05,SAM.MOBILE_DEVICE&&(this.Tolerance=.1),null!==e){this.CreationCamera=e.GetCamera().Serialize(),this.Layer=e,this.Popup=new SAM.WidgetPopup(this);var n=e.AnnotationView.Camera,a=e.AnnotationView.Viewport;this.Grid=new t,this.Grid.Origin=[0,0],this.Grid.OutlineColor=[0,0,0],this.Grid.SetOutlineColor("#0A0F7A"),e.ScaleWidget?this.Grid.BinWidth=e.ScaleWidget.LengthWorld:this.Grid.BinWidth=30*n.Height/a[3],this.Grid.BinHeight=this.Grid.BinWidth,this.Grid.LineWidth=2*n.Height/a[3],this.Grid.FixedSize=!1;var r=.8*a[2]/e.GetPixelsPerUnit();this.Grid.Dimensions[0]=Math.floor(r/this.Grid.BinWidth);var h=.8*a[3]/e.GetPixelsPerUnit();if(this.Grid.Dimensions[1]=Math.floor(h/this.Grid.BinHeight),this.Grid.UpdateBuffers(this.Layer.AnnotationView),this.Text=new SAM.Text,this.Text.Position=this.Grid.Origin,this.Text.String=SAM.DistanceToString(2.5e-7*this.Grid.BinWidth),this.Text.Color=[0,0,.5],this.Text.Anchor=[0,0],this.Text.UpdateBuffers(this.Layer.AnnotationView),localStorage.GridWidgetDefaults){var l=JSON.parse(localStorage.GridWidgetDefaults);l.Color&&(this.Dialog.ColorInput.val(SAM.ConvertColorToHex(l.Color)),this.Grid.SetOutlineColor(this.Dialog.ColorInput.val())),void 0!==l.LineWidth&&(this.Dialog.LineWidthInput.val(l.LineWidth),this.Grid.LineWidth=l.LineWidth)}this.Layer.AddWidget(this),this.State=i}}var i=3;t.prototype=new SAM.Shape,t.prototype.UpdateBuffers=function(t){if(this.PointBuffer=[],this.Matrix=mat4.create(),mat4.identity(this.Matrix),!(this.Dimensions[0]<1||this.Dimensions[1]<1||this.BinWidth<=0||this.BinHeight<=0)){var e=this.BinWidth*this.Dimensions[0],i=this.BinHeight*this.Dimensions[1],o=e/2,s=i/2,n=this.Dimensions[1]%2?0:e,a=0;this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0);for(var r=0;r<this.Dimensions[1];++r)n=n?0:e,this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0),a+=this.BinHeight,this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0);for(n=n?0:e,this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0),r=0;r<this.Dimensions[0];++r)a=a?0:i,this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0),n+=this.BinWidth,this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0);a=a?0:i,this.PointBuffer.push(n-o),this.PointBuffer.push(a-s),this.PointBuffer.push(0)}},e.prototype.ComputeCorner=function(t,e,i,o){var s=this.Grid.BinWidth*this.Grid.Dimensions[0]/2,n=this.Grid.BinHeight*this.Grid.Dimensions[1]/2;s+=i,n+=o;var a=this.Grid.Origin[0],r=this.Grid.Origin[1],h=(this.Layer.GetCamera().GetImageRotation()-this.Grid.Orientation)/90;h=((h=Math.round(h))%4+4)%4;var l,d,u=Math.cos(3.14156*this.Grid.Orientation/180),p=Math.sin(3.14156*this.Grid.Orientation/180);return 0===h?(l=t*s,d=e*n):3===h?(l=t*s,d=-e*n):2===h?(l=-t*s,d=-e*n):1===h&&(l=-t*s,d=e*n),a=a+u*l+p*d,r=r+u*d-p*l,[a,r]},e.prototype.Draw=function(t){this.Grid.Draw(t);var e=-this.Grid.BinWidth*this.Grid.Dimensions[0]/2,i=-this.Grid.BinHeight*this.Grid.Dimensions[1]/2;this.Text.Anchor=[0,20],this.Text.Orientation=this.Grid.Orientation-this.Layer.GetCamera().GetImageRotation(),this.Text.Orientation=(this.Text.Orientation%360+360)%360,this.Text.Orientation>90&&this.Text.Orientation<270&&(this.Text.Orientation-=180,this.Text.Anchor=[this.Text.PixelBounds[1],0]);var o=this.Grid.Orientation*Math.PI/180,s=Math.cos(o),n=Math.sin(o),a=s*e+n*i,r=s*i-n*e;this.Text.Position=[this.Grid.Origin[0]+a,this.Grid.Origin[1]+r],this.Text.Draw(t)},e.prototype.PasteCallback=function(t,e,i){this.Load(t);var o=this.Layer.GetCamera().GetImageRotation()-i.GetImageRotation();this.Grid.Orientation+=o,this.Grid.Origin=[e[0],e[1]],this.Text.Position=[e[0],e[1]],this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.Layer.EventuallyDraw()},e.prototype.Serialize=function(){if(void 0===this.Grid)return null;var t={};return t.type="grid",t.user_note_flag=this.UserNoteFlag,t.origin=this.Grid.Origin,t.lineColor=SAM.ConvertColorToHex(this.Grid.OutlineColor),t.bin_width=this.Grid.BinWidth,t.bin_height=this.Grid.BinHeight,t.dimensions=this.Grid.Dimensions,t.orientation=this.Grid.Orientation,t.lineWidth=this.Grid.LineWidth,t.creation_camera=this.CreationCamera,t},e.prototype.Load=function(t){this.UserNoteFlag=t.user_note_flag,this.Grid.Origin[0]=parseFloat(t.origin[0]),this.Grid.Origin[1]=parseFloat(t.origin[1]),this.Grid.OutlineColor=SAM.CovertColor(t.lineColor),t.width&&(this.Grid.BinWidth=parseFloat(t.width)),t.height&&(this.Grid.BinHeight=parseFloat(t.height)),t.bin_width&&(this.Grid.BinWidth=parseFloat(t.bin_width)),t.bin_height&&(this.Grid.BinHeight=parseFloat(t.bin_height)),this.Grid.Dimensions[0]=parseInt(t.dimensions[0]),this.Grid.Dimensions[1]=parseInt(t.dimensions[1]),this.Grid.Orientation=parseFloat(t.orientation),this.Grid.LineWidth=parseFloat(t.lineWidth),this.Grid.FixedSize=!1,this.Grid.UpdateBuffers(this.Layer.AnnotationView),this.Text.String=SAM.DistanceToString(2.5e-7*this.Grid.BinWidth),this.Text.Position=this.Grid.Origin,this.Text.UpdateBuffers(this.Layer.AnnotationView),void 0!==t.creation_camera&&(this.CreationCamera=t.CreationCamera)},e.prototype.HandleKeyPress=function(t,e){if(5===this.State)return!1;if(67===event.keyCode&&event.ctrlKey){var i={Type:"GridWidget",Data:this.Serialize(),Camera:this.Layer.GetCamera().Serialize()};return localStorage.ClipBoard=JSON.stringify(i),!1}return!0},e.prototype.HandleDoubleClick=function(t){return!0},e.prototype.HandleMouseDown=function(t){if(1!==t.which)return!0;var e=this.Layer.GetCamera();return this.DragLast=e.ConvertPointViewerToWorld(t.offsetX,t.offsetY),!1},e.prototype.HandleMouseUp=function(t){return this.SetActive(!1),window.SA&&SA.RecordState(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),!0},e.prototype.HandleMouseMove=function(t){if(1!==t.which)return 0===t.which&&this.SetActive(this.CheckActive(t)),!0;var e,i,o=this.Layer.GetCamera().ConvertPointViewerToWorld(t.offsetX,t.offsetY);if(6===this.State)e=o[0]-this.DragLast[0],i=o[1]-this.DragLast[1],this.DragLast=o,this.Grid.Origin[0]+=e,this.Grid.Origin[1]+=i;else{e=o[0]-this.Grid.Origin[0],i=o[1]-this.Grid.Origin[1];var s=Math.cos(3.14156*this.Grid.Orientation/180),n=Math.sin(3.14156*this.Grid.Orientation/180),a=s*e-n*i,r=s*i+n*e;a=.5*this.Grid.Dimensions[0]+a/this.Grid.BinWidth,r=.5*this.Grid.Dimensions[1]+r/this.Grid.BinHeight;var h=Math.round(a),l=Math.round(r);e=i=0;var d=!1;8===this.State?(e=h-this.Grid.Dimensions[0])&&(this.Grid.Dimensions[0]=h,e=.5*e*this.Grid.BinWidth,d=!0):7===this.State?h&&(this.Grid.Dimensions[0]-=h,e=.5*h*this.Grid.BinWidth,d=!0):10===this.State?(i=l-this.Grid.Dimensions[1])&&(this.Grid.Dimensions[1]=l,i=.5*i*this.Grid.BinHeight,d=!0):9===this.State&&l&&(this.Grid.Dimensions[1]-=l,i=.5*l*this.Grid.BinHeight,d=!0),d&&(a=s*e+n*i,r=s*i-n*e,this.Grid.Origin[0]+=a,this.Grid.Origin[1]+=r,this.Grid.UpdateBuffers(this.Layer.AnnotationView))}this.Layer.EventuallyDraw()},e.prototype.HandleMouseWheel=function(t){},e.prototype.HandleTouchPan=function(t){return!0},e.prototype.HandleTouchPinch=function(t){return!0},e.prototype.HandleTouchEnd=function(t){this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),this.SetActive(!1)},e.prototype.CheckActive=function(t){var e,i;this.Grid.FixedSize?(e=t.offsetX,i=t.offsetY):(e=t.worldX,i=t.worldY),e-=this.Grid.Origin[0],i-=this.Grid.Origin[1];var o=Math.cos(3.14156*this.Grid.Orientation/180),s=Math.sin(3.14156*this.Grid.Orientation/180),n=o*e-s*i,a=o*i+s*e;e=.5*this.Grid.Dimensions[0]+n/this.Grid.BinWidth,i=.5*this.Grid.Dimensions[1]+a/this.Grid.BinHeight;var r=Math.round(e),h=Math.round(i);if(r<0||r>this.Grid.Dimensions[0]||h<0||h>this.Grid.Dimensions[1])return this.SetActive(!1),!1;e=(e-r)*this.Grid.BinWidth,i=(i-h)*this.Grid.BinHeight;var l=5/this.Layer.GetPixelsPerUnit();return(Math.abs(e)<l||Math.abs(i)<l)&&(this.ActiveIndex=[r,h],!0)},e.prototype.GetActive=function(){return this.State!==i},e.prototype.Deactivate=function(){this.Layer.AnnotationView.Parent.css({cursor:"default"}),this.Popup.StartHideTimer(),this.State=i,this.Grid.Active=!1,this.Layer.DeactivateWidget(this),this.DeactivateCallback&&this.DeactivateCallback(),this.Layer.EventuallyDraw()},e.prototype.SetActive=function(t){if(t){if(this.State=4,this.Grid.Active=!0,!this.ActiveIndex)return void console.log("No active index");0===this.ActiveIndex[0]?(this.State=7,this.Layer.AnnotationView.Parent.css({cursor:"col-resize"})):this.ActiveIndex[0]===this.Grid.Dimensions[0]?(this.State=8,this.Layer.AnnotationView.Parent.css({cursor:"col-resize"})):0===this.ActiveIndex[1]?(this.State=9,this.Layer.AnnotationView.Parent.css({cursor:"row-resize"})):this.ActiveIndex[1]===this.Grid.Dimensions[1]?(this.State=10,this.Layer.AnnotationView.Parent.css({cursor:"row-resize"})):(this.State=6,this.Layer.AnnotationView.Parent.css({cursor:"move"})),this.PlacePopup()}else this.Deactivate();this.Layer.EventuallyDraw()},e.prototype.PlacePopup=function(){var t=this.ComputeCorner(1,-1,0,0);t=this.Layer.GetCamera().ConvertPointWorldToViewer(t[0],t[1]),this.Popup.Show(t[0]+10,t[1]-30)},e.prototype.ShowPropertiesDialog=function(){this.Dialog.ColorInput.val(SAM.ConvertColorToHex(this.Grid.OutlineColor)),this.Dialog.LineWidthInput.val(this.Grid.LineWidth.toFixed(2)),this.Dialog.BinWidthInput.val(SAM.DistanceToString(2.5e-7*this.Grid.BinWidth)),this.Dialog.BinHeightInput.val(SAM.DistanceToString(2.5e-7*this.Grid.BinHeight)),this.Dialog.RotationInput.val(this.Grid.Orientation),this.Dialog.Show(!0)},e.prototype.DialogApplyCallback=function(){var t=this.Dialog.ColorInput.val();this.Grid.SetOutlineColor(t),this.Grid.LineWidth=parseFloat(this.Dialog.LineWidthInput.val()),this.Grid.BinWidth=4e6*SAM.StringToDistance(this.Dialog.BinWidthInput.val()),this.Grid.BinHeight=4e6*SAM.StringToDistance(this.Dialog.BinHeightInput.val()),this.Grid.Orientation=parseFloat(this.Dialog.RotationInput.val()),this.Grid.UpdateBuffers(this.Layer.AnnotationView),this.SetActive(!1),this.Text.String=SAM.DistanceToString(2.5e-7*this.Grid.BinWidth),this.Text.UpdateBuffers(this.Layer.AnnotationView),window.SA&&SA.RecordState(),this.Layer.EventuallyDraw(),this.UserNoteFlag&&SA.notesWidget&&SA.notesWidget.EventuallySaveUserNote(),SAM.NotesWidget&&!this.UserNoteFlag&&SAM.NotesWidget.MarkAsModified(),localStorage.GridWidgetDefaults=JSON.stringify({Color:t,LineWidth:this.Grid.LineWidth})},SAM.GridWidget=e}(),function(){"use strict";function t(){SAM.Shape.call(this),this.BinLength=100,this.TickSize=6,this.NumberOfBins=1,this.Orientation=0,this.Origin=[1e4,1e4],this.OutlineColor=[0,0,0],this.PointBuffer=[],this.PositionCoordinateSystem=SAM.Shape.VIEWER}function e(){this.PixelsPerMeter=0,this.Shape=new t,this.Shape.OutlineColor=[0,0,0],this.Shape.Origin=[200,15],this.Shape.BinLength=200,this.Shape.FixedSize=!0,this.Text=new SAM.Text,this.Text.PositionCoordinateSystem=SAM.Shape.VIEWER,this.Text.Position=[200,0],this.Text.String="",this.Text.Color=[0,0,0],this.Text.Anchor=[20,0],this.State=i}var i=3;t.prototype=new SAM.Shape,t.prototype.destructor=function(){},t.prototype.UpdateBuffers=function(t){this.PointBuffer=[],this.Matrix=mat4.create(),mat4.identity(this.Matrix);var e=0,i=this.TickSize;this.PointBuffer.push(e),this.PointBuffer.push(i),this.PointBuffer.push(0),i=0,this.PointBuffer.push(e),this.PointBuffer.push(i),this.PointBuffer.push(0);for(var o=0;o<this.NumberOfBins;++o)e+=this.BinLength,this.PointBuffer.push(e),this.PointBuffer.push(i),this.PointBuffer.push(0),i=this.TickSize,this.PointBuffer.push(e),this.PointBuffer.push(i),this.PointBuffer.push(0),i=0,this.PointBuffer.push(e),this.PointBuffer.push(i),this.PointBuffer.push(0)},e.prototype.Update=function(t){if(t){var e=Math.round(t.GetPixelsPerUnit()/t.GetMetersPerUnit());if(this.PixelsPerMeter!==e){this.PixelsPerMeter=e;for(var i=0,o=this.PixelsPerMeter;o>200;)o/=10,--i;this.Units="nm";var s=1e-9;i>=-6&&(this.Units="µm",s=1e-6),i>=-3&&(this.Units="mm",s=.001),i>=-2&&(this.Units="cm",s=.01),i>=0&&(this.Units="m",s=1),i>=3&&(this.Units="km",s=1e3),this.Shape.BinLength=o,this.Shape.NumberOfBins=Math.floor(200/o);var n=o*this.Shape.NumberOfBins,a=n/this.PixelsPerMeter,r=Math.round(a/s);this.Label=r.toString()+this.Units,this.LengthWorld=4e6*a,this.Text.String=this.Label,this.Text.UpdateBuffers(t),this.Text.Position=[this.Shape.Origin[0]+n/2,this.Shape.Origin[1]-15],this.Shape.UpdateBuffers(t)}}},e.prototype.Draw=function(t){t&&t.HasUnits()&&(this.Update(t),this.Shape.Draw(t),this.Text.Draw(t))},e.prototype.HandleKeyPress=function(t,e){return!0},e.prototype.HandleDoubleClick=function(t){return!0},e.prototype.HandleMouseDown=function(t){return!1},e.prototype.HandleMouseUp=function(t){return!0},e.prototype.HandleMouseMove=function(t){return!0},e.prototype.HandleMouseWheel=function(t){},e.prototype.HandleTouchPan=function(t){return!0},e.prototype.HandleTouchPinch=function(t){return!0},e.prototype.HandleTouchEnd=function(t){this.SetActive(!1)},e.prototype.CheckActive=function(t){return this.SetActive(!1),!1},e.prototype.GetActive=function(){return this.State!==i},e.prototype.Deactivate=function(){this.State=i,this.Shape.Active=!1,this.Layer.EventuallyDraw()},e.prototype.SetActive=function(t){t!==this.GetActive()&&(t?(this.State=4,this.Shape.Active=!0):this.Deactivate())},SAM.ScaleWidget=e}(),function(){"use strict";function t(t){t=t||"body",SAM.DialogOverlay||(SAM.DialogOverlay=$("<div>").appendTo(t).css({position:"fixed",left:"0px",width:"100%","background-color":"#AAA",opacity:"0.4","z-index":"1010"}).saFullHeight().hide()),this.Dialog=$("<div>").appendTo(t).css({"z-index":"1011"}).addClass("sa-view-dialog-div"),this.Row1=$("<div>").addClass("sa-view-dialog-title").appendTo(this.Dialog).css({width:"100%",height:"2.5em","box-sizing":"border-box"}),this.Title=$("<div>").appendTo(this.Row1).css({float:"left"}).addClass("sa-view-dialog-title").text("Title"),this.CloseButton=$("<div>").appendTo(this.Row1).css({float:"right"}).addClass("sa-view-dialog-close").text("Close"),this.Body=$("<div>").appendTo(this.Dialog).css({width:"100%","box-sizing":"border-box","margin-bottom":"30px"}),this.ApplyButtonDiv=$("<div>").appendTo(this.Dialog).addClass("sa-view-dialog-apply-div"),this.ApplyButton=$("<button>").appendTo(this.ApplyButtonDiv).addClass("sa-view-dialog-apply-button").text("Apply")}t.prototype.SetApplyCallback=function(t){var e=this;e.ApplyButton.click(function(i){return SA.ContentEditableHasFocus=!1,e.Hide(),t(),!0})},t.prototype.SetCloseCallback=function(t){var e=this;this.CloseButton.click(function(i){return SA.ContentEditableHasFocus=!1,e.Hide(),t(),!0})},t.prototype.Show=function(t){SA.ContentEditableHasFocus=!0;var e=this;SAM.DialogOverlay.show(),this.Dialog.fadeIn(300),t?SAM.DialogOverlay.off("click.dialog"):SAM.DialogOverlay.on("click.dialog",function(t){e.Hide()}),SAM.ContentEditableHasFocus=!0},t.prototype.Hide=function(){SAM.DialogOverlay.off("click.dialog"),SAM.DialogOverlay.hide(),this.Dialog.fadeOut(300),SAM.ContentEditableHasFocus=!1},SAM.Dialog=t}(),function(){"use strict";function t(){}var e=function(t,e,i,o){this.HighlightedRect=new SAM.Rect,this.HighlightedRect.OutlineColor=[1,1,0],this.ArrowMode=!0,this.ViewerParent=e.GetDiv(),this.Layer=new SAM.AnnotationLayer(this.ViewerParent),this.Layer.SetCamera(e.GetCamera()),e.AddLayer(this),this.ArrowMode&&(this.ArrowLayer=new SAM.AnnotationLayer(this.ViewerParent),this.ArrowLayer.SetCamera(e.GetCamera()),this.LoadItemArrows(i,"plane-nose",this.ArrowLayer)),this.Viewer=e,this.ActiveClassIndex=0,this.ItemId=i,this.CreateClasses(o),this.ActionState=0,this.InitializeGui(t,"GirderAnnotationIterator"),this.IteratorIndex=-1,this.SetActiveClassIndex(0)};e.prototype.EventuallyDraw=function(){if(!this.RenderPending){this.RenderPending=!0;var t=this;window.requestAnimationFrame(function(){t.RenderPending=!1,t.Draw()})}},e.prototype.GetView=function(){return this.Layer.GetView()},e.prototype.GetCamera=function(){return this.Layer.GetCamera()},e.prototype.Remove=function(){this.LayerControl.remove(),this.InstructionsHeading.remove(),this.InstructionsUL.remove(),this.Layer.Remove(),this.ArrowLayer&&this.ArrowLayer.Remove(),this.Viewer.RemoveLayer(this)},e.prototype.UpdateSize=function(){this.Layer.UpdateSize(),this.ArrowLayer&&this.ArrowLayer.UpdateSize()},e.prototype.CreateClasses=function(t){var e=t.length;this.Classes=[];for(var i=0;i<e;++i){var o={label:t[i],index:i};if(this.Classes.push(o),0===i)o.color="#FFFF00";else if(1===i)o.color="#FF0000";else if(2===i)o.color="#00FF00";else{var s=(i-3)/(e-4);this.Classes[i].color=SAM.ConvertColorToHex([s,1-s,1])}this.RequestAnnotationFromName(o)}},e.prototype.RequestAnnotationFromName=function(t){if(window.girder){var e=this;girder.rest.restRequest({url:"annotation?itemId="+this.ItemId+"&name="+t.label+"&limit=1",method:"GET"}).done(function(i){if(i.length>0)t.annotation_id=i[0]._id,e.RequestAnnotationFromId(t);else{var o={elements:[],name:t.label};girder.rest.restRequest({url:"annotation?itemId="+e.ItemId,method:"POST",contentType:"application/json",data:JSON.stringify(o)}).done(function(i){t.annotation_id=i._id,e.LoadAnnotation(i,t)})}})}else window.alert("Could not find girder client")},e.prototype.RequestAnnotationFromId=function(t){if(window.girder){var e=this;girder.rest.restRequest({url:"annotation/"+t.annotation_id,method:"GET",contentType:"application/json"}).done(function(i){e.LoadAnnotation(i,t)})}else window.alert("Could not find girder client")},e.prototype.LoadAnnotation=function(e,i){i.annotation=e.annotation;var o={};o.type="rect_set",o.centers=[],o.widths=[],o.heights=[],o.confidences=[],o.labels=[];for(var s=e.annotation,n=0;n<s.elements.length;++n){var a=s.elements[n];"rectangle"===a.type&&(o.widths.push(a.width),o.heights.push(a.height),o.centers.push(a.center[0]),o.centers.push(a.center[1]),void 0===a.scalar&&(a.scalar=1),o.confidences.push(a.scalar),o.labels.push(i.label))}var r=new SAM.RectSetWidget;r.Load(o),r.Hash=new t;var h=this.Viewer.GetOverViewBounds();r.Hash.Build(r.Shape,h);var l=r.Shape;if(!l.LabelColors)for(l.LabelColors={},n=0;n<this.Classes.length;++n)l.LabelColors[this.Classes[n].label]=this.Classes[n].color;i.widget=r,r.Shape.SetOutlineColor(i.color),this.EventuallyDraw()},e.prototype.GetSquareSize=function(){var t=64;if(this.SquareSize)t=this.SquareSize;else if(this.Classes.length>0){var e=this.Classes[this.ActiveClassIndex];if(e.widget){var i=e.widget.Shape;i.Heights.length>0&&(t=i.Heights[0])}}var o=this.GetCamera(),s=o.GetHeight();t>s/.75&&(t=s/.75,this.SquareSize=t);var n=o.GetSpacing();return t<10*n&&(t=10*n,this.SquareSize=t),t},e.prototype.SetActiveClassIndex=function(t){if(t<0||t>=this.Classes.length)return!1;if(this.Classes[this.ActiveClassIndex].gui.css({"background-color":"#FFF"}),this.ActiveClassIndex=t,this.Classes[t].gui.css({"background-color":"#DEF"}),this.SetCursorColor(this.ViewerParent,this.Classes[t].color),!this.IteratorClass){var e=this.Classes[t];this.ActiveLabel.text(e.label)}return!1},e.prototype.GetActive=function(){return!0},e.prototype.Draw=function(){this.Layer.Draw();var t=this.Layer.GetView();this.HighlightedRect.Draw(t),this.ArrowLayer&&this.ArrowLayer.Draw();for(var e=0;e<this.Classes.length;++e)this.Classes[e].widget&&this.Classes[e].widget.Draw(this.Layer)},e.prototype.HandleMouseDown=function(t){return!this.ArrowLayer||this.ArrowLayer.HandleMouseDown(t)},e.prototype.HandleMouseUp=function(t){return!this.ArrowLayer||this.ArrowLayer.HandleMouseUp(t)},e.prototype.HandleMouseClick=function(t){var e=this.ArrowLayer.HandleSelect(t);if(e!==this.SelectedWidget)return this.SelectedWidget&&(this.SelectedWidget.SetActive(!1),this.SelectedWidget.SetSelected(!1)),e?(e.SetActive(!0),this.SelectedWidget=e,!1):(this.SelectedWidget=void 0,!0)},e.prototype.HandleMouseMove=function(t){return!this.ArrowLayer||this.ArrowLayer.HandleMouseMove(t)},e.prototype.HandleMouseWheel=function(t){return!0},e.prototype.SetIteratorIndex=function(t){this.SetHighlightedRect(this.IteratorClass,t),this.IteratorIndex=t,-1===t&&(this.IteratorClass=void 0),this.UpdateActiveView()},e.prototype.SetHighlightedRect=function(t,e){var i=t.widget,o=i.Shape;i.Visibility=!1,this.HighlightedRect.Visibility=!0,this.HighlightedRect.Width=o.Widths[e],this.HighlightedRect.Height=o.Heights[e],this.HighlightedRect.Orientation=0;var s=o.Centers[2*e],n=o.Centers[2*e+1];this.HighlightedRect.Origin=[s,n],this.HighlightedRect.UpdateBuffers(),this.EventuallyDraw()},e.prototype.HandleKeyDown=function(t){return!this.IteratorClass&&(!this.ArrowLayer||this.ArrowLayer.HandleMouseUp(t))},e.prototype.HandleKeyUp=function(t){if(this.IteratorClass){if(46===t.keyCode||8===t.keyCode)return this.ArrowLayer&&(this.ArrowLayer.DeleteSelected(),this.ArrowLayer.EventuallyDraw()),t.preventDefault(),!1;if(27===t.keyCode)return this.Stop(),!1;if(this.IteratorClass){if(37===t.keyCode)return this.ChangeCurrent(-1),!1;if(39===t.keyCode||32===t.keyCode)return this.ChangeCurrent(1),!1}}return!this.ArrowLayer||this.ArrowLayer.HandleMouseUp(t)},e.prototype.UpdateActiveView=function(){if(void 0===this.IteratorClass||void 0===this.IteratorClass.widget)return!0;var t=this.IteratorClass.widget.Shape,e=this.IteratorIndex;if(e<0){var i=this.Classes[this.ActiveClassIndex];this.ActiveLabel.text(i.label)}else{this.ActiveLabel.text(e.toString()+" of "+t.Labels.length.toString()+", "+t.Confidences[e].toPrecision(2)+", "+t.Labels[e]);var o=this.Viewer;o.RollTarget=this.GetCamera().GetWorldRoll(),o.TranslateTarget=t.GetCenter(this.IteratorIndex),o.AnimateLast=(new Date).getTime(),o.AnimateDuration=200,o.EventuallyRender(!0)}},e.prototype.HandleArrowFinished=function(t){this.ArrowWidget=void 0},e.prototype.StartArrow=function(t){this.SelectedWidget&&(this.SelectedWidget.SetActive(!1),this.SelectedWidget.SetSelected(!1));var e=this;this.ArrowWidget||(this.ArrowWidget=new SAM.ArrowWidget(this.ArrowLayer),this.ArrowWidget.SetColor("#00ffff"),this.ArrowWidget.Arrow.Width=2,this.ArrowLayer.AddWidget(this.ArrowWidget),this.ArrowWidget.SetStateToDrawing(),this.ArrowWidget.SetStateChangeCallback(function(t){e.HandleArrowFinished(t)}))},e.prototype.LoadItemArrows=function(t,e,i){var o=this;girder.rest.restRequest({url:"annotation?itemId="+t+"&name="+e+"&limit=1",method:"GET"}).done(function(i){if(i.length>0)o.ArrowAnnotationId=i[0]._id,girder.rest.restRequest({url:"annotation/"+o.ArrowAnnotationId,method:"GET",contentType:"application/json"}).done(function(t){o.LoadAnnotationArrows(t)});else{var s={elements:[],name:e};o.ArrowAnnotation=s,girder.rest.restRequest({url:"annotation?itemId="+t,method:"POST",contentType:"application/json",data:JSON.stringify(s)}).done(function(t){o.ArrowAnnotationId=t._id})}})},e.prototype.LoadAnnotationArrows=function(t,e){this.ArrowAnnotation=t.annotation;for(var i=t.annotation,o=0;o<i.elements.length;++o){var s=i.elements[o],n=s.points[1][0]-s.points[0][0],a=s.points[1][1]-s.points[0][1],r=Math.sqrt(n*n+a*a),h=180*Math.atan2(a,n)/Math.PI;if("arrow"===s.type){var l={origin:s.points[0],length:r,width:s.lineWidth,orientation:h,fillcolor:SAM.ConvertColor(s.fillColor),outlinecolor:SAM.ConvertColor(s.lineColor)},d=new SAM.ArrowWidget(this.ArrowLayer);d.Load(l),this.ArrowLayer.AddWidget(d)}}this.EventuallyDraw()},e.prototype.ChangeCurrent=function(t){if(void 0===this.IteratorClass.widget)return!0;for(var e=this.IteratorClass.widget.Shape,i=this.IteratorIndex,o=this.GetConfidenceThreshold();;){if((i+=t)<0||i>=e.Widths.length)return void this.Stop();if(e.Confidences[i]>=o)return this.ArrowMode&&this.StartArrow(),void this.SetIteratorIndex(i)}},e.prototype.HandleClick=function(t){return!0},e.prototype.InitializeGui=function(t,e){var i=this;this.LayerControl=$("<div>").appendTo(t).css({border:"1px solid #CCC",width:"100%"}),this.ActiveLabel=$("<div>").appendTo(this.LayerControl).prop("title","Start sorting detections").attr("contenteditable","false").text("");var o=$("<p>").appendTo(this.LayerControl);this.StartStopButton=$("<button>").appendTo(o).text("Start").css({"background-color":"#5F5"}).prop("title","Start sorting detections").css({width:"5em"}).on("click",function(){i.StartStop()}),$("<button>").appendTo(o).text("Save").prop("title","Save annotations to server").click(function(){i.Save()});var s=$("<div>").appendTo(this.LayerControl).css({border:"1px solid #CCC",width:"100%",height:"50px"});this.Slider=$('<input type="range" min="0" max="100">').appendTo(s).on("input",function(){i.SliderCallback()}),$("<div>").appendTo(s).html("0%").css({float:"left"}),$("<div>").appendTo(s).html("Confidence").css({float:"right",position:"relative",left:"-50%","text-align":"left"}),$("<div>").appendTo(s).html("100%").css({float:"right"});for(var n=$("<p>").appendTo(this.LayerControl),a=0;a<this.Classes.length;++a)this.MakeClassButton(n,a);this.InstructionsHeading=$("<h4>").appendTo(t).text("Instructions"),this.InstructionsUL=$("<ul>").appendTo(t);var r=$("<li>").appendTo(this.InstructionsUL).text("Browsing"),h=$("<ul>").appendTo(r);$("<li>").appendTo(h).text("Arrow keys: pan screen"),$("<li>").appendTo(h).text("Left mouse drag: pan"),$("<li>").appendTo(h).text("Scroll wheel: zoom"),$("<li>").appendTo(h).text('"<" button: previous image'),$("<li>").appendTo(h).text('">" button: next image'),$("<li>").appendTo(h).text('"Start" button: iterate over all planes');var l=$("<li>").appendTo(this.InstructionsUL).text("Iterating"),d=$("<ul>").appendTo(l);$("<li>").appendTo(d).text("Space bar: advance to next plane"),$("<li>").appendTo(d).text("Right arrow key: advance to next plane"),$("<li>").appendTo(d).text("Left arrow key: back to previos plane"),$("<li>").appendTo(d).text("A new arrow is automatically triggerd when you advance"),$("<li>").appendTo(d).text("Mouse down: place the arrow's tip"),$("<li>").appendTo(d).text("Drag with mouse down: place the arrow's base"),$("<li>").appendTo(d).text("Mouse up: finish the arrow"),$("<li>").appendTo(d).text("Click on an arrow to make it dragable")},e.prototype.MakeClassButton=function(t,e){var i=this,o=this.Classes[e];o.gui=$("<div>").appendTo(t).text(e.toString()+": "+o.label).css({color:o.color}).click(function(){i.SetActiveClassIndex(e)})},e.prototype.UpdateHash=function(){for(var t=this.Viewer.GetOverViewBounds(),e=0;e<this.Classes.length;++e){var i=this.Classes[e].widget;i.Hash.Build(i.Shape,t)}},e.prototype.GetConfidenceThreshold=function(){return parseInt(this.Slider.val())/100},e.prototype.SliderCallback=function(){for(var t=this.GetConfidenceThreshold(),e=0;e<this.Classes.length;++e)this.Classes[e].widget&&this.Classes[e].widget.SetThreshold(t);this.EventuallyDraw(),this.CheckIteratorVisibility()},e.prototype.CheckIteratorVisibility=function(){if(this.IteratorClass&&!(this.IteratorIndex<0)){var t=this.IteratorClass.widget.Shape,e=this.GetConfidenceThreshold();t.Confidences[this.IteratorIndex]<e&&this.ChangeCurrent(1)}},e.prototype.Stop=function(){this.SetIteratorIndex(-1),this.InteractorClass=void 0,this.StartStopButton.text("Start").css({"background-color":"#5F5"}).prop("title","Start sorting detections")},e.prototype.Start=function(){if(this.Viewer.Focus(),this.Viewer.ZoomTarget=500,this.IteratorClass=this.Classes[this.ActiveClassIndex],this.IteratorClass.widget.Shape.GetLength()<1)return window.alert("No annotations in "+this.IteratorClass.label),void(this.IteratorClass=void 0);this.SetIteratorIndex(0),this.CheckIteratorVisibility(),this.StartStopButton.text("Stop").css({"background-color":"#F55"}).prop("title","Stop sorting detections"),this.ArrowMode&&this.StartArrow()},e.prototype.StartStop=function(){this.IteratorClass?this.Stop():this.Start()},e.prototype.SplitDetections=function(){for(var t={},e=0;e<this.Classes.length;++e)t[this.Classes[e].label]=this.Classes[e],this.Classes[e].newRectSet=new SAM.RectSet,this.Classes[e].newRectSet.LabelColors=this.Classes[e].widget.Shape.LabelColors,this.Classes[e].newRectSet.Threshold=this.Classes[e].widget.Shape.Threshold;for(e=0;e<this.Classes.length;++e)for(var i=this.Classes[e].widget.Shape,o=0;o<i.GetLength();++o){var s=t[i.Labels[o]].newRectSet;s.CopyRectangle(i,o,s.GetLength())}for(e=0;e<this.Classes.length;++e)this.Classes[e].widget.Shape=this.Classes[e].newRectSet,delete this.Classes[e].newRectSet;this.UpdateHash()},e.prototype.Save=function(){var t=this.ArrowAnnotation;t.elements=this.ArrowLayerToGirderElements(this.ArrowLayer),SA.PushProgress(),girder.rest.restRequest({url:"annotation/"+this.ArrowAnnotationId,method:"PUT",data:JSON.stringify(t),contentType:"application/json"}).done(function(){SA.PopProgress()})},e.prototype.ArrowLayerToGirderElements=function(t){for(var e=[],i=0;i<t.GetNumberOfWidgets();++i){var o=t.GetWidget(i).Serialize(),s=[o.origin[0],o.origin[1],0],n=[o.origin[0],o.origin[1],0],a=o.orientation*Math.PI/180;n[0]+=o.length*Math.cos(a),n[1]+=o.length*Math.sin(a);var r=[s,n],h={type:"arrow",lineWidth:o.width,fillColor:SAM.ConvertColorToHex(o.fillcolor),lineColor:SAM.ConvertColorToHex(o.outlinecolor),points:r};e.push(h)}return e},e.prototype.RectSetToGirderElements=function(t){for(var e=[],i=t.Serialize(),o=i.widths.length,s=0;s<o;++s){var n={type:"rectangle",label:{value:i.labels[s]},center:[i.centers[2*s],i.centers[2*s+1],0],height:i.heights[s],width:i.widths[s],rotation:0,scalar:i.confidences[s]};e.push(n)}return e},e.prototype.SetActive=function(t){t!==this.Active&&(this.Active=t,this.EventuallyDraw())},e.prototype.SetCursorColor=function(t,e){var i=document.createElement("canvas"),o=i.getContext("2d");i.width=16,i.height=24,o.moveTo(0,18),o.lineTo(0,0),o.lineTo(12,12),o.lineTo(7,13),o.lineTo(11,21),o.lineTo(8,22),o.lineTo(4,14),o.closePath(),o.fillStyle=e,o.fill(),o.strokeStyle="#000",o.stroke(),t[0].style.cursor="url("+i.toDataURL()+"), auto"},t.prototype.Initialize=function(t,e){this.Origin=[t[0],t[2]],this.BinSize=Math.sqrt((t[1]-t[0])*(t[3]-t[2])/(e+1)),this.XDim=Math.ceil((t[1]-t[0])/this.BinSize),this.YDim=Math.ceil((t[3]-t[2])/this.BinSize),this.Grid=new Array(this.YDim);for(var i=0;i<this.YDim;++i){for(var o=new Array(this.XDim),s=0;s<this.XDim;++s)o[s]=[];this.Grid[i]=o}},t.prototype.Add=function(t,e,i,o){var s,n;s=t[0]-e/2;var a=Math.floor((s-this.Origin[0])/this.BinSize);a=Math.max(Math.min(a,this.XDim-1),0),s=t[0]+e/2;var r=Math.floor((s-this.Origin[0])/this.BinSize);r=Math.max(Math.min(r,this.XDim-1),0),n=t[1]-i/2;var h=Math.floor((n-this.Origin[1])/this.BinSize);h=Math.max(Math.min(h,this.YDim-1),0),n=t[1]+i/2;var l=Math.floor((n-this.Origin[1])/this.BinSize);l=Math.max(Math.min(l,this.YDim-1),0);for(var d=h;d<=l;++d)for(var u=a;u<=r;++u)this.Grid[d][u].push(o)},t.prototype.Build=function(t,e){this.RectSet=t;var i=t.GetLength();this.Initialize(e,i);for(var o=0;o<i;++o){var s=o<<1;this.Add([t.Centers[s],t.Centers[s+1]],t.Widths[o],t.Heights[o],o)}},t.prototype.Get=function(t,e){for(var i,o=Math.max(Math.min(Math.floor((t[0]-this.Origin[0])/this.BinSize),this.XDim-1),0),s=Math.max(Math.min(Math.floor((t[1]-this.Origin[1])/this.BinSize),this.YDim-1),0),n=this.Grid[s][o],a=0;a<n.length;++a){var r=n[a],h=this.RectSet.Confidences[r],l=this.RectSet.Widths[r],d=this.RectSet.Heights[r],u=this.RectSet.Centers[r<<1],p=this.RectSet.Centers[1+(r<<1)],c=Math.abs(u-t[0]),f=Math.abs(p-t[1]);if(c<l/2&&f<d/2&&e<=h){var g=Math.max(c,f);(!i||g<=i.dist)&&(i={dist:g,index:r,center:[u,p],width:l,height:d})}}return i},t.prototype.GetOverlapping=function(t,e,i,o){var s,n,a=[],r=e/2,h=i/2,l=t[0],d=t[1],u=e*i;s=t[0]-r;var p=Math.floor((s-this.Origin[0])/this.BinSize);p=Math.max(Math.min(p,this.XDim-1),0),s=t[0]+r;var c=Math.floor((s-this.Origin[0])/this.BinSize);c=Math.max(Math.min(c,this.XDim-1),0),n=t[1]-h;var f=Math.floor((n-this.Origin[1])/this.BinSize);f=Math.max(Math.min(f,this.YDim-1),0),n=t[1]+h;var g=Math.floor((n-this.Origin[1])/this.BinSize);g=Math.max(Math.min(g,this.YDim-1),0);for(var v=f;v<=g;++v)for(var S=p;S<=c;++S)for(var y=this.Grid[v][S],m=0;m<y.length;++m){var w=y[m],C=this.RectSet.Widths[w]/2,A=this.RectSet.Heights[w]/2,T=C*A*4,b=this.RectSet.Centers[w<<1],D=this.RectSet.Centers[1+(w<<1)],x=Math.max(l-r,b-C),P=Math.min(l+r,b+C),M=Math.max(d-h,D-A),I=Math.min(d+h,D+A);if(Math.max(0,P-x)*Math.max(0,I-M)/Math.min(u,T)>o){for(var L=!1,V=0;V<a.length&&!L;++V)a[V]===w&&(L=!0);L||a.push(w)}}return a},SAM.SpatialHash=t,SAM.GirderAnnotationIterator=e}(),function(){"use strict";function t(t,e,i,o){this.VolumeCenter=void 0,this.SectionIndex=-1,this.First=!0,this.ApiRoot=o,this.Stack=[],this.Caches={},this.Display=e,e.AddLayer(this);var s=this;this.SliderDiv=$("<div>").appendTo(t).css({position:"absolute",left:"0px",bottom:"5px",width:"100%","z-index":"1000"}).on("keyup",function(t){s.HandleKeyUp(t)}).hover(function(){s.SliderDiv.focus()},function(){s.SliderDiv.blur()}),this.SliderDiv.slider({start:function(t,e){s.StartCallback(e.value)},slide:function(t,e){s.SlideCallback(e.value)},stop:function(t,e){s.StopCallback(e.value)}}),this.SlideLabel=$("<div>").appendTo(this.SliderDiv).css({position:"absolute",top:"-25px","text-align":"center",color:"#ddf","text-shadow":"2px 2px #000"}).hide()}t.prototype.SetAnnotationName=function(t){this.AnnotationName=t},t.prototype.StartCallback=function(t){this.SlideLabel.text(this.SectionIndex.toString());var e=100*t/(this.Stack.length-1);this.SlideLabel.css({left:e+"%"}),this.SlideLabel.show()},t.prototype.SlideCallback=function(t){this.SetSectionIndex(t);var e=100*t/(this.Stack.length-1);this.SlideLabel.text(t.toString()),this.SlideLabel.css({left:e+"%"})},t.prototype.StopCallback=function(t){this.SetSectionIndex(t),this.SlideLabel.text(t.toString()),this.SlideLabel.hide()},t.prototype.HandleKeyUp=function(t){return 33===t.keyCode||80===t.keyCode?(this.Previous(),!1):34!==t.keyCode&&32!==t.keyCode&&78!==t.keyCode||(this.Next(),!1)},t.prototype.Next=function(){this.SetSectionIndex(this.SectionIndex+1)},t.prototype.Previous=function(){this.SetSectionIndex(this.SectionIndex-1)},t.prototype.LoadFolder=function(t){var e=this;this.Stack=[],this.ErrorCount=0,window.girder&&girder.rest.restRequest({url:"folder/"+t+"/details",method:"GET",contentType:"application/json"}).done(function(i){var o=i.nItems;e.LoadFolderImageIds(t,0,100,o)})},t.prototype.LoadFolderImageIds=function(t,e,i,o){var s=this;e>=o?this.Stack.length>0&&(this.SetSectionIndex(0),this.ErrorCount=0,this.LoadStackMetaData()):girder.rest.restRequest({url:"item?folderId="+t+"&limit="+i+"&offset="+e+"&sort=lowerName&sortdir=1",method:"GET",contentType:"application/json",error:function(n,a){s.ErrorCount+=1,s.ErrorCount<100?(console.error(n.status+" "+n.statusText,n.responseText),s.LoadFolderImageIds(t,e,i,o)):console.log("Too many errors loading folder")}}).done(function(n){for(var a=0;a<n.length;++a){var r,h=n[a];if(h.largeImage)if(h.meta&&h.meta.sections)for(var l=h.meta.sections,d=0;d<l.length;++d){var u=l[d];r={imageId:h._id},u.trans&&(r.transform=u.trans),u.bounds&&(r.bounds=[u.bounds[0],u.bounds[2],u.bounds[1],u.bounds[3]]),s.Stack.push(r)}else r={imageId:n[a]._id},s.Stack.push(r)}s.LoadFolderImageIds(t,e+i,i,o)})},t.prototype.LoadSections=function(t){var e=this;this.Stack=[],t.length>0&&this.SetSectionIndex(0);for(var i=0;i<t.length;++i){var o=t[i],s={imageId:o.itemId};o.trans&&(s.transform=o.trans),o.bounds&&(s.bounds=[o.bounds[0],o.bounds[2],o.bounds[1],o.bounds[3]]),e.Stack.push(s)}this.LoadStackMetaData()},t.prototype.SetSectionIndex=function(t){if(t>=this.Stack.length&&(t=this.Stack.length-1),!(t<0)&&this.SectionIndex!==t){console.log("stack index "+t.toString()),this.SectionIndex=t;for(var e=this.Display.GetNumberOfLayers(),i=0;i<e;++i){var o=this.Display.GetLayer(i);o&&o.SetTime&&o.SetTime(t)}this.RenderSection(this.Stack[t])}},t.prototype.RenderSection=function(t){if(void 0!==t.SaSection){var e=this.Caches[t.imageId];if(void 0!==e&&e.RootsLoaded){if(this.First&&(delete this.First,this.SliderDiv.slider("option","max",this.Stack.length-1),this.Display.SetCamera([(t.bounds[0]+t.bounds[1])/2,(t.bounds[2]+t.bounds[3])/2],0,t.bounds[3]-t.bounds[2])),this.Display.SetSection(t.SaSection),e.Annotation){var o=this.Display.GetAnnotationLayer();i(o,e.Annotation)}if(this.Display.EventuallyRender(),this.Overlay){var s=this.Stack.indexOf(t);if(-1!==s&&s<this.Stack.length-1){var n=this.Stack[s+1];if(void 0===(e=this.Caches[n.imageId])||!e.RootsLoaded)return;this.Overlay.SetSection(n.SaSection)}this.Overlay.DrawTiles()}}}},t.prototype.LoadStackMetaData=function(){if(this.ErrorCount>100)console.error("Too many errors loading item tile info.");else if(0!==this.Stack.length){var t=this,e=Math.max(this.SectionIndex,0),i=this.Stack[e];i.SaSection&&(i=void 0);for(var o=1;!i&&o<this.Stack.length;){var s=e+o;s>=0&&s<this.Stack.length&&(i=this.Stack[s]).SaSection&&(i=void 0),s=e-o,!i&&s>=0&&s<this.Stack.length&&(i=this.Stack[s]).SaSection&&(i=void 0),++o}i&&this.CreateSaSection(i,function(){t.LoadStackMetaData()})}},t.prototype.CreateSaSection=function(t,e){var i=this.Caches[t.imageId];if(i)return this.CreateSaSectionFromCache(t,i),void(e&&e());var o=this;girder.rest.restRequest({url:"item/"+t.imageId+"/tiles",method:"GET",contentType:"application/json",error:function(t,i){console.error(t.status+" "+t.statusText,t.responseText),this.ErrorCount+=1,e&&e()}}).done(function(i){o.LoadItem(i,t,e)})},t.prototype.LoadItem=function(t,i,o){var s=t.sizeX,n=t.sizeY;void 0===i.bounds&&(i.bounds=[0,s-1,0,n-1]);var a=new SA.Cache;this.Caches[i.imageId]=a;var r=new e(s,n,t.tileWidth,t.tileHeight,0,t.levels-1,this.ApiRoot,i.imageId,[0,s-1,0,n-1]);a.SetTileSource(r);var h=new SA.Section;h.AddCache(a),i.SaSection=h,a.SetTileSource(r);var l=this;a.LoadRoots(function(){if(a.RootsLoaded=!0,-1!==l.SectionIndex){var t=l.Stack[l.SectionIndex];i.imageId===t.imageId&&l.RenderSection(t)}}),this.CreateSaSectionFromCache(i,a),this.AnnotationName&&girder.rest.restRequest({url:"annotation?itemId="+i.imageId+"&name="+this.AnnotationName,method:"GET",contentType:"application/json",error:function(t,e){console.error(t.status+" "+t.statusText,t.responseText)}}).done(function(t){if(t.length>0){var e=t[0]._id;girder.rest.restRequest({url:"annotation/"+e,method:"GET",contentType:"application/json",error:function(t,e){console.error(t.status+" "+t.statusText,t.responseText)}}).done(function(t){a.Annotation=t.annotation})}}),o&&o()},t.prototype.CreateSaSectionFromCache=function(t,e){var i=e.GetImageData();void 0===t.bounds&&(t.bounds=[0,i.dimensions[0]-1,0,i.dimensions[1]-1]);var o=t.bounds,s=[.5*(o[0]+o[1]),.5*(o[2]+o[3])];this.VolumeCenter||(this.VolumeCenter=s),void 0===t.transform&&(t.transform=[1,0,0,1,s[0]-this.VolumeCenter[0],s[1]-this.VolumeCenter[1]]);var n=new SA.Section;n.AddCache(e),n.SetTransform(t.transform);var a=SAM.InvertTransform(t.transform);n.Bounds=SAM.TransformBounds(a,o),t.SaSection=n};var e=function(t,e,i,o,s,n,a,r,h){this.height=e,this.width=t,this.TileWidth=i,this.TileHeight=o,this.apiRoot=a,this.imageId=r,this.bounds=h,this.maxLevel=n};e.prototype.getTileUrl=function(t,e,i,o){return this.apiRoot+"/item/"+this.imageId+"/tiles/zxy/"+t+"/"+e+"/"+i};var i=function(t,e){t.SetVisibility(!0),t.Reset();var i={};i.type="rect_set",i.centers=[],i.widths=[],i.heights=[],i.confidences=[],i.labels=[];for(var o=e,s=0;s<o.elements.length;++s){var n=o.elements[s],a={};if("view"===n.type){var r=t.GetCamera();r.SetWorldFocalPoint(n.center),r.SetHeight(n.height),n.rotation?r.SetWorldRoll(n.rotation):r.SetWorldRoll(0),r.ComputeMatrix(),t.Viewer&&t.Viewer.EventuallyRender()}"circle"===n.type&&(a.type=n.type,a.lineColor=SAM.ConvertColor(n.lineColor),a.lineWidth=n.lineWidth,a.origin=n.center,a.radius=n.radius,t.LoadWidget(a)),"arrow"===n.type&&(a.type="text",a.string=n.label.value,a.color=SAM.ConvertColor(n.fillColor),a.size=n.label.fontSize,a.position=n.points[0].slice(0),a.offset=n.points[1].slice(0),a.offset[0]-=a.position[0],a.offset[1]-=a.position[1],t.LoadWidget(a)),"rectanglegrid"===n.type&&(a.type="grid",a.lineColor=SAM.ConvertColor(n.lineColor),a.lineWidth=n.lineWidth,a.origin=n.center,a.bin_width=n.width/n.widthSubdivisions,a.bin_height=n.height/n.heightSubdivisions,a.orientation=n.rotation,a.dimensions=[n.widthSubdivisions,n.heightSubdivisions],t.LoadWidget(a)),"rectangle"===n.type&&("rectangle"===n.type?(i.widths.push(n.width),i.heights.push(n.height),i.centers.push(n.center[0]),i.centers.push(n.center[1]),void 0===n.scalar&&(n.scalar=1),i.confidences.push(n.scalar),void 0===n.vector&&(n.vector=[0,0,0]),void 0===i.vectors&&(i.vectors=[]),i.vectors.push(n.vector[0]),i.vectors.push(n.vector[1]),n.label?i.labels.push(n.label.value):i.labels.push("")):(a.type="rect",a.lineColor=SAM.ConvertColor(n.lineColor),a.lineWidth=n.lineWidth,a.origin=n.center,a.width=n.width,a.length=n.height,a.orientation=n.rotation,t.LoadWidget(a))),"polyline"===n.type&&(a.type=n.type,a.closedloop=n.closed,a.lineColor=SAM.ConvertColor(n.lineColor),a.lineWidth=n.lineWidth,a.points=n.points,t.LoadWidget(a))}i.widths.length>0&&t.LoadWidget(i),t.EventuallyDraw()};SAM.GirderStackWidget=t}(),function(){"use strict";function t(t,e,i,o){this.ChipSize=128,this.MaxChips=200,this.Positives=e,this.Negatives=i,this.NumPositives=e.length,this.NumNegatives=i.length;for(var s=0;s<e.length;++s)e[s].positive=!0;for(s=0;s<i.length;++s)i[s].positive=!1;this.Detections=e.concat(i),this.Detections.sort(function(t,e){return e.element.scalar-t.element.scalar}),this.Container=$("<div>").appendTo(t).css({width:"100%","margin-right":"30px"}),this.RocDiv=$("<div>").appendTo(this.Container).css({width:"100%",position:"relative"}),this.LightBoxDiv=$("<div>").appendTo(this.Container).css({width:"100%","min-height":"500px",position:"relative"}),this.FalsePositiveDiv=$("<div>").appendTo(this.LightBoxDiv).css({border:"1px solid #AAA",position:"absolute",left:"0px",width:"50%",top:"0px"}),this.FalseNegativeDiv=$("<div>").appendTo(this.LightBoxDiv).css({position:"absolute",left:"50%",width:"50%",top:"0px"});var n=this;this.SliderDiv=$("<div>").appendTo(this.RocDiv).css({position:"absolute",left:"0px",bottom:"0px",width:"100%","z-index":"10"}).hover(function(){n.SliderDiv.focus()},function(){n.SliderDiv.blur()}),this.SliderDiv.slider({start:function(t,e){},slide:function(t,e){var i=1-e.value/100;n.UpdateThreshold(i)},stop:function(t,e){}}),this.DrawGraph(),this.InitializeChips(),this.UpdateThreshold(1)}var e="not loaded";t.prototype.UpdateThreshold=function(t){var e=0,i=0,o=0;for(e=0;e<this.Points.length;++e)if(this.Points[e][2]<t){i=this.Points[e][0],o=this.Points[e][1];break}for(console.log(t),i=this.XScale(i),o=this.YScale(o),this.Dot.attr("cx",i).attr("cy",o),this.ThreshLabel.attr("x",i).attr("y",o).text(t.toFixed(2)),e=0;e<this.Detections.length;++e){var s=this.Detections[e];s.imgDiv&&(s.positive?s.element.scalar<=t?s.imgDiv.show():s.imgDiv.hide():s.element.scalar>=t?s.imgDiv.show():s.imgDiv.hide())}},t.prototype.GetImageUrl=function(t,e,i,o,s,n){var a=40*n/s;return a>40&&(a=40),"api/v1/item/"+t+"/tiles/region?magnification="+a+"&left="+e+"&top="+i+"&regionWidth="+o+"&regionHeight="+s+"&units=base_pixels&exact=false&encoding=JPEG&jpegQuality=95&jpegSubsampling=0"},t.prototype.InitializeChips=function(){this.Positives.sort(function(t,e){return t.element.scalar-e.element.scalar}),this.Negatives.sort(function(t,e){return e.element.scalar-t.element.scalar}),this.Positives=this.Positives.slice(0,this.MaxChips),this.Negatives=this.Negatives.slice(0,this.MaxChips);for(var t=0;t<this.Positives.length;++t)this.CreateChip(this.Positives[t],this.FalseNegativeDiv);for(t=0;t<this.Negatives.length;++t)this.CreateChip(this.Negatives[t],this.FalsePositiveDiv)},t.prototype.CreateChip=function(t,e){var i=t.imageId,o=t.element;if("rectangle"===o.type){var s=Math.round(o.center[0]-o.width/2),n=Math.round(o.center[1]-o.height/2),a=$("<div>").appendTo(e).addClass("img-div").css({height:(this.ChipSize+8).toString()+"px",width:(this.ChipSize+8).toString()+"px",margin:"1px",display:"inline-block",position:"relative",cursor:"crosshair",border:"4px solid #EEE"}).attr("tabindex","0"),r=$("<img>").appendTo(a).addClass("img-chip").css({height:this.ChipSize.toString()+"px",width:this.ChipSize.toString()+"px",cursor:"crosshair"}).attr("tabindex","0").prop("src",this.GetImageUrl(i,s,n,920,920,this.ChipSize));t.imgDiv=a,t.img=r}},t.prototype.DrawGraph=function(){this.Points=[];for(var t=0,i=0,o=Math.round(this.Detections.length/100),s=0;s<this.Detections.length;++s){var n=this.Detections[s];0!==o&&s%o!=0||this.Points.push([t,i,n.element.scalar]),n.positive?++i:++t}this.Points.push([t,i]);var a={top:20,right:20,bottom:50,left:70},r=600-a.left-a.right,h=400-a.top-a.bottom,l=e.scale.linear().domain([0,this.NumNegatives]).range([0,r]),d=e.scale.linear().domain([0,this.NumPositives]).range([h,0]),u=e.svg.axis().scale(l).orient("bottom").ticks(5),p=e.svg.axis().scale(d).orient("left").ticks(5),c=e.select(this.RocDiv[0]).append("svg").attr("width",r+a.left+a.right).attr("height",h+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")"),f=e.svg.line().x(function(t){return l(t[0])}).y(function(t){return d(t[1])});c.append("path").attr("class","line").attr("fill","none").attr("stroke","blue").attr("d",f(this.Points)),c.append("g").attr("class","x axis").attr("stroke-width","1").attr("transform","translate(0,"+h+")").call(u).append("text").style("text-anchor","end").attr("transform","translate("+r+", 0)").attr("dy","-.55em").text("False Positives"),c.append("g").attr("class","y axis").attr("stroke-width","1").call(p).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("True Positives"),this.XScale=l,this.YScale=d,this.Dot=c.append("circle").attr("cx","0").attr("cy",h.toString()).attr("r","30").attr("stroke","black").attr("stroke-width","1").attr("fill","yellow").attr("r","10"),this.ThreshLabel=c.append("text").attr("x","0").attr("y","0").attr("dy","-20").style("text-anchor","middle").text("0.0")},SAM.GirderRocWidget=t}(),function(){"use strict";function t(t,e){this.Viewport=[0,0,100,100],this.ShapeList=[],this.Camera=new SAM.Camera,this.OutlineColor=[0,.5,0],this.OutlineMatrix=mat4.create(),this.OutlineCamMatrix=mat4.create(),this.Parent=t,this.Parent=t||$("<div>"),this.Canvas=$("<canvas>"),e||(this.Context2d=this.Canvas[0].getContext("2d")),this.Canvas.appendTo(this.Parent).css({position:"absolute",left:"0%",top:"0%",width:"100%",height:"100%"}),this.Parent.addClass("sa-view-canvas-div")}function e(){this.IncX=1,this.IncY=1}t.prototype.Delete=function(){this.Parent.off("mousedown.viewer"),this.Parent.off("mousemove.viewer"),this.Parent.off("wheel.viewer"),this.Parent.off("touchstart.viewer"),this.Parent.off("touchmove.viewer"),this.Parent.off("touchend.viewer"),this.Parent.off("keydown.viewer"),this.Parent.off("wheel.viewer"),delete this.ShapeList,delete this.Camera,delete this.Parent,delete this.Canvas},t.prototype.GetCamera=function(){return this.Camera},t.prototype.SetCamera=function(t){this.Camera=t},t.prototype.GetImageData=function(){var t=this.Camera,e=Math.floor(t.ViewportWidth),i=Math.floor(t.ViewportHeight),o=this.Context2d.getImageData(0,0,e,i);return o.Camera=new SAM.Camera,o.Camera.DeepCopy(this.Camera),Object.setPrototypeOf(o,new SAM.ImageData),o.IncX=4,o.width=e,o.height=i,o.IncY=o.IncX*o.width,o},t.prototype.GetPixelsPerUnit=function(){var t=this.Camera.GetWorldMatrix();return.5*this.Viewport[2]/(t[3]+t[15])},t.prototype.HasUnits=function(){var t=this.GetCache();return!!(t&&t.Image&&t.Image.units)&&"Units"!==t.Image.units},t.prototype.GetMetersPerUnit=function(){var t,e=this.GetCache();return t=e?{value:e.Image.spacing[0],units:e.Image.units}:{value:250,units:"nm"},SAM.ConvertToMeters(t),t.value},t.prototype.GetViewport=function(){return this.Viewport},t.prototype.GetWidth=function(){return this.Parent.width()},t.prototype.GetHeight=function(){return this.Parent.height()},t.prototype.UpdateSize=function(){this.UpdateCanvasSize()},t.prototype.UpdateCanvasSize=function(){if(!this.Parent.is(":visible"))return!1;var t=this.Parent.position(),e=this.Parent.width(),i=this.Parent.height();return!(e<=0||i<=0)&&(this.SetViewport([t.left,t.top,e,i]),!0)},t.prototype.SetViewport=function(t){var e=t[2],i=t[3];this.Canvas.attr("width",e.toString()),this.Canvas.attr("height",i.toString()),this.Viewport=t,this.Camera.SetViewport(t)},t.prototype.CaptureImage=function(){var t=this.Canvas[0].toDataURL(),e=document.createElement("img");return e.src=t,e},t.prototype.AddShape=function(t){this.ShapeList.push(t)},t.prototype.DrawShapes=function(){if(this.Parent.is(":visible"))for(var t=0;t<this.ShapeList.length;t++)this.ShapeList[t].Draw(this)},t.prototype.Clear=function(){this.Context2d.save(),this.Context2d.setTransform(1,0,0,1,0,0),this.Context2d.clearRect(0,0,this.Viewport[2],this.Viewport[3]),this.Context2d.restore()},t.prototype.DrawHistory=function(t){if(this.gl)alert("Drawing history does not work with webGl yet.");else{var e=this.Context2d;e.save(),e.setTransform(1,0,0,1,0,0),e.setTransform(1,0,0,-1,0,this.Viewport[3]),e.transform(.5*this.Viewport[2],0,0,.5*this.Viewport[3],.5*this.Viewport[2],.5*this.Viewport[3]);var i=this.Camera,o=i.GetWorldMatrix(),s=1/o[15];e.transform(o[0]*s,o[1]*s,o[4]*s,o[5]*s,o[12]*s,o[13]*s);for(var n=SA.recorderWidget.TimeLine,a=0;a<n.length;++a){var r=(i=n[a].ViewerRecords[0].Camera).Height,h=i.Width,l=Math.cos(i.GetWorldRoll()),d=Math.sin(i.GetWorldRoll());e.save();var u=i.GetWorldFocalPoint();e.transform(l,-d,d,l,u[0],u[1]);var p=2*t/r;p>1&&(p=1),e.fillStyle="rgba(0,128,0,"+p+")",e.fillRect(-h/2,-r/2,h,r),e.stroke(),e.restore()}e.restore()}},t.prototype.DrawFocalPoint=function(){if(this.gl)alert("Drawing focal point does not work with webGl yet.");else{var t=.5*this.Viewport[2],e=.5*this.Viewport[3],i=this.Context2d;i.save(),i.setTransform(1,0,0,1,0,0),i.strokeStyle="rgba(255,255,200,100)",i.fillStyle="rgba(0,0,50,100)",i.beginPath(),i.fillRect(t-30,e-1,60,3),i.rect(t-30,e-1,60,3),i.fillRect(t-1,e-30,3,60),i.rect(t-1,e-30,3,60);var o=e/2;i.beginPath(),i.moveTo(t-o,e-o+30),i.lineTo(t-o,e-o),i.lineTo(t-o+30,e-o),i.moveTo(t+o,e-o+30),i.lineTo(t+o,e-o),i.lineTo(t+o-30,e-o),i.moveTo(t+o,e+o-30),i.lineTo(t+o,e+o),i.lineTo(t+o-30,e+o),i.moveTo(t-o,e+o-30),i.lineTo(t-o,e+o),i.lineTo(t-o+30,e+o),i.stroke(),++o,i.beginPath(),i.strokeStyle="rgba(0,0,50,100)",i.moveTo(t-o,e-o+30),i.lineTo(t-o,e-o),i.lineTo(t-o+30,e-o),i.moveTo(t+o,e-o+30),i.lineTo(t+o,e-o),i.lineTo(t+o-30,e-o),i.moveTo(t+o,e+o-30),i.lineTo(t+o,e+o),i.lineTo(t+o-30,e+o),i.moveTo(t-o,e+o-30),i.lineTo(t-o,e+o),i.lineTo(t-o+30,e+o),i.stroke(),i.restore()}},t.prototype.DrawCorrelations=function(t,e){if(this.gl)alert("Drawing correlations does not work with webGl yet.");else{var i=this.Context2d;i.save(),i.setTransform(1,0,0,1,0,0),i.strokeStyle="rgba(200,255,255,100)",i.fillStyle="rgba(255,0,0,100)";for(var o=0;o<t.length;++o){var s=t[o].GetPoint(e),n=this.Camera.GetWorldMatrix(),a=(s[0]*n[0]+s[1]*n[4]+n[12])/n[15],r=(s[0]*n[1]+s[1]*n[5]+n[13])/n[15];a=(1+a)*this.Viewport[2]*.5,r=(1-r)*this.Viewport[3]*.5,i.beginPath(),i.fillRect(a-20,r-1,40,3),i.rect(a-20,r-1,40,3),i.fillRect(a-1,r-20,3,40),i.rect(a-1,r-20,3,40),i.stroke()}i.restore()}},t.prototype.DrawCopyright=function(t){if(void 0!==t)if(this.gl);else{this.Context2d.setTransform(1,0,0,1,0,0),this.Context2d.font="18px Arial";var e=.5*this.Viewport[2]-50,i=this.Viewport[3]-10;this.Context2d.fillStyle="rgba(128,128,128,0.5)",this.Context2d.fillText(t,e,i)}},t.prototype.DrawOutline=function(t){if(this.gl){var e=SA.polyProgram;this.gl.useProgram(e),this.gl.viewport(this.Viewport[0],this.Viewport[3]-this.Viewport[1],this.Viewport[2],this.Viewport[3]),mat4.identity(this.OutlineCamMatrix),this.OutlineCamMatrix[0]=2,this.OutlineCamMatrix[5]=2,this.OutlineCamMatrix[10]=0,this.OutlineCamMatrix[12]=-1,this.OutlineCamMatrix[13]=-1;var i=this.Camera.ZRange[0]+.001,o=this.Camera.ZRange[1]-.001;this.OutlineCamMatrix[14]=i,mat4.identity(this.OutlineMatrix),this.gl.uniformMatrix4fv(e.mvMatrixUniform,!1,this.OutlineMatrix),t&&(this.OutlineCamMatrix[14]=o,this.gl.uniformMatrix4fv(e.pMatrixUniform,!1,this.OutlineCamMatrix),this.gl.uniform3f(e.colorUniform,1,1,1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,SA.squarePositionBuffer),this.gl.vertexAttribPointer(e.vertexPositionAttribute,SA.squarePositionBuffer.itemSize,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,SA.squarePositionBuffer.numItems)),this.OutlineCamMatrix[14]=i,this.gl.uniformMatrix4fv(e.pMatrixUniform,!1,this.OutlineCamMatrix),this.gl.uniform3f(e.colorUniform,this.OutlineColor[0],this.OutlineColor[1],this.OutlineColor[2]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,SA.squareOutlinePositionBuffer),this.gl.vertexAttribPointer(e.vertexPositionAttribute,SA.squareOutlinePositionBuffer.itemSize,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.LINE_STRIP,0,SA.squareOutlinePositionBuffer.numItems)}},e.prototype.GetIntensity=function(t,e){if(!this.data)return 0;t=Math.round(t),e=Math.round(e);var i=t*this.IncX+e*this.IncY;return(this.data[i]+this.data[i+1]+this.data[i+2])/3},e.prototype.InBounds=function(t,e){return!!this.data&&(t>=0&&t<this.width&&e>=0&&e<this.height)},e.prototype.MarkEdge=function(t,e,i,o){if(!this.EdgeMarks){var s=Math.round(this.width*this.height);this.EdgeMarks=new Array(s);for(var n=0;n<s;++n)this.EdgeMarks[n]=0}var a=0;t!==i?a=t<i?1:4:e!==o&&(a=e<o?2:8);var r=t+e*this.width,h=this.EdgeMarks[r];return!!(h&a)||(this.EdgeMarks[r]=h|a,!1)},SAM.ImageData=e,SAM.View=t}(),function(){"use strict";function t(t,e){this.Viewer=t,this.Parent=t.GetDiv(),this.ItemId=e,this.LayerGuis=[],this.ModifiedCount=0,this.EditingLayerGui=void 0,this.Viewer.ScaleOn(),this.RestoreVisibilityFromLocalStorage(),this.Margin=6,this.ToolDivHeight=70,this.Div=$("<div>").appendTo(this.Parent).attr("id","saAnnotationPanel").hover(function(){$(this).css({opacity:"1"})},function(){$(this).css({opacity:"0.6"})}).css({position:"absolute",left:"3px",top:5*this.Margin+this.ToolDivHeight+"px",bottom:2*this.Margin+"px",opacity:"0.6","z-index":"2"}),this.Parent=t.GetDiv(),this.InitializeHelp(this.Parent.parent()),e&&(this.InitializeNavigation(t.GetDiv(),e),this.Initialize(this.Div,e)),this.Viewer.AddLayer(this)}t.prototype.TestUploadFile=function(t){var e=this;girder.rest.restRequest({url:"item/"+t.item_id+"/files",method:"GET"}).done(function(i){for(var o=0;o<i.length;++o)if(i[o].name===t.name){t.file_id=i[o]._id;break}e.TestUploadFile2(t)})},t.prototype.TestUploadFile2=function(t){var e,i=this;"file_id"in t?(e={size:t.data.length},girder.rest.restRequest({url:"file/"+t.file_id+"/contents",params:e,method:"PUT"}).done(function(e){t.upload_id=e._id,i.TestUploadFile3(t)})):(e={parentType:"item",parentId:t.item_id,name:"test.txt",size:t.data.length,mimeType:"text/plain"},girder.rest.restRequest({url:"file",params:e,method:"POST"}).done(function(e){t.upload_id=e._id,i.TestUploadFile3(t)}))},t.prototype.TestUploadFile3=function(t){var e={offset:0,uploadId:t.upload_id};girder.rest.restRequest({url:"file/chunk",params:e,method:"POST",data:t.data}).done(function(t){console.log("upload sucessful "+t._id)})},t.prototype.UpdateSize=function(){for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t].layer;e&&e.UpdateSize&&e.UpdateSize()}},t.prototype.Draw=function(){for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t].Layer;e&&e.Draw&&e.Draw()}},t.prototype.Reset=function(){for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t].layer;e&&e.Reset&&e.Reset()}},t.prototype.InitializeNavigation=function(t,e){var i=this;new SA.GirderNavigationWidget(t,e).SetChangeItemCallback(function(t){i.ChangeItem(t)})},t.prototype.WithEditingLayerCall=function(t){this.EditingLayerGui||(this.EditingLayerGui=this.GetDefaultLayerGui());var e=this.EditingLayerGui;e.AfterLoad(function(){e.DisplayAnnotation(),e.EditOn(),t(e)})},t.prototype.InitializeHelp=function(t){var e=$("<div>").appendTo(t).css({position:"absolute",left:"3px",top:"3px","min-height":"300px","min-width":"200px","background-color":"#fff",border:"1px solid #666666","z-index":"400"}).hide().on("mouseleave",function(t){e.hide()});$("<div>").appendTo(e).prop("title","close").addClass("sa-view-button").css({position:"absolute",right:"3px",top:"3px",height:"24px",color:"#000","z-index":"300"}).text("close").on("click touchend",function(t){e.hide()});var i=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(i).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"fullScreen32.png").css({height:"24px"}),$("<p>").appendTo(i).css({display:"inline-block"}).text("Expand the viewer to fullscreen.");var o=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(o).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"fullScreenOff32.png").css({height:"24px"}),$("<p>").appendTo(o).css({display:"inline-block"}).text("Exit fullscreen");var s=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(s).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"Text.png").css({height:"24px"}),$("<p>").appendTo(s).css({display:"inline-block"}).text("Text tool: Select text to drag it.");var n=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(n).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"Arrow.png").css({height:"24px"}),$("<p>").appendTo(n).css({display:"inline-block"}).text("Arrow tool: draw an arrow. Mouse press places the tip. Mouse drag places the end.");var a=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(a).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"Pencil-icon.png").css({height:"24px"}),$("<p>").appendTo(a).css({display:"inline-block"}).text("Pencil tool: draw lines on the slide. Click on a line to select it.");var r=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(r).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"open_lasso.png").css({height:"24px","margin-left":"24px"}),$("<p>").appendTo(r).css({display:"inline-block"}).text("Open pencil mode: Simple open strokes.");var h=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(h).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"select_lasso.png").css({height:"24px","margin-left":"24px"}),$("<p>").appendTo(h).css({display:"inline-block"}).text("Closed pencil mode: Draw closed loops that can be modified with subsequent strokes. Editing strokes must cross the loop twice."),$("<hr>").appendTo(e),$("<p>").appendTo(e).css({display:"inline-block"}).text("Click on any annotation to select it. The delete key deletes selected annotations. When one annotation is selected it can be edited.");var l=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(l).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"rect_select.png").css({height:"24px"}),$("<p>").appendTo(l).css({display:"inline-block"}).text("The rectancle selection tool allows multiple annotations to be selected at once.");var d=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(d).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"Menu.jpg").css({height:"24px"}),$("<p>").appendTo(d).css({display:"inline-block"}).text("Show the selected annotation's property dialog."),$("<hr>").appendTo(e);var u=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(u).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"AnnotationButton.jpg").css({height:"24px"}),$("<p>").appendTo(u).css({display:"inline-block"}).text("Annotation buttons represent markup collections. YOu can click the name to change it.");var p=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(p).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"eyeClosed32.png").css({height:"24px","margin-left":"24px"}),$("<img>").appendTo(p).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"eyeOpen32.png").css({height:"24px"}),$("<p>").appendTo(p).css({display:"inline-block"}).text("The visibility toggle hides or shows all the markups in the annotation group.");var c=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(c).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"edit_up.png").css({height:"24px","margin-left":"24px"}),$("<img>").appendTo(c).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"edit_down.png").css({height:"24px"}),$("<p>").appendTo(c).css({display:"inline-block"}).text("The edit toggle selects a single annotation group for editing.");var f=$("<div>").appendTo(e).css({width:"100%"});$("<img>").appendTo(f).addClass("sa-view-button").attr("src",SA.ImagePathUrl+"remove.png").css({height:"24px","margin-left":"24px"}),$("<p>").appendTo(f).css({display:"inline-block"}).text("Delete a selected annotation. If no annotation is selected, the whole annotation group will be deleted."),$("<img>").appendTo(t).prop("title","help").addClass("sa-view-button").attr("src",SA.ImagePathUrl+"question32.png").css({position:"absolute",left:"35px",top:"2px",height:"24px","z-index":"300"}).on("click touchend",function(t){e.show()})},t.prototype.ChangeItem=function(t){var e=this;this.ItemId=t;var i=this.LocalStorageVisibleAnnotationNames.splice(0);this.DeleteAnnotationButtons(),this.LocalStorageVisibleAnnotationNames=i,this.Initialize(this.Div,t),girder.rest.restRequest({url:"item/"+t+"/tiles",method:"GET"}).done(function(i){e.LoadItemToViewer(t,i)})},t.prototype.DeleteAnnotationButtons=function(){this.EditingLayerGui=void 0;for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t];e.EditOff(),e.VisibilityOff(),e.Div&&e.Div.remove()}this.LayerGuis=[]},t.prototype.RestoreVisibilityFromLocalStorage=function(){this.LocalStorageVisibleAnnotationNames=[];var t=localStorage.getItem("SAAnnotationVisibility");t&&(this.LocalStorageVisibleAnnotationNames=JSON.parse(t))},t.prototype.SaveVisibilityInLocalStorage=function(){for(var t=this.LocalStorageVisibleAnnotationNames,e=0;e<this.LayerGuis.length;++e){var i=this.LayerGuis[e],o=i.Name,s=t.indexOf(o);i.Visible&&-1===s&&t.push(i.Name),i.Visible||-1===s||t.splice(s,1)}localStorage.setItem("SAAnnotationVisibility",JSON.stringify(t)),this.LocalStorageVisibleAnnotationNames=t},t.prototype.LoadItemToViewer=function(t,e){var i={height:e.sizeY,width:e.sizeX,tileWidth:e.tileWidth,tileHeight:e.tileHeight,minLevel:0,maxLevel:e.levels-1,units:"mm",spacing:[e.mm_x,e.mm_y],getTileUrl:function(e,i,o,s){return"api/v1/item/"+t+"/tiles/zxy/"+e+"/"+i+"/"+o}};e.mm_x||(i.spacing=[1,1]);var o=SA.TileSourceToNote(i);this.Viewer.SetNote(o,0,!0)},t.prototype.Initialize=function(t,e){this.ScrollDiv=$("<div>").appendTo(t).attr("id","saAnnotationButtons").css({direction:"rtl","overflow-y":"auto"}),this.ButtonDiv=$("<div>").appendTo(this.ScrollDiv).on("mousemove touchmove",function(){return!0}).css({direction:"ltr"});var i=this;girder.rest.restRequest({url:"user/me",method:"GET"}).done(function(t){i.UserData=t||{_id:"0000",login:"guest"},e&&i.RequestGirderImageItem(e)})},t.prototype.RequestGirderImageItem=function(t){var e={limit:50,offset:0,sort:"lowerName",sortdir:0},i=this;girder.rest.restRequest({url:"annotation?itemId="+t,method:"GET",data:JSON.stringify(e)}).done(function(t){i.LoadGirderItemAnnotations(t)})},t.prototype.LoadGirderItemAnnotations=function(t){for(var e=0;e<t.length;++e){var i=new SAM.AnnotationLayerGui(t[e],this);this.LayerGuis.push(i)}if(this.ItemId){var o=this;girder.rest.restRequest({url:"item/"+this.ItemId,method:"GET"}).done(function(t){o.CheckItemDataAccessTools(t)})}},t.prototype.CheckItemDataAccessTools=function(t){var e=this;girder.rest.restRequest({url:"folder/"+t.folderId,method:"GET"}).done(function(t){e.CheckFolderDataAccessTools(t)})},t.prototype.CheckFolderDataAccessTools=function(t){0!==t._accessLevel&&this.InitializeDefaultToolPanel()},t.prototype.InitializeDefaultToolPanel=function(){this.DefaultToolPanel=new SAM.AnnotationToolPanel(this),this.DefaultToolPanel.Show()},t.prototype.GetDefaultLayerName=function(){return this.UserData.login},t.prototype.GetDefaultLayerGui=function(){for(var t,e=this.GetDefaultLayerName(),i=0;i<this.LayerGuis.length;++i)if((t=this.LayerGuis[i]).Name===e)return t;return t=new SAM.AnnotationLayerGui({annotation:{name:e},creatorId:this.UserData._id},this),this.LayerGuis.push(t),t},t.prototype.UpdateSize=function(){for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t].layer;e&&e.UpdateSize&&e.UpdateSize()}},t.prototype.Draw=function(){for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t].Layer;e&&e.Draw&&e.Draw()}},t.prototype.Reset=function(){for(var t=0;t<this.LayerGuis.length;++t){var e=this.LayerGuis[t].layer;e&&e.Reset&&e.Reset()}},t.prototype.HandleTouchStart=function(t){if(this.CheckForIPadPencil(t))return this.WithEditingLayerCall(function(e){e.SelectedWidgets=[e.Layer.GetIPadPencilWidget()],e.Layer.HandleTouchStart(t)}),!1;if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleTouchStart)return e.HandleTouchStart(t)}return!0},t.prototype.HandleTouchMove=function(t){if(this.CheckForIPadPencil(t),this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleTouchMove)return e.HandleTouchMove(t)}return!0},t.prototype.HandleTouchEnd=function(t){if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleTouchEnd)return this.EditingLayerGui.UpdateToolVisibility(),e.HandleTouchEnd(t)}return!0},t.prototype.HandleMouseDown=function(t){if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleMouseDown)return e.HandleMouseDown(t)}return!0},t.prototype.HandleMouseUp=function(t){if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleMouseUp)return e.HandleMouseUp(t)}return!0},t.prototype.HandleMouseMove=function(t){if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleMouseMove)return e.HandleMouseMove(t)}return!0},t.prototype.HandleMouseWheel=function(t){if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleMouseWheel)return e.HandleMouseWheel(t)}return!0},t.prototype.HandleKeyDown=function(t){if(!this.EditingLayerGui)return!0;var e=this.EditingLayerGui.Layer;return 46!==t.keyCode&&8!==t.keyCode||!this.EditingLayerGui?!e||!e.HandleKeyDown||e.HandleKeyDown(t):(this.EditingLayerGui.DeleteSelected(),e.EventuallyDraw(),t.preventDefault(),!1)},t.prototype.HandleMouseClick=function(t){if(this.EditingLayerGui){var e=this.EditingLayerGui.Layer;if(e&&e.HandleMouseClick&&!e.HandleMouseClick(t))return!1;var i=[];return e.HandleSelect&&(i=e.HandleSelect(t)),this.EditingLayerGui.SetSelectedWidgets(i),0===i.length}for(var o=0;o<this.LayerGuis.length;++o){var s=this.LayerGuis[o];if((e=s.Layer)&&e.HandleSelect&&(i=e.HandleSelect(t)).length>0)return this.SetEditingLayerGui(s),this.EditingLayerGui.SetSelectedWidgets(i),!1}return!0},t.prototype.SetEditingLayerGui=function(t){this.EditingLayerGui!==t&&(this.DefaultToolPanel.Hide(),this.EditingLayerGui&&(this.EditingLayerGui.GetToolPanel().Hide(),this.EditingLayerGui.EditOff()),void 0===t?this.DefaultToolPanel.Show():t.GetToolPanel().Show(),this.EditingLayerGui=t)},t.prototype.CheckForIPadPencil=function(t,e){if("iPad"===SAM.MOBILE_DEVICE&&t.touches&&1===t.touches.length){var i=t.touches[0];if(i.force&&!isNaN(i.force)&&0!==i.force)return e&&print("event force = "+i.force),t.pencil=!0,this.PencilOpenClosedToggle.show(),!0;e&&(void 0===i.force?print("No force in event"):print("non qualified event force = "+i.force))}return!1},SAM.LayerPanel=t}(),function(){"use strict";function t(t,e){this.LayerPanel=e,this.Viewer=this.LayerPanel.Viewer,this.SelectedWidgets=[],this.ActiveColor="#7CF",this.DefaultColor="#DDD",this.ButtonSize="16px","iPad"===SAM.MOBILE_DEVICE&&(this.ButtonSize="24px");var i=this,o=$("<div>").appendTo(e.ButtonDiv).css({display:"table","min-width":2*this.Radius+"px","min-height":2*this.Radius+"px",margin:"2px","background-color":this.DefaultColor,opacity:"0.7",border:"1px solid #666666","border-radius":"2px"}),s=$("<div>").appendTo(o).css({display:"inline",position:"static","padding-left":"4px","padding-right":"4px"}).text(t.annotation.name);s.hover(function(){$(this).css({"background-color":this.ActiveColor,cursor:"text"})},function(){$(this).css({"background-color":this.DefaultColor,cursor:"pointer"})});var n=$("<img>").appendTo(o).attr("type","image").attr("src",SA.ImagePathUrl+"eyeClosed32.png").css({display:"inline",width:this.ButtonSize,height:this.ButtonSize,cursor:"pointer",position:"static",margin:"1px","background-color":this.DefaultColor,border:"1px solid #555"}),a=$("<img>").appendTo(o).addClass("saEditToggle").attr("type","image").attr("src",SA.ImagePathUrl+"edit_up.png").css({display:"inline",width:this.ButtonSize,height:this.ButtonSize,cursor:"pointer",position:"relative",margin:"1px","background-color":"#fff",border:"1px solid #555"}),r=$("<img>").appendTo(o).attr("type","image").attr("src",SA.ImagePathUrl+"remove.png").css({display:"inline",width:this.ButtonSize,height:this.ButtonSize,cursor:"pointer",position:"relative",color:"red",margin:"1px","background-color":"#DDD",border:"1px solid #555"}).hide();this.GirderAnnotId=t._id,this.CreatorId=t.creatorId,this.Data=void 0,this.Div=o,this.VisToggle=n,this.Visible=!1,this.EditToggle=a,this.Editing=!1,this.NameButton=s,this.DeleteButton=r,this.Name=t.annotation.name,this.Modified=!1,n.on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),a.on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),r.on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),s.on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),n.hover(function(){$(this).css({"background-color":this.ActiveColor})},function(){$(this).css({"background-color":this.DefaultColor})}),n.on("click touchstart",function(){i.Visible?i.VisibilityOff():i.AfterLoad(function(){i.VisibilityOn()})}),a.on("click touchstart",function(){return i.Editing?i.EditOff():i.AfterLoad(function(){i.EditOn()}),!1}),t.creatorId===this.LayerPanel.UserData._id&&(this.EditNameOff(),r.on("click touchstart",function(){return i.DeleteCallback(),!1})),this.LayerPanel.LocalStorageVisibleAnnotationNames.indexOf(this.Name)>-1&&this.AfterLoad(function(){i.VisibilityOn()})}t.prototype.MakeAnnotationLayer=function(t){var e=new SAM.AnnotationLayer(t.GetDiv());e.SetViewer(t),e.SetCamera(t.GetCamera()),e.ScaleWidget.View=this.MainView,e.SetViewer(t),e.UpdateSize(),this.Layer=e;var i=this;return e.SetActivatedCallback(function(){i.EditOn()}),e.SetModifiedCallback(function(){i.AnnotationModified()}),e},t.prototype.GetToolPanel=function(){return this.ToolPanel||(this.Name===this.LayerPanel.GetDefaultLayerName()?this.ToolPanel=this.LayerPanel.DefaultToolPanel:this.Data.annotation.elements.length>0&&this.Data.annotation.elements[0].user&&this.Data.annotation.elements[0].user.imageUrl?this.ToolPanel=new SAM.MaskToolPanel(this.LayerPanel):this.ToolPanel=new SAM.AnnotationToolPanel(this.LayerPanel),this.ToolPanel.SetLayerGui(this)),this.ToolPanel},t.prototype.EditOn=function(){if(this.Editing)this.UpdateToolVisibility();else{this.Editing=!0,this.GetToolPanel();var t=this;this.NameButton.on("click touchstart",function(){return t.AfterLoad(function(){t.EditNameOn()}),!1}),this.EditToggle.attr("src",SA.ImagePathUrl+"edit_down.png"),this.DeleteButton.show(),this.LayerPanel.SetEditingLayerGui(this),this.Div.css({"background-color":this.ActiveColor}),this.VisibilityOn(),this.UpdateToolVisibility()}},t.prototype.EditOff=function(){this.Editing&&(this.Editing=!1,this.EditToggle.attr("src",SA.ImagePathUrl+"edit_up.png"),this.Layer&&(this.Layer.SetSelected(!1),this.Layer.Deactivate(),this.Layer.EventuallyDraw()),this.EditNameOff(),this.NameButton.off("click touchstart"),this.Modified&&this.RecordAndSave(),this.DeleteButton.hide(),this.LayerPanel.EditingLayerGui===this&&(this.Div.css({"background-color":this.DefaultColor}),this.LayerPanel.SetEditingLayerGui(void 0)),this.UpdateToolVisibility())},t.prototype.AnnotationModified=function(){this.Modified||(this.LayerPanel.ModifiedCount+=1),this.Modified=!0,"guest"!==this.LayerPanel.UserData.login&&this.EditToggle.css({"background-color":"#F55"});var t=this;this.SaveTimerId||(console.log("Save in 30 seconds"),this.SaveTimerId=setTimeout(function(){t.RecordAndSave()},3e4)),window.onbeforeunload=function(e){return console.log("Leaving page "+t.LayerPanel.ModifiedCount),!0}},t.prototype.VisibilityOn=function(){this.Visible||(this.Visible=!0,this.VisToggle.attr("src",SA.ImagePathUrl+"eyeOpen32.png"),this.DisplayAnnotation(),this.LayerPanel.SaveVisibilityInLocalStorage())},t.prototype.VisibilityOff=function(){this.Visible&&(this.Visible=!1,this.VisToggle.attr("src",SA.ImagePathUrl+"eyeClosed32.png"),this.Layer.SetVisibility(!1),this.EditOff(),this.LayerPanel.SaveVisibilityInLocalStorage())},t.prototype.EditNameOn=function(){var t=this;this.EditOn(),this.Viewer.InteractionOff(),this.NameButton.off(),this.NameButton.attr("tabindex","1"),this.LayerPanel.Div.on("mousedown.namebutton",function(){t.EditNameOff()}),this.LayerPanel.Div.on("mouseleave.namebutton",function(){t.EditNameOff()}),this.Viewer.GetDiv().on("mousedown.namebutton",function(){t.EditNameOff()}),this.NameButton.attr("contentEditable",!0),this.NameButton.focus()},t.prototype.EditNameOff=function(){var t=this,e=this.NameButton.text();e!==this.Name&&(this.Name=e,this.AnnotationModified()),this.Viewer.InteractionOn(),this.LayerPanel.Div.off("mousedown.namebutton"),this.LayerPanel.Div.off("mouseleave.namebutton"),this.Viewer.GetDiv().off("mousedown.namebutton"),this.NameButton.attr("contentEditable",!1).css({cursor:"pointer"}).on("click touchstart",function(){return t.AfterLoad(function(){t.EditNameOn()}),!1}),this.NameButton.on("mousedown mousemove mouseup touchstart touchend",function(){return!1}),this.Name!==this.LayerPanel.GetDefaultLayerName()&&this.LayerPanel.InitializeDefaultToolPanel()},t.prototype.AfterLoad=function(t){if(void 0!==this.GirderAnnotId)if(this.Data)t();else{var e=this;$("body").css({cursor:"wait"}),girder.rest.restRequest({url:"annotation/"+this.GirderAnnotId,method:"GET",contentType:"application/json"}).done(function(i){$("body").css({cursor:""}),e.Data=i,t()})}else t()},t.prototype.DeleteCallback=function(){this.LayerPanel.EditingLayerGui&&this.Delete()},t.prototype.Delete=function(){if(!this.LayerPanel.EditingLayerGui.Layer.IsSelected()){if(!confirm("Do you want to delete the entire annotation group?"+this.Name))return;if(this.SaveTimerId&&(clearTimeout(this.SaveTimerId),this.SaveTimerId=void 0),this.VisibilityOff(),!this.GirderAnnotId)return void this.DeleteAnnotationGui();var t=this;girder.rest.restRequest({url:"annotation/"+this.GirderAnnotId,method:"DELETE",contentType:"application/json"}).done(function(e){t.DeleteAnnotationGui()})}},t.prototype.DeleteAnnotationGui=function(){this.ToolPanel&&(this.ToolPanel.SetLayerGui(void 0),this.ToolPanel=void 0),this.VisibilityOff(),this.Div.remove();var t=this.LayerPanel.LayerGuis.indexOf(this);this.LayerPanel.LayerGuis.splice(t,1)},t.prototype.DisplayAnnotation=function(){if(!this.Layer){this.MakeAnnotationLayer(this.Viewer).Reset();var t={};if(t.type="rect_set",t.centers=[],t.widths=[],t.heights=[],t.confidences=[],t.labels=[],!this.Data)return;for(var e=this.Data.annotation,i=0;i<e.elements.length;++i){var o=e.elements[i],s={};if("view"===o.type){var n=this.Layer.GetCamera();n.SetWorldFocalPoint(o.center),n.SetHeight(o.height),o.rotation?n.SetWorldRoll(o.rotation):n.SetWorldRoll(0),n.ComputeMatrix(),this.Layer.Viewer&&this.Layer.Viewer.EventuallyRender()}if("circle"===o.type&&this.Layer.LoadWidget(o),"rect"===o.type&&this.Layer.LoadWidget(o),"arrow"===o.type)if(o.label)s.type="text",s.string=o.label.value,s.color=SAM.ConvertColor(o.fillColor),s.size=o.label.fontSize,s.position=o.points[0].slice(0),s.offset=o.points[1].slice(0),s.offset[0]-=s.position[0],s.offset[1]-=s.position[1],s.visibility=o.points[0][2],this.Layer.LoadWidget(s);else{s.type="arrow",s.origin=o.points[0].slice(0),s.fillColor=o.fillColor,s.lineColor=o.lineColor;var a=o.points[1][0]-o.points[0][0],r=o.points[1][1]-o.points[0][1],h=Math.sqrt(a*a+r*r);s.length=h,s.orientation=180*-Math.atan2(r/h,a/h)/Math.PI,void 0!==o.lineWidth?s.width=o.lineWidth:s.width=10,s.fixedsize="false",s.fixedorientation="false",this.Layer.LoadWidget(s)}if("rectanglegrid"===o.type&&(s.type="grid",s.lineColor=SAM.ConvertColor(o.lineColor),s.lineWidth=o.lineWidth,s.origin=o.center,s.bin_width=o.width/o.widthSubdivisions,s.bin_height=o.height/o.heightSubdivisions,s.orientation=o.rotation,s.dimensions=[o.widthSubdivisions,o.heightSubdivisions],this.Layer.LoadWidget(s)),"rectangle"===o.type){this.Layer.LoadWidget(o)}"polyline"===o.type&&(s.type="pencil",s.lineColor=SAM.ConvertColor(o.lineColor),s.lineWidth=o.lineWidth,s.shapes=[o.points],s.closedFlags=[o.closed],this.Layer.LoadWidget(s))}t.widths.length>0&&this.Layer.LoadWidget(t)}this.Layer.SetVisibility(!0),this.Layer.EventuallyDraw()},t.prototype.RecordAndSave=function(){var t=this;if(this.SaveTimerId&&(clearTimeout(t.SaveTimerId),t.SaveTimerId=void 0),this.Data||(this.Data={annotation:{elements:[]}}),this.Data.annotation.elements=this.RecordAnnotation(),this.Data.annotation.name=this.Name,this.EditToggle.css({"background-color":"#FF5"}),this.GirderAnnotId)girder.rest.restRequest({url:"annotation/"+this.GirderAnnotId,method:"PUT",contentType:"application/json",data:JSON.stringify(this.Data.annotation)}).done(function(e){t.AnnotationSaved()});else{if(this.Layer.IsEmpty())return void this.AnnotationSaved();girder.rest.restRequest({url:"annotation?itemId="+this.LayerPanel.ItemId,method:"POST",contentType:"application/json",data:JSON.stringify(this.Data.annotation)}).done(function(e){t.GirderAnnotId=t.Data._id=e._id,t.AnnotationSaved()})}},t.prototype.AnnotationSaved=function(){this.Modified&&(this.LayerPanel.ModifiedCount-=1),this.Modified=!1,this.Div.css({border:"1px solid #666"}),this.EditToggle.css({"background-color":"#FFF"}),0===this.LayerPanel.ModifiedCount&&(window.onbeforeunload=void 0)},t.prototype.RecordAnnotation=function(){var t,e,i,o,s,n=[];for(t=0;t<this.Layer.GetNumberOfWidgets();++t)if(this.Layer.GetWidget(t).Serialize){var a=this.Layer.GetWidget(t).Serialize();if("circle"===a.type&&(s=a),"rectangle"===a.type&&(s=a),"text"===a.type&&((o=[a.position,a.offset])[1][0]+=a.position[0],o[1][1]+=a.position[1],o[0][2]=o[1][2]=a.visibility,(s={type:"arrow",lineWidth:10,fillColor:SAM.ConvertColorToHex(a.color),points:o}).label={value:a.string,fontSize:a.size,color:SAM.ConvertColorToHex(a.color)}),"arrow"===a.type){var r=[a.origin[0],a.origin[1],0],h=[a.origin[0],a.origin[1],0],l=-a.orientation*Math.PI/180;h[0]+=a.length*Math.cos(l),h[1]+=a.length*Math.sin(l),o=[r,h],s={type:"arrow",lineColor:a.lineColor,fillColor:a.fillColor,points:o}}if("grid"===a.type&&(s={type:"rectanglegrid",center:a.origin,width:a.bin_width*a.dimensions[0],height:a.bin_height*a.dimensions[1],rotation:a.orientation,normal:[0,0,1],widthSubdivisions:a.dimensions[0],heightSubdivisions:a.dimensions[1],lineWidth:a.lineWidth,lineColor:a.lineColor}),"rect_set"===a.type){var d=a.widths.length;for(e=0;e<d;++e)s={type:"rectangle",label:{value:a.labels[e]},center:[a.centers[2*e],a.centers[2*e+1],0],height:a.heights[e],width:a.widths[e],rotation:0,scalar:a.confidences[e]},n.push(s);s=void 0}if("polyline"===a.type&&(s={type:"polyline",closed:a.closedloop,lineWidth:a.lineWidth,lineColor:a.lineColor,points:a.points}),"lasso"===a.type&&(s={type:"polyline",closed:!0,lineWidth:a.lineWidth,lineColor:a.lineColor,points:a.points}),"pencil"===a.type)for(i=0;i<a.shapes.length;++i)o=a.shapes[i],s={type:"polyline",closed:a.closedFlags[i],points:o},void 0!==a.lineColor&&(s.lineColor=a.lineColor),void 0!==a.lineWidth&&(s.lineWidth=Math.round(a.lineWidth)),n.push(s),s=void 0;else s&&(n.push(s),s=void 0)}return n},t.prototype.UpdateToolVisibility=function(){this.ToolPanel&&this.ToolPanel.UpdateToolVisibility()},t.prototype.DeleteSelected=function(){if(this.Layer.IsEmpty())this.Delete();else if(this.Layer.DeleteSelected()&&(this.AnnotationModified(),this.Layer.IsEmpty()))this.Delete();else{this.SelectedWidgets=[];var t=this.GetToolPanel();t.ToolRadioButtonCallback(t.CursorButton),this.UpdateToolVisibility(),this.Layer.EventuallyDraw()}},t.prototype.SetSelectedWidgets=function(t){this.SelectedWidgets=[];var e;if(!t||0===t.length)return(e=this.GetToolPanel()).HighlightRadioToolButton(e.CursorButton),this.Viewer.EventuallyRender(),e.UpdateToolVisibility(),!0;this.EditOn();var i=t[0];e=this.GetToolPanel(),"pencil"===i.Type&&(i.IsModeClosed()?e.SetPencilModeToClosed():e.SetPencilModeToOpen(),e.HighlightRadioToolButton(e.PencilButton),i.SetStateToDrawing(this.Layer)),"text"===i.Type&&(i.SetActive(!0),e.HighlightRadioToolButton(e.TextButton)),"arrow"===i.Type&&(e.HighlightRadioToolButton(e.ArrowButton),i.SetActive(!0)),"circle"===i.Type&&(e.HighlightRadioToolButton(e.CircleButton),i.SetActive(!0)),"rect"===i.Type&&(e.HighlightRadioToolButton(e.RectangleButton),i.SetActive(!0)),this.SelectedWidgets=t,e.UpdateToolVisibility()},SAM.AnnotationLayerGui=t}(),function(){"use strict";function t(t){this.LayerPanel=t,this.Viewer=t.Viewer,this.Parent=this.Viewer.GetDiv(),this.Margin=t.Margin,this.ToolDivHeight=t.ToolDivHeight,this.ToolPanel=$("<div>").appendTo(this.Parent.parent()).hover(function(){$(this).css({opacity:"1"})},function(){$(this).css({opacity:"0.6"})}).css({position:"absolute","background-color":"#fff",border:"1px solid #666666",left:"3px",top:5*this.Margin+"px",opacity:"0.6","z-index":"300"}).draggable().hide(),this.ToolDiv=$("<div>").appendTo(this.ToolPanel),this.OptionsDiv=$("<div>").appendTo(this.ToolPanel).attr("id","saAnnotationTools"),this.InitializeTools()}t.prototype.SetLayerGui=function(t){this.LayerGui=t},t.prototype.GetLayerGui=function(){return this.LayerGui||(this.LayerGui=this.LayerPanel.GetDefaultLayerGui()),this.LayerGui},t.prototype.Hide=function(){this.ToolPanel.hide()},t.prototype.Show=function(){this.ToolPanel.show()},t.prototype.InitializeTools=function(){var t=this;this.CursorButton=this.AddToolRadioButton("cursor_arrow.png","CursorOn"),this.TextButton=this.AddToolRadioButton("Text.png","TextButtonOn"),this.ArrowButton=this.AddToolRadioButton("Arrow.png","ArrowButtonOn"),this.CircleButton=this.AddToolRadioButton("Circle.png","CircleButtonOn"),this.RectangleButton=this.AddToolRadioButton("rectangle.gif","RectangleButtonOn"),this.PencilButton=this.AddToolRadioButton("Pencil-icon.png","PencilButtonOn"),this.RectSelectButton=this.AddToolRadioButton("rect_select.png","RectSelectOn"),this.RectSelectButton.hide(),this.CursorButton.css({border:"2px solid #333","background-color":"#bcf"}),this.ActiveToolButton=this.CursorButton,this.PencilOpenClosedState=0,this.PencilOpenClosedToggle=$("<img>").appendTo(this.OptionsDiv).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").css({border:"1px solid #333",width:"28px",height:"28px","background-color":"#fff"}).attr("type","image").prop("title","open/closed").attr("src",SA.ImagePathUrl+"open_lasso.png").on("click touchstart",function(){return t.TogglePencilOpenClosed(),!1}).hide(),this.PencilOpenClosedToggle.on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),this.PencilOpenClosedState=0,this.PencilOpenClosedToggle=$("<img>").appendTo(this.OptionsDiv).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").css({border:"1px solid #333","background-color":"#fff"}).attr("type","image").prop("title","open/closed").attr("src",SA.ImagePathUrl+"open_lasso.png").on("click touchstart",function(){return t.TogglePencilOpenClosed(),!1}).hide(),this.PencilOpenClosedToggle.on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),this.PropertiesDialogButton=$("<img>").appendTo(this.OptionsDiv).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").css({border:"1px solid #333",width:"28px",height:"28px","background-color":"#fff"}).attr("type","image").prop("title","properties").attr("src",SA.ImagePathUrl+"Menu.jpg").on("click touchstart",function(){return t.ShowSelectedWidgetMenu(),!1}).hide().on("mousedown mousemove mouseup touchmove touchend",function(){return!1}),this.LoadDefaults()},t.prototype.AddToolRadioButton=function(t,e){var i=this,o=$("<img>").appendTo(this.ToolDiv).css({border:"2px solid #ccc",margin:"1px","background-color":"#fff",width:"28px",height:"28px"}).attr("type","image").attr("src",SA.ImagePathUrl+t).on("click touchstart",function(){return i.ToolRadioButtonCallback(o),!1}).on("mousedown mousemove mouseup touchmove touchend",function(){return!1});return e&&o.on("radio-on",function(){i.LayerPanel.WithEditingLayerCall(function(t){i.Viewer.InteractionOn(),i[e](t)})}),o},t.prototype.HighlightRadioToolButton=function(t){if(t===this.ActiveToolButton)return!1;this.ActiveToolButton.css({border:"2px solid #ccc","background-color":"#fff"}),t.css({border:"2px solid #222","background-color":"#cdf"}),this.ActiveToolButton=t},t.prototype.ToolRadioButtonCallback=function(t){if(t===this.ActiveToolButton)return!1;this.HighlightRadioToolButton(t),this.LayerPanel.EditingLayerGui&&this.LayerPanel.EditingLayerGui.Layer.InactivateAll(),t.trigger("radio-on"),this.UpdateToolVisibility()},t.prototype.ShowSelectedWidgetMenu=function(){var t=this.GetLayerGui();if(1!==!t.SelectedWidgets.length){var e=t.SelectedWidgets[0];e.SetStateToDialog?e.SetStateToDialog():e.ShowPropertiesDialog()}},t.prototype.UpdateToolVisibility=function(){1===this.GetLayerGui().SelectedWidgets.length?this.PropertiesDialogButton.show():this.PropertiesDialogButton.hide(),this.LayerPanel.EditingLayer&&!this.LayerPanel.EditingLayer.Layer.IsEmpty()?this.RectSelectButton.show():this.RectSelectButton.hide();var t=!1;if(this.LayerPanel.EditingLayer)for(var e=this.LayerPanel.EditingLayer.Layer,i=0;i<e.GetNumberOfWidgets();++i){var o=e.GetWidget(i);if("pencil"===o.Type&&o.IsSelected&&o.IsSelected()){t=!0;break}}this.LayerPanel.EditingLayer&&(this.ActiveToolButton===this.PencilButton||t?this.PencilOpenClosedToggle.show():this.PencilOpenClosedToggle.hide())},t.prototype.LoadDefaults=function(){localStorage.SaAnnotationPanelDefaults&&"closed"===JSON.parse(localStorage.SaAnnotationPanelDefaults).PencilMode&&this.SetPencilModeToClosed()},t.prototype.SaveDefaults=function(){var t={PencilMode:"open"};1===this.PencilOpenClosedState&&(t.PencilMode="closed"),localStorage.SaAnnotationPanelDefaults=JSON.stringify(t)},t.prototype.TogglePencilOpenClosed=function(){1===this.PencilOpenClosedState?this.SetPencilModeToOpen():this.SetPencilModeToClosed(),this.LayerPanel.EditingLayer&&this.LayerPanel.EditingLayer.Layer.EventuallyDraw()},t.prototype.SetPencilModeToOpen=function(){if(0!==this.PencilOpenClosedState){if(this.PencilOpenClosedState=0,this.PencilOpenClosedToggle.attr("src",SA.ImagePathUrl+"open_lasso.png"),this.LayerGui)for(var t=this.LayerGui,e=0;e<t.SelectedWidgets.length;++e){var i=t.SelectedWidgets[e];i.SetModeToOpen&&i.SetModeToOpen(),this.LayerPanel.EditingLayer&&this.LayerPanel.EditingLayer.Layer.EventuallyDraw()}this.SaveDefaults()}},t.prototype.SetPencilModeToClosed=function(){if(1!==this.PencilOpenClosedState){if(this.PencilOpenClosedState=1,this.PencilOpenClosedToggle.attr("src",SA.ImagePathUrl+"select_lasso.png"),this.LayerGui)for(var t=this.LayerGui,e=0;e<t.SelectedWidgets.length;++e){var i=t.SelectedWidgets[e];i.SetModeToClosed&&i.SetModeToClosed(),this.LayerPanel.EditingLayer&&this.LayerPanel.EditingLayer.Layer.EventuallyDraw()}this.SaveDefaults()}},t.prototype.CursorOn=function(){this.LayerPanel.EditingLayer&&this.LayerPanel.EditingLayer.Layer&&(this.LayerPanel.EditingLayer.Layer.SetSelected(!1),this.LayerPanel.EditingLayer.Layer.EventuallyDraw()),this.Viewer.GetParentDiv().css({cursor:""}),this.ActiveToolButton=this.CursorButton,this.LayerGui&&(this.LayerGui.SelectedWidgets=[])},t.prototype.RectSelectOn=function(){var t=this,e=this.LayerPanel.EditingLayer.Layer;e.SetSelected(!1);var i=new SAM.RectSelectWidget(e);i.SetFinishCallback(function(e){t.RectSelectOff(i)}),e.AddWidget(i),e.ActivateWidget(i),i.SetStateToDrawing(e)},t.prototype.RectSelectOff=function(t){for(var e=this.LayerPanel.EditingLayer,i=[],o=e.Layer,s=0;s<o.GetNumberOfWidgets();++s){var n=o.GetWidget(s);n.ApplySelect&&n.ApplySelect(t)&&i.push(n)}o.RemoveWidget(t),o.EventuallyDraw(),e=this.GetLayerGui(),1===i.length?e.SetSelectedWidget(i[0]):(e.SelectedWidgets=i,this.HighlightRadioToolButton(this.CursorButton)),this.UpdateToolVisibility()},t.prototype.TextButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("text")),e||(e=new SAM.TextWidget(i),i.AddWidget(e),e.SetStateToDialog());var o=this;e.SetStateChangeCallback(function(){e.Layer?e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton):(o.GetLayerGui().SelectedWidgets=[],o.ToolRadioButtonCallback(o.CursorButton),o.UpdateToolVisibility())}),this.GetLayerGui().SelectedWidgets=[e]},t.prototype.ArrowButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("arrow")),e||(e=new SAM.ArrowWidget(i),i.AddWidget(e)),e.SetStateToDrawing(i);var o=this;e.SetStateChangeCallback(function(){e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton)}),this.GetLayerGui().SelectedWidgets=[e]},t.prototype.CircleButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("circle")),e||(e=new SAM.CircleWidget(i),i.AddWidget(e)),e.SetStateToDrawing(i);var o=this;e.SetStateChangeCallback(function(){e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton)}),this.GetLayerGui().SelectedWidgets=[e]},t.prototype.RectangleButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("rect")),e||(e=new SAM.RectWidget(i),i.AddWidget(e)),e.SetStateToDrawing(i);var o=this;e.SetStateChangeCallback(function(){e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton)}),this.GetLayerGui().SelectedWidgets=[e]},t.prototype.PencilButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("pencil")),e||(e=new SAM.PencilWidget(i),i.AddWidget(e)),e.SetStateToDrawing(i);var o=this;e.SetStateChangeCallback(function(){e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton)}),0===this.PencilOpenClosedState?e.SetModeToOpen(i):e.SetModeToClosed(i),this.GetLayerGui().SelectedWidgets=[e]},t.prototype.SetTime=function(t){for(var e=0;e<this.AnnotationObjects.length;++e){var i=this.AnnotationObjects[e].Layer;i&&(i.ZTime=t)}},SAM.AnnotationToolPanel=t}(),function(){"use strict";function t(t){this.LayerPanel=t,this.Viewer=t.Viewer,this.Parent=this.Viewer.GetDiv(),this.Margin=t.Margin,this.ToolDivHeight=t.ToolDivHeight,this.ToolPanel=$("<div>").appendTo(this.Parent.parent()).hover(function(){$(this).css({opacity:"1"})},function(){$(this).css({opacity:"0.6"})}).css({position:"absolute","background-color":"#fff",border:"1px solid #666666",left:"3px",top:5*this.Margin+"px",opacity:"0.6","z-index":"300"}).draggable().hide(),this.ToolDiv=$("<div>").appendTo(this.ToolPanel),this.OptionsDiv=$("<div>").appendTo(this.ToolPanel).attr("id","saAnnotationTools"),this.InitializeTools()}t.prototype.SetLayerGui=function(t){this.LayerGui=t},t.prototype.Hide=function(){this.ToolPanel.hide()},t.prototype.Show=function(){this.ToolPanel.show()},t.prototype.InitializeTools=function(){this.CursorButton=this.AddToolRadioButton("cursor_arrow.png","CursorOn"),this.PaintButton=this.AddToolRadioButton("paint64.png","PaintButtonOn"),this.EraseButton=this.AddToolRadioButton("eraser64.png","EraseButtonOn"),this.CursorButton.css({border:"2px solid #333","background-color":"#bcf"}),this.ActiveToolButton=this.CursorButton},t.prototype.AddToolRadioButton=function(t,e){var i=this,o=$("<img>").appendTo(this.ToolDiv).css({border:"2px solid #ccc",margin:"1px","background-color":"#fff",width:"28px",height:"28px"}).attr("type","image").attr("src",SA.ImagePathUrl+t).on("click touchstart",function(){return i.ToolRadioButtonCallback(o),!1}).on("mousedown mousemove mouseup touchmove touchend",function(){return!1});return e&&o.on("radio-on",function(){i.LayerPanel.WithEditingLayerCall(function(t){i[e](t)})}),o},t.prototype.HighlightRadioToolButton=function(t){if(t===this.ActiveToolButton)return!1;this.ActiveToolButton.css({border:"2px solid #ccc","background-color":"#fff"}),t.css({border:"2px solid #222","background-color":"#cdf"}),this.ActiveToolButton=t},t.prototype.ToolRadioButtonCallback=function(t){if(t===this.ActiveToolButton)return!1;this.HighlightRadioToolButton(t),this.LayerPanel.EditingLayer&&this.LayerPanel.EditingLayer.Layer.InactivateAll(),t.trigger("radio-on"),this.UpdateToolVisibility()},t.prototype.UpdateToolVisibility=function(){console.log("UpdateToolVisibility not needed here.  Does it have to be called?")},t.prototype.CursorOn=function(){this.LayerPanel.EditingLayer&&this.LayerPanel.EditingLayer.Layer&&(this.LayerPanel.EditingLayer.Layer.SetSelected(!1),this.LayerPanel.EditingLayer.Layer.EventuallyDraw()),this.Viewer.GetParentDiv().css({cursor:""}),this.ActiveToolButton=this.CursorButton,this.LayerGui.SelectedWidgets=[]},t.prototype.PaintButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("paint")),e||(e=new SAM.PaintWidget(i),i.AddWidget(e),e.SetCreationCamera(i.GetCamera())),e.SetStateToDrawing(i);var o=this;e.SetStateChangeCallback(function(){e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton)}),this.LayerGui.SelectedWidgets=[e]},t.prototype.EraseButtonOn=function(t){t.EditOn();var e,i=t.Layer;e||(e=i.GetASelectedWidget("erase")),e||(e=new SAM.EraseWidget(i),i.AddWidget(e),e.SetCreationCamera(i.GetCamera())),e.SetStateToDrawing(i);var o=this;e.SetStateChangeCallback(function(){e.GetActive()||o.ToolRadioButtonCallback(o.CursorButton)}),this.LayerGui.SelectedWidgets=[e]},t.prototype.SetTime=function(t){for(var e=0;e<this.AnnotationObjects.length;++e){var i=this.AnnotationObjects[e].Layer;i&&(i.ZTime=t)}},SAM.MaskToolPanel=t}(),window.SA=window.SA||{},function(){"use strict";SA.setCookie=function(t,e,i){var o=new Date;o.setDate(o.getDate()+i);var s=escape(e)+(null===i?"":"; expires="+o.toUTCString());document.cookie=t+"="+s},SA.getCookie=function(t){var e,i,o,s=document.cookie.split(";");for(e=0;e<s.length;e++)if(i=s[e].substr(0,s[e].indexOf("=")),o=s[e].substr(s[e].indexOf("=")+1),(i=i.replace(/^\s+|\s+$/g,""))===t)return unescape(o)}}(),function(){"use strict";function t(t,e){this.InitializeItemId(e),this.ChangeItemCallback=void 0,this.ItemIndex=-1,this.FolderItemIds=void 0;var i=this,o="40px";if(SAM.detectMobile()){this.Tab={},this.Tab.Panel=$("<div>").appendTo(t).hide().addClass("ui-responsive").css({position:"absolute",right:"150px",bottom:"20px","z-index":"5"});var s=this.Tab.Panel;this.Tab.show=function(){s.show()},this.Tab.hide=function(){s.hide()}}else this.Tab=new SA.Tab(t,SA.ImagePathUrl+"nav.png","navigationTab"),this.Tab.Div.css({"box-sizing":"border-box","`position":"absolute",bottom:"0px",right:"150px","z-index":"200"}),this.Tab.Panel.addClass("sa-view-navigation-panel").css({overflow:"hidden"}),this.NoteDisplay=$("<div>").appendTo(this.Tab.Div).addClass("sa-view-note").html("");this.PreviousSlideButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"previousSlide.png").click(function(){i.PreviousSlide()}),this.PreviousNoteButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"previousNote.png").click(function(){i.PreviousNote()}),this.NextNoteButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"nextNote.png").click(function(){i.NextNote()}),this.NextSlideButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"nextSlide.png").css({"z-index":"100"}).click(function(){i.NextSlide()}),this.NextSlideButton.on("touchend",function(t){return i.NextSlide(),!1}),this.NameLabel=$("<div>").appendTo(this.Tab.Panel).css({"font-size":"10px",position:"relative",top:"-3px"}),SAM.MOBILE_DEVICE&&(o="80px","iPhone"===SAM.MOBILE_DEVICE&&(o="100px"),this.PreviousSlideButton.css({height:o,width:o,opacity:"0.8"}).on("touchend",function(){i.PreviousSlide()}),this.PreviousNoteButton.css({height:o,width:o,opacity:"0.8"}).on("touchend",function(){i.PreviousNote()}),this.NextNoteButton.css({height:o,width:o,opacity:"0.8"}).on("touchend",function(){i.NextNote()}),this.NextSlideButton.css({height:o,width:o,opacity:"0.8"}))}t.prototype.SetChangeItemCallback=function(t){this.ChangeItemCallback=t},t.prototype.ChangeItem=function(){window.history.pushState(this.ItemId,"SlideAtlas viewer "+this.ItemId,"/#item/"+this.ItemId),this.ChangeItemCallback&&this.ChangeItemCallback(this.ItemId)},t.prototype.InitializeItemId=function(t){this.ItemId=t;var e=this;girder.rest.restRequest({url:"item/"+t,method:"GET"}).done(function(i){i&&i.folderId?e.InitializeFolderId(i.folderId):console.log("Could not find item "+t)})},t.prototype.InitializeFolderId=function(t){var e=this;girder.rest.restRequest({url:"item?folderId="+t+"&limit=5000&sort=lowerName&sortdir=1",method:"GET"}).done(function(t){e.LoadFolderItems(t)})},t.prototype.LoadFolderItems=function(t){this.ItemIndex=-1,this.FolderItemIds=[],this.FolderItemNames=[];for(var e=0;e<t.length;++e){var i=t[e]._id;i===this.ItemId&&(this.ItemIndex=e),this.FolderItemIds.push(i),this.FolderItemNames.push(t[e].name)}this.Update()},t.prototype.SetInteractionEnabled=function(t){var e=this;t?this.Display.Parent.on("keydown.navigation",function(t){return e.HandleKeyDown(t)}):this.Display.Parent.off("keydown.navigation")},t.prototype.HandleKeyDown=function(t){var e=t.keyCode;return 34===e?(this.NextSlide(),!1):78===e||32===e?(this.NextNote(),!1):33===e?(this.PreviousSlide(),!1):80!==e||(this.PreviousNote(),!1)},t.prototype.ToggleVisibility=function(){this.SetVisibility(!this.Visibility)},t.prototype.SetVisibility=function(t){this.Visibility=t,t?this.Tab.show():this.Tab.hide()},t.prototype.Update=function(){this.ItemName=this.FolderItemNames[this.ItemIndex],this.NameLabel.text(this.ItemIndex.toString()+":"+this.ItemName),!this.FolderItemIds||this.ItemIndex<=0?(this.PreviousNoteButton.removeClass("sa-active"),this.PreviousSlideButton.removeClass("sa-active")):(this.PreviousNoteButton.addClass("sa-active"),this.PreviousSlideButton.addClass("sa-active")),!this.FolderItemIds||this.ItemIndex>=this.FolderItemIds.length-1?(this.NextNoteButton.removeClass("sa-active"),this.NextSlideButton.removeClass("sa-active")):(this.NextNoteButton.addClass("sa-active"),this.NextSlideButton.addClass("sa-active"))},t.prototype.PreviousNote=function(){this.FolderItemIds&&(this.ItemIndex<=0||(this.ItemIndex-=1,this.ItemId=this.FolderItemIds[this.ItemIndex],this.ChangeItem(),this.Update()))},t.prototype.NextNote=function(){this.FolderItemIds&&(this.ItemIndex>=this.FolderItemIds.length||(this.ItemIndex+=1,this.ItemId=this.FolderItemIds[this.ItemIndex],this.ChangeItem(),this.Update()))},t.prototype.GetFastIncrement=function(){var t=this.FolderItemIds.length/20;if(t<5)return 5;var e;for(e=10;e<=50;e+=10)if(t<e)return e;for(e=100;e<=500;e+=100)if(t<e)return e;return 1e3},t.prototype.PreviousSlide=function(){if(this.FolderItemIds&&!(this.ItemIndex<=0)){var t=this.GetFastIncrement();this.ItemIndex-=t,this.ItemIndex<0&&(this.ItemIndex=0),this.ItemId=this.FolderItemIds[this.ItemIndex],this.ChangeItem(),this.Update()}},t.prototype.NextSlide=function(){if(this.FolderItemIds&&!(this.ItemIndex>=this.FolderItemIds.length)){var t=this.GetFastIncrement();this.ItemIndex+=t,this.ItemIndex>=this.FolderItemIds.length&&(this.ItemIndex=this.FolderItemIds.length-1),this.ItemId=this.FolderItemIds[this.ItemIndex],this.ChangeItem(),this.Update()}},SA.GirderNavigationWidget=t}(),window.SA=window.SA||{},function(){"use strict";function t(t,e,i){var o;return o=t.createShader(e),t.shaderSource(o,i),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(SA.Debug(t.getShaderInfoLog(o)),null)}function e(t){if(!t.tileVertexTextureCoordinateBuffer){var e=t.gl,i=[],o=[];o.push(0),o.push(0),i.push(0),i.push(0),i.push(0),o.push(1),o.push(0),i.push(1),i.push(0),i.push(0),o.push(0),o.push(1),i.push(0),i.push(1),i.push(0),o.push(1),o.push(1),i.push(1),i.push(1),i.push(0);var s=[];s.push(0),s.push(1),s.push(2),s.push(2),s.push(1),s.push(3),t.tileVertexTextureCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.tileVertexTextureCoordBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),t.tileVertexTextureCoordBuffer.itemSize=2,t.tileVertexTextureCoordBuffer.numItems=o.length/2,t.tileVertexPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.tileVertexPositionBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW),t.tileVertexPositionBuffer.itemSize=3,t.tileVertexPositionBuffer.numItems=i.length/3,t.tileCellBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.tileCellBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(s),e.STATIC_DRAW),t.tileCellBuffer.itemSize=1,t.tileCellBuffer.numItems=s.length}}function i(){SAM.detectMobile()}function o(){$("window").trigger("resize")}function s(t){return SA.HandleKeyDownStack(t)}function n(t){return SA.HandleKeyUpStack(t)}function a(){SA.Edit&&SA.SaveButton&&SA.SaveButton.attr("src",SA.ImagePathUrl+"save.png")}function r(){SA.Edit&&SA.SaveButton&&SA.SaveButton.attr("src",SA.ImagePathUrl+"save22.png")}function h(){SA.notesWidget.SaveCallback(function(){SA.SaveButton.attr("src",SA.ImagePathUrl+"save22.png")})}function l(t){SA.RootNote=t,"Presentation"!==t.Type&&"HTML"!==t.Type?(SAM.detectMobile(),$("body").addClass("sa-view-body"),i(),SAM.detectMobile()&&SA.MOBILE_ANNOTATION_WIDGET&&(SA.MOBILE_ANNOTATION_WIDGET=new SA.MobileAnnotationWidget),SA.MainDiv=$("<div>").appendTo("body").css({position:"fixed",left:"0px",width:"100%"}).saFullHeight(),SA.resizePanel=new SA.ResizePanel(SA.MainDiv),SA.display=new SA.DualViewWidget(SA.resizePanel.MainDiv),SA.notesWidget=new SA.NotesWidget(SA.resizePanel.PanelDiv,SA.display),"Stack"===t.Type&&SA.display.SetNumberOfViewers(2),SA.notesWidget.SetModifiedCallback(a),SA.notesWidget.SetModifiedClearCallback(r),SA.notesWidget.SetNavigationWidget(SA.display.NavigationWidget),SA.display.NavigationWidget&&SA.display.NavigationWidget.SetInteractionEnabled(!0),SA.recorderWidget=new SA.RecorderWidget(SA.display),""===SA.User||SAM.detectMobile()||(SA.Edit?SA.SaveButton=$("<img>").appendTo(SA.resizePanel.MainDiv).css({position:"absolute",bottom:"4px",left:"10px",height:"28px","z-index":"5"}).prop("title","save to databse").addClass("editButton").attr("src",SA.ImagePathUrl+"save22.png").click(h):SA.FAVORITES_WIDGET=new SA.FavoritesWidget(SA.MainDiv,SA.display)),SAM.MOBILE_DEVICE&&SA.DualDisplay&&SA.DualDisplay.NavigationWidget&&SA.DualDisplay.NavigationWidget.SetVisibility(!1),SAM.MOBILE_DEVICE&&SA.MOBILE_ANNOTATION_WIDGET&&SA.MOBILE_ANNOTATION_WIDGET.SetVisibility(!1),document.onkeydown=s,document.onkeyup=n,document.oncontextmenu=SA.cancelContextMenu,SAM.MOBILE_DEVICE||(SA.VIEW_BROWSER=new SA.ViewBrowser($("body")),SA.InitSlideSelector(SA.MainDiv),SA.viewMenu1=new SA.ViewEditMenu(SA.display.Viewers[0],SA.display.Viewers[1]),SA.viewMenu2=new SA.ViewEditMenu(SA.display.Viewers[1],SA.display.Viewers[0]),SA.display.UpdateGui()),SA.SetNote(t),$(window).bind("orientationchange",function(t){o()}),$(window).resize(function(){o()}).trigger("resize"),SA.display&&SA.display.Draw()):SA.presentation=new SA.Presentation(t,SA.Edit)}window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,SA.TileSourceToCache=function(t){var e=t.width,i=t.height;t.bounds||(t.bounds=[0,e-1,0,i-1]);var o=new SA.Cache;o.TileSource=t;var s={levels:t.maxLevel+1,dimensions:[e,i],bounds:t.bounds,units:t.units,spacing:t.spacing,_id:(new ObjectId).toString()};return t.tileHeight&&(s.TileHeight=t.tileHeight),t.tileWidth&&(s.TileWidth=t.tileWidth),t.filename?(s.filename=t.filename,s.label=t.filename):s.label=s._id,o.SetImageData(s),o},SA.TileSourceToViewerRecord=function(t){var e=t.width,i=t.height;t.bounds||(t.bounds=[0,e-1,0,i-1]);var o=SA.TileSourceToCache(t).Image,s=new SA.ViewerRecord;s.Image=o,s.OverViewBounds=t.bounds;var n=t.bounds;return s.Camera={FocalPoint:[(n[0]+n[1])/2,(n[2]+n[3])/2],Roll:0,Height:n[3]-n[2]},s},SA.TileSourceToNote=function(t){var e=new SA.Note,i=SA.TileSourceToViewerRecord(t);return e.ViewerRecords.push(i),e},SA.UpdateUserNotes=function(){SA.notesWidget&&SA.notesWidget.UpdateUserNotes(),SA.display&&SA.display.UpdateUserNotes()},SA.SetNote=function(t){SA.notesWidget&&SA.notesWidget.SetNote(t),SA.navigationWidget&&SA.navigationWidget.SetNote(t),SA.display&&SA.display.SetNote(t)},SA.SetNoteFromId=function(t){var e=SA.GetNoteFromId(t);return e?(SA.SetNote(e),e):((e=new SA.Note).LoadViewId(t,function(){SA.SetNote(e)}),e)},SA.FirefoxWhich=function(t){void 0===t.which&&(t.which=t.buttons,2===t.which?t.which=3:3===t.which&&(t.which=2),console.log("firefox which = "+t.which))},SA.Debug=function(t){console.log(t)},SA.ZERO_PAD=function(t,e){return("0000000000"+t.toFixed()).slice(-e)},SA.ProgressCount=0,SA.Caches=[],SA.StartInteractionListeners=[],SA.PushProgress=function(){$("body").css({cursor:"progress"}),SA.ProgressCount+=1},SA.PopProgress=function(){SA.ProgressCount-=1,SA.ProgressCount<=0&&$("body").css({cursor:"default"})},SA.Run=function(){var t=SA;SA.SessionId?$.ajax({type:"get",url:SA.SessionUrl+"?json=true&sessid="+SA.SessionId,success:function(e,i){t.Session=e,t.HideAnnotations=e.hide,t.Run2()},error:function(){SA.Debug("AJAX - error() : session"),t.Run2()}}):SA.Run2()},SA.Run2=function(){""!==SA.ViewId&&"None"!==SA.ViewId||delete SA.ViewId,""!==SA.SessionId&&"None"!==SA.SessionId||delete SA.SessionId;var t=new SA.Note;if("presentation"===SA.ViewId){var e=window.prompt("Please enter the presentation title.","SlideShow");if(null===e)return;t.Title=e,t.HiddenTitle=e,t.Text="",t.Type="HTML",l(t)}else{if(""===SA.ViewId)return void SA.Debug("Missing view id");t.LoadViewId(SA.ViewId,function(){l(t)})}},SA.HandleKeyDownStack=function(t){return!!SA.ContentEditableHasFocus||(16===t.keyCode||(17===t.keyCode?(SA.ControlKeyPressed=!0,!0):SA.ControlKeyPressed&&90===t.keyCode?(SA.recorderWidget.UndoState(),!1):SA.ControlKeyPressed&&89===t.keyCode?(SA.recorderWidget.RedoState(),!1):!SA.presentation||(SA.presentation.HandleKeyDown(t),!0)))},SA.HandleKeyUpStack=function(t){if(SA.ContentEditableHasFocus)return!0;if(90===t.keyCode&&t.shiftKey)return SA.DeformableAlignViewers(!1),!0;if(89===t.keyCode&&t.shiftKey)return SA.DeformableAlignViewers(!0),!0;if(88===t.keyCode){if(SA.StackCursorFlag=!SA.StackCursorFlag,t.shiftKey&&SA.StackCursorFlag){SA.testAlignTranslation();var e=SA;window.setTimeout(function(){e.StackCursorFlag=!1},1e3)}return SA.display.EventuallyRender(),!1}return 16===t.keyCode||17===t.keyCode&&(SA.ControlKeyPressed=!1),!SA.presentation||(SA.presentation.HandleKeyUp(t),!0)},SA.OnStartInteraction=function(t){SA.StartInteractionListeners.push(t)},SA.TriggerStartInteraction=function(){if(SA.StartInteractionListeners)for(var t=0;t<SA.StartInteractionListeners.length;++t)(0,SA.StartInteractionListeners[t])()},SA.TagCompare=function(t,e,i){return i?t.toUpperCase()===e.substring(0,t.length).toUpperCase():e.toUpperCase().search(t.toUpperCase())},SA.AddHtmlTags=function(t){var e,i,o,s,n,a,r=[{string:"History:",class:"sa-history"},{string:"Diagnosis:",class:"sa-diagnosis"},{string:"Differential Diagnosis:",class:"sa-differential-diagnosis"},{string:"Teaching Points:",class:"sa-teaching-points"},{string:"Compare with:",class:"sa-compare"},{string:"Notes:",class:"sa-notes"}],h=t.children();for(i=0;i<h.length;++i){var l=$(h[i]);for(o=0;o<r.length;++o)l.hasClass(r[o].class)&&(n=r[o]);if(n)e=void 0;else if(l.hasClass("sa-ssc-title"))e=void 0;else{var d=l.text();if(SA.TagCompare("SSC",d,!0)&&!l.hasClass("sa-ssc-title")&&l.addClass("sa-ssc-title"),l.children().length>1)for(o=0;o<r.length;++o)if(s=r[o],SA.TagCompare(s.string,d,!1)>0){(a=l.children()).remove(),a.insertAfter(l),h=t.children(),d=l.text();break}for(n=!1,o=0;o<r.length;++o)if(s=r[o],SA.TagCompare(s.string,d,!0)){n=s;break}n&&("DIV"===l[0].tagName?(a=l.children(),l.children().remove(),a.insertAfter(l),h=t.children(),e=l,++i,l=$(h[i])):(e=$("<div>").insertBefore(l),h=t.children(),++i),e.addClass(n.class)),e&&(l.remove(),l.appendTo(e),h=t.children(),--i)}}},SA.GetSelectionRange=function(t){var e,i=window.getSelection(),o=null;if(i.rangeCount>0)for((e=i.getRangeAt(0)).noCursor=!1,o=e.commonAncestorContainer;o&&o!==t[0];)o&&(o=o.parentNode);return o?e:null},SA.MakeSelectionRange=function(t){var e=window.getSelection();t[0].focus();var i=$("<br>").appendTo(t),o=document.createRange();return o.selectNode(i[0]),e.removeAllRanges(),e.addRange(o),o},SA.GetUser=function(){return void 0!==SA.User?SA.User:""},SA.initWebGL=function(t){e(t)},SA.createWebGlProgram=function(e,i,o){var s=t(o,o.FRAGMENT_SHADER,e),n=t(o,o.VERTEX_SHADER,i),a=o.createProgram();return o.attachShader(a,n),o.attachShader(a,s),o.linkProgram(a),o.getProgramParameter(a,o.LINK_STATUS)||SA.Debug("Could not initialise shaders"),a.vertexPositionAttribute=o.getAttribLocation(a,"aVertexPosition"),o.enableVertexAttribArray(a.vertexPositionAttribute),a.pMatrixUniform=o.getUniformLocation(a,"uPMatrix"),a.mvMatrixUniform=o.getUniformLocation(a,"uMVMatrix"),a};SA.cancelContextMenu=function(t){return t&&t.stopPropagation&&t.stopPropagation(),!1}}(),window.SA=window.SA||{},function(){"use strict";function t(t,e){var o=this;this.Viewer=t,this.OtherViewer=e,this.Tab=new SA.Tab(t.GetDiv(),SA.ImagePathUrl+"Menu.jpg","editTab"),this.Tab.Div.css({position:"absolute",right:"47px",bottom:"0px","z-index":"200"}).prop("title","View Menu"),this.Tab.Panel.addClass("sa-view-edit-panel"),SA.VIEW_BROWSER&&$("<button>").appendTo(this.Tab.Panel).text("Load Slide").addClass("sa-view-edit-button").click(function(){o.Tab.PanelOff(),SA.VIEW_BROWSER.Open(o.Viewer)}),SA.Edit&&$("<button>").appendTo(this.Tab.Panel).text("Save View").addClass("sa-view-edit-button").click(function(){o.SaveView()}),SA.notesWidget&&($("<button>").appendTo(this.Tab.Panel).text("Download Image").addClass("sa-view-edit-button").click(function(){o.Tab.PanelOff(),i(o.Viewer)}),$("<button>").appendTo(this.Tab.Panel).text("Slide Info").addClass("sa-view-edit-button").click(function(){o.ShowSlideInformation()}),SA.recorderWidget.TimeLine&&(this.HistoryMenuItem=$("<button>").appendTo(this.Tab.Panel).text("History On").addClass("sa-view-edit-button").click(function(){o.ToggleHistory()})),this.OtherViewer&&(this.CopyZoomMenuItem=$("<button>").appendTo(this.Tab.Panel).text("Copy Zoom").hide().addClass("sa-view-edit-button").click(function(){o.CopyZoom()})),$("<button>").appendTo(this.Tab.Panel).text("Flip Horizontal").addClass("sa-view-edit-button").click(function(){o.FlipHorizontal()}),SA.Edit?$("<button>").appendTo(this.Tab.Panel).text("Save OverView Bounds").addClass("sa-view-edit-button").click(function(){o.SetViewBounds()}):$("<button>").appendTo(this.Tab.Panel).text("Set OverView Bounds").addClass("sa-view-edit-button").click(function(){o.SetViewBounds()}))}function e(t,e){var i=this;this.Editable=e,this.Body=$("<div>").appendTo(t).css({"background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px",position:"absolute",top:"30%",left:"30%",width:"40%",height:"40%",overflow:"auto",padding:"10px","z-index":"4",color:"#303030","font-size":"20px"}).hide().mouseleave(function(){i.Close()}),this.TitleInput=$("<div>").css({width:"100%",cursor:"text","white-space":"nowrap","margin-bottom":"5px"}).appendTo(this.Body).keypress(function(t){return 13!==t.keyCode}),e&&this.TitleInput.attr("contenteditable","true").css({background:"#f0f0ff"}),this.CopyrightDiv=$("<div>").css({width:"100%",display:"inline-block"}).appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.CopyrightLabel=$("<div>").appendTo(this.CopyrightDiv).text("Copyright:"),this.CopyrightInput=$("<div>").css({width:"300px",cursor:"text"}).appendTo(this.CopyrightDiv).keypress(function(t){return 13!==t.keyCode}),e&&this.CopyrightInput.attr("contenteditable","true").css({background:"#f0f0ff"}),this.ResolutionDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.ResolutionLabel=$("<div>").appendTo(this.ResolutionDiv).text("Resolution:").addClass("sa-view-annotation-modal-input-label"),this.ResolutionInput=$("<div>").appendTo(this.ResolutionDiv),this.ResolutionUnitsInput=$("<div>").appendTo(this.ResolutionDiv),e&&(this.ResolutionInput.attr("contenteditable","true").css({background:"#f0f0ff",cursor:"text"}).keypress(function(t){return 13!==t.keyCode}),this.ResolutionUnitsInput.attr("contenteditable","true").css({background:"#f0f0ff",cursor:"text"}).attr("contenteditable","true").keypress(function(t){return 13!==t.keyCode})),this.FileNameDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.CreatedDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.DimensionsDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div"),this.LevelsDiv=$("<div>").appendTo(this.Body).addClass("sa-view-annotation-modal-div")}t.prototype.SetVisibility=function(t){t?this.Tab.show():this.Tab.hide()},t.prototype.ToggleHistory=function(){this.Tab.PanelOff(),this.Viewer.HistoryFlag=!this.Viewer.HitoryFlag,this.Viewer.HistoryFlag?this.HistoryMenuItem.text("History Off"):this.HistoryMenuItem.text("History On"),SA.display.EventuallyRender()},t.prototype.SaveView=function(){this.Tab.PanelOff(),SA.notesWidget&&SA.notesWidget.SaveCallback()},t.prototype.GetViewerBounds=function(t){var e=t.GetCamera(),i=e.GetWorldFocalPoint(),o=e.GetWidth()/2,s=e.GetHeight()/2;return[i[0]-o,i[0]+o,i[1]-s,i[1]+s]},t.prototype.SetViewBounds=function(){this.Tab.PanelOff();var t=this.GetViewerBounds(this.Viewer),e=SA.display.GetNote(),i=e.ViewerRecords[this.Viewer.RecordIndex];i.OverViewBounds=t,i.Image.bounds=i.OverViewBounds,this.Viewer.OverView.Camera.SetWorldFocalPoint([(t[0]+t[1])/2,(t[2]+t[3])/2]),this.Viewer.OverView.Camera.SetHeight(t[3]-t[2]),this.Viewer.OverView.Camera.ComputeMatrix(),this.Viewer.eventuallyRender();var o=this;if(SA.Edit){var s=JSON.stringify(e.Serialize(!0)),n=new Date;$.ajax({type:"post",url:"webgl-viewer/saveviewnotes",data:{note:s,date:n.getTime()},success:function(t,e){o.Viewer.EventuallyRender()},error:function(){SA.Debug("AJAX - error() : saveviewnotes (bounds)")}})}},t.prototype.SetImageBounds=function(){this.Tab.PanelOff();var t=this.Viewer,e=t.GetCache().Image.database,i=t.GetCache().Image._id,o=this.GetViewerBounds(t);t.GetCache().Image.bounds=o,t.OverView.Camera.SetWorldFocalPoint([(o[0]+o[1])/2,(o[2]+o[3])/2]),t.OverView.Camera.SetHeight(o[3]-o[2]),t.OverView.Camera.ComputeMatrix(),t.EventuallyRender(),$.ajax({type:"post",url:"webgl-viewer/set-image-bounds",data:{img:i,imgdb:e,bds:JSON.stringify(o)},success:function(t,e){},error:function(){SA.Debug("AJAX - error() : saveusernote 1")}})},t.prototype.CopyZoom=function(){this.Tab.PanelOff();var t=this.Viewer.GetCamera(),e=this.OtherViewer.GetCamera();this.Viewer.AnimateCamera(t.GetWorldFocalPoint(),t.GetWorldRoll(),e.Height)},t.prototype.ShowSlideInformation=function(){this.Tab.PanelOff();var t=this.Viewer.MainView.Section.Caches[0].Image;SA.SlideInformation.Open(t,this.Viewer)},t.prototype.FlipHorizontal=function(){if(this.Tab.PanelOff(),this.Viewer){var t=this.Viewer.GetCamera();this.Viewer.ToggleMirror(),this.Viewer.SetCamera(t.GetWorldFocalPoint(),t.GetRotation()+180,t.Height),SA.RecordState()}};var i=function(){function t(){a={};var t=new SAM.Dialog(function(){a.Viewer=SA.VIEWER;var t=parseInt(a.DimensionDialog.PxWidthInput.val()),e=parseInt(a.DimensionDialog.PxHeightInput.val()),i=a.DimensionDialog.StackCheckbox.prop("checked");a.CancelDialog.Show(1),i?a.CancelDialog.StackMessage.show():a.CancelDialog.StackMessage.hide(),SA.VIEWER.SaveLargeImage("slide-atlas.png",t,e,i,function(){a.Viewer=void 0,a.CancelDialog.Hide()})});t.Body.css({margin:"1em 2em","padding-bottom":"2em","padding-right":"3em"}),a.DimensionDialog=t,t.Title.text("Download Image"),t.PxDiv=$("<div>").appendTo(t.Body).css({border:"1px solid #555",margin:"15px","padding-left":"5px"}),t.PxLabel=$("<div>").appendTo(t.PxDiv).text("Dimensions:").css({position:"relative",top:"-9px",display:"inline-block","background-color":"white"}),t.PxWidthDiv=$("<div>").appendTo(t.PxDiv).css({display:"table-row"}),t.PxWidthLabel=$("<div>").appendTo(t.PxWidthDiv).text("Width:").css({display:"table-cell","text-align":"right",width:"6em"}),t.PxWidthInput=$('<input type="number">').appendTo(t.PxWidthDiv).val("1900").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){e()}),t.PxWidthUnits=$("<div>").appendTo(t.PxWidthDiv).text("Pixels").css({display:"table-cell","text-align":"left"}),t.PxHeightDiv=$("<div>").appendTo(t.PxDiv).css({display:"table-row",margin:"5px"}),t.PxHeightLabel=$("<div>").appendTo(t.PxHeightDiv).text("Height:").css({display:"table-cell","text-align":"right"}),t.PxHeightInput=$('<input type="number">').appendTo(t.PxHeightDiv).val("1080").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){i()}),t.PxHeightUnits=$("<div>").appendTo(t.PxHeightDiv).text("Pixels").css({display:"table-cell","text-align":"left"}),t.SizeDiv=$("<div>").appendTo(t.Body).css({border:"1px solid #555",margin:"15px","padding-left":"5px"}),t.SizeLabel=$("<div>").appendTo(t.SizeDiv).text("Document Size:").css({position:"relative",top:"-9px",display:"inline-block","background-color":"white"}),t.SizeWidthDiv=$("<div>").appendTo(t.SizeDiv).css({display:"table-row",margin:"5px"}),t.SizeWidthLabel=$("<div>").appendTo(t.SizeWidthDiv).text("Width:").css({display:"table-cell","text-align":"right",width:"6em"}),t.SizeWidthInput=$('<input type="number">').appendTo(t.SizeWidthDiv).val("1900").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){o()}),t.SizeWidthUnits=$("<div>").appendTo(t.SizeWidthDiv).text("Inches").css({display:"table-cell","text-align":"left"}),t.SizeHeightDiv=$("<div>").appendTo(t.SizeDiv).css({display:"table-row",margin:"5px"}),t.SizeHeightLabel=$("<div>").appendTo(t.SizeHeightDiv).text("Height:").css({display:"table-cell","text-align":"right"}),t.SizeHeightInput=$('<input type="number">').appendTo(t.SizeHeightDiv).val("1900").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){s()}),t.SizeHeightUnits=$("<div>").appendTo(t.SizeHeightDiv).text("Inches").css({display:"table-cell","text-align":"left"}),t.SizeResDiv=$("<div>").appendTo(t.SizeDiv).css({display:"table-row",margin:"5px"}),t.SizeResLabel=$("<div>").appendTo(t.SizeResDiv).text("Resolution:").css({display:"table-cell","text-align":"right"}),t.SizeResInput=$('<input type="number">').appendTo(t.SizeResDiv).val("72").css({display:"table-cell",width:"100px",margin:"5px"}).change(function(){n()}),t.SizeResUnits=$("<div>").appendTo(t.SizeResDiv).text("Pixels/Inch").css({display:"table-cell","text-align":"left"}),t.ProportionsDiv=$("<div>").appendTo(t.Body).css({margin:"15px","padding-left":"5px"}),t.ProportionsLabel=$("<div>").appendTo(t.ProportionsDiv).text("Constrain Proportions:").css({display:"inline"}),t.ProportionsCheckbox=$('<input type="checkbox">').appendTo(t.ProportionsDiv).css({display:"inline"}).prop("checked",!0),t.StackDiv=$("<div>").appendTo(t.Body).css({margin:"15px","padding-left":"5px"}).hide(),t.StackLabel=$("<div>").appendTo(t.StackDiv).text("All stack sections:").css({display:"inline"}),t.StackCheckbox=$('<input type="checkbox">').appendTo(t.StackDiv).css({display:"inline"}).prop("checked",!1),t.AspectRatio=1,t=new SAM.Dialog(function(){a.Viewer&&(a.Viewer.CancelLargeImage(),a.Viewer=void 0)}),a.CancelDialog=t,t.Title.text("Processing"),t.WaitingImage=$("<img>").appendTo(t.Body).attr("src",SA.ImagePathUrl+"circular.gif").attr("alt","waiting...").css({width:"40px"}),t.StackMessage=$("<div>").appendTo(t.Body).text("Downloading multiple images.  Turn off browser's prompt-on-download option.").hide(),t.ApplyButton.text("Cancel")}function e(){var t=a.DimensionDialog,e=parseInt(t.SizeResInput.val()),i=parseInt(t.PxWidthInput.val());t.SizeWidthInput.val((i/e).toFixed(2));var o;t.ProportionsCheckbox.prop("checked")?(o=i/t.AspectRatio,t.PxHeightInput.val(o.toFixed()),t.SizeHeightInput.val((o/e).toFixed(2))):(o=parseInt(t.PxHeightInput.val()),t.AspectRatio=i/o)}function i(){var t=a.DimensionDialog,e=parseInt(t.SizeResInput.val()),i=parseInt(t.PxHeightInput.val());t.SizeHeightInput.val((i/e).toFixed(2));var o;t.ProportionsCheckbox.prop("checked")?(o=i*t.AspectRatio,t.PxWidthInput.val(o.toFixed()),t.SizeWidthInput.val((o/e).toFixed(2))):(o=parseInt(t.PxWidthInput.val()),t.AspectRatio=o/i)}function o(){var t=a.DimensionDialog,e=parseInt(t.SizeResInput.val()),i=parseInt(t.SizeWidthInput.val());t.PxWidthInput.val((i*e).toFixed());var o;t.ProportionsCheckbox.prop("checked")?(o=i/t.AspectRatio,t.SizeHeightInput.val(o.toFixed(2)),t.PxHeightInput.val((o*e).toFixed())):(o=parseInt(t.SizeHeightInput.val()),t.AspectRatio=i/o)}function s(){var t=a.DimensionDialog,e=parseInt(t.SizeResInput.val()),i=parseInt(t.SizeHeightInput.val());t.PxHeightInput.val((i*e).toFixed());var o;t.ProportionsCheckbox.prop("checked")?(o=i*t.AspectRatio,t.SizeWidthInput.val(o.toFixed(2)),t.PxWidthInput.val((o*e).toFixed())):(o=parseInt(t.SizeWidthInput.val()),t.AspectRatio=o/i)}function n(){var t=a.DimensionDialog,e=parseInt(t.SizeResInput.val()),i=parseInt(t.SizeHeightInput.val()),o=parseInt(t.SizeWidthInput.val());t.PxHeightInput.val((i*e).toFixed()),t.PxWidthInput.val((o*e).toFixed())}var a;return function(e){SA.VIEWER=e,a||t();var i=e.GetViewport(),o=a.DimensionDialog;o.PxWidthInput.val(i[2]),o.PxHeightInput.val(i[3]);var s=parseInt(o.SizeResInput.val());o.SizeWidthInput.val((i[2]/s).toFixed(2)),o.SizeHeightInput.val((i[3]/s).toFixed(2)),o.AspectRatio=i[2]/i[3],"Stack"===SA.display.GetNote().Type?a.DimensionDialog.StackDiv.show():a.DimensionDialog.StackDiv.hide(),a.DimensionDialog.Show(1)}}();SA.InitSlideSelector=function(t){$("<div>").appendTo(t).css({"background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px",position:"absolute",top:"35px",left:"35px",width:"500px",height:"700px",overflow:"auto","z-index":"4",color:"#303030","font-size":"20px"}).attr("id","sessionMenu").hide().mouseleave(function(){$(this).fadeOut()}),$("<ul>").appendTo("#sessionMenu").attr("id","sessionMenuSelector"),$("<div>").appendTo(t).css({"background-color":"white","border-style":"solid","border-width":"1px","border-radius":"5px",position:"absolute",top:"135px",left:"135px",width:"500px",height:"700px",overflow:"auto","z-index":"4",color:"#303030","font-size":"20px"}).attr("id","viewMenu").hide().mouseleave(function(){$(this).fadeOut()}),$("<ul>").appendTo("#viewMenu").attr("id","viewMenuSelector"),SA.SlideInformation=new e(t,SA.Edit)},e.prototype.Open=function(t,e){this.Viewer=e,this.ImageObj=t,this.TitleInput.text(t.label),this.FileNameDiv.text("File Name: "+t.filename),this.CreatedDiv.text("Created: "+t.uploaded_at),this.DimensionsDiv.text("Dimensions: "+t.dimensions[0]+", "+t.dimensions[1]),this.LevelsDiv.text("Levels: "+t.levels),this.CopyrightInput.text(t.copyright);var i;i=t.units?{value:t.spacing[0],units:t.units}:{value:.25,units:"µm"},SAM.ConvertForGui(i),this.ResolutionInput.text(i.value.toString()),this.ResolutionUnitsInput.text(i.units.toString()),this.Body.show()},e.prototype.Close=function(){if(this.Editable){this.ImageObj.label=this.TitleInput.text(),this.ImageObj.copyright=this.CopyrightInput.text();var t={value:parseFloat(this.ResolutionInput.text()),units:this.ResolutionUnitsInput.text()};SAM.ConvertToMeters(t),this.ImageObj.spacing[0]=this.ImageObj.spacing[1]=t.value,this.ImageObj.units=t.units}if(this.Body.fadeOut(),this.Editable){this.ImageObj.dimensions.length<3&&this.ImageObj.dimensions.push(1);var e={_id:this.ImageObj._id,database:this.ImageObj.database,label:this.ImageObj.label,copyright:this.ImageObj.copyright,spacing:this.ImageObj.spacing,units:this.ImageObj.units},i=this;$.ajax({type:"post",url:"webgl-viewer/saveimagedata",data:{metadata:JSON.stringify(e)},success:function(t,e){i.Viewer&&i.Viewer.EventuallyRender()},error:function(){SA.Debug("AJAX - error() : saveimagedata")}})}},SA.ViewEditMenu=t}(),window.SA=window.SA||{},function(){"use strict";function t(t){var e=this;this.Div=$("<div>").appendTo(t).hide().css({position:"absolute",top:"5%",height:"80%",left:"10%",width:"70%",padding:"5%","z-index":"1007","text-align":"left",color:"#303030"}).mouseleave(function(){e.Div.fadeOut()}),this.TabbedDiv=new SA.TabbedDiv(this.Div),this.BrowserDiv=this.TabbedDiv.NewTabDiv("Browser"),this.BrowserDiv.css({"overflow-y":"auto"}),this.SearchDiv=this.TabbedDiv.NewTabDiv("Search"),this.ClipboardDiv=this.TabbedDiv.NewTabDiv("Clipboard"),this.BrowserPanel=new i(this.BrowserDiv,function(t){e.SelectView(t)}),this.SearchPanel=new SA.SearchPanel(this.SearchDiv,function(t){e.SelectImage(t)}),this.ClipboardPanel=new SA.ClipboardPanel(this.ClipboardDiv,function(t){e.SelectView(t)}),this.Viewer=null}function e(t,e,i,o){var s=this;this.Data=i,this.InitializeCallback=o,this.TitleDiv=$("<div>").css({position:"relative"}).appendTo(t),this.Bullet=$("<span>").appendTo(this.TitleDiv).css({position:"absolute",left:"0px",top:"1px",opacity:"0.75"}).addClass("ui-icon ui-icon-plus").on("click.open",function(){s.OpenCallback()}).addClass("saButton"),this.Title=$("<div>").appendTo(this.TitleDiv).css({"margin-left":"20px"}),this.Label=$("<div>").appendTo(this.Title).css({display:"block"}).text(e),this.List=$("<ul>").appendTo(t).addClass("sa-ul").hide()}function i(t,e){this.BrowserDiv=t,this.SelectView=e,this.BrowserInfo=null,this.ReloadViewBrowserInfo(),this.ProgressCount=0}t.prototype.SelectView=function(t){null===t&&(this.Viewer.SetCache(null),this.Viewer.eventuallyRender());var e=new SA.ViewerRecord;e.Load(t.ViewerRecords[0]),this.Viewer.SetViewerRecord(e)},t.prototype.SelectImage=function(t){this.Div.fadeOut();var e=SA.FindCache(t);this.Viewer.Reset(),this.Viewer.SetCache(e),SA.RecordState(),this.Viewer.eventuallyRender()},t.prototype.Open=function(t){this.Viewer=t,t&&this.Div.show()},e.prototype.OpenCallback=function(){var t=this;this.InitializeCallback&&(this.InitializeCallback(this),delete this.InitializeCallback),this.Bullet.off("click.open").removeClass("ui-icon-plus").addClass("ui-icon-minus").on("click.close",function(){t.CloseCallback()}),this.List.show()},e.prototype.CloseCallback=function(){var t=this;this.Bullet.off("click.close").removeClass("ui-icon-minus").addClass("ui-icon-plus").on("click.open",function(){t.OpenCallback()}),this.List.hide()},i.prototype.PushProgress=function(){this.BrowserDiv.css({cursor:"progress"}),this.ProgressCount+=1},i.prototype.PopProgress=function(){this.ProgressCount-=1,this.ProgressCount<=0&&this.BrowserDiv.css({cursor:"default"})},i.prototype.LoadGUI=function(){var t=this,i=this.BrowserInfo;this.BrowserDiv.empty();for(var o=$("<ul>").addClass("sa-ul").appendTo(this.BrowserDiv),s=0;s<i.sessions.length;++s)for(var n=$("<li>").appendTo(o),a=i.sessions[s],r=new e(n,a.rule).List,h=0;h<a.sessions.length;++h){var l=a.sessions[h],d={db:l.sessdb,sessid:l.sessid};new e($("<li>").appendTo(r),l.label,d,function(e){t.RequestSessionViews(e)})}},i.prototype.ReloadViewBrowserInfo=function(){var t=this;this.PushProgress(),$.get("/sessions?json=true",function(e,i){t.PopProgress(),"success"===i?(t.BrowserInfo=e,t.LoadGUI(e)):SA.Debug("ajax failed.")})},i.prototype.RequestSessionViews=function(t){var e=this;this.PushProgress();var i=t.Data.sessid;$.get("/sessions?json=true&sessid="+i,function(i,o){e.PopProgress(),"success"===o?e.AddSessionViews(t,i):SA.Debug("ajax failed.")})},i.prototype.AddSessionViews=function(t,e){for(var i=this,o=t.List,s=0;s<e.images.length;++s){var n=e.images[s],a=i.AddViewFolder(o,n.label,n.view);this.RequestViewChildren(a)}},i.prototype.AddViewFolder=function(t,i,o){var s=this,n=new e($("<li>").appendTo(t),i,{viewid:o});return n.Bullet.hide(),n.Title.click(function(){s.ViewClickCallback(n)}).addClass("saButton"),n},i.prototype.RequestViewChildren=function(t){var e=this;this.PushProgress();var i=t.Data.viewid;$.ajax({type:"get",url:"/webgl-viewer/getview",data:{viewid:i},success:function(i,o){e.PopProgress(),e.LoadViewChildren(t,i)},error:function(){SA.Debug("AJAX - error() : getview"),e.PopProgress()}})},i.prototype.LoadViewChildren=function(t,e){if("HTML"===e.Type){var i=$("<div>").appendTo(t.Title).css({position:"relative",height:"100px",width:"134px","margin-bottom":"2px",overflow:"hidden",border:"1px solid #AAA"}),o=$("<div>").appendTo(i).saPresentation({aspectRatio:1.3333});if(o.saHtml(e.Text),o.trigger("resize"),o.find(".sa-element").saElement({editable:!1,interactive:!1}),o.find(".sa-viewer").saElement({hideCopyright:!0}),!e.Title||""===e.Title){var s=o.find(".sa-presentation-title");s.length>0&&t.Label.text(s.text())}}else if(e.ViewerRecords&&e.ViewerRecords.length>0){var n=e.ViewerRecords[0].Image;$("<img>").appendTo(t.Title).attr("src","/thumb?db="+n.database+"&img="+n._id).css({height:"50px",display:"block"})}if(e.Children&&!(e.Children.length<1)){t.Bullet.show();for(var a=0;a<e.Children.length;++a){var r=e.Children[a],h=this.AddViewFolder(t.List,r.Title,r._id);this.LoadViewChildren(h,r)}}},i.prototype.ViewClickCallback=function(t){var e=this,i=t.Data.viewid;this.PushProgress(),$.ajax({type:"get",url:"/webgl-viewer/getview",data:{viewid:i},success:function(t,i){e.PopProgress(),e.SelectView(t)},error:function(){e.PopProgress(),SA.Debug("AJAX - error() : getview (browser)")}})},SA.BrowserPanel=i,SA.ViewBrowser=t}(),window.SA=window.SA||{},function(){"use strict";function t(t){var e=this;this.Viewers=[],this.ViewerDivs=[],this.saNote=null,this.saNoteStartIndex=0,this.Parent=t,t.addClass("sa-dual-viewer"),this.TopDiv=$("<div>").appendTo(t).css({position:"relative",width:"100%",height:"100%"});for(var i=0;i<2;++i){var o=$("<div>").appendTo(this.TopDiv).css({position:"absolulute",top:"0px"}).saViewer({overview:!0,zoomWidget:!0}).addClass("sa-view-canvas-div");this.ViewerDivs[i]=o,this.Viewers[i]=o[0].saViewer,this.Viewers[i].RecordIndex=i}SA.VIEWERS=this.Viewers,SA.VIEWER1=this.Viewers[0],SA.VIEWER2=this.Viewers[1],this.DualView=!1,this.Viewer1Fraction=1,this.AnimationLastTime=0,this.AnimationDuration=0,this.AnimationTarget=0,this.NavigationWidget=new SA.NavigationWidget(this.TopDiv,this),SAM.MOBILE_DEVICE?this.NavigationWidget.SetVisibility(!1):($("<img>").appendTo(this.ViewerDivs[0]).css({position:"absolute",right:"0px",top:"0px"}).addClass("sa-view-dualview-div").attr("id","dualWidgetLeft").attr("src",SA.ImagePathUrl+"dualArrowLeft2.png").click(function(){e.ToggleDualView()}).attr("draggable","false").on("dragstart",function(){return!1}),$("<img>").appendTo(this.TopDiv).appendTo(this.ViewerDivs[1]).css({position:"absolute",left:"0px",top:"0px"}).hide().addClass("sa-view-dualview-img").attr("id","dualWidgetRight").attr("src",SA.ImagePathUrl+"dualArrowRight2.png").click(function(){e.ToggleDualView()}).attr("draggable","false").on("dragstart",function(){return!1}))}SA.VIEWERS=[],t.prototype.EventuallyRender=function(){for(var t=0;t<this.Viewers.length;++t)this.GetViewer(t).EventuallyRender(!1)},t.prototype.Record=function(t,e){if(e&&(t.StartIndex=e),e=e||0,"Stack"!==t.Type&&(!this.DualView&&t.ViewerRecords.length>1&&(t.ViewerRecords=[t.ViewerRecords[0]]),this.DualView&&t.ViewerRecords.length<2))for(;t.ViewerRecords.length<2;)t.ViewerRecords.push(new SA.ViewerRecord);for(var i=0;i<this.GetNumberOfViewers();++i)i+e<t.ViewerRecords.length&&this.GetViewer(i).Record(t,i+e)},t.prototype.ProcessArguments=function(t){if(t.note&&(this.SetNote(t.note,t.viewIndex),this.Parent.attr("sa-note-id",t.note.Id||t.note.TempId)),t.tileSource){var e=t.tileSource.width,i=t.tileSource.height,o=new SA.Cache;o.TileSource=t.tileSource;var s=new SA.Note,n={levels:t.maxLevel+1,dimensions:[e,i],bounds:[0,e-1,0,i-1],_id:s.TempId},a=new SA.ViewerRecord;a.Image=n,a.OverViewBounds=[0,e-1,0,i-1],a.Camera={FocalPoint:[e/2,i/2],Roll:0,Height:i},s.ViewerRecords.push(a),o.SetImageData(n),this.SetNote(t.note,t.viewIndex)}for(var r=0;r<this.Viewers.length;++r){var h=this.Viewers[r];void 0!==t.hideCopyright&&h.SetCopyrightVisibility(!t.hideCopyright),void 0!==t.overview&&h.SetOverViewVisibility(t.overview),void 0!==t.navigation&&this.NavigationWidget.SetVisibility(t.navigation),void 0!==t.dualWidget&&(this.HideHandles=!t.dualWidget,this.UpdateGui()),void 0!==t.zoomWidget&&h.SetZoomWidgetVisibility(t.zoomWidget),void 0!==t.drawWidget&&h.SetAnnotationWidgetVisibility(t.drawWidget),void 0!==t.rotatable&&h.SetRotatable(t.rotatable),void 0!==t.menu&&(h.Menu||(h.Menu=new SA.ViewEditMenu(h,null)),h.Menu.SetVisibility(t.menu)),void 0!==t.interaction&&(h.SetInteractionEnabled(t.interaction),this.NavigationWidget&&this.NavigationWidget.SetInteractionEnabled(t.interaction))}},t.prototype.RecordAnnotations=function(){SA.Edit&&this.saNote&&this.saNote.RecordAnnotations(this)},t.prototype.SetNote=function(t){var e=this;if(t&&2!==t.LoadState)t.LoadViewId(t.Id,function(){e.SetNote(t)});else{this.saNote=t,this.saNoteStartIndex=t.StartIndex;var i=t.StartIndex||0;!t||i<0||i>=t.ViewerRecords.length?console.log("Cannot set viewer record of note"):(this.saViewerIndex=i,this.NavigationWidget&&this.NavigationWidget.SetNote(t),this.DisplayNote(t),"Stack"===t.Type&&(this.GetViewer(0).OnInteraction(function(){e.SynchronizeViews(0,t)}),this.GetViewer(1).OnInteraction(function(){e.SynchronizeViews(1,t)}),t.DisplayStack(this),this.SynchronizeViews(0,t)))}},t.prototype.MatrixMultiply=function(t,e){var i=e[0]*t[0]+e[1]*t[1]+t[2],o=e[0]*t[3]+e[1]*t[4]+t[5],s=e[0]*t[6]+e[1]*t[7]+t[8];e[0]=i/s,e[1]=o/s},t.prototype.InitializeSynchronousViewsWithPoints=function(t,e,i,o,s,n){var a=new SA.Note,r=new SA.ViewerRecord;r.Transform=new SA.PairTransformation;var h=new SA.ViewerRecord;h.Transform=new SAM.MatrixTransformation,h.Transform.InitializeWithPoints(t,e,i,o,s,n);var l,d=t,u=e;l=h.Transform.ForwardTransformPoint(d),console.log(u[0]+","+u[1]+":"+l[0]+","+l[1]),d=i,u=o,l=h.Transform.ForwardTransformPoint(d),console.log(u[0]+","+u[1]+":"+l[0]+","+l[1]),d=s,u=n,l=h.Transform.ForwardTransformPoint(d),console.log(u[0]+","+u[1]+":"+l[0]+","+l[1]),a.ViewerRecords=[r,h],a.StartIndex=0,a.Type="Stack",this.saNote=a,this.saNoteStartIndex=a.StartIndex,this.saViewerIndex=0;var p=this;this.GetViewer(0).OnInteraction(function(){p.SynchronizeViews(0,a)}),this.GetViewer(1).OnInteraction(function(){p.SynchronizeViews(1,a)}),this.SynchronizeViews(0,a)},t.prototype.InitializeSynchronousViews=function(t,e){var i=new SA.Note,o=new SA.ViewerRecord;o.Transform=new SA.PairTransformation;var s=new SA.ViewerRecord;s.Transform=new SAM.MatrixTransformation(t,e);var n;n=s.Transform.ForwardTransformPoint([259,656]),console.log("(345,261):"+n[0]+","+n[1]),n=s.Transform.ForwardTransformPoint([285,8896]),console.log("(167,7265):"+n[0]+","+n[1]),n=s.Transform.ForwardTransformPoint([9406,16]),console.log("(7789,306):"+n[0]+","+n[1]),n=s.Transform.ForwardTransformPoint([7977,6215]),console.log("(6689,5510):"+n[0]+","+n[1]),i.ViewerRecords=[o,s],i.StartIndex=0,i.Type="Stack",this.saNote=i,this.saNoteStartIndex=i.StartIndex,this.saViewerIndex=0;var a=this;this.GetViewer(0).OnInteraction(function(){a.SynchronizeViews(0,i)}),this.GetViewer(1).OnInteraction(function(){a.SynchronizeViews(1,i)}),this.SynchronizeViews(0,i)},t.prototype.DisplayNote=function(t,e){var i=this.GetNumberOfViewers();if(0!==i){"Stack"===t.Type&&(i=2),"Stack"!==t.Type&&(i=t.ViewerRecords.length,this.SetNumberOfViewers(i));for(var o=t.StartIndex,s=0;s<i;++s){var n=this.GetViewer(s);s+o<t.ViewerRecords.length&&(n.SetViewerRecord(t.ViewerRecords[o+s],e),n.RecordIndex=s)}}},t.prototype.UpdateUserNotes=function(){var t=this.saNote;this.DisplayNote(t,!0)},t.prototype.GetNote=function(){return this.saNote},t.prototype.GetRootNote=function(){for(var t=this.saNote;t.Parent;)t=t.Parent;return t},t.prototype.SetNoteFromId=function(t){var e=SA.GetNoteFromId(t);if(e||(e=new SA.Note),2!==e.LoadState){var i=this;return e.LoadViewId(t,function(){i.SetNote(e)}),e}return this.SetNote(e),e},t.prototype.GetNumberOfViewers=function(){return this.DualView?2:1},t.prototype.GetViewer=function(t){return this.Viewers[t]},t.prototype.SetNumberOfViewers=function(t){this.DualView=t>1,this.DualView?this.Viewer1Fraction=.5:this.Viewer1Fraction=1,this.UpdateSize(),this.UpdateGui()},t.prototype.ToggleDualView=function(){this.DualView=!this.DualView,this.DualView?(this.Viewers[1].GetCache()||(this.Viewers[1].SetCache(this.Viewers[0].GetCache()),this.Viewers[1].GetCamera().DeepCopy(this.Viewers[0].GetCamera())),this.AnimationCurrent=1,this.AnimationTarget=.5,$("#dualViewCopyZoom").show()):(this.AnimationCurrent=.5,this.AnimationTarget=1,this.UpdateGui()),SA.RecordState(),this.AnimationLastTime=(new Date).getTime(),this.AnimationDuration=1e3,this.AnimateViewToggle()},t.prototype.UpdateGui=function(){if(this.HideHandles)return $("#dualWidgetLeft").hide(),void $("#dualWidgetRight").hide();this.DualView?($("#dualWidgetLeft").hide(),$("#dualWidgetRight").show(),$("#dualViewCopyZoom").show()):($("#dualWidgetRight").hide(),$("#dualViewCopyZoom").hide(),$("#dualWidgetLeft").show())},t.prototype.AnimateViewToggle=function(){var t=(new Date).getTime()-this.AnimationLastTime;if(t>this.AnimationDuration)return this.Viewer1Fraction=this.AnimationTarget,this.UpdateSize(),this.UpdateGui(),void this.Draw();var e=t/this.AnimationDuration;this.AnimationDuration*=1-e,this.Viewer1Fraction+=(this.AnimationTarget-this.Viewer1Fraction)*e,this.UpdateSize(),this.Draw();var i=this;window.requestAnimationFrame(function(){i.AnimateViewToggle()})},t.prototype.CreateThumbnailImage=function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),o=this.Viewers[0].MainView.CaptureImage(),s=t/o.height,n=Math.round(o.width*s),a=Math.round(o.height*s);if(this.DualView){var r=this.Viewers[2].MainView.CaptureImage(),h=Math.round(r.width*s),l=Math.round(r.height*s);e.width=n+h,e.height=Math.max(a,l),i.drawImage(r,0,0,r.width,r.height,n,0,h,l)}else e.width=n,e.height=a;i.drawImage(o,0,0,o.width,o.height,0,0,n,a);var d=e.toDataURL("image/jpeg",.8),u=document.createElement("img");return u.src=d,u},t.prototype.Draw=function(t){t&&t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.saNote&&this.saNote.WaterMark?SA.WaterMark=!0:SA.WaterMark=!1,this.Viewers[0]&&(this.Viewers[0].Animate(),this.DualView&&this.Viewers[1].Animate(),this.Viewers[0].Draw()),this.Viewers[1]&&this.DualView&&this.Viewers[1].Draw()},t.prototype.UpdateSize=function(){var t=100*this.Viewer1Fraction;this.ViewerDivs[0]&&(this.ViewerDivs[0].css({left:"0%",width:t+"%",height:"100%"}),this.Viewers[0].UpdateSize()),this.ViewerDivs[1]&&(this.ViewerDivs[1].css({left:t+"%",width:100-t+"%",height:"100%"}),this.Viewers[1].UpdateSize()),t>=90?this.Viewers[1].Hide():this.Viewers[1].Show()},t.prototype.AnnotationWidgetOn=function(){for(var t=0;t<this.Viewers.length;++t)this.Viewers.AnnotationWidgetOn()},t.prototype.AnnotationWidgetOff=function(){for(var t=0;t<this.Viewers.length;++t)this.Viewers.AnnotationWidgetOff()},t.prototype.SynchronizeViews=function(t,e){if(!(t+e.StartIndex>=e.ViewerRecords.length)){if(SA.Edit&&SA.StackCursorFlag){var i=e.ViewerRecords[e.StartIndex+1].Transform;if(!e.ActiveCorrelation&&i.Correlations){if(!i)return void alert("Missing transform");for(var o=this.GetViewer(0).GetCamera().GetBounds(),s=0;s<i.Correlations.length;){var n=i.Correlations[s];n.point0[0]>o[0]&&n.point0[0]<o[1]&&n.point0[1]>o[2]&&n.point0[1]<o[3]?i.Correlations.splice(s,1):++s}e.ActiveCorrelation=new SA.PairCorrelation,i.Correlations.push(e.ActiveCorrelation)}var a=this.GetViewer(0).GetCamera(),r=this.GetViewer(1).GetCamera();e.ActiveCorrelation.SetPoint0(a.GetWorldFocalPoint()),e.ActiveCorrelation.SetPoint1(r.GetWorldFocalPoint());var h=r.GetWorldRoll()-a.GetWorldRoll();return i.Correlations&&i.Correlations.length>1&&(h=0),e.ActiveCorrelation.SetWorldRoll(h),void e.ActiveCorrelation.SetHeight(.5*(r.Height+a.Height))}e.ActiveCorrelation=void 0,e.PreCamera||(e.PreCamera=new SAM.Camera),e.PostCamera||(e.PostCamera=new SAM.Camera);var l,d,u=[e.PreCamera,this.GetViewer(0).GetCamera(),this.GetViewer(1).GetCamera(),e.PostCamera],p=t+1;for(l=p+1;l<u.length;++l)(d=l-1+e.StartIndex)<e.ViewerRecords.length?e.ViewerRecords[d].Transform.ForwardTransformCamera(u[l-1],u[l]):u[l]=void 0;for(l=p;l>0;--l)(d=l+e.StartIndex-1)>0?e.ViewerRecords[d].Transform.ReverseTransformCamera(u[l],u[l-1]):u[l-1]=void 0;var c,f;if(u[0]){for(c=SA.FindCache(e.ViewerRecords[e.StartIndex-1].Image),u[0].SetViewport(this.GetViewer(0).GetViewport()),f=c.ChooseTiles(u[0],0,[]),l=0;l<f.length;++l)f[l].LoadQueueAdd();SA.LoadQueueUpdate()}if(u[3]){for(c=SA.FindCache(e.ViewerRecords[e.StartIndex+2].Image),u[3].SetViewport(this.GetViewer(0).GetViewport()),f=c.ChooseTiles(u[3],0,[]),l=0;l<f.length;++l)f[l].LoadQueueAdd();SA.LoadQueueUpdate()}0===t?(this.GetViewer(1).UpdateCamera(),this.GetViewer(1).EventuallyRender(!1)):(this.GetViewer(0).UpdateCamera(),this.GetViewer(0).EventuallyRender(!1));var g=this.GetViewer(t);for(l=0;l<2;++l)if(l!==t){var v=this.GetViewer(l);v.AnnotationWidget&&g.AnnotationWidget&&v.AnnotationWidget.SetVisibility(g.AnnotationWidget.GetVisibility())}}},t.prototype.MatchPolylines=function(t,e){e=e||.5;for(var i=this.Viewers[0].GetAnnotationLayer().GetWidgets(),o=this.Viewers[1].GetAnnotationLayer().GetWidgets(),s=this.saNote,n=s.ViewerRecords[s.StartIndex+1].Transform,a=0;a<i.length;++a){var r=i[a];if(r.Polyline){var h=r.Polyline,l=Math.floor(255*h.OutlineColor[0]),d=Math.floor(255*h.OutlineColor[1]),u=Math.floor(255*h.OutlineColor[2]);if(l!==t[0]||d!==t[1]||u!==t[2])continue;console.log("Matched color "+a);for(var p,c,f=[.5*(h.Bounds[0]+h.Bounds[1]),.5*(h.Bounds[2]+h.Bounds[3])],g=Math.abs(h.Bounds[1]-h.Bounds[0])+Math.abs(h.Bounds[3]-h.Bounds[2]),v=h.ComputeArea(),S=-1,y=0;y<o.length;++y){var m=o[y];if(m.Polyline){var w=m.Polyline,C=n.ForwardTransform(f,g),A=[.5*(w.Bounds[0]+w.Bounds[1]),.5*(w.Bounds[2]+w.Bounds[3])],T=w.ComputeArea(),b=A[0]-C[0],D=A[1]-C[1],x=(b*b+D*D+Math.abs(T-v))/v;(-1===S||x<p)&&(p=x,c=m,S=y)}}-1===S?console.log("+++ No candidates: Widget"+a):p<e?(c.Polyline.OutlineColor=r.Polyline.OutlineColor.slice(0),console.log("+++ Match: Widget "+a+" = "+S+", ("+p+")")):console.log("--- No match: Widget "+a+", Closest "+S+", ("+p+")")}}this.EventuallyRender()},t.prototype.SetPolylineColor=function(t){for(var e=this.Viewers[1].GetAnnotationLayer().GetWidgets(),i=0;i<e.length;++i){var o=e[i];o.Polyline&&(o.Polyline.OutlineColor=t.slice(0))}this.EventuallyRender()},SA.DualViewWidget=t}(),function(){"use strict";function t(t){this.Div=$("<div>").appendTo(t).css({position:"relative",width:"100%",height:"100%"}),this.TabDiv=$("<div>").appendTo(this.Div).css({position:"absolute",width:"100%",height:"30px"}),this.BodyDiv=$("<div>").appendTo(this.Div).css({position:"absolute",width:"100%",top:"30px",bottom:"0px"}),this.TabPanels=[],this.CurrentTabPanel=null}function e(t,e){var i=this;this.Enabled=!0,this.Tab=$("<div>").appendTo(t.TabDiv).text(e).css({color:"#AAA","border-color":"#BBB",position:"relative",bottom:"-2px",padding:"2px 7px 2px 7px",margin:"5px 0px 0px 5px",display:"inline-block","border-width":"1px","border-style":"solid","border-radius":"5px 5px 0px 0px","z-index":"6",background:"white"}).click(function(){t.OpenTabPanel(i)}),this.Div=$("<div>").hide().appendTo(t.BodyDiv).css({position:"absolute",top:"0px",bottom:"3px",left:"3px",right:"3px","border-width":"1px","border-style":"solid","border-color":"#BBB","z-index":"5",background:"white"})}t.prototype.NewTabDiv=function(t,i){var o=new e(this,t);return i&&o.Tab.prop("title",i),this.TabPanels.push(o),1===this.TabPanels.length&&this.OpenTabPanel(o),o.Div},t.prototype.OpenTabPanel=function(t){if(t){for(var e=0;e<this.TabPanels.length;++e){var i=this.TabPanels[e];i.Div.hide(),i.Tab.css({color:"#AAA","z-index":"4","border-color":"#BBB"})}t.Div.show(),t.Tab.css({color:"#000","z-index":"6","border-color":"#BBB #BBB #FFF #BBB"}),this.CurrentTabPanel=t,$(window).trigger("resize")}},t.prototype.GetCurrentDiv=function(){if(this.CurrentTabPanel)return this.CurrentTabPanel.Div},t.prototype.GetTabPanelFromDiv=function(t){for(var e=0;e<this.TabPanels.length;++e){var i=this.TabPanels[e];if(i.Div===t)return i}return null},t.prototype.GetTabPanelFromIndex=function(t){return t<0||t>=this.TabPanels.length?(console.log("GetTabPanelFromIndex("+t+"): error"),null):this.TabPanels[t]},t.prototype.ShowTabDiv=function(t){this.OpenTabPanel(this.GetTabPanelFromDiv(t))},t.prototype.ShowTabIndex=function(t){this.OpenTabPanel(this.GetTabPanelFromIndex(t))},t.prototype.EnableTabDiv=function(t){var e=this.GetTabPanelFromDiv(t);e.Enabled=!0,e.Tab.show()},t.prototype.DisableTabDiv=function(t){var e=this.GetTabPanelFromDiv(t);if(e){if(e.Enabled=!1,e===this.CurrentTabPanel){this.CurrentTabPanel=null;for(var i=0;i<this.TabPanels.length;++i)if(this.TabPanels[i].Enabled){this.OpenTabPanel(this.TabPanel[i]);break}}e.Tab.css({color:"#AAA","z-index":"4","border-color":"#BBB"}),e.Div.hide(),e.Tab.hide()}},SA.TabbedDiv=t,SA.TabPanel=e}(),function(){"use strict";function t(){SA.Notes||(SA.Notes=[]),this.Id=this.TempId=(new ObjectId).toString(),SA.Notes.push(this);var t=this;this.LoadState=e,this.User=SA.GetUser();var i=new Date;this.Date=i.getTime(),this.Type="Note",this.Mode="",this.Title="",this.Text="",this.Modified=!1,this.ViewerRecords=[],this.Parent=null,this.Children=[],this.ChildrenVisibility=!0,this.Div=$("<li>").attr({class:"note"}),this.TitleDiv=$("<div>").css({position:"relative"}).appendTo(this.Div),this.SortHandle=$("<span>").appendTo(this.TitleDiv).css({position:"absolute",left:"0px",top:"0px",opacity:"0.5"}).addClass("ui-icon ui-icon-bullet"),this.ButtonsDiv=$("<div>").appendTo(this.TitleDiv).css({float:"right"}).hide(),this.TitleEntry=$("<div>").css({"margin-left":"20px"}).appendTo(this.TitleDiv).text(this.Title).addClass("sa-title"),"answer-hide"!==this.Mode&&"answer-interactive"!==this.Mode||this.TitleEntry.text("-"),SA.Edit&&(this.AddButton=$("<img>").appendTo(this.ButtonsDiv).attr("src",SA.ImagePathUrl+"page_add.png").addClass("editButton").prop("title","add view").css({width:"12px",height:"12px",opacity:"0.5"}),this.LinkButton=$("<img>").appendTo(this.ButtonsDiv).attr("src",SA.ImagePathUrl+"link.png").prop("title","show url").addClass("editButton").css({width:"12px",height:"12px",opacity:"1.0"}),this.RemoveButton=$("<img>").appendTo(this.ButtonsDiv).hide().attr("src",SA.ImagePathUrl+"remove.png").prop("title","delete").addClass("editButton").css({width:"12px",height:"12px",opacity:"0.5"})),(SA.HideAnnotations||"answer-hide"===this.Mode||"answer-interactive"===this.Mode)&&this.TitleEntry.text("-"),SA.Edit&&(this.Modified=!1,"answer-hide"===this.Mode&&"answer-interactive"!==this.Mode&&this.TitleEntry.attr("contenteditable","true")),this.ChildrenDiv=$("<ul>").addClass("sa-ul").appendTo(this.Div),SA.Edit?this.ChildrenDiv.sortable({update:function(e,i){t.SortCallback()},handle:".ui-icon"}):this.ChildrenDiv.disableSelection(),this.StartIndex=0,this.ActiveCorrelation=void 0,this.StackDivs=[]}var e=0;SA.GetNoteFromId=function(t){for(var e=0;e<SA.Notes.length;++e){var i=SA.Notes[e];if(i.Id&&i.Id===t)return i}return null},SA.GetUserNoteFromImageId=function(t){for(var e=0;e<SA.Notes.length;++e){var i=SA.Notes[e];if("UserNote"===i.Type&&i.Parent===t)return i}return null},SA.DeleteNote=function(t){var e=SA.Notes.indexOf(t);-1!==e&&SA.Notes.splice(e,1)},t.prototype.DeepCopy=function(e){this.Image=t.Image,this.Children=[];for(var i=0;i<e.Children.length;++i){var o=new SA.Note;o.DeepCopy(e.Children[i]),this.Children.push(o)}this.Parent=e.Parent,this.StartIndex=e.StartIndex;var s=e.Id,n=this.Id;for(this.Text=e.Text.replace(s,n),this.Title=e.Title,this.Type=e.Type,this.User=e.User,this.ViewerRecords=[],i=0;i<e.ViewerRecords.length;++i){var a=new SA.ViewerRecord;a.DeepCopy(e.ViewerRecords[i]),this.ViewerRecords.push(a)}},t.prototype.SortCallback=function(){for(var t=[],e=this.ChildrenDiv.children(),i=0;i<e.length;++i){var o=$(e[i]).data("index"),s=this.Children[o];s.Div.data("index",i),t.push(s)}this.Children=t,this.UpdateChildrenGUI(),SA.notesWidget&&SA.notesWidget.MarkAsModified()},t.prototype.ClearHyperlink=function(){if(this.Id){this.SelectHyperlink();var t=window.getSelection();document.execCommand("insertText",t.toString())}},t.prototype.SelectHyperlink=function(){if(this.Id){var t=document.getElementById(this.Id);if(t){var e=document.createRange();e.selectNode(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)}}},t.prototype.UnselectHyperlink=function(){if(this.Id&&document.getElementById(this.Id)){var t=document.createRange();t.collapse(!0);var e=window.getSelection();e.removeAllRanges(),e.addRange(t)}},t.prototype.SetParent=function(t){this.Parent=t,t&&SA.Edit&&this.RemoveButton.show()},t.prototype.TitleFocusInCallback=function(){SA.ContentEditableHasFocus=!0,SA.SetNote(this)},t.prototype.TitleFocusOutCallback=function(){if(this.Modified&&(this.Modified=!1,"answer-hide"!==this.Mode&&"answer-interactive"!==this.Mode&&(this.Title=this.TitleEntry.text()),SA.notesWidget&&SA.notesWidget.MarkAsModified()),SA.ContentEditableHasFocus=!1,this.Modified&&(this.Modified=!1,"answer-hide"!==this.Mode&&"answer-interactive"!==this.Mode)){var t=this.TitleEntry.text();this.Title===t||SA.HideAnnotations||(this.Title=t,this.Save())}},t.prototype.LinkCallback=function(){if(SA.LinkDiv){var t="slide-atlas.org/webgl-viewer?view="+this.Id;SA.LinkDiv.html(t),SA.LinkDiv.show();var e=document.createRange();e.selectNodeContents(SA.LinkDiv[0]);var i=window.getSelection();i.removeAllRanges(),i.addRange(e),document.execCommand("copy",!1,null)}},t.prototype.DeleteCallback=function(){if("UserNote"!==this.Type){var t=this.Parent;if(null!==t){this.ClearHyperlink(),"view"!==this.Type&&SA.display&&SA.display.NavigationWidget&&SA.display.NavigationWidget.GetNote()===this&&SA.display.NavigationWidget.PreviousNote();var e=t.Children.indexOf(this);t.Children.splice(e,1),this.Parent=null,t.UpdateChildrenGUI(),SA.notesWidget&&SA.notesWidget.MarkAsModified()}}},t.prototype.SetUserNote=function(t){var e=this;e.UserNote=t,t.Parent=e,t.Type="UserNote"},t.prototype.UserCanEdit=function(){return SA.Edit},t.prototype.RecordView=function(t){if(0!==t.GetNumberOfViewers())if("Stack"!==this.Type){this.ViewerRecords=[];for(var e=0;e<t.GetNumberOfViewers();++e){var i=new SA.ViewerRecord;i.CopyViewer(t.GetViewer(e)),this.ViewerRecords.push(i)}}else{var o=t.GetViewer(0);0===this.StartIndex&&this.ViewerRecords[0].CopyViewer(o)}},t.prototype.AddChild=function(t,e){t.Div.data("index",this.Children.length),e?this.Children.splice(0,0,t):this.Children.push(t),this.UpdateChildrenGUI()},t.prototype.UpdateChildrenGUI=function(){var t;if(this.ChildrenDiv.empty(),"Stack"!==this.Type){if(0!==this.Children.length){var e=[];for(t=0;t<this.Children.length;++t)"Note"===this.Children[t].Type&&e.push(this.Children[t]);for(t=0;t<this.Children.length;++t)"Note"!==this.Children[t].Type&&e.push(this.Children[t]);for(this.Children=e,t=0;t<this.Children.length;++t)"Note"===this.Children[t].Type&&(this.Children[t].DisplayGUI(this.ChildrenDiv),this.Children[t].Div.data("index",t),this.Children.length>1?this.Children[t].SortHandle.addClass("sa-sort-handle"):this.Children[t].SortHandle.removeClass("sa-sort-handle"))}}else for(this.StackDivs=[],t=0;t<this.ViewerRecords.length;++t){var i=$("<div>").addClass("note").appendTo(this.ChildrenDiv);SA.HideAnnotations?i.text(t.toString()):i.text(this.ViewerRecords[t].Image.label),this.StackDivs.push(i),t===this.StartIndex&&i.css({"background-color":"#BBB"})}},t.prototype.NewIterator=function(){return new SA.NoteIterator(this)},t.prototype.Contains=function(t){for(var e=0;e<this.Children.length;++e){var i=this.Children[e];if(i===t)return!0;if(i.Contains(t))return!0}return!1},t.prototype.NewChild=function(t,e){var i=new SA.Note;i.Title=e;var o=new Date;return i.Date=o.getTime(),this.Children.splice(t,0,i),i.SetParent(this),i},t.prototype.Save=function(t,e){console.log("Save note "+this.Id+" "+this.Title);var i=this,o=JSON.stringify(this.Serialize(e)),s=new Date;SA.PushProgress(),$.ajax({type:"post",url:"/webgl-viewer/saveviewnotes",data:{note:o,date:s.getTime()},success:function(e,o){SA.PopProgress(),t&&t(i),i.LoadState=2},error:function(){SA.PopProgress(),SA.Debug("AJAX - error() : saveviewnotes")}})},t.prototype.HasAnnotations=function(){for(var t=0;t<this.ViewerRecords.length;++t)if(this.ViewerRecords.Annotations.length>0)return!0;return!1},t.prototype.RecordAnnotations=function(t){this.UserNote&&(this.UserNote.RecordAnnotations(t),(this.UserNote.HasAnnotations()||this.UserNote.LoadState!==e)&&this.UserNote.Save());for(var i=0;i<t.GetNumberOfViewers();++i)this.ViewerRecords.length>this.StartIndex+i&&this.ViewerRecords[this.StartIndex+i].CopyAnnotations(t.GetViewer(i),"UserNote"===this.Type)},t.prototype.DisplayGUI=function(t){var e=this;this.Div.appendTo(t),"answer-hide"!==this.Mode&&"answer-interactive"!==this.Mode?(this.TitleEntry.click(function(){SA.SetNote(e),e.ButtonsDiv.show()}).bind("input",function(){e.Modified=!0}).focusin(function(){e.TitleFocusInCallback()}).focusout(function(){e.TitleFocusOutCallback()}).mouseleave(function(){e.Modified&&(e.Modified=!1,e.Title=e.TitleEntry.text(),SA.notesWidget&&SA.notesWidget.MarkAsModified())}),this.TitleDiv.hover(function(){e.TitleEntry.css({color:"#33D"}),SA.notesWidget&&SA.notesWidget.SelectedNote===e&&e.ButtonsDiv.show()},function(){e.TitleEntry.css({color:"#3AF"}),e.ButtonsDiv.hide()}),this.TitleEntry.text(this.Title)):this.TitleEntry.text("-"),SA.Edit&&(this.AddButton.click(function(){SA.notesWidget&&SA.notesWidget.NewCallback()}),this.LinkButton.click(function(){e.LinkCallback()}),this.RemoveButton.click(function(){e.DeleteCallback()})),this.UpdateChildrenGUI()},t.prototype.Serialize=function(t){var e={};e.SessionId=localStorage.sessionId,e.Type=this.Type,e.Mode=this.Mode,e.User=this.User,e.Date=this.Date,this.WaterMark&&(e.WaterMark=this.WaterMark),this.TypeData&&(e.TypeData=this.TypeData),this.NotesPanelOpen&&(e.NotesPanelOpen=!0),this.Id&&(e._id=this.Id,delete this._id),this.Parent&&("string"==typeof this.Parent&&(e.ParentId=this.Parent),"object"==typeof this.Parent&&this.Parent.Id&&(e.ParentId=this.Parent.Id),delete this.ParentId),e.Title=this.Title,e.HiddenTitle=this.HiddenTitle,e.Text=this.Text,e.ViewerRecords=[];for(var i=0;i<this.ViewerRecords.length;++i)if(this.ViewerRecords[i].Image){var o=this.ViewerRecords[i].Serialize();e.ViewerRecords.push(o)}if(e.CoordinateSystem="Pixel",!t)for(e.Children=[],i=0;i<this.Children.length;++i)e.Children.push(this.Children[i].Serialize(t));return e},t.prototype.Load=function(t){this.LoadState=2;var e;for(e in t)this[e]=t[e];this._id&&(this.Id=this._id,delete this._id),"UserNote"!==this.Type&&this.ParentId&&(this.Parent=SA.GetNoteFromId(this.ParentId),delete this.ParentId),SA.HideAnnotations||"answer-hide"===this.Mode||"answer-interactive"===this.Model?this.TitleEntry.text("-"):this.TitleEntry.text(this.Title);for(var i=0;i<this.Children.length;++i){var o=this.Children[i],s=new SA.Note;s.SetParent(this),"string"==typeof o?s.Id=o:s.Load(o),this.Children[i]=s,s.Div.data("index",i)}for(this.UserNote&&(t=this.UserNote,this.UserNote=new SA.Note,this.UserNote.Load(t)),i=0;i<this.ViewerRecords.length;++i)this.ViewerRecords[i]&&(t=this.ViewerRecords[i],this.ViewerRecords[i]=new SA.ViewerRecord,this.ViewerRecords[i].Load(t),i<3&&this.ViewerRecords[i].RequestUserNote())};var i=[];t.prototype.LoadViewId=function(t,e){if(2!==this.LoadState){if(1!==this.LoadState){var o=this;this.LoadState=1,SA.PushProgress(),$.ajax({type:"get",url:"/webgl-viewer/getview",data:{viewid:t},success:function(t,s){SA.PopProgress(),o.Load(t),e&&e();for(var n=[],a=0;a<i.length;++a){var r=i[a];r.note===o?r.callback():n.push(r)}i=n},error:function(){SA.PopProgress(),SA.Debug("AJAX - error() : getview")}})}}else e()},t.prototype.Collapse=function(){this.ChildrenVisibility=!1,this.Contains(SA.notesWidget.SelectedNote)&&SA.SetNote(this),this.UpdateChildrenGUI(),SA.display.NavigationWidget.Update()},t.prototype.Expand=function(){this.ChildrenVisibility=!0,this.UpdateChildrenGUI(),SA.display.NavigationWidget.Update()},t.prototype.DisplayStack=function(t){if(SA.Edit&&this.StartIndex+1<this.ViewerRecords.length){var e=this.ViewerRecords[this.StartIndex+1].Transform;e&&(t.GetViewer(0).StackCorrelations=e.Correlations,t.GetViewer(1).StackCorrelations=e.Correlations)}for(var i=0;i<this.StackDivs.length;++i)i===this.StartIndex?this.StackDivs[i].css({"background-color":"#BBB"}):this.StackDivs[i].css({"background-color":"#FFF"})},t.prototype.InitializeStackTransforms=function(){for(var t=1;t<this.ViewerRecords.length;++t)if(!this.ViewerRecords[t].Transform){var e=this.ViewerRecords[t-1].Camera,i=this.ViewerRecords[t].Camera,o=i.GetWorldRoll()-e.GetWorldRoll();o<0&&(o+=2*Math.PI);var s=new SA.PairTransformation;s.AddCorrelation(e.GetWorldFocalPoint(),i.GetWorldFocalPoint(),o,.5*(e.Height+i.Height)),this.ViewerRecords[t].Transform=s}},SA.Note=t}(),function(){"use strict";function t(){var t=this;this.Windows=new Array(3),this.Windows[0]=new Array(3),this.Windows[1]=new Array(3),this.Windows[2]=new Array(3),this.ScreenRectangle=$("<div>").appendTo("body").css({position:"absolute",background:"#06F",opacity:"0.5","z-index":"100"}).hide(),this.HorizontalLine=$("<div>").appendTo(this.ScreenRectangle).css({position:"absolute",left:"0px",width:"100%",top:"50%",height:"1px",background:"#FFF",opacity:"0.4"}),this.VerticalLine=$("<div>").appendTo(this.ScreenRectangle).css({position:"absolute",top:"0px",height:"100%",left:"50%",width:"1px",background:"#FFF",opacity:"0.4"}),this.WindowRectangle=$("<div>").appendTo(this.ScreenRectangle).css({position:"absolute","box-sizing":"border-box",background:"#AAA",border:"1px solid #FFF",opacity:"0.7"}),this.ScreenRectangle.bind("mousemove",function(e){t.HandleMouseMove(e)}),this.ScreenRectangle.bind("mouseup",function(e){t.HandleMouseUp(e)}),this.ScreenRectangle.bind("mouseleave",function(e){t.HandleMouseLeave(e)}),$(window).bind("beforeunload",function(){for(var e=0;e<3;++e)for(var i=0;i<3;++i){var o=t.Windows[e][i];o&&!o.closed&&o.close()}})}t.prototype.Show=function(t,e,i,o){this.Title=o||"SlideAtlas",this.Url=i,this.AvailableLeft=screen.availLeft||0,this.AvailableTop=screen.availTop||0,this.AvailableWidth=screen.availWidth||screen.width||1e3,this.AvailableHeight=screen.availHeight||screen.height||800;var s=this.AvailableWidth/10,n=this.AvailableHeight/10,a=t-s/2,r=e-n/2;a<0&&(a=0),r<0&&(r=0),this.Partition=[1,1],this.WindowRectangle.css({left:"3%",top:"3%",width:"94%",height:"94%"}),this.ScreenRectangle.css({left:a+"px",top:r+"px",width:s+"px",height:n+"px"}).show()},t.prototype.HandleMouseLeave=function(t){this.ScreenRectangle.hide()},t.prototype.HandleMouseUp=function(t){var e=this.Partition[0],i=this.Partition[1],o=this.Windows[e][i];if(o&&!o.closed)return o.location.href=this.Url,void(o.document.title=this.Title);var s=this.AvailableLeft,n=this.AvailableTop;o=this.AvailableWidth;var a=this.AvailableHeight;1!==e&&(o/=2),1!==i&&(a/=2),2===e&&(s+=o),2===i&&(n+=a),o-=27,a-=100;var r=this.Title+" "+e+" "+i;this.Windows[this.Partition[0]][this.Partition[1]]=window.open(this.Url,r,"alwaysRaised=yes,titlebar=no,menubar=no,toolbar=no,dependent=yes,left="+s+",top="+n+",width="+o+",height="+a),this.ScreenRectangle.hide()},t.prototype.HandleMouseMove=function(t){for(var e=this.ScreenRectangle.width(),i=this.ScreenRectangle.height(),o=t.offsetX,s=t.offsetY,n=$(t.originalEvent.srcElement);n[0]!==this.ScreenRectangle[0];){var a=n.position();if(o+=a.left,s+=a.top,!(n=n.parent()))return}o<e/3?(this.Partition[0]=0,this.WindowRectangle.css({left:"3%",width:"44%"})):o>2*e/3?(this.Partition[0]=2,this.WindowRectangle.css({left:"53%",width:"44%"})):(this.Partition[0]=1,this.WindowRectangle.css({left:"3%",width:"94%"})),s<i/3?(this.Partition[1]=0,this.WindowRectangle.css({top:"3%",height:"44%"})):s>2*i/3?(this.Partition[1]=2,this.WindowRectangle.css({top:"53%",height:"44%"})):(this.Partition[1]=1,this.WindowRectangle.css({top:"3%",height:"94%"}))},SA.WindowManager=t}(),function(){"use strict";function t(t,e){this.Header=$("<div>").appendTo(t).css({width:"100%"}),this.Body=$("<div>").appendTo(t).css({width:"100%",position:"absolute",top:"90px",bottom:"0px"});var i=this;this.Header.saOnResize(function(){var t=i.Header.height();0!==t?i.Body.css({top:t+"px"}):setTimeout(function(){i.Header[0].onresize()},250)}),this.Display=e,this.Parent=t,this.Editable=!0,this.Edit=!0,this.ChangeCallback=null,this.EditButtons=[],this.AddEditButton(SA.ImagePathUrl+"camera.png","link view",function(){i.InsertCameraLink()}),this.AddEditButton(SA.ImagePathUrl+"link.png","link URL",function(){i.InsertUrlLink()}),this.AddEditButton(SA.ImagePathUrl+"font_bold.png","bold",function(){document.execCommand("bold",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"text_italic.png","italic",function(){document.execCommand("italic",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"edit_underline.png","underline",function(){document.execCommand("underline",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"list_bullets.png","unorded list",function(){document.execCommand("InsertUnorderedList",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"list_numbers.png","ordered list",function(){document.execCommand("InsertOrderedList",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"indent_increase.png","indent",function(){document.execCommand("indent",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"indent_decrease.png","outdent",function(){document.execCommand("outdent",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"alignment_left.png","align left",function(){document.execCommand("justifyLeft",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"alignment_center.png","align center",function(){document.execCommand("justifyCenter",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"edit_superscript.png","superscript",function(){document.execCommand("superscript",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"edit_subscript.png","subscript",function(){document.execCommand("subscript",!1,null)}),this.AddEditButton(SA.ImagePathUrl+"font_increase.png","large font",function(){document.execCommand("fontSize",!1,"5"),i.ChangeBulletSize("1.5em")}),this.AddEditButton(SA.ImagePathUrl+"font_decrease.png","small font",function(){document.execCommand("fontSize",!1,"2"),i.ChangeBulletSize("0.9em")}),this.AddEditButton(SA.ImagePathUrl+"question.png","add question",function(){i.AddQuestion()}),this.InitializeHomeButton(this.Header),this.TextEntry=$("<div>").appendTo(this.Body).attr("contenteditable","true").removeAttr("readonly").css({"box-sizing":"border-box",width:"100%",height:"100%",overflow:"auto",resize:"none","border-style":"inset","font-size":"10pt","font-family":"Century Gothic",background:"#f5f8ff"}).bind("input",function(){i.EventuallyUpdate()}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1,i.Update()}).mouseleave(function(){i.Update()}),this.UpdateTimer=null,this.EditOff(),this.Note=null}t.prototype.HomeCallback=function(){this.Note&&SA.SetNote(this.Note)},t.prototype.InitializeHomeButton=function(t){var e=this;this.HomeButton=$("<div>").appendTo(t).text("Home").css({"text-align":"center",border:"1px solid #666666","border-radius":"10px",margin:"2px",color:"#29C",background:"white"}).hover(function(){$(this).css("color","blue")},function(){$(this).css("color","#29C")}),this.HomeButton.contextmenu(function(){return!1}),this.HomeButton.mousedown(function(t){if(0===t.button)return e.HomeCallback(),!1;if(2===t.button){e.LinkMenuObject={Link:e.HomeButton,Note:e.Note};var i=$(this).position();return e.DeleteLinkButton.hide(),e.LinkMenu.css({left:25+i.left+"px",top:i.top+"px"}).show(),!1}return!0}),this.LinkMenuObject=void 0,this.LinkMenu=$("<div>").appendTo(t).hide().mouseleave(function(){$(this).hide()}).css({position:"absolute","background-color":"#FFFFFF",border:"1px solid #666666","box-sizing":"border-box",left:"-78px",width:"100px",padding:"0px 2px"}),$("<button>").appendTo(this.LinkMenu).text("Save View").css({margin:"2px 0px",width:"100%"}).prop("title","Replace Annotation").click(function(){e.SaveLink(e.LinkMenuObject.Link,e.LinkMenuObject.Note),e.LinkMenu.hide()}),this.DeleteLinkButton=$("<button>").appendTo(this.LinkMenu).text("Delete").css({margin:"2px 0px",width:"100%"}).click(function(){e.DeleteLink(e.LinkMenuObject.Link,e.LinkMenuObject.Note),e.LinkMenu.hide()})},t.prototype.StartWindowManagerTimer=function(t,e,i){this.WindowManagerX=e,this.WindowManagerY=i,this.LinkWindowLocation=0;var o=this;this.WindowManagerTimer=setTimeout(function(){o.WindowManagerTimer=void 0,o.ShowWindowManager(t,e,i)},1e3)},t.prototype.ShowWindowManager=function(t,e,i){this.WindowMangerTimer&&(clearTimeout(this.WindowManagerTimer),this.WindowManagerTimer=void 0),SA.windowManager||(SA.windowManager=new SA.WindowManager),SA.windowManager.Show(e,i,"/webgl-viewer?view="+t.Id,t.Title),this.LinkWindowLocation=1},t.prototype.FormatLink=function(t){var e=this,i=document.getElementById(t.Id);i&&($(i).css({color:"#29C",background:"white"}).hover(function(){$(this).css("color","blue")},function(){$(this).css("color","#29C")}).attr("contenteditable","false"),$(i).contextmenu(function(){return!1}),$(i).mousedown(function(o){if(0===o.button)return e.StartWindowManagerTimer(t,o.pageX,o.pageY),!1;if(2===o.button){e.LinkMenuObject={Link:$(i),Note:t};var s=$(this).position();return e.DeleteLinkButton.show(),e.LinkMenu.css({left:25+s.left+"px",top:s.top+"px"}).show(),!1}return!0}),$(i).mousemove(function(i){if(1===i.which){var o=i.pageX-e.WindowManagerX,s=i.pageY-e.WindowManagerY;Math.abs(o)+Math.abs(s)>5&&e.ShowWindowManager(t,i.pageX,i.pageY)}}),$(i).mouseup(function(i){return 0!==i.button||(e.WindowManagerTimer&&(clearTimeout(e.WindowManagerTimer),e.WindowManagerTimer=void 0),0!==e.LinkWindowLocation)||(SA.SetNote(t),!1)}))},t.prototype.SaveLink=function(t,e){e.RecordView(this.Display),e.Save()},t.prototype.DeleteLink=function(t,e){var i=t.text();$(document.createTextNode(i)).insertAfter(t),t.remove(),e.DeleteCallback(),this.UpdateNote(),this.Note.Save()},t.prototype.Change=function(t){this.ChangeCallback=t},t.prototype.EventuallyUpdate=function(){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.UpdateTimer=null);var t=this;this.UpdateTimer=setTimeout(function(){t.UpdateNote()},5e3)},t.prototype.Update=function(){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.UpdateTimer=null,this.UpdateNote())},t.prototype.EditOff=function(){if(this.Edit){this.Edit=!1;for(var t=0;t<this.EditButtons.length;++t)this.EditButtons[t].hide();this.TextEntry.attr("contenteditable","false").attr("spellcheck","false").css({"border-style":"outset",background:"#ffffff"}).unbind("input").unbind("focusin").unbind("focusout").unbind("mouseleave").blur()}},t.prototype.EditableOff=function(){this.EditOff(),this.Editable=!1},t.prototype.EditOn=function(){var t=this;if(this.Editable&&!this.Edit){this.Edit=!0;for(var e=0;e<this.EditButtons.length;++e)this.EditButtons[e].show();this.TextEntry.attr("contenteditable","true").removeAttr("readonly").css({"border-style":"inset",background:"#f5f8ff"}).bind("input",function(){t.Modified=!0,t.EventuallyUpdate()}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1,t.Update()}).mouseleave(function(){t.Update()})}},t.prototype.AddEditButton=function(t,e,i){var o=$("<img>");e&&o.prop("title",e),o.appendTo(this.Header).addClass("editButton").attr("src",t).click(i),this.EditButtons.push(o)},t.prototype.AddQuestion=function(){var t=$("<div>").css({position:"relative",margin:"3%",width:"90%",background:"#FFF",border:"1px solid #AAA",padding:"1% 1% 1% 1%"}).attr("contenteditable","false").saQuestion({editable:SA.Edit,position:"static"}),e=this,i=SA.GetSelectionRange(this.TextEntry);if(!i.collapsed){var o=i.cloneContents();if(t.saQuestion("SetQuestionText",o.firstChild.textContent),o.childElementCount>1){var s=[],n=0,a=o.querySelector("li");a?s=a.parentElement:o.childElementCount>2?(s=o,n=1):s=o.children[1];for(var r=n;r<s.childElementCount;++r){var h=s.children[r],l="bold"===h.style.fontWeight||$(h).find("b").length>0;t.saQuestion("AddAnswerText",h.textContent,l)}}}t.saQuestion("OpenDialog",function(){i?(i.deleteContents(),i.insertNode(document.createElement("br"))):i=SA.MakeSelectionRange(e.TextEntry),i.insertNode(t[0]),i.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(i),e.TextEntry[0].focus(),e.UpdateNote()})},t.prototype.ChangeBulletSize=function(t){var e=SA.GetSelectionRange(this.TextEntry);e=e||SA.MakeSelectionRange(this.TextEntry);for(var i=$("li"),o=0;o<i.length;++o){var s=i[o];(e.isPointInRange(s,0)||e.isPointInRange(s,1))&&$(s).css({"font-size":t})}},t.prototype.InsertUrlLink=function(){var t=this,e=window.getSelection(),i=SA.GetSelectionRange(this.TextEntry),o=e.toString();if(!this.UrlDialog){var s=new SAM.Dialog(function(){t.InsertUrlLinkAccept()});s.Body.css({margin:"1em 2em"}),this.UrlDialog=s,s.Dialog.css({width:"40em"}),s.Title.text("Paste URL link"),s.TextDiv=$("<div>").appendTo(s.Body).css({display:"table-row",width:"100%"}),s.TextLabel=$("<div>").appendTo(s.TextDiv).text("Text to display:").css({display:"table-cell",height:"2em","text-align":"left"}),s.TextInput=$("<input>").appendTo(s.TextDiv).val("#30ff00").css({display:"table-cell",width:"25em"}),s.UrlDiv=$("<div>").appendTo(s.Body).css({display:"table-row"}),s.UrlLabel=$("<div>").appendTo(s.UrlDiv).text("URL link:").css({display:"table-cell","text-align":"left"}),s.UrlInput=$("<input>").appendTo(s.UrlDiv).val("#30ff00").css({display:"table-cell",width:"25em"}).bind("input",function(){var e=t.UrlDialog.UrlInput.val();t.UrlDialog.LastUrl===t.UrlDialog.TextInput.val()&&t.UrlDialog.TextInput.val(e),t.UrlDialog.LastUrl=e,""===e?t.UrlDialog.ApplyButton.attr("disabled",!0):t.UrlDialog.ApplyButton.attr("disabled",!1)})}this.UrlDialog.SelectionRange=i,this.UrlDialog.TextInput.val(o),this.UrlDialog.UrlInput.val(""),this.UrlDialog.LastUrl="",this.UrlDialog.ApplyButton.attr("disabled",!0),this.UrlDialog.Show(!0)},t.prototype.InsertUrlLinkAccept=function(){var t=window.getSelection(),e=this.UrlDialog.SelectionRange;e=e||SA.MakeSelectionRange(this.TextEntry);var i=document.createElement("a");i.href=this.UrlDialog.UrlInput.val(),i.target="_blank",e.collapsed||(e.extractContents(),e.collapse(!0));var o=this.UrlDialog.TextInput.val();""===o&&(o=this.UrlDialog.UrlInput.val()),i.appendChild(document.createTextNode(o)),e.insertNode(i),e.noCursor&&t.removeAllRanges(),this.UpdateNote()},t.prototype.InsertCameraLink=function(){var t=this.Note;t||(t=SA.display.GetRootNote());var e="(view)",i=t.Children.length,o=t.NewChild(i,e);o.RecordView(this.Display),o.Type="View";var s=SA.GetSelectionRange(this.TextEntry);s?s.collapsed||(e=s.toString()):s=SA.MakeSelectionRange(this.TextEntry),o.Title=e,s.deleteContents();var n=document.createElement("span");n.id=o.Id,$(n).attr("contenteditable","false"),n.appendChild(document.createTextNode(e)),s.insertNode(n),this.FormatLink(o),s.collapse(!1);var a=window.getSelection();a.removeAllRanges(),a.addRange(s),this.TextEntry[0].focus(),this.UpdateNote(),this.Note.Save(),SA.SetNote(o)},t.prototype.Resize=function(t,e){var i;i=this.TextEntry.offset(),this.TextEntry.height(e-i.top-5)},t.prototype.SetHtml=function(t){console.log("Something called 'TextEditor::SetHtml'"),this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.Update()),this.Note=null,this.EditOn(),this.TextEntry.html(t),SA.Edit&&this.TextEntry.find(".sa-question").saQuestion({editable:!0,position:"static"}),SA.AddHtmlTags(this.TextEntry)},t.prototype.GetHtml=function(){return this.TextEntry.html()},t.prototype.LoadNote=function(t){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.Update()),this.Note=t,this.HomeButton[0].id=t.Id,this.TextEntry.html(t.Text),SA.AddHtmlTags(this.TextEntry),this.UpdateMode(t.Mode),SA.Edit&&this.TextEntry.find(".sa-question").saQuestion({editable:!0,position:"static"});for(var e=0;e<t.Children.length;++e)this.FormatLink(t.Children[e]);this.MakeLinksClickable(),SA.Edit&&this.EditOn(),this.TextEntry.trigger("resize")},t.prototype.UpdateMode=function(t){"answer-show"===t&&this.Note&&this.Note.Title?this.HomeButton.text(this.Note.Title):this.HomeButton.text("Home"),"answer-show"===t?($(".sa-note").show(),$(".sa-notes").show(),$(".sa-diagnosis").show(),$(".sa-differential-diagnosis").show(),$(".sa-teaching-points").show(),$(".sa-compare").show(),$(".sa-question").saQuestion("SetMode",t)):"answer-hide"!==t&&"answer-interactive"!==t||($(".sa-note").hide(),$(".sa-notes").hide(),$(".sa-diagnosis").hide(),$(".sa-differential-diagnosis").hide(),$(".sa-teaching-points").hide(),$(".sa-compare").hide(),$(".sa-question").saQuestion("SetMode",t))},t.prototype.UpdateNote=function(){this.UpdateTimer=null,this.Note&&(this.Note.Text=this.TextEntry.html(),this.ChangeCallback&&this.ChangeCallback(),this.MakeLinksClickable())},t.prototype.MakeLinksClickable=function(){if(SA.Edit)for(var t=$("a"),e=0;e<t.length;++e){var i=t[e];$(i).click(function(){window.open(this.href,"_blank")})}},SA.TextEditor=t}(),function(){"use strict";function t(t,e){this.ModifiedCallback=null,this.DisplayedNote=null,SA.LinkDiv=$("<div>").appendTo("body").css({top:"30px",left:"10%",position:"absolute",width:"80%",height:"50px","z-index":"3","background-color":"#FFF",border:"1px solid #777","border-radius":"8px","text-align":"center","padding-top":"26px"}).hide().mouseleave(function(){SA.LinkDiv.fadeOut()}),SA.Edit&&SA.LinkDiv.attr("contenteditable","true");var i=this;this.Display=e,this.Modified=!1,this.Window=$("<div>").appendTo(t).css({"background-color":"white",position:"absolute",top:"0%",left:"0%",height:"100%",width:"100%","z-index":"2"}).attr("draggable","false").on("dragstart",function(){return!1}).attr("id","NoteWindow"),this.TabbedWindow=new SA.TabbedDiv(this.Window),this.TextDiv=this.TabbedWindow.NewTabDiv("Text"),this.UserTextDiv=this.TabbedWindow.NewTabDiv("Notes","private notes"),this.LinksDiv=this.TabbedWindow.NewTabDiv("Views"),this.LinksRoot=$("<ul>").addClass("sa-ul").css({"padding-left":"0px"}).appendTo(this.LinksDiv),this.LinksDiv.css({overflow:"auto","text-align":"left",color:"#303030","font-size":"18px"}).attr("id","NoteTree"),SA.Edit&&(this.AddViewButton=$("<button>").appendTo(this.LinksDiv).css({"border-radius":"4px",margin:"1em"}).text("+ New View")),this.QuizButton=$("<div>").appendTo(this.TextDiv).addClass("editButton").css({float:"right","font-size":"small","margin-top":"4px","padding-left":"2px","padding-right":"2px",border:"1px solid #AAA","border-radius":"2px"}).text("show").hide(),SA.Edit&&(this.QuizDiv=$("<div>").appendTo(this.TextDiv),this.QuizMenu=$('<select name="quiz" id="quiz">').appendTo(this.QuizDiv).css({float:"right",margin:"3px"}).change(function(){i.RootNote&&("review"===this.value?i.RootNote.Mode="answer-show":"hidden"===this.value?i.RootNote.Mode="answer-hide":"interactive"===this.value&&(i.RootNote.Mode="answer-interactive"),i.UpdateQuestionMode())}),this.QuizLabel=$("<div>").appendTo(this.TextDiv).css({float:"right","font-size":"small","margin-top":"4px"}).text("quiz"),$("<option>").appendTo(this.QuizMenu).text("review"),$("<option>").appendTo(this.QuizMenu).text("hidden"),$("<option>").appendTo(this.QuizMenu).text("interactive"),this.QuizMenu.val("review")),this.TextEditor=new SA.TextEditor(this.TextDiv,this.Display),SA.Edit?this.TextEditor.Change(function(){i.MarkAsModified()}):this.TextEditor.EditableOff(),this.UserTextEditor=new SA.TextEditor(this.UserTextDiv,this.Display),this.UserTextEditor.Change(function(){i.UserTextEditor.Note.Save()})}t.prototype.EventuallySaveUserNote=function(){this.UserNoteTimerId&&clearTimeout(this.UserNoteTimerId);var t=this;this.UserNoteTimerId=setTimeout(function(){t.SaveUserNote()},2e3)},t.prototype.Flush=function(){this.UserNoteTimerId&&(clearTimeout(this.UserNoteTimerId),this.UserNoteTimerId=!1,this.SaveUserNote())},t.prototype.SaveUserNote=function(){this.UserNoteTimerId=!1;var t=SA.notesWidget.GetCurrentNote();if(t&&0!==t.ViewerRecords.length){var e=t.ViewerRecords[t.StartIndex].UserNote;if(SA&&SA.display)for(var i=0;i<1;++i)e.ViewerRecords[0].CopyAnnotations(SA.display.GetViewer(i),!0);(e.ViewerRecords[0].Annotations.length>0||2===e.LoadState)&&e.Save()}},t.prototype.IsUserTextTabOpen=function(){return this.TabbedWindow.GetCurrentDiv()===this.UserTextDiv},t.prototype.UpdateQuestionMode=function(){if(this.RootNote){if(this.RootNote.Mode||(this.RootNote.Mode="answer-show"),this.QuizMenu&&("answer-hide"===this.RootNote.Mode?this.QuizMenu.val("hidden"):"answer-interactive"===this.RootNote.Mode?this.QuizMenu.val("interactive"):this.QuizMenu.val("review")),"answer-interactive"===this.RootNote.Mode){var t=this;this.QuizButton.show().css("background-color","").click(function(){t.SetAnswerVisibility("answer-show"),t.QuizButton.css({"background-color":"#AAAAAA"})})}else this.QuizButton.hide();this.SetAnswerVisibility(this.RootNote.Mode)}},t.prototype.SetAnswerVisibility=function(t){SA.AddHtmlTags(this.TextEditor.TextEntry),this.TextEditor.UpdateMode(t)},t.prototype.SetNavigationWidget=function(t){this.NavigationWidget=t},t.prototype.SetModifiedCallback=function(t){this.ModifiedCallback=t},t.prototype.SetModifiedClearCallback=function(t){this.ModifiedClearCallback=t},t.prototype.SetNote=function(t){for(var e=t;e!==this.RootNote&&e.Parent&&"UserNote"!==e.Type;)e=e.Parent;if(e===this.RootNote||"UserNote"===e.Type){if(SA.LinkDiv.is(":visible")&&SA.LinkDiv.fadeOut(),"UserNote"!==e.Type){for(var i=t;i&&"View"===i.Type;)i=i.Parent;i&&this.TextEditor.LoadNote(i)}t!==this.SelectedNote&&(this.SelectedNote&&(this.SelectedNote.TitleEntry.css({background:"white"}),$("#"+this.SelectedNote.Id).css({background:"white"})),this.SelectedNote=t,this.UpdateUserNotes(),t.TitleEntry.css({background:"#f0f0f0"}),$("#"+t.Id).css({background:"#e0e0ff"}))}else this.SetRootNote(e)},t.prototype.MarkAsModified=function(){this.ModifiedCallback&&this.ModifiedCallback(),this.Modified=!0},t.prototype.MarkAsNotModified=function(){this.ModifiedClearCallback&&this.ModifiedClearCallback(),this.Modified=!1},t.prototype.SetRootNote=function(t){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.Update()),this.RootNote=t,this.DisplayRootNote(),this.UpdateQuestionMode()},t.prototype.EditOn=function(){SA.SaveButton.prop("title","save to database").attr("src",SA.ImagePathUrl+"save22.png").click(function(){self.SaveCallback()}),this.AddViewButton.show(),this.TextEditor.EditOn()},t.prototype.EditOff=function(){SA.SaveButton.prop("title","edit view").attr("src",SA.ImagePathUrl+"text_edit.png").click(function(){self.EditOn()}),this.AddViewButton.hide(),this.TextEditor.EditOff()},t.prototype.SaveCallback=function(t){SA.AddHtmlTags(this.TextEditor.TextEntry),SA.display.RecordAnnotations();var e=this.GetCurrentNote();e&&e.RecordView(this.Display),this.RootNote&&(e=this.RootNote),e.NotesPanelOpen=SA.resizePanel&&SA.resizePanel.Visibility;var i=this;e.Save(function(){i.Modified=!1,t&&t()})},t.prototype.GetCurrentNote=function(){return this.Display.GetNote()},t.prototype.SaveBrownNote=function(){var t=new SA.Note;t.RecordView(this.Display),t.SetParent(this.GetCurrentNote())},t.prototype.RandomCallback=function(){var t=this.GetCurrentNote();t.Children.sort(function(t,e){return Math.random()-.5}),t.UpdateChildrenGUI()},t.prototype.DisplayRootNote=function(){if(this.RootNote){if(SA.resizePanel&&SA.resizePanel.SetVisibility(this.RootNote.NotesPanelOpen,0),this.TextEditor.LoadNote(this.RootNote),this.LinksRoot.empty(),this.RootNote.DisplayGUI(this.LinksRoot),this.SetNote(this.RootNote),SA.Edit){var t=this;this.AddViewButton.appendTo(this.LinksDiv).click(function(){var e=SA.notesWidget.RootNote,i=e.Children.length,o=e.NewChild(i,"New View");o.RecordView(t.Display),o.Save(),e.UpdateChildrenGUI(),this.Display.SetNote(o)})}""===this.RootNote.Text?this.TabbedWindow.ShowTabDiv(this.LinksDiv):this.TabbedWindow.ShowTabDiv(this.TextDiv)}},t.prototype.NewCallback=function(){var t=this.GetCurrentNote(),e=0;if(t.Parent){var i=t.Children.indexOf(t);i>=0&&(e=i+1,t=t.Parent)}var o=t.NewChild(e,"New View");o.RecordView(this.Display),t.UpdateChildrenGUI(),t.Save(),this.Display.SetNote(o)},t.prototype.UpdateUserNotes=function(){""!==SA.User&&SA.VIEWER1&&this.UserTextEditor.EditOn();var t=this.SelectedNote;if(t&&t.ViewerRecords.length>0){var e=t.ViewerRecords[t.StartIndex].UserNote;this.UserTextEditor.LoadNote(e)}},SA.NotesWidget=t}(),function(){function t(t,i,o){var s=this;t||alert("null parent: tab"),t=t||SA.MainDiv,this.Div=$("<div>").appendTo(t).attr("id",o).addClass("sa-view-div"),this.Button=$("<img>").appendTo(this.Div).attr("type","image").attr("src",i).addClass("sa-view-button").on("click touchstart",function(){s.TogglePanel()}).attr("draggable","false").on("dragstart",function(){return!1}),this.Panel=$("<div>").appendTo(this.Div).hide().addClass("sa-view-panel"),e.push(this),this.PanelOpen=!1}var e=[];t.prototype.show=function(){this.Div.show()},t.prototype.hide=function(){this.Div.hide()},t.prototype.TogglePanel=function(){this.PanelOpen?this.PanelOff():this.PanelOn()},t.prototype.PanelOn=function(){if(!this.PanelOpen){this.PanelOpen=!0,this.Panel.show();for(var t=this.Panel.offset().left,i=t+this.Panel.outerWidth(),o=0;o<e.length;++o)if(e[o]!==this){var s=e[o].Panel.offset().left,n=s+e[o].Panel.outerWidth();(s=Math.max(t,s))<(n=Math.min(i,n))&&e[o].PanelOff()}this.Button.addClass("sa-active")}},t.prototype.PanelOff=function(){this.PanelOpen=!1,this.Panel.hide(),this.Button.removeClass("sa-active")},SA.Tab=t}(),function(){"use strict";function t(t,e){var i=this;this.Viewer=e,this.Layer=t,t.AnnotationWidget=this,SAM.detectMobile(),this.Tab=new SA.Tab(t.GetParent(),SA.ImagePathUrl+"pencil3Up.png","annotationTab"),this.Tab.Div.css({"box-sizing":"border-box",position:"absolute",bottom:"0px",right:"110px"}),this.Tab.Panel.addClass("sa-view-annotation-panel"),this.VisibilityDiv=$("<div>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-vis").on("click touchstart",function(){i.ToggleVisibility()}),this.VisibilityImage=$("<img>").appendTo(this.VisibilityDiv).addClass("sa-view-annotation-vis-img").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"toggleswitch.jpg"),this.TextButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"Text.png").on("click touchstart",function(){i.NewText()}),this.CircleButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"Circle.png").on("click touchstart",function(){i.NewCircle()}),this.RectButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"rectangle.gif").on("click touchstart",function(){i.NewRect()}),this.GridButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"grid.png").on("click touchstart",function(){i.NewGrid()}),this.PolylineButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"FreeForm.gif").on("click touchstart",function(){i.NewPolyline()}),this.PencilButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"Pencil-icon.jpg").on("click touchstart",function(){i.NewPencil()}),this.LassoButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"select_lasso.png").on("click touchstart",function(){i.NewLasso()}),window.SA&&this.Viewer&&(this.SectionsButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-annotation-button sa-flat-button-active").addClass("sa-active").attr("type","image").attr("src",SA.ImagePathUrl+"sections.png").on("click touchstart",function(){i.DetectSections()}))}t.prototype.show=function(){this.Tab.show()},t.prototype.hide=function(){this.Tab.hide()},t.prototype.SetVisibility=function(t){if(this.Layer.GetVisibility()!==t){if(SA.notesWidget){var e=SA.notesWidget.GetCurrentNote();if(e&&"Stack"===e.Type)for(var i=0;i<e.ViewerRecords.length;++i)e.ViewerRecords[i].AnnotationVisibility=t}this.VisibilityImage&&(0===t?this.VisibilityImage.css({top:"-30px"}):this.VisibilityImage.css({top:"1px"})),this.Layer.SetVisibility(t),this.Layer.EventuallyDraw()}},t.prototype.GetVisibility=function(){return this.Layer.GetVisibility()},t.prototype.ToggleVisibility=function(){var t=this.GetVisibility();t=0===t?2:0,this.SetVisibility(t),window.SA&&SA.RecordState()},t.prototype.TogglePanel=function(){this.Panel.toggle(),this.Panel.is(":visible")?this.TabButton.addClass("sa-active"):this.TabButton.removeClass("sa-active")},t.prototype.NewText=function(){var t=this.TextButton;this.ActivateButton(t,SAM.TextWidget).ShowPropertiesDialog()},t.prototype.NewPencil=function(){var t=this.PencilButton;this.ActivateButton(t,SAM.PencilWidget)},t.prototype.NewLasso=function(){var t=this.LassoButton;this.ActivateButton(t,SAM.ImageWidget)},t.prototype.NewPolyline=function(){var t=this.PolylineButton;this.ActivateButton(t,SAM.PolylineWidget)},t.prototype.NewCircle=function(){var t=this.CircleButton;this.ActivateButton(t,SAM.CircleWidget)},t.prototype.NewRect=function(){var t=this.RectButton;this.ActivateButton(t,SAM.RectWidget)},t.prototype.NewGrid=function(){var t=this.GridButton,e=this.ActivateButton(t,SAM.GridWidget),i=this.Layer.GetCamera(),o=i.GetWorldFocalPoint();e.Grid.Origin=[o[0],o[1],0],e.Grid.Orientation=i.GetWorldRotation(),this.Layer.DeactivateWidget(e)},t.prototype.NewFill=function(){var t=this.FillButton;this.ActivateButton(t,SAM.FillWidget).Initialize()},t.prototype.ActivateButton=function(t,e){var i=this.Layer.ActiveWidget;if(i){if(t.Pressed)return void i.Deactivate();i.Deactivate()}return t.Pressed=!0,t.addClass("sa-active"),this.SetVisibility(2),i=new e(this.Layer,!0),this.Layer.ActivateWidget(i),i.DeactivateCallback=function(){t.removeClass("sa-active"),i.DeactivateCallback=void 0,t.Pressed=!1},SA.Edit||(this.UserNoteFlag=!0),SA.notesWidget&&SA.notesWidget.IsUserTextTabOpen()&&(i.UserNoteFlag=!0),i},t.prototype.DetectSections=function(){if(window.SA){var t=this.Layer.GetActiveWidget(),e=this.SectionsButton;if(t){if(e.Pressed)return void t.Deactivate();t.Deactivate()}e.Pressed=!0,e.addClass("sa-active"),t=null;for(var i=this.Layer.GetWidgets(),o=0;o<i.length&&null==t;++o){var s=i[o];"sections"===s.Type&&(t=s)}if(null==t&&((t=new SA.SectionsWidget(this.Layer,this.Viewer,!1)).ComputeSections(this.Viewer),t.IsEmpty()))return this.Layer.RemoveWidget(t),e.removeClass("sa-active"),void(e.Pressed=!1);t.SetActive(!0),t.DeactivateCallback=function(){e.removeClass("sa-active"),t.DeactivateCallback=void 0,e.Pressed=!1}}},SA.AnnotationWidget=t}(),function(){"use strict";function t(){this.AnnotationVisibility=0,this.Annotations=[],this.UserNote=null}SA.RECORDER_WIDGET=null,t.prototype.DeepCopy=function(t){this.AnnotationVisibility=t.AnnotationVisibility,this.Annotations=JSON.parse(JSON.stringify(t.Annotations)),this.Camera=new SAM.Camera,this.Camera.DeepCopy(t.Camera),this.Image=t.Image,this.OverViewBounds=t.OverViewBounds.slice(0),this.UserNote=t.UserNote},t.prototype.Load=function(t){if(!t.Image.units&&t.Image.filename){var e=t.Image.filename.split(".");"ptif"===e[e.length-1]&&(t.Image.spacing=[.25,.25,1],t.Image.units="µm")}if(!t.Camera){var i=t.Image.bounds;i&&(t.Camera={FocalPoint:[(i[0]+i[1])/2,(i[2]+i[3])/2],Height:i[3]-i[2],Width:i[1]-i[0],Roll:0})}for(var o in t)this[o]=t[o];if(this.OverviewBounds&&(this.OverViewBounds=t.OverviewBounds,delete this.OverviewBounds),void 0===this.Camera.Width&&(this.Camera.Width=1.62*this.Camera.Height),this.OverViewBounds||(this.OverViewBounds=this.Image.bounds),this.Annotations)for(var s=0;s<this.Annotations.length;++s){var n=this.Annotations[s];n&&n.color&&(n.color=SAM.ConvertColor(n.color))}if(this.Transform){var a=new SA.PairTransformation;a.Load(this.Transform),this.Transform=a}if(this.UserNote&&console.log("Loading over a user note"),!this.UserFlag&&!(this.UserNote&&this.UserNote.Parent===this.Image._id||(this.UserNote=SA.GetUserNoteFromImageId(this.Image._id),this.UserNote))){this.UserNote=new SA.Note,this.UserNote.Parent=this.Image._id;var r=new SA.ViewerRecord;r.Camera=new SAM.Camera,r.Camera.DeepCopy(this.Camera),r.Image=this.Image,r.OverViewBounds=this.OverViewBounds.slice(0),r.UserFlag=!0,this.UserNote.ViewerRecords=[r],this.UserNote.Type="UserNote"}},t.prototype.RequestUserNote=function(){if(this.UserNote&&0===this.UserNote.LoadState){this.UserNote.LoadState=1;var t=this;$.ajax({type:"get",url:"/webgl-viewer/getusernotes",data:{imageid:this.UserNote.Parent},success:function(e,i){t.LoadUserNote(e)},error:function(){SA.Debug("AJAX - error() : getusernotes"),t.UserNote&&(SA.DeleteNote(t.UserNote),delete t.UserNote)}})}},t.prototype.LoadUserNote=function(t){if(0!==t.Notes.length){var e=this.UserNote,i=t.Notes[0];if(t.Notes.length>1){SA.Debug("Warning: More than one user note for the same image..");for(var o=1;o<t.Notes.length;++o)i.Text+="<br>"+t.Notes[o].Text,i.ViewerRecords[0].Annotations=i.ViewerRecords[0].Annotations.concat(t.Notes[o].ViewerRecords[0].Annotations)}""!==e.Text&&(i.Text=e.Text+"<br>"+i.Text),e.ViewerRecords[0].Annotations.length>0&&(i.ViewerRecords[0].Annotations=i.ViewerRecords[0].Annotations.concat(e.ViewerRecords[0].Annotations)),e.Load(i),SA.UpdateUserNotes()}},t.prototype.CopyViewer=function(t){var e=t.GetCache();if(!e)return this.Camera=null,this.AnnotationVisibility=!1,void(this.Annotations=[]);this.OverViewBounds=t.GetOverViewBounds(),this.OverViewBounds=t.GetOverViewBounds(),this.Image=e.Image,this.UserNote=SA.GetUserNoteFromImageId(this.Image._id),this.Camera=t.GetCamera().Serialize();var i=t.Layers[0];if(i){this.AnnotationVisibility=i.GetVisibility(),this.Annotations=[];for(var o=i.GetWidgets(),s=0;s<o.length;++s)this.Annotations.push(o[s].Serialize())}},t.prototype.CopyAnnotations=function(t,e){if(this.Annotations=[],0!==t.Layers.length&&t.Layers[0])for(var i=t.Layers[0].GetWidgets(),o=0;o<i.length;++o){var s=i[o];if(s.UserNoteFlag=s.UserNoteFlag||!1,e===s.UserNoteFlag){var n=i[o].Serialize();n&&this.Annotations.push(n)}}},t.prototype.Serialize=function(){var t={};return t.Image=this.Image._id,t.Database=this.Image.database,t.NumberOfLevels=this.Image.levels,t.Camera=this.Camera,this.Annotations&&(t.Annotations=JSON.parse(JSON.stringify(this.Annotations))),t.AnnotationVisibility=this.AnnotationVisibility,this.OverViewBounds&&(t.OverViewBounds=this.OverViewBounds),this.Transform&&(t.Transform=this.Transform.Serialize()),t},t.prototype.LoadTiles=function(t){var e=SA.FindCache(this.Image),i=new SAM.Camera;i.Load(this.Camera),i.SetViewport(t),i.ComputeMatrix();for(var o=e.ChooseTiles(i,0,[]),s=0;s<o.length;++s)SA.LoadQueueAddTile(o[s])},SA.RecordState=function(){SA.RECORDER_WIDGET&&SA.RECORDER_WIDGET.RecordState()};var e=function(t){SA.RECORDER_WIDGET||(SA.RECORDER_WIDGET=this);var e=this;this.Display=t,this.RecordTimerId=0,this.TimeLine=[],this.RedoStack=[],this.Recording=!0,this.RecordingName="",this.RecordButton=$("<img>").appendTo("body").css({opacity:"0.5",position:"absolute",height:"20px",bottom:"120px",right:"20px","z-index":"1"}).attr("src",SA.ImagePathUrl+"stopRecording2.png").hide().click(function(){e.RecordingStop()}),this.UndoButton=$("<img>").appendTo("body").css({opacity:"0.5",position:"absolute",height:"30px",bottom:"5px",right:"100px","z-index":"1"}).attr("src",SA.ImagePathUrl+"undo.png").hide().click(function(){alert("undo")}),this.RedoButton=$("<img>").appendTo("body").css({opacity:"0.5",position:"absolute",height:"30px",bottom:"5px",right:"70px","z-index":"1"}).attr("src",SA.ImagePathUrl+"redo.png").hide().click(function(){alert("REDO")}),this.RecordingName=SA.getCookie("SlideAtlasRecording"),void 0!==this.RecordingName&&"false"!==this.RecordingName&&(this.Recording=!0,this.UpdateGUI()),this.RecordState()};e.prototype.UpdateGUI=function(){this.Recording?this.RecordButton.show():this.RecordButton.hide()},e.prototype.RecordingStart=function(){if(!this.Recording){this.Recording=!0;var t=new Date;this.RecordingName="Bev"+t.getTime(),SA.setCookie("SlideAtlasRecording",this.RecordingName,1),this.UpdateGUI(),this.RecordState()}},e.prototype.RecordingStop=function(){this.Recording&&(this.Recording=!1,SA.setCookie("SlideAtlasRecording","false",1),this.UpdateGUI())},e.prototype.RecordStateCallback=function(){if(0!==this.Display.GetNumberOfViewers()){this.RecordTimerId=0,this.RedoStack=[];var t=new SA.Note;if(t.Type="Record",t.RecordView(this.Display),SA.display){var e=SA.display.GetNote();if(!e||!e.Id)return void this.RecordState();t.ParentId=e.Id,t.SetParent(e)}$.ajax({type:"post",url:"/webgl-viewer/saveusernote",data:{note:JSON.stringify(t.Serialize(!0)),col:"tracking",type:"Record"},success:function(e,i){t.Id=e},error:function(){}}),this.TimeLine.push(t),SA.DeleteNote(t)}},e.prototype.RecordState=function(){if(0!==this.Display.GetNumberOfViewers()){this.RecordTimerId&&(clearTimeout(this.RecordTimerId),this.RecordTimerId=0);var t=this;this.RecordTimerId=setTimeout(function(){t.RecordStateCallback()},1e3)}},e.prototype.GetRecords=function(){var t=this;$.ajax({type:"get",url:"/webgl-viewer/getfavoriteviews",data:{col:"tracking"},success:function(e,i){t.Records=e.viewArray},error:function(){SA.Debug("AJAX - error() : get records")}})},e.prototype.RecordState=function(){this.RecordTimerId&&(clearTimeout(this.RecordTimerId),this.RecordTimerId=0);var t=this;this.RecordTimerId=setTimeout(function(){t.RecordStateCallback()},1e3)},e.prototype.UndoState=function(){if(this.TimeLine.length>1){var t=this.TimeLine.pop();this.RedoStack.push(t),t=this.TimeLine[this.TimeLine.length-1],SA.SetNote(t)}},e.prototype.RedoState=function(){if(0!==this.RedoState.length){var t=this.RedoStack.pop();this.TimeLine.push(t),t.DisplayView()}},SA.ViewerRecord=t,SA.RecorderWidget=e}(),function(){"use strict";function t(t,e){this.Display=e,this.SlideIndex=0,this.Session=[],this.NoteIterator=new SA.NoteIterator;var i=this,o="40px";if(SAM.detectMobile()){this.Tab={},this.Tab.Panel=$("<div>").appendTo(e.GetViewer(0).GetDiv()).hide().addClass("ui-responsive").css({position:"absolute",left:"50px",bottom:"20px","z-index":"5"});var s=this.Tab.Panel;this.Tab.show=function(){s.show()},this.Tab.hide=function(){s.hide()}}else this.Tab=new SA.Tab(t,SA.ImagePathUrl+"nav.png","navigationTab"),this.Tab.Div.addClass("sa-view-navigation-div"),this.Tab.Panel.addClass("sa-view-navigation-panel"),this.NoteDisplay=$("<div>").appendTo(this.Tab.Div).addClass("sa-view-note").html("");this.PreviousSlideButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"previousSlide.png").click(function(){i.PreviousSlide()}),this.PreviousNoteButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"previousNote.png").click(function(){i.PreviousNote()}),this.NextNoteButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"nextNote.png").click(function(){i.NextNote()}),this.NextSlideButton=$("<img>").appendTo(this.Tab.Panel).addClass("sa-view-navigation-button").attr("src",SA.ImagePathUrl+"nextSlide.png").css({"z-index":"100"}).click(function(){i.NextSlide()}),this.NextSlideButton.on("touchend",function(t){return i.NextSlide(),!1}),SAM.MOBILE_DEVICE&&(o="80px","iPhone"===SAM.MOBILE_DEVICE&&(o="100px"),this.PreviousSlideButton.css({height:o,width:o,opacity:"0.8"}).on("touchend",function(){i.PreviousSlide()}),this.PreviousNoteButton.css({height:o,width:o,opacity:"0.8"}).on("touchend",function(){i.PreviousNote()}),this.NextNoteButton.css({height:o,width:o,opacity:"0.8"}).on("touchend",function(){i.NextNote()}),this.NextSlideButton.css({height:o,width:o,opacity:"0.8"})),this.CopyrightWrapper=$("<div>").appendTo(t).css({width:"100%","text-align":"center"}).html()}function e(t){this.Note=t,this.ChildIterator=null}t.prototype.GetNote=function(){return this.NoteIterator.GetNote()},t.prototype.SetInteractionEnabled=function(t){var e=this;t?this.Display.Parent.on("keydown.navigation",function(t){return e.HandleKeyDown(t)}):this.Display.Parent.off("keydown.navigation")},t.prototype.HandleKeyDown=function(t){var e=t.keyCode;return 34===e?(this.NextSlide(),!1):78===e||32===e?(this.NextNote(),!1):33===e?(this.PreviousSlide(),!1):80!==e||(this.PreviousNote(),!1)},t.prototype.SetNote=function(t){if(this.GetNote()!==t){var e=this;this.SessionId?t.SessionId=this.SessionId:SA.Session?(this.Session=SA.Session.session.views,this.SessionId=SA.Session.sessid,this.Update()):t.SessionId&&"HTML"!==SA.RootNote.Type&&(this.SessionId=t.SessionId,$.ajax({type:"get",url:SA.SessionUrl+"?json=true&sessid="+this.SessionId,success:function(t,i){e.SessionId===t.sessid?(e.Session=t.session.views,e.Update()):console.log("expecting a second session to load.")},error:function(){SA.Debug("AJAX - error() : session")}})),this.NoteIterator.SetNote(t),this.Update()}},t.prototype.ToggleVisibility=function(){this.SetVisibility(!this.Visibility)},t.prototype.SetVisibility=function(t){this.Visibility=t,t?this.Tab.show():this.Tab.hide()},t.prototype.Update=function(){this.PreviousNoteButton.removeClass("sa-active"),this.NextNoteButton.removeClass("sa-active");var t=this.GetNote();if(t){for(var e=0;e<this.Session.length;++e)this.Session[e].id===t.Id&&(this.SlideIndex=e);"Stack"===t.Type?(t.StartIndex>0&&(t.ViewerRecords[t.StartIndex-1].LoadTiles([0,0,200,150]),this.PreviousNoteButton.addClass("sa-active")),t.StartIndex<t.ViewerRecords.length-1&&(t.ViewerRecords[t.StartIndex+1].LoadTiles([0,0,200,150]),this.NextNoteButton.addClass("sa-active")),t.StartIndex<t.ViewerRecords.length-2&&t.ViewerRecords[t.StartIndex+2].LoadTiles([0,0,200,150])):(this.NoteIterator.IsStart()||this.PreviousNoteButton.addClass("sa-active"),this.NoteIterator.IsEnd()||this.NextNoteButton.addClass("sa-active"))}this.SlideIndex<=0?this.PreviousSlideButton.removeClass("sa-active"):this.PreviousSlideButton.addClass("sa-active"),this.SlideIndex>=this.Session.length-1?this.NextSlideButton.removeClass("sa-active"):this.NextSlideButton.addClass("sa-active"),SA.RootNote&&"HTML"===SA.RootNote.Type&&(this.PreviousSlideButton.removeClass("sa-active"),this.NextSlideButton.removeClass("sa-active"))},t.prototype.PreviousNote=function(){SA.StackCursorFlag=!1,SA.notesWidget&&SA.notesWidget.Flush();var t=this.GetNote();if("Stack"===t.Type){if(t.StartIndex<=0)return;var e=this.Display.GetViewer(1),i=this.Display.GetViewer(0).GetCamera(),o=i.GetWorldFocalPoint(),s=i.GetWorldRotation(),n=i.GetHeight();return this.Display.RecordAnnotations(),--t.StartIndex,t.ViewerRecords[t.StartIndex].RequestUserNote(),SA.display=this.Display,SA.SetNote(t),SA.UpdateUserNotes(),e.SetCamera(o,s,n),t.DisplayStack(this.Display),this.Display.SynchronizeViews(1,t),this.Update(),void(this.NoteDisplay&&this.NoteDisplay.html(""+t.StartIndex))}if(this.NoteIterator.IsStart())this.PreviousSlide();else{SA.display.RecordAnnotations();var a=this.NoteIterator.Previous();this.SetNote(a),this.Update(),SA.display=this.Display,SA.display.RecordAnnotations(),SA.SetNote(a),SA.UpdateUserNotes()}},t.prototype.NextNote=function(){SA.StackCursorFlag=!1,SA.notesWidget&&SA.notesWidget.Flush();var t=this.GetNote();if("Stack"===t.Type){if(t.StartIndex>=t.ViewerRecords.length-1)return;var e=this.Display.GetViewer(0),i=this.Display.GetViewer(1).GetCamera(),o=i.GetWorldFocalPoint(),s=i.GetWorldRotation(),n=i.GetHeight();return this.Display.RecordAnnotations(),++t.StartIndex,t.ViewerRecords[t.StartIndex].RequestUserNote(),SA.display=this.Display,SA.SetNote(t),SA.UpdateUserNotes(),e.SetCamera(o,s,n),t.DisplayStack(this.Display),this.Display.SynchronizeViews(0,t),this.Update(),void(this.NoteDisplay&&this.NoteDisplay.html(""+t.StartIndex))}if(this.NoteIterator.IsEnd())this.NextSlide();else{var a=this.NoteIterator.Next();this.Update(),SA.display=this.Display,SA.display.RecordAnnotations(),SA.SetNote(a),SA.UpdateUserNotes()}},t.prototype.PreviousSlide=function(){SA.notesWidget&&SA.notesWidget.Flush(),SA.StackCursorFlag=!1;for(var t=this.SlideIndex-1;t>=0&&"Presentation"===this.Session[t].Type;)--t;if(!(t<0)){var e=!0;SA.notesWidget&&SA.notesWidget.Modified&&SA.Edit&&(e=confirm("Unsaved edits will be lost.  Are you sure you want to move to the next slide?")),e&&(SA.notesWidget&&SA.notesWidget.MarkAsNotModified(),this.SlideIndex=t,SA.SetNoteFromId(this.Session[this.SlideIndex].id),this.NoteDisplay&&this.NoteDisplay.html(""))}},t.prototype.NextSlide=function(){SA.notesWidget&&SA.notesWidget.Flush(),SA.StackCursorFlag=!1;for(var t=this.SlideIndex+1;t<this.Session.length&&"Presentation"===this.Session[t].Type;)++t;if(!(t>=this.Session.length)){var e=!0;SA.notesWidget&&SA.notesWidget.Modified&&(e=confirm("Unsaved edits will be lost.  Are you sure you want to move to the next slide?")),e&&(SA.notesWidget&&SA.notesWidget.MarkAsNotModified(),this.SlideIndex=t,SA.SetNoteFromId(this.Session[this.SlideIndex].id),this.NoteDisplay&&this.NoteDisplay.html(""))}},e.prototype.GetChildArray=function(){return this.Note?this.Note.Children:[]},e.prototype.GetChildIndex=function(){return null===this.ChildIterator?-1:this.GetChildArray().indexOf(this.ChildIterator.Note)},e.prototype.GetParentNote=function(){if(null===this.ChildIterator)return null;var t=this.ChildIterator.GetParentNote();return null===t&&(t=this.Note),t},e.prototype.IsStart=function(){return null===this.ChildIterator},e.prototype.IsEnd=function(){return!this.Note||(null===this.ChildIterator?!(this.Note.Children.length>0&&this.Note.ChildrenVisibility):this.GetChildIndex()===this.GetChildArray().length-1&&this.ChildIterator.IsEnd())},e.prototype.Next=function(){if(this.Note){if(null===this.ChildIterator)return this.Note.Children.length>0&&this.Note.ChildrenVisibility?(this.ChildIterator=this.GetChildArray()[0].NewIterator(),this.ChildIterator.GetNote()):this.Note;if(!this.ChildIterator.IsEnd())return this.ChildIterator.Next();var t=this.GetChildIndex();return t<this.GetChildArray().length-1?(this.ChildIterator=this.GetChildArray()[t+1].NewIterator(),this.ChildIterator.GetNote()):this.ChildIterator.GetNote()}},e.prototype.Previous=function(){if(this.Note){if(null===this.ChildIterator)return this.Note;if(!this.ChildIterator.IsStart())return this.ChildIterator.Previous();var t=this.GetChildIndex()-1;return t>=0?(this.ChildIterator=this.GetChildArray()[t].NewIterator(),this.ChildIterator.ToEnd(),this.ChildIterator.GetNote()):(this.ChildIterator=null,this.Note)}},e.prototype.ToStart=function(){this.ChildIterator&&(this.ChildIterator=null)},e.prototype.ToEnd=function(){if(this.Note){if(this.Note.Children.length>0&&this.Note.ChildrenVisibility){this.ChildArray=this.Note.Children;var t=this.ChildArray.length-1;return this.ChildIterator=this.ChildArray[t].NewIterator(),this.ChildIterator.ToEnd()}return this.ChildArray=null,this.ChildIterator=null,this.Note}},e.prototype.SetNote=function(t){if(this.GetNote()!==t)for(this.ToStart();;){if(this.GetNote()===t)return;if(this.IsEnd())return this.ToStart(),void(this.Note=t);this.Next()}},e.prototype.GetNote=function(){return null!==this.ChildIterator?this.ChildIterator.GetNote():this.Note},SA.NoteIterator=e,SA.NavigationWidget=t}(),function(){"use strict";function t(){var t="80px";"iPhone"===SAM.detectMobile()&&(t="100px");var e=this;this.Div=$("<div>").appendTo(SA.VIEWERS[0].GetDiv()).css({position:"absolute",right:"0px",bottom:"0px","z-index":"5"}),this.CircleButton=$("<img>").appendTo(this.Div).css({height:t,width:t,opacity:"0.6",margin:"1px",padding:"5px"}).attr("src",SA.ImagePathUrl+"Circle128.jpg").on("touchend",function(){e.CircleCallback()}),this.CircleButton.prop("title","Circle Annotation"),this.TextButton=$("<img>").appendTo(this.Div).css({height:t,width:t,opacity:"0.6",margin:"1px",padding:"5px"}).attr("src",SA.ImagePathUrl+"Text128.jpg").on("touchend",function(){e.TextCallback()}),this.TextButton.prop("title","Text Annotation"),this.Visibility=!1}t.prototype.CircleCallback=function(){console.log("New circle"),this.Layer=SA.VIEWERS[0].GetAnnotationLayer(),void 0!==this.Layer.ActiveWidget&&this.Layer.ActiveWidget.Deactivate();var t=new SAM.CircleWidget(this.Layer,!1),e=this.Layer.GetCamera(),i=e.GetWorldFocalPoint();t.Shape.Origin=i,t.Shape.Radius=e.Height/4,t.Shape.UpdateBuffers(this.Layer.AnnotationView),this.Layer.EventuallyDraw(),this.Layer.SetVisibility(!0)},t.prototype.TextCallback=function(){this.Layer=SA.VIEWERS[0].GetAnnotationLayer();var t=this.Layer.ActiveWidget;t&&t.Deactivate(),this.Layer.SetVisibility(!0),t=new SAM.TextWidget(this.Layer,"");var e=this.Layer.GetCamera().getWorldFocalPoint();t.Text.Anchor=e,this.Layer.EventuallyDraw(),this.Layer.ActivateWidget(t),t.ShowPropertiesDialog()},t.prototype.SetVisibility=function(t){this.Visibility=t,t?this.Div.show():this.Div.hide()},t.prototype.ToggleVisibility=function(){this.SetVisibility(!this.Visibility)},SA.MobileAnnotationWidget=t}(),function(){"use strict";function t(t){var e=this;this.Position="absolute",this.Editable=!1,this.Interactive=!0,this.Div=t,this.ClickCallback=null,this.DeleteCallback=null,this.LockActive=!1,this.Div.css({overflow:"hidden"}).hover(function(){e.ActiveOn()},function(){e.ActiveOff()}),this.Div.on("mousedown.element",function(t){return e.HandleMouseDown(t)}).on("tap.element",function(t){return!this.ClickCallback||(this.ClickCallback(this.Div[0]),!1)}),this.ButtonDiv=$("<div>").addClass("sa-edit-gui").css({height:"20px",position:"absolute",top:"0px",left:"0px",cursor:"auto","z-index":"1000"}).mousedown(function(){return!1}),this.DeleteButton=$("<img>").appendTo(this.ButtonDiv).addClass("editButton").css({height:"16px",position:"absolute",top:"0px",left:"0px"}).attr("src",SA.ImagePathUrl+"remove.png").prop("title","delete"),this.MenuButton=$("<img>").appendTo(this.ButtonDiv).addClass("editButton").css({height:"16px",position:"absolute",top:"0px",left:"20px"}).attr("src",SA.ImagePathUrl+"Menu.jpg").prop("title","properties"),this.InitializeDialog()}function e(t){var e=this;this.Div=t;var i=t[0].saElement;this.BackgroundPanel=i.AddAccordionTab("Background",function(){e.DialogInitialize()},function(){e.DialogApply()}),this.BackgroundLine1=$("<div>").appendTo(this.BackgroundPanel).css({width:"100%"}),this.BackgroundCheck=$('<input type="checkbox">').appendTo(this.BackgroundLine1).change(function(){$(this).is(":checked")?e.BackgroundColor.spectrum("enable"):e.BackgroundColor.spectrum("disable")}),this.BackgroundColorLabel=$("<div>").appendTo(this.BackgroundLine1).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Color"),this.BackgroundColorDiv=$("<div>").appendTo(this.BackgroundLine1).css({display:"inline-block",height:"18px","margin-left":"1em"}),this.BackgroundColor=$('<input type="text">').appendTo(this.BackgroundLine1).val("#005077").spectrum({showAlpha:!0}),this.BackgroundColor.spectrum("disable"),this.BackgroundLine2=$("<div>").appendTo(this.BackgroundPanel).css({width:"100%"}),this.GradientCheck=$('<input type="checkbox">').appendTo(this.BackgroundLine2).change(function(){$(this).is(":checked")?(e.GradientColor.spectrum("enable"),e.GradientColor.spectrum("show")):(e.GradientColor.spectrum("disable"),e.GradientColor.spectrum("hide"))}),this.GradientLabel=$("<div>").appendTo(this.BackgroundLine2).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Gradient"),this.GradientColorDiv=$("<div>").appendTo(this.BackgroundLine2).css({display:"inline-block",height:"18px","margin-left":"1em"}),this.GradientColor=$('<input type="text">').appendTo(this.GradientColorDiv).val("#005077").spectrum({showAlpha:!0})}function i(t){var e=this;this.Div=t;var i=t[0].saElement;this.PaddingPanel=i.AddAccordionTab("Margins",function(){e.DialogPaddingInitialize()},function(){e.DialogPaddingApply()}),this.PaddingLeftLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingLeftLabel=$("<div>").appendTo(this.PaddingLeftLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Left:"),this.PaddingLeft=$('<input type="number">').appendTo(this.PaddingLeftLine).keypress(function(t){return 13!==t.keyCode}),this.PaddingTopLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingTopLabel=$("<div>").appendTo(this.PaddingTopLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Top:"),this.PaddingTop=$('<input type="number">').appendTo(this.PaddingTopLine).keypress(function(t){return 13!==t.keyCode}),this.PaddingRightLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingRightLabel=$("<div>").appendTo(this.PaddingRightLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Right:"),this.PaddingRight=$('<input type="number">').appendTo(this.PaddingRightLine).keypress(function(t){return 13!==t.keyCode}),this.PaddingBottomLine=$("<div>").appendTo(this.PaddingPanel).css({width:"100%"}),this.PaddingBottomLabel=$("<div>").appendTo(this.PaddingBottomLine).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Bottom:"),this.PaddingBottom=$('<input type="number">').appendTo(this.PaddingBottomLine).keypress(function(t){return 13!==t.keyCode})}function o(t){var e=this;this.Div=t,this.Div.addClass("sa-question");var i=t[0].saElement;i.Dialog.Dialog.css({width:"500px"}),this.QuestionPanel=i.AddAccordionTab("Question",function(){e.DialogInitialize()},function(){e.DialogApply()}),this.DialogInitialize()}function s(t){var e=this;this.Div=t,this.Div.addClass("sa-text-editor"),t.saText({click:function(){e.EditingOn()}});var i=t[0].saElement;this.TextPanel=i.AddAccordionTab("Text",function(){e.DialogInitialize()},function(){e.DialogApply()}),this.FontSizeDiv=$("<div>").appendTo(this.TextPanel).css({height:"32px"}).addClass("sa-view-annotation-modal-div"),this.FontSizeLabel=$("<div>").appendTo(this.FontSizeDiv).text("Font Size:").addClass("sa-view-annotation-modal-input-label"),this.FontSize=$('<input type="number">').appendTo(this.FontSizeDiv).addClass("sa-view-annotation-modal-input").keypress(function(t){return 13!==t.keyCode}),this.FontColorDiv=$("<div>").appendTo(this.TextPanel).css({height:"32px"}).addClass("sa-view-annotation-modal-div"),this.FontColorLabel=$("<div>").appendTo(this.FontColorDiv).text("Color:").addClass("sa-view-annotation-modal-input-label"),this.FontColor=$('<input type="text">').appendTo(this.FontColorDiv).val("#050505").spectrum({showAlpha:!0}),this.LineHeightDiv=$("<div>").appendTo(this.TextPanel).css({height:"32px"}).addClass("sa-view-annotation-modal-div"),this.LineHeightLabel=$("<div>").appendTo(this.LineHeightDiv).text("Line Height %:").addClass("sa-view-annotation-modal-input-label"),this.LineHeight=$('<input type="number">').appendTo(this.LineHeightDiv).addClass("sa-view-annotation-modal-input").val(1).keypress(function(t){return 13!==t.keyCode}),this.Div.css({overflow:"visible"}),this.EditButtonDiv=$("<div>").appendTo(this.Div.parent()).addClass("sa-edit-gui").css({height:"20px",position:"absolute",width:"275px",cursor:"auto"}).hide().mousedown(function(){return!1}),this.AddButton(SA.ImagePathUrl+"link.png","link URL",function(){e.InsertUrlLink()}),this.AddButton(SA.ImagePathUrl+"font_bold.png","bold",function(){document.execCommand("bold",!1,null)}),this.AddButton(SA.ImagePathUrl+"text_italic.png","italic",function(){document.execCommand("italic",!1,null)}),this.AddButton(SA.ImagePathUrl+"edit_underline.png","underline",function(){document.execCommand("underline",!1,null)}),this.AddButton(SA.ImagePathUrl+"list_bullets.png","unorded list",function(){document.execCommand("InsertUnorderedList",!1,null)}),this.AddButton(SA.ImagePathUrl+"list_numbers.png","ordered list",function(){document.execCommand("InsertOrderedList",!1,null)}),this.AddButton(SA.ImagePathUrl+"indent_increase.png","indent",function(){document.execCommand("indent",!1,null)}),this.AddButton(SA.ImagePathUrl+"indent_decrease.png","outdent",function(){document.execCommand("outdent",!1,null)}),this.AddButton(SA.ImagePathUrl+"alignment_left.png","align left",function(){document.execCommand("justifyLeft",!1,null)}),this.AddButton(SA.ImagePathUrl+"alignment_center.png","align center",function(){document.execCommand("justifyCenter",!1,null)}),this.AddButton(SA.ImagePathUrl+"alignment_full.png","align full",function(){document.execCommand("justifyFull",!1,null)}),this.AddButton(SA.ImagePathUrl+"edit_superscript.png","superscript",function(){document.execCommand("superscript",!1,null)}),this.AddButton(SA.ImagePathUrl+"edit_subscript.png","subscript",function(){document.execCommand("subscript",!1,null)})}function n(t){var e=this;t[0].saElement.SetClickCallback(function(){e.Expand(!0)}),this.Div=t,this.Expanded=!1,this.ExpandCallback=null,this.AspectRatio=!1,this.Interactive=!0;var i=t.parent();this.Mask=i.find(".sa-light-box-mask"),0===this.Mask.length&&(this.Mask=$("<div>").appendTo(i).addClass("sa-light-box-mask").addClass("sa-edit-gui").hide().css({position:"absolute",left:"0px",top:"0px",width:"100%",height:"100%","z-index":"99",opacity:"0.5","background-color":"#000"}))}function a(t){if(!t.saButtons){var e=new r($(t));t.saButtons=e}return t.saButtons.ButtonsDiv}function r(t){this.Enabled=!0,this.Div=t,this.TimerId=-1;var e=t.position();this.ButtonsDiv=$("<div>").appendTo(t.parent()).addClass("sa-edit-gui").hide().css({position:"absolute",left:e.left+10+"px",top:e.top-20+"px",width:"360px","z-index":"10"}),this.ButtonsDiv[0].saButtons=this;var i=this;this.ButtonsDiv.mouseenter(function(){i.ShowButtons(2)}).mouseleave(function(){i.HideButtons()}),this.Div.mouseenter(function(){i.ShowButtons(1)}).mouseleave(function(){i.HideButtons()})}function h(t,e,i,o,s){var n=a(t),r=$("<img>").addClass("editButton").css({height:"16px"}).attr("src",e);return o&&r.on("click touchstart",o),i&&r.prop("title",i),s?r.prependTo(n):r.appendTo(n),r}function l(t){t.saButtons&&(t.saButtons.Enabled=!1,t.saButtons.ButtonsDiv.hide())}function d(t){t.saButtons&&(t.saButtons.Enabled=!0)}function u(t){t.saButtons&&t.saButtons.ButtonsDiv.remove()}function p(t){var e,i=t[0];"object"==typeof t[1]&&(e=t[1]),e&&e.prefixUrl&&(SA.ImagePathUrl=e.prefixUrl,SAM.ImagePathUrl=e.prefixUrl),$(window).off("resize.sa").on("resize.sa",c);for(var o=0;o<i.length;++o)if("destroy"!==t[1]){i[o].saViewer||(e&&(i.hasClass("sa-dual-viewer")&&(e.dual=!0),e.dual?i[o].saViewer=new SA.DualViewWidget($(i[o])):i[o].saViewer=new SA.Viewer($(i[o]))),i[o].onresize=function(){this.saViewer.UpdateSize()},$(i[o]).addClass("sa-resize"));var s=i[o].saViewer;if(s&&"function"==typeof s[t[1]])return s[t[1]].apply(s,Array.prototype.slice.call(t,2));e&&i[o].saViewer.ProcessArguments(e),i[o].saViewer.EventuallyRender()}else $(i[o]).removeClass("sa-resize"),$(i[o]).removeClass("sa-resize"),$(i[o]).removeClass("sa-viewer"),i[o].saViewer&&(i[o].saViewer.Delete(),delete i[o].saViewer)}function c(){for(var t=window.innerHeight,e=$(".sa-full-height"),i=0;i<e.length;++i){var o=e[i];$(o).css({top:"0px",height:t+"px"})}var s=$(".sa-resize");for(i=0;i<s.length;++i)s[i].onresize&&s[i].onresize()}function f(t,e){this.Div=t,this.AspectRatio=e.aspectRatio,this.Zoom=1,this.ShiftX=0,this.ShiftY=0}function g(t){this.XStops=null,this.YStops=null,this.Percentage=!0,this.Div=t;var e=this;h(t[0],SA.ImagePathUrl+"fullscreen.png","drag",null,!0).mousedown(function(t){var i=e.Div.parent();e.Div.detach(),e.Div.appendTo(i),e.Div.css({"z-index":"5"}),e.OldX=t.pageX,e.OldY=t.pageY;var o=e.Div.position(),s=o.left,n=o.top,a=e.Div.parent().width(),r=e.Div.parent().height();return e.XStops&&e.XStops.Start(s,a),e.YStops&&e.YStops.Start(n,r),$("body").on("mousemove.saDrag",function(t){return e.Drag(t.pageX-e.OldX,t.pageY-e.OldY),e.OldX=t.pageX,e.OldY=t.pageY,!1}),$("body").on("mouseup.saDrag",function(t){return e.Div.css("z-index",""),$("body").off("mousemove.saDrag"),$("body").off("mouseup.saDrag"),!1}),!1})}function v(t){this.Threshold=25,this.Stopped=!1,this.Stop=0,this.Delta=0,this.Target=0,this.Gap=100,this.Divisions=t,this.Last=0}function S(t){var e=this;this.FullWindowOptionButton=$("<img>").appendTo(t).attr("src",SA.ImagePathUrl+"fullscreenOn.png").prop("title","full window").css({position:"absolute",width:"12px",left:"-5px",top:"-5px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).on("click touchstart",function(){e.SetFullWindow(t,!0)}),this.FullWindowOptionOffButton=$("<img>").appendTo(t).hide().attr("src",SA.ImagePathUrl+"fullscreenOff.png").prop("title","full window off").css({position:"absolute",background:"#FFF",width:"16px",left:"1px",top:"1px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).on("click touchstart",function(){e.SetFullWindow(t,!1)})}function y(t){this.Button=h(t,SA.ImagePathUrl+"remove.png","delete",function(){t.saViewer&&m(t.saViewer),u(t),$(t).remove()},!0)}function m(t){for(var e=t.saViewerIndex,i=t.saNote,o=$(".sa-lightbox-viewer"),s=0;s<o.length;++s)o[s].saViewer&&o[s].saViewer.saNote===i&&o[s].saViewer.saViewerIndex>e&&--o[s].saViewer.saViewerIndex;i.ViewerRecords.splice(e,1)}function w(t){var e=this;this.Width=353,this.PanelDiv=$("<div>").appendTo(t).css({"background-color":"white",position:"absolute",top:"0px",bottom:"0px",left:"0px",width:this.Width+"px"}).attr("draggable","false").on("dragstart",function(){return!1}),this.MainDiv=$("<div>").appendTo(t).css({position:"absolute",top:"0px",bottom:"0px",left:this.Width+"px",right:"0px","border-left":"1px solid #AAA"}).attr("draggable","false").on("dragstart",function(){return!1}),this.OpenButton=$("<img>").appendTo(this.MainDiv).css({position:"absolute",height:"20px",width:"20px",top:"0px",left:"1px",opacity:"0.6","-moz-user-select":"none","-webkit-user-select":"none","z-index":"6"}).attr("src",SA.ImagePathUrl+"dualArrowRight2.png").on("click touchstart",function(){e.SetVisibility(!0)}).attr("draggable","false").hide().on("dragstart",function(){return!1}),this.CloseButton=$("<img>").appendTo(this.MainDiv).css({position:"absolute",height:"20px",top:"0px",left:"-22px",opacity:"0.6","-moz-user-select":"none","-webkit-user-select":"none","z-index":"6"}).attr("src",SA.ImagePathUrl+"dualArrowLeft2.png").on("click touchstart",function(){e.SetVisibility(!1)}).attr("draggable","false").on("dragstart",function(){return!1}),this.Visibility=!0,this.Dragging=!1,this.ResizeEdge=$("<div>").appendTo(t).css({position:"absolute",height:"100%",width:"3px",top:"0px",left:this.Width+"px",background:"#BDF","z-index":"10",cursor:"col-resize"}).hover(function(){$(this).css({background:"#9BF"})},function(){$(this).css({background:"#BDF"})}).mousedown(function(){return e.StartDrag(),!1})}function C(t,e){this.InsertMenuTimer=0,this.InsertMenu=$("<ul>").appendTo(e).css({position:"absolute",left:"-110px",top:"25px",width:"150px","font-size":"18px","box-shadow":"10px 10px 5px #AAA","z-index":"5"}).hide();for(var i in t)this.AddMenuItem(i,t[i]);this.InsertMenu.menu();var o=this;i=Object.keys(t)[0],e.on("click touchstart",function(){t[i](),o.InsertMenu.hide()}),e.mouseover(function(){o.ShowInsertMenu()}),this.InsertMenu.mouseover(function(){o.ShowInsertMenu()}),e.mouseleave(function(){o.EventuallyHideInsertMenu()}),this.InsertMenu.mouseleave(function(){o.EventuallyHideInsertMenu()})}jQuery.prototype.saElement=function(e){for(var i=0;i<this.length;++i){if(!this[i].saElement){var o=new t($(this[i]));this[i].saElement=o,$(this[i]).addClass("sa-element")}this[i].saElement.ProcessArguments(arguments)}return this},t.prototype.ActiveOn=function(){var t=this;if(!this.Interactive)return!0;this.SavedBorder||(this.SavedBorder=this.Div[0].style.border),this.Div.css({"border-color":"#7BF"}),this.Editable&&(this.ButtonDiv.appendTo(this.Div),this.MenuButton.on("mousedown",function(){return t.OpenDialog(),!1}),this.DeleteButton.on("mousedown",function(){return t.DeleteCallback&&t.DeleteCallback(t.Div[0]),t.Div.remove(),!1}))},t.prototype.ActiveOff=function(){if(!this.Interactive)return!0;this.SavedBorder&&(this.Div[0].style.border=this.SavedBorder,delete this.SavedBorder),this.ButtonDiv.remove()},t.prototype.InitializeDialog=function(){var t=this;this.Dialog=new SAM.Dialog(function(){t.DialogApplyCallback()}),this.Dialog.Title.text("Properties"),this.DialogInitializeFunctions=[],this.DialogApplyFunctions=[],this.Dialog.QuizPanel=this.AddAccordionTab("Quiz",function(){t.Dialog.QuizCheck.prop("checked",t.Div.hasClass("sa-quiz-hide"))},function(){t.Dialog.QuizCheck.is(":checked")?t.Div.addClass("sa-quiz-hide"):t.Div.removeClass("sa-quiz-hide")}),this.Dialog.QuizLabel=$("<div>").appendTo(this.Dialog.QuizPanel).css({display:"inline-block"}).text("Hide for quiz:"),this.Dialog.QuizCheck=$('<input type="checkbox">').appendTo(this.Dialog.QuizPanel),this.Dialog.BorderPanel=this.AddAccordionTab("Border",function(){t.DialogInitialize()},function(){t.DialogApply()}),this.Dialog.BorderLine1=$("<div>").appendTo(this.Dialog.BorderPanel).css({width:"100%"}),this.Dialog.BorderCheck=$('<input type="checkbox">').appendTo(this.Dialog.BorderLine1).change(function(){$(this).is(":checked")?(t.Dialog.BorderWidth.prop("disabled",!1),t.Dialog.BorderColor.spectrum("enable")):(t.Dialog.BorderWidth.prop("disabled",!0),t.Dialog.BorderColor.spectrum("disable"))}),this.Dialog.BorderWidthLabel=$("<div>").appendTo(this.Dialog.BorderLine1).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Width"),this.Dialog.BorderWidth=$('<input type="number">').appendTo(this.Dialog.BorderLine1).addClass("sa-view-annotation-modal-input").css({display:"inline-block",width:"3em"}).prop("disabled",!0).val(1).keypress(function(t){return 13!==t.keyCode}),this.Dialog.BorderColorDiv=$("<div>").appendTo(this.Dialog.BorderLine1).css({float:"right",height:"18px"}),this.Dialog.BorderColor=$('<input type="text">').appendTo(this.Dialog.BorderColorDiv).spectrum({showAlpha:!0}),this.Dialog.BorderLine2=$("<div>").appendTo(this.Dialog.BorderPanel).css({width:"100%"}),this.Dialog.BorderRadiusCheck=$('<input type="checkbox">').appendTo(this.Dialog.BorderLine2).change(function(){$(this).is(":checked")?t.Dialog.BorderRadius.prop("disabled",!1):t.Dialog.BorderRadius.prop("disabled",!0)}),this.Dialog.BorderRadiusLabel=$("<div>").appendTo(this.Dialog.BorderLine2).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Radius"),this.Dialog.BorderRadius=$('<input type="number">').appendTo(this.Dialog.BorderLine2).addClass("sa-view-annotation-modal-input").prop("disabled",!0).css({display:"inline-block",width:"3em"}).val(5).keypress(function(t){return 13!==t.keyCode}),this.Dialog.BorderLine3=$("<div>").appendTo(this.Dialog.BorderPanel).css({width:"100%"}),this.Dialog.ShadowCheck=$('<input type="checkbox">').appendTo(this.Dialog.BorderLine3).change(function(){$(this).is(":checked")?(t.Dialog.ShadowOffset.prop("disabled",!1),t.Dialog.ShadowBlur.prop("disabled",!1),t.Dialog.ShadowColor.spectrum("enable")):(t.Dialog.ShadowOffset.prop("disabled",!0),t.Dialog.ShadowBlur.prop("disabled",!0),t.Dialog.ShadowColor.spectrum("disable"))}),this.Dialog.ShadowLabel=$("<div>").appendTo(this.Dialog.BorderLine3).css({display:"inline-block",padding:"0px 5px",width:"4em",height:"20px","text-align":"right"}).text("Shadow"),this.Dialog.ShadowOffset=$('<input type="number">').appendTo(this.Dialog.BorderLine3).addClass("sa-view-annotation-modal-input").prop("disabled",!0).css({display:"inline-block",width:"3em"}).val(10).keypress(function(t){return 13!==t.keyCode}),this.Dialog.ShadowBlurLabel=$("<div>").appendTo(this.Dialog.BorderLine3).css({display:"inline-block",padding:"0px 5px",width:"3em",height:"20px","text-align":"right"}).text("Blur"),this.Dialog.ShadowBlur=$('<input type="number">').appendTo(this.Dialog.BorderLine3).addClass("sa-view-annotation-modal-input").prop("disabled",!0).css({display:"inline-block",width:"3em"}).val(5).keypress(function(t){return 13!==t.keyCode}),this.Dialog.ShadowColorDiv=$("<div>").appendTo(this.Dialog.BorderLine3).css({float:"right",height:"18px"}),this.Dialog.ShadowColor=$('<input type="text">').appendTo(this.Dialog.ShadowColorDiv).val("#AAAAAA").prop("disabled",!0).css({float:"right",height:"18px"}).spectrum({showAlpha:!0})},t.prototype.AddAccordionTab=function(t,e,i){e&&this.DialogInitializeFunctions.push(e),i&&this.DialogApplyFunctions.push(i);var o=$("<div>").appendTo(this.Dialog.Body).attr("title",t).css({width:"100%"}),s=$("<div>").appendTo(o).text(t).addClass("sa-accordion-tab"),n=$("<div>").appendTo(o).css({width:"100%",padding:"5px",border:"1px solid #AAA","box-sizing":"border-box"}).hide(),a=this;return s.on("click touchstart",function(){a.OpenAccordionPanel&&a.OpenAccordionPanel.hide(200),a.OpenAccordionPanel!==n?(n.show(200),a.OpenAccordionPanel=n):a.OpenAccordionPanel=null}),this.OpenAccordionPanel&&this.OpenAccordionPanel.hide(),this.OpenAccordionPanel=n,n.show(),n},t.prototype.HideAccordionTab=function(t){this.Div[0].saElement.Dialog.Body.children("[title=Quiz]").hide()},t.prototype.OpenDialog=function(t){if(!this.DialogInitialized){for(var e=0;e<this.DialogInitializeFunctions.length;++e)this.DialogInitializeFunctions[e](this.Dialog);this.DialogInitialized=!0}this.OpenDialogCallback=t,this.Dialog.Show(!0)},t.prototype.DialogInitialize=function(){var t=this.Div[0].style.borderWidth;if(""!==t&&(this.Dialog.BorderCheck.prop("checked",!0),this.Dialog.BorderWidth.prop("disabled",!1),this.Dialog.BorderColor.spectrum("enable"),this.Dialog.BorderWidth.val(parseInt(t)),(t=this.SavedBorder)&&""!==t||(t=this.Div[0].style.border),""!==t&&(t=t.substr(t.indexOf("rgb")),this.Dialog.BorderColor.spectrum("set",t))),""!==(t=this.Div[0].style.borderRadius)&&(this.Dialog.BorderRadiusCheck.prop("checked",!0),this.Dialog.BorderRadius.prop("disabled",!1),this.Dialog.BorderRadius.val(parseInt(t))),""!==(t=this.Div[0].style.boxShadow)){this.Dialog.ShadowCheck.prop("checked",!0);var e=t.indexOf(")")+1,i=t.substr(t.indexOf("rgb"),e);this.Dialog.ShadowColor.spectrum("set",i),this.Dialog.ShadowColor.spectrum("enable");var o=(t=t.substr(e+1)).split(" ");this.Dialog.ShadowOffset.prop("disabled",!1),this.Dialog.ShadowOffset.val(parseInt(o[0])),this.Dialog.ShadowBlur.prop("disabled",!1),this.Dialog.ShadowBlur.val(parseInt(o[2]))}},t.prototype.DialogApplyCallback=function(){for(var t=0;t<this.DialogApplyFunctions.length;++t)this.DialogApplyFunctions[t](this.Dialog);this.OpenDialogCallback&&(this.OpenDialogCallback(this),delete this.OpenDialogCallback)},t.prototype.DialogApply=function(){delete this.SavedBorder;var t;if(this.Dialog.BorderCheck.is(":checked")){var e=this.Dialog.BorderColor.spectrum("get");t=parseFloat(this.Dialog.BorderWidth.val()),this.Div.css({border:t+"px solid "+e})}else this.Div.css("border","");if(this.Dialog.BorderRadiusCheck.is(":checked")?(t=parseFloat(this.Dialog.BorderRadius.val()),this.Div.css({borderRadius:t+"px"})):this.Div.css("borderRadius",""),this.Dialog.ShadowCheck.is(":checked")){var i=this.Dialog.ShadowColor.spectrum("get"),o=parseInt(this.Dialog.ShadowOffset.val()),s=parseInt(this.Dialog.ShadowBlur.val());this.Div.css({"box-shadow":o+"px "+o+"px "+s+"px "+i})}else this.Div.css("box-shadow","")},t.prototype.ProcessArguments=function(t){if(t.length>0){if("function"==typeof this[t[0]])return this[t[0]].apply(this,Array.prototype.slice.call(t,1));t=t[0]}else t={};t.position&&(this.Position=t.position),void 0!==t.aspectRatio?""===t.apsectRatio?(delete this.AspectRatio,this.Div.removeAttr("sa-aspect-ratio")):(this.AspectRatio=t.aspectRatio,this.Div.attr("sa-aspect-ratio",t.aspectRatio)):this.AspectRatio=this.Div.attr("sa-aspect-ratio"),void 0!==t.editable&&(t.editable?this.EditableOn():(this.EditableOff(),this.Div.attr("contenteditable","false").addClass("sa-noselect"),this.Div.find("div").attr("contenteditable","false").addClass("sa-noselect"))),void 0!==t.interactive&&(this.Interactive=t.interactive,this.Interactive?this.Div.removeClass("sa-noselect"):this.Div.addClass("sa-noselect")),void 0!==t.click&&(this.ClickCallback=t.click,this.Clickable=!0),void 0!==t.delete&&(this.DeleteCallback=t.delete),this.ConvertToPercentages()},t.prototype.SetClickCallback=function(t){this.ClickCallback=t,this.Clickable=!0},t.prototype.EditableOn=function(){this.Editable=!0,this.Clickable=!0;var t=this;this.Div.on("mousewheel.element",function(e){return t.HandleMouseWheel(e.originalEvent)}),"absolute"===this.Position&&this.Div.on("mousemove.elementCursor",function(e){return t.HandleMouseMoveCursor(e)})},t.prototype.EditableOff=function(){this.Editable=!1,this.Div.css({cursor:"auto"}),this.Div.off("mousewheel.element"),this.Div.off("keyup.element"),this.Div.off("mousemove.elementCursor"),this.ButtonDiv.remove()},t.prototype.HandleMouseDown=function(t){if(!this.Interactive)return!0;if(1===t.which){if(!this.Clickable)return!0;var e=this;return this.ClickStart=Date.now(),$("body").on("mouseup.element",function(t){return e.HandleMouseUp(t)}),this.Editable&&"absolute"===this.Position&&(this.DragLastX=t.screenX,this.DragLastY=t.screenY,$("body").on("mousemove.element",function(t){return e.HandleMouseMove(t)}),$("body").on("mouseleave.element",function(t){return e.HandleMouseUp(t)}),this.Div[0].saElement.LockActive=!0),!1}return!0},t.prototype.RaiseToTop=function(){var t=this.Div.parent();this.Div.detach(),this.Div.appendTo(t)},t.prototype.HandleMouseMoveCursor=function(t){if(!this.Interactive)return!0;if(SA.FirefoxWhich(t),0===t.which){for(;t.srcElement&&t.srcElement!==this.Div[0];)t.offsetX+=t.srcElement.offsetLeft,t.offsetY+=t.srcElement.offsetTop,t.srcElement=t.srcElement.parentElement;var e=t.offsetX,i=t.offsetY,o=this.Div.outerWidth(),s=this.Div.outerHeight(),n=(o+s)/100;n<6&&(n=6);var a=o-n,r=s-n;e<n&&i<n?(this.Div.css({cursor:"nwse-resize"}),this.MoveState=5):e>a&&i>r?(this.Div.css({cursor:"nwse-resize"}),this.MoveState=6):e<n&&i>r?(this.Div.css({cursor:"nesw-resize"}),this.MoveState=7):e>a&&i<n?(this.Div.css({cursor:"nesw-resize"}),this.MoveState=8):e<n?(this.Div.css({cursor:"ew-resize"}),this.MoveState=1):e>a?(this.Div.css({cursor:"ew-resize"}),this.MoveState=2):i<n?(this.Div.css({cursor:"ns-resize"}),this.MoveState=3):i>r?(this.Div.css({cursor:"ns-resize"}),this.MoveState=4):(this.Div.css({cursor:"move"}),this.MoveState=0)}return!0},t.prototype.HandleMouseMove=function(t){if(SA.FirefoxWhich(t),1===t.which){if(Date.now()-this.ClickStart<200)return!0;this.Dragging||(this.RaiseToTop(),this.Dragging=!0);var e=t.screenX-this.DragLastX,i=t.screenY-this.DragLastY;this.DragLastX=t.screenX,this.DragLastY=t.screenY;var o=this.Div.position(),s=this.Div.outerWidth(),n=this.Div.outerHeight(),a=this.Div.css("box-sizing");this.AspectRatio&&"number"!=typeof this.AspectRatio&&(this.AspectRatio=s/n);var r,h;if(0===this.MoveState)return r=o.left+e,h=o.top+i,this.Div[0].style.top=h.toString()+"px",this.Div[0].style.left=r.toString()+"px",!1;if(1===this.MoveState)return r=o.left+e,s-=e,this.Div[0].style.left=r.toString()+"px","border-box"===a?this.Div.width(s):this.Div.outerWidth(s),this.AspectRatio&&this.Div.innerHeight(this.Div.innerWidth/this.AspectRatio),this.Div.trigger("resize"),!1;if(2===this.MoveState)return s+=e,"border-box"===a?this.Div.width(s):this.Div.outerWidth(s),this.AspectRatio&&this.Div.innerHeight(this.Div.innerWidth()/this.AspectRatio),this.Div.trigger("resize"),!1;if(3===this.MoveState)return h=o.top+i,n-=i,this.Div[0].style.top=h.toString()+"px","border-box"===a?this.Div.height(n):this.Div.outerHeight(n),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(4===this.MoveState)return n+=i,"border-box"===a?this.Div.height(n):this.Div.outerHeight(n),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(5===this.MoveState)return r=o.left+e,h=o.top+i,s-=e,n-=i,this.Div[0].style.top=h.toString()+"px",this.Div[0].style.left=r.toString()+"px","border-box"===a?(this.Div.width(s),this.Div.height(n)):(this.Div.outerWidth(s),this.Div.outerHeight(n)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(6===this.MoveState)return s+=e,n+=i,"border-box"===a?(this.Div.width(s),this.Div.height(n)):(this.Div.outerWidth(s),this.Div.outerHeight(n)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(7===this.MoveState)return r=o.left+e,s-=e,n+=i,this.Div[0].style.left=r.toString()+"px","border-box"===a?(this.Div.width(s),this.Div.height(n)):(this.Div.outerWidth(s),this.Div.outerHeight(n)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1;if(8===this.MoveState)return h=o.top+i,s+=e,n-=i,this.Div[0].style.top=h.toString()+"px","border-box"===a?(this.Div.width(s),this.Div.height(n)):(this.Div.outerWidth(s),this.Div.outerHeight(n)),this.AspectRatio&&this.Div.innerWidth(this.Div.innerHeight()*this.AspectRatio),this.Div.trigger("resize"),!1}return!0},t.prototype.HandleMouseUp=function(t){return $("body").off("mouseup.element"),this.Editable&&(this.Dragging&&(this.Dragging=!1,this.ConvertToPercentages()),$("body").off("mousemove.element"),$("body").off("mouseleave.element"),this.Div[0].saElement.LockActive=!1,this.Div[0].saElement.ActiveOff()),Date.now()-this.ClickStart<200&&this.ClickCallback&&this.ClickCallback(this.Div[0]),!1},t.prototype.HandleMouseWheel=function(t){var e=this.Div.width(),i=this.Div.height(),o=0,s=0,n=0;t.deltaY?n=t.deltaY:t.wheelDelta&&(n=t.wheelDelta),n>0?(o=.05*e,s=.05*i):n<0&&(o=-.0476*e,s=-.0476*i),e+=o,this.Div[0].style.width=e.toString()+"px",i+=s,this.Div[0].style.height=i.toString()+"px";var a=this.Div.position(),r=a.left-o/2,h=a.top-s/2;return this.Div[0].style.top=h.toString()+"px",this.Div[0].style.left=r.toString()+"px",this.Div.trigger("resize"),!1},t.prototype.ConvertToPercentages=function(){var t=this.Div[0].style.width;-1===t.indexOf("%")&&(t=100*(t=parseFloat(t))/this.Div.parent().width(),this.Div[0].style.width=t.toString()+"%");var e=this.Div[0].style.height;-1===e.indexOf("%")&&(e=100*(e=parseFloat(e))/this.Div.parent().height(),this.Div[0].style.height=e.toString()+"%");var i=this.Div.css("top");-1===i.indexOf("%")&&(i=100*(i=parseFloat(i))/this.Div.parent().height(),this.Div[0].style.top=i.toString()+"%");var o=this.Div.css("left");-1===o.indexOf("%")&&(o=100*(o=parseFloat(o))/this.Div.parent().width(),this.Div[0].style.left=o.toString()+"%")},jQuery.prototype.saRectangle=function(t){this.saElement(),this.addClass("sa-presentation-rectangle");for(var i=0;i<this.length;++i){var o=this[i];o.saRectangle||(o.saRectangle=new e($(o))),o.saRectangle.ProcessArguments(arguments)}return this},e.prototype.ProcessArguments=function(t){if(0!==t.length)return this.Div[0].saElement.ProcessArguments(t),"function"==typeof this[t[0]]?this[t[0]].apply(this,Array.prototype.slice.call(t,1)):void 0},e.prototype.DialogInitialize=function(){var t=this.Div[0].style.background;if(""===t&&(t=this.Div[0].style.backgroundColor),""===t)return this.BackgroundCheck.prop("checked",!1),this.BackgroundColor.spectrum("disable"),this.GradientCheck.prop("checked",!1),this.GradientColor.spectrum("disable"),void this.GradientColor.spectrum("hide");if("rgb"===t.substring(0,3))return this.BackgroundCheck.prop("checked",!0),this.BackgroundColor.spectrum("set",t),this.BackgroundColor.spectrum("enable"),this.GradientCheck.prop("checked",!1),this.GradientColor.spectrum("disable"),void this.GradientColor.spectrum("hide");if("linear-gradient"===t.substring(0,15)){var e=t.indexOf("rgb"),i=t.indexOf(")")+1;return this.BackgroundCheck.prop("checked",!0),this.BackgroundColor.spectrum("enable"),this.BackgroundColor.spectrum("set",t.substring(e,i)),e=t.indexOf("rgb",i),i=t.indexOf(")",i)+1,this.GradientCheck.prop("checked",!0),this.GradientColor.spectrum("enable"),this.GradientColor.spectrum("show"),void this.GradientColor.spectrum("set",t.substring(e,i))}SA.Debug("parse error: "+t)},e.prototype.DialogApply=function(){if(this.BackgroundCheck.is(":checked")){var t=this.BackgroundColor.spectrum("get");if(this.GradientCheck.is(":checked")){var e=this.GradientColor.spectrum("get");this.Div.css({background:"linear-gradient("+t+","+e+")"})}else this.Div.css({background:t})}else this.Div.css("background","")},jQuery.prototype.saText=function(t){this.saRectangle(),this.addClass("sa-text");for(var e=0;e<this.length;++e){var o=this[e];o.saText||(o.saText=new i($(o))),o.saText.ProcessArguments(arguments)}return this},i.prototype.ProcessArguments=function(t){if(0!==t.length)return this.Div[0].saRectangle.ProcessArguments(t),"function"==typeof this[t[0]]?this[t[0]].apply(this,Array.prototype.slice.call(t,1)):void 0},i.prototype.DialogPaddingInitialize=function(){var t;t=this.Div[0].style.paddingLeft,this.PaddingLeft.val(8*parseFloat(t)),t=this.Div[0].style.paddingTop,this.PaddingTop.val(8*parseFloat(t)),t=this.Div[0].style.paddingRight,this.PaddingRight.val(8*parseFloat(t)),t=this.Div[0].style.paddingBottom,this.PaddingBottom.val(8*parseFloat(t))},i.prototype.DialogPaddingApply=function(){this.Div[0].style.paddingLeft=this.PaddingLeft.val()/8+"%",this.Div[0].style.paddingTop=this.PaddingTop.val()/8+"%",this.Div[0].style.paddingRight=this.PaddingRight.val()/8+"%",this.Div[0].style.paddingBottom=this.PaddingBottom.val()/8+"%"},jQuery.prototype.saQuestion=function(t){this.saText();for(var e=0;e<this.length;++e)this[e].saQuestion||(this[e].saQuestion=new o($(this[e])),this[e].saElement.HideAccordionTab("Quiz")),this[e].saQuestion.ProcessArguments(arguments);return this},o.prototype.SetQuestionText=function(t){var e=this.Div.find(".sa-q");0===e.length&&(e=$("<div>").addClass("sa-q").appendTo(this.Div)),e.text(t),this.Div.attr("type","multiple-choice")},o.prototype.AddAnswerText=function(t,e){var i=t;"-"===t[0]?i=t.substring(1):"."!==t[1]&&":"!==t[1]||(i=t.substring(2)),i=i.trim();var o=this.Div.find("ol");0===o.length&&(o=$("<ol>").appendTo(this.Div));var s=$("<li>").appendTo(o).addClass("sa-answer");s.text(i),e&&s.addClass("sa-true")},o.prototype.ProcessArguments=function(t){if(0!==t.length)return this.Div[0].saText.ProcessArguments(t),"function"==typeof this[t[0]]?this[t[0]].apply(this,Array.prototype.slice.call(t,1)):void 0},o.prototype.SetMode=function(t){this.Div.find(".sa-answer").css({color:"#000"}),"answer-show"===t?(this.Div.find(".sa-quiz-hide").show(),this.Div.find(".sa-true").css({"font-weight":"bold"}),this.Div.find(".sa-short-answer").css({color:"#00C"}).show()):(this.Div.find(".sa-quiz-hide").hide(),this.Div.find(".sa-true").css({"font-weight":"normal"}),this.Div.find(".sa-short-answer").hide()),"answer-interactive"===t?this.Div.find(".sa-answer").css({cursor:"pointer",color:"#057"}).hover(function(){$(this).css({background:"#DDD"})},function(){$(this).css({background:"#FFF"})}).on("click.answer",function(){$(this).hasClass("sa-true")?$(this).css({"font-weight":"bold",color:"#000"}):$(this).css({color:"#C00"})}):this.Div.find(".sa-answer").css({color:"#000"}).css("cursor","").off("hover").off("click.answer")},o.prototype.AddAnswerTo=function(t,e,i,o){var s=$("<div>").appendTo(t).css({width:"100%",position:"relative"}),n=$('<input type="checkbox">').appendTo(s),a=$("<div>").appendTo(s).css({border:"1px solid #AAA",position:"absolute",left:"30px",right:"2px",top:"2px"}).attr("contenteditable","true");n.change(function(){$(this).is(":checked")?a.css({"font-weight":"bold"}):a.css({"font-weight":"normal"})}),i&&(a.text(i),o&&(n.attr("checked","true"),a.css({"font-weight":"bold"})));var r={Div:s,Check:n,Input:a};return e.push(r),r},o.prototype.DialogInitialize=function(){var t=this,e=this.QuestionPanel;e.empty(),this.QuestionTypeSelect=$("<select>").appendTo(e),this.QuestionTypeMultipleChoice=$("<option>").appendTo(this.QuestionTypeSelect).text("Multiple Choice"),this.QuestionTypeSortAnswer=$("<option>").appendTo(this.QuestionTypeSelect).text("Short Answer"),this.QuestionTypeSelect.change(function(){"Multiple Choice"===$(this).val()&&(t.MultipleChoiceDiv.show(),t.TrueFalseDiv.hide(),t.ShortAnswerDiv.hide()),"True or False"===$(this).val()&&(t.MultipleChoiceDiv.hide(),t.TrueFalseDiv.show(),t.ShortAnswerDiv.hide()),"Short Answer"===$(this).val()&&(t.MultipleChoiceDiv.hide(),t.TrueFalseDiv.hide(),t.ShortAnswerDiv.show())}),this.QuestionLabel=$("<div>").appendTo(e).text("Question:"),this.Question=$("<div>").appendTo(e).css({border:"1px solid #AAA",margin:"2px"}).attr("contenteditable","true"),this.ShortAnswerDiv=$("<div>").appendTo(e).css({border:"1px solid #AAA",width:"100%",height:"3em",margin:"1px"}).attr("contenteditable","true").hide(),this.TrueFalseDiv=$("<div>").appendTo(e).hide(),this.TrueFalseAnswers=[],this.AddAnswerTo(this.TrueFalseDiv,this.TrueFalseAnswers,"True"),this.AddAnswerTo(this.TrueFalseDiv,this.TrueFalseAnswers,"False"),this.MultipleChoiceDiv=$("<div>").appendTo(e),this.MultipleChoiceAnswerLabel=$("<div>").appendTo(this.MultipleChoiceDiv).addClass("sa-mutliple-choice-answer").text("Answers:"),this.MultipleChoiceAnswers=[];var i=this.Div.find(".sa-q");if(i.length>0){this.Question.text(i.text());var o=this.Div.attr("type");if("multiple-choice"===o){this.QuestionTypeSelect.val("Multiple Choice");for(var s=this.Div.find(".sa-answer"),n=0;n<s.length;++n){var a=$(s[n]),r=a.hasClass("sa-true");this.AddAnswerTo(this.MultipleChoiceDiv,this.MultipleChoiceAnswers,a.text(),r)}}else"short-answer"===o&&(this.ShortAnswerDiv.text($(".sa-short-answer").text()),this.QuestionTypeSelect.val("Short Answer"),this.ShortAnswerDiv.show(),this.MultipleChoiceDiv.hide())}this.AddBlankMultipleChoiceAnswer()},o.prototype.AddBlankMultipleChoiceAnswer=function(){var t=this;this.AddAnswerTo(this.MultipleChoiceDiv,this.MultipleChoiceAnswers).Input.on("focus.answer",function(){t.AddBlankMultipleChoiceAnswer()})},o.prototype.DialogApply=function(){this.Div.find(".sa-q").remove(),this.Div.find("ol").remove(),this.Div.find(".sa-short-answer").remove();var t,e=$("<div>").appendTo(this.Div).addClass("sa-q").text(this.Question.text());if("Multiple Choice"===this.QuestionTypeSelect.val()){this.Div.attr("type","multiple-choice"),e=$("<ol>").appendTo(this.Div).css({margin:"0px 0px 0px 0.5em"});for(var i,o,s=[];this.MultipleChoiceAnswers.length>0;){var n=Math.floor(Math.random()*this.MultipleChoiceAnswers.length);i=this.MultipleChoiceAnswers.splice(n,1)[0],s.push(i)}for(this.MultipleChoiceAnswers=s,t=0;t<this.MultipleChoiceAnswers.length;++t)""!==(i=this.MultipleChoiceAnswers[t]).Input.text()&&(o=$("<li>").appendTo(e).addClass("sa-answer").text(i.Input.text()),i.Check.is(":checked")&&(o.css({"font-weight":"bold"}),o.addClass("sa-true")))}if("True or False"===this.QuestionTypeSelect.val())for(this.Div.attr("type","true-false"),e=$("<ol>").appendTo(this.Div).css({margin:"0px 0px 0px 0.5em"}),t=0;t<this.TrueFalseAnswers.length;++t)""!==(i=this.TrueFalseAnswers[t]).Input.text()&&(o=$("<li>").appendTo(e).addClass("sa-true-false-answer").text(i.Input.text()),i.Check.is(":checked")&&(o.css({"font-weight":"bold"}),o.addClass("sa-true")));"Short Answer"===this.QuestionTypeSelect.val()&&(this.Div.attr("type","short-answer"),e=$("<div>").appendTo(this.Div).css({color:"#00C"}).addClass("sa-short-answer").text(this.ShortAnswerDiv.text()))},jQuery.prototype.saTextEditor=function(t){for(var e=0;e<this.length;++e){if(!this[e].saTextEditor){var i=new s($(this[e]),t);this[e].saTextEditor=i}this[e].saTextEditor.ProcessArguments(arguments)}return this},s.prototype.EditingOn=function(){$("body")[0].saTextEditing&&$("body")[0].saTextEditing.EditingOff(),$("body")[0].saTextEditing=this;var t=this.Div.position(),e=this.Div.outerWidth();e<275&&(e=275);var i=this.Div.outerHeight()+20;this.EditButtonDiv.css({left:t.left+"px",top:t.top-20+"px",width:e+"px",height:i+"px"}).show();var o=this;$("body").on("mousedown.textEditor",function(t){o.Div[0]===t.srcElement||o.EditButtonDiv[0]===t.srcElement||$.contains(o.Div[0],t.srcElement)||$.contains(o.EditButtonDiv[0],t.srcElement)||o.EditingOff()}),this.Div[0].saElement.LockActive=!0,this.SavedMovable=this.Div[0].saElement.Editable,this.Div[0].saElement.EditableOff(),this.Div[0].saElement.Clickable=!1,this.Div.attr("contenteditable","true").css({cursor:"text"}),SA.ContentEditableHasFocus=!0},s.prototype.EditingOff=function(){delete $("body")[0].saTextEditing,$("body").off("mousedown.textEditor");for(var t=this.Div.find("*"),e=0;e<t.length;++e)if(t[e].style.lineHeight.indexOf("px")>-1){var i=parseFloat(t[e].style.lineHeight);i=100*i/parseFloat($(t[e]).css("font-size")),t[e].style.lineHeight=i.toString()+"%"}var o=this.Div[0].scrollHeight;o>this.Div.outerHeight()&&("border-box"===this.Div.css("box-sizing")?this.Div.height(o+4):this.Div.outerHeight(o+4),this.Div.trigger("resize"),this.Div[0].saElement.ConvertToPercentages()),this.EditButtonDiv.hide(),this.Div[0].saElement.LockActive=!1,this.Div[0].saElement.ActiveOff(),this.SavedMovable&&this.Div[0].saElement.EditableOn(),this.Div[0].saElement.Clickable=!0,this.Div.attr("contenteditable","false").off("mouseleave.textEditor").css("cursor",""),SA.ContentEditableHasFocus=!1},s.prototype.AddButton=function(t,e,i,o){var s=this.EditButtonDiv,n=$("<img>").addClass("editButton").css({height:"16px"}).attr("src",t);return i&&n.click(i),e&&n.prop("title",e),o?n.prependTo(s):n.appendTo(s),n},s.prototype.ProcessArguments=function(t){if(t=t||{dialog:!0},this.Div[0].saText.ProcessArguments(t),"function"==typeof this[t[0]])return this[t[0]].apply(this,Array.prototype.slice.call(t,1))},s.prototype.DialogInitialize=function(){var t;if(this.Div[0].saScalableFont){var e=this.Div[0].saScalableFont.scale,i=Math.round(800*e);this.FontSize.val(i)}var o="#000000";""!==(t=this.Div[0].style.color)&&(o=SAM.ConvertColorToHex(t)),this.FontColor.spectrum("set",o);var s=120;""!==(t=this.Div[0].style.lineHeight)&&"%"===t.substring(t.length-1)&&(s=parseFloat(t.substr(0,t.length-1))),this.LineHeight.val(s)},s.prototype.DialogApply=function(){if(this.FontSize){var t=parseFloat(this.FontSize.val())/800;this.Div.saScalableFont({scale:t})}if(this.LineHeight){var e=parseFloat(this.LineHeight.val());this.Div[0].style.lineHeight=e+"%"}var i;this.FontColor&&(i=this.FontColor.spectrum("get"),this.Div[0].style.color=i),i="#000000";var o=this.Div[0].style.color;""!==o&&(i=o),this.FontColor.spectrum("set",i)},s.prototype.Delete=function(){this.Div.remove()},s.prototype.InsertUrlLink=function(){var t=this,e=window.getSelection(),i=SA.GetSelectionRange(this.Div),o=e.toString();if(!this.UrlDialog){var s=new SAM.Dialog(function(){t.InsertUrlLinkAccept()});this.UrlDialog=s,s.Dialog.css({width:"40em"}),s.Title.text("Paste URL link"),s.TextDiv=$("<div>").appendTo(s.Body).css({display:"table-row",width:"100%"}),s.TextLabel=$("<div>").appendTo(s.TextDiv).text("Text to display:").css({display:"table-cell",height:"2em","text-align":"left"}),s.TextInput=$("<input>").appendTo(s.TextDiv).val("#30ff00").css({display:"table-cell",width:"25em"}),s.UrlDiv=$("<div>").appendTo(s.Body).css({display:"table-row"}),s.UrlLabel=$("<div>").appendTo(s.UrlDiv).text("URL link:").css({display:"table-cell","text-align":"left"}),s.UrlInput=$("<input>").appendTo(s.UrlDiv).val("#30ff00").css({display:"table-cell",width:"25em"}).on("input",function(){var e=t.UrlDialog.UrlInput.val();t.UrlDialog.LastUrl===t.UrlDialog.TextInput.val()&&t.UrlDialog.TextInput.val(e),t.UrlDialog.LastUrl=e,""===e?t.UrlDialog.ApplyButton.attr("disabled",!0):t.UrlDialog.ApplyButton.attr("disabled",!1)})}this.UrlDialog.SelectionRange=i,this.UrlDialog.TextInput.val(o),this.UrlDialog.UrlInput.val(""),this.UrlDialog.LastUrl="",this.UrlDialog.ApplyButton.attr("disabled",!0),this.UrlDialog.Show(!0)},s.prototype.InsertUrlLinkAccept=function(){var t=window.getSelection(),e=this.UrlDialog.SelectionRange;e||(e=SA.MakeSelectionRange(this.Div));var i=document.createElement("a");i.href=this.UrlDialog.UrlInput.val(),i.target="_blank",e.collapsed||(e.extractContents(),e.collapse(!0));var o=this.UrlDialog.TextInput.val();""===o&&(o=this.UrlDialog.UrlInput.val()),i.appendChild(document.createTextNode(o)),e.insertNode(i),e.noCursor&&t.removeAllRanges()},s.prototype.GetSelection=function(){var t,e=window.getSelection(),i=null;if(e.rangeCount>0)for((t=e.getRangeAt(0)).noCursor=!1,i=t.commonAncestorContainer;i&&i!==this.Div[0];)i&&(i=i.parentNode);if(!i)return this.Div;for(var o=t.extractContents().children,s=0;s<o.length;++s)t.insertNode(o[s]);return $(o)},s.prototype.SetPositionPixel=function(t,e){this.Percentage?(t=100*t/this.Div.parent().width(),e=100*e/this.Div.parent().height(),this.Div[0].style.left=t.toString()+"%",this.Div[0].style.top=e.toString()+"%"):(this.Div[0].style.left=t+"px",this.Div[0].style.top=e+"px")},jQuery.prototype.saLightBox=function(t){this.saElement(),this.addClass("sa-light-box");for(var e=0;e<this.length;++e){if(!this[e].saLightBox){var i=new n($(this[e]));this[e].saLightBox=i}this[e].saLightBox.ProcessArguments(arguments)}return this},n.prototype.ProcessArguments=function(t){if(0!==t.length)return this.Div[0].saElement.ProcessArguments(t),"function"==typeof this[t[0]]?this[t[0]].apply(this,Array.prototype.slice.call(t,1)):(void 0!==(t=t[0]).aspectRatio&&(this.AspectRatio=t.aspectRatio),void 0!==t.editable&&(this.Editable=t.editable),void 0!==t.expand&&this.Expand(t.expand,t.animate),void 0!==t.Interactive&&(this.Interactive=t.interactive),t.onExpand&&(this.ExpandCallback=t.onExpand),"function"==typeof this[t[0]]?this[t[0]].apply(this,Array.prototype.slice.call(t,1)):void 0)},n.prototype.UpdateSize=function(){if(this.Expanded){var t=this,e="5%",i="5%",o="90%",s="90%";if(this.AspectRatio){this.Div[0].onresize||(this.Div[0].onresize=function(){t.UpdateSize()},this.Div.addClass("sa-resize"));var n=this.Div.width()/this.Div.height(),a=this.Div.parent().width(),r=this.Div.parent().height();(o=Math.floor(.9*a))/(s=Math.floor(.9*r))>n?o=Math.floor(s*n):s=Math.floor(o/n),e=Math.floor(.5*(a-o))+"px",i=Math.floor(.5*(r-s))+"px",o+="px",s+="px"}this.Div.css({"z-index":"1001"}),this.Div.css({left:e,top:i,width:o,height:s})}},n.prototype.Expand=function(t,e){if(this.Interactive&&t!==this.Expanded){var i=this;t?(this.Div.saElement({editable:!1}),this.Expanded=!0,this.SavedTop=this.Div[0].style.top,this.SavedLeft=this.Div[0].style.left,this.SavedWidth=this.Div[0].style.width,this.SavedHeight=this.Div[0].style.height,this.SavedZIndex=this.Div[0].style.zIndex,this.Div.css({"z-index":"1001"}),this.UpdateSize(),this.Div.trigger("resize"),this.Mask.show(),this.Mask.on("mousedown.lightbox",function(){i.Expand(!1,!0)})):(this.Mask.hide(),this.Mask.off("mousedown.lightbox"),e?this.Div.animate({top:i.SavedTop,left:i.SavedLeft,width:i.SavedWidth,height:i.SavedHeight,"z-index":i.SavedZIndex},{step:function(){i.Div.trigger("resize")}}):this.Div.css({top:i.SavedTop,left:i.SavedLeft,width:i.SavedWidth,height:i.SavedHeight,"z-index":i.SavedZIndex}),this.Expanded=!1,this.Editable&&this.Div.saElement({editable:!0})),this.ExpandCallback&&this.ExpandCallback(t),this.Div.trigger("resize")}},jQuery.prototype.saLightBoxViewer=function(t){return t.hideCopyright||(t.hideCopyright=!0),t.zoomWidget||(t.zoomWidget=!1),t.dualWidget||(t.dualWidget=!1),t.navigation||(t.navigation=!1),t.drawWidget||(t.drawWidget=!1),void 0===t.interaction&&(t.interaction=!1),t.overview=!1,this.saViewer(t),t.onExpand=function(t){if(this.Div.saViewer({interaction:t}),t)this.Div.saViewer({overview:!0,navigation:!0,menu:!0,zoomWidget:!0,dualWidget:!0,drawWidget:!0});else{this.Div.saViewer({overview:!1,navigation:!1,menu:!1,zoomWidget:!1,dualWidget:!1,drawWidget:!1});var e=this.Div[0].saViewer,i=e.saNote;if(!this.Div[0].saLightBox.Editable&&i){var o=e.saViewerIndex||0;e.SetNote(i,o)}}},this.saLightBox(t),this.addClass("sa-lightbox-viewer"),this};var A=null;jQuery.prototype.saButtons=function(t){var e;if("enable"===t)for(e=0;e<this.length;++e)d(this[e]);if("disable"===t)for(e=0;e<this.length;++e)l(this[e])},r.prototype.PlaceButtons=function(){var t=this.Div.position();this.ButtonsDiv.css({left:t.left+10+"px",top:t.top-20+"px"})},r.prototype.ShowButtons=function(t){this.TimerId>=0&&(clearTimeout(this.TimerId),this.TimerId=-1),this.Enabled&&(A&&A!==this.ButtonsDiv&&(A.fadeOut(200),A=this.ButtonsDiv),this.PlaceButtons(),1===t?(this.ButtonsDiv.fadeIn(400),this.ButtonsDiv.children().css({opacity:"0.4"})):(this.ButtonsDiv.show(),this.ButtonsDiv.children().css({opacity:"1.0"})))},r.prototype.HideButtons=function(){if(this.TimerId<0){var t=this;this.TimerId=setTimeout(function(){A===t.ButtonsDiv&&(A=null),t.ButtonsDiv.fadeOut(200)},200)}},jQuery.prototype.saHtml=function(t){if(!t){this.find(".sa-light-box").saLightBox({expand:!1,animate:!1}),this.find(".sa-quiz-hide").show(),this.find(".sa-presentation-title").show();var e=this.clone();return e.find(".sa-edit-gui").remove(),e.find(".sa-standin").remove(),e.find(".ui-resizable").resizable("destroy"),e.find(".sa-lightbox-viewer").empty(),e.html()}this.html(t),this.find(".sa-scalable-font").saScalableFont(),this.find(".sa-presentation-rectangle").saRectangle(),this.find(".sa-presentation-view").addClass("sa-lightbox-viewer").removeClass("sa-presentation-view"),this.find(".ui-resizable-handle").remove(),this.find(".ui-resizable").removeClass("ui-resizable");var i=this.find(".sa-lightbox-viewer");i.saLightBoxViewer({hideCopyright:!0,interaction:!1});for(var o=0;o<i.length;++o){var s=i[o].saViewer,n=$(i[o]).attr("sa-note-id"),a=$(i[o]).attr("sa-viewer-index")||0;a=parseInt(a),n&&s.SetNoteFromId(n,a)}if(SA.Edit){this.find(".sa-resizable");this.find(".sa-text-editor").saTextEditor({editable:!0}),this.find(".sa-presentation-rectangle").saRectangle({editable:!0}),this.find(".sa-question").saQuestion({editable:!0}),this.find(".sa-presentation-image").saLightBox({aspectRatio:!0,editable:!0}),this.find(".sa-lightbox-viewer").saViewer({drawWidget:!1})}else this.find(".sa-text-editor").css({overflow:"visible"})},jQuery.prototype.saResizable=function(t){return t=t||{},t.start=function(t,e){this.saViewer&&this.saViewer.DisableInteraction()},t.stop=function(t,e){var i=$(this).width();i=100*i/$(this).parent().width(),this.style.width=i.toString()+"%";var o=$(this).height();o=100*o/$(this).parent().height(),this.style.height=o.toString()+"%";var s=$(this).position(),n=100*s.top/$(this).parent().height(),a=100*s.left/$(this).parent().width();this.style.top=n.toString()+"%",this.style.left=a.toString()+"%"},this.addClass("sa-resizable"),this},jQuery.prototype.saViewer=function(t){return T(this,t)};var T=function(t,e){return"object"==typeof(e=e||{})&&(e.viewerIndex=e.viewerIndex||0),e.viewId&&(e.note=SA.GetNoteFromId(e.viewId),null===e.note)?(e.note=new SA.Note,e.note.LoadViewId(e.viewId,function(){p(arguments)}),t):0===arguments.length?p([t,e])||t:p(arguments)||t};jQuery.prototype.saRecordViewer=function(){for(var t=0;t<this.length;++t)if(this[t].saViewer&&this[t].saViewer.saNote){var e=this[t].saViewer.saViewerIndex||0,i=this[t].saViewer.saNote;this[t].saViewer.Record(i,e)}},jQuery.prototype.saOnResize=function(t){this.addClass("sa-resize");for(var e=0;e<this.length;++e)this[e].onresize=t;return this},jQuery.prototype.saTriggerResize=function(){$(window).trigger("resize")};jQuery.prototype.saFullHeight=function(t){return b(this,t)};var b=function(t,e){t.css({top:"0px"}),t.addClass("sa-full-height");for(var i=0;i<t.length;++i)t[i].saFullHeight=e;return $(window).off("resize.sa").on("resize.sa",c).trigger("resize"),t};jQuery.prototype.saPresentation=function(t){this.addClass("sa-presentation"),this.addClass("sa-resize"),$(window).off("resize.sa").on("resize.sa",c).trigger("resize");for(var e=0;e<this.length;++e){var i=this[e];i.saPresentation||(i.saPresentation=new f($(i),t),i.onresize=function(){this.saPresentation.Resize()}),setTimeout(function(){i.saPresentation.Resize()},300)}return this},f.prototype.Resize=function(){var t=this.AspectRatio,e=this.Div.parent(),i=e.innerWidth(),o=e.innerHeight(),s=i,n=o;s/n>t?s=n*t:n=s/t,s*=this.Zoom,n*=this.Zoom;var a=.5*(i-s)+this.ShiftX,r=.5*(o-n)+this.ShiftY;this.Div.css({position:"absolute",top:r+"px",height:n+"px",left:a+"px",width:s+"px"})},f.prototype.HandleMouseDown=function(t){var e=this;if(this.ClickStart=Date.now(),1!==t.which&&3!==t.which||$("body").on("mouseup.presentation",function(t){return e.HandleMouseUp(t)}),1===t.which)return $("body").on("mousemove.presentation",function(t){return e.HandleMouseMove(t)}),$("body").on("mouseleave.presentation",function(t){return e.HandleMouseUp(t)}),this.DragLastX=t.screenX,this.DragLastY=t.screenY,!1},f.prototype.HandleMouseWheel=function(t){var e=0;if(t.deltaY?e=t.deltaY:t.wheelDelta&&(e=t.wheelDelta),0!==e)return e>0?this.Zoom*=1.01:e<0&&(this.Zoom*=.99),this.Resize(),!1},f.prototype.HandleMouseMove=function(t){if(Date.now()-this.ClickStart<200)return!0;if(1===t.which){var e=t.screenX-this.DragLastX,i=t.screenY-this.DragLastY;return this.DragLastX=t.screenX,this.DragLastY=t.screenY,this.ShiftX+=e,this.ShiftY+=i,this.Resize(),!1}return!0},f.prototype.HandleMouseUp=function(t){return $("body").off("mouseup.presentation"),1===t.which&&($("body").off("mousemove.presentation"),$("body").off("mouseleave.presentation")),!0},jQuery.prototype.saScalableFont=function(t){this.addClass("sa-scalable-font"),this.addClass("sa-resize"),$(window).off("resize.sa").on("resize.sa",c);for(var e=0;e<this.length;++e){var i=this[e];i.saScalableFont||(i.onresize=function(){o=this.saScalableFont.scale;var t=$(this).parent().innerHeight(),e=Math.round(o*t)+"px";this.style.fontSize=e,$(this).children("font").css({"font-size":e})},i.saScalableFont={},i.saScalableFont.scale=.1);var o=i.saScalableFont.scale,s=i.getAttribute("sa-font-scale");s&&(o=parseFloat(s)),t&&t.scale&&"string"==typeof(o=t.scale)&&(o="%"===o.substring(-1)?parseFloat(o.substr(0,o.length-1))/100:parseFloat(o)),i.setAttribute("sa-font-scale",o.toString()),i.saScalableFont.scale=o,i.onresize()}return this},jQuery.prototype.saDraggable=function(t){t=t||{grid:[30,39]},this.addClass("sa-draggable");for(var e=0;e<this.length;++e){if(!this[e].saDraggable){var i=new g($(this[e]));this[e].saDraggable=i}this[e].saDraggable.ProcessArguments(t)}return this},g.prototype.ProcessArguments=function(t){if(t.grid&&(this.XStops=new v(t.grid[0]),this.YStops=new v(t.grid[1])),"function"==typeof this[t[0]])return this[t[0]].apply(this,Array.prototype.slice.call(t,1))},g.prototype.Drag=function(t,e){var i=this.Div.position(),o=i.left,s=i.top,n=this.Div.parent().width(),a=this.Div.parent().height(),r=o+t,h=s+e;this.XStops&&(r=this.XStops.Drag(t)),this.YStops&&(h=this.YStops.Drag(e)),this.Percentage?(r/=n,h/=a,r*=100,h*=100,this.Div[0].style.left=r+"%",this.Div[0].style.top=h+"%"):(this.Div[0].style.left=r+"px",this.Div[0].style.top=h+"px"),this.Div[0].saButtons.PlaceButtons()},v.prototype.Start=function(t,e){this.Stopped=!1,this.Delta=0,this.Last=t,this.Size=e,this.Target=t,this.Gap=e/this.Divisions},v.prototype.Drag=function(t){this.Target+=t,t+=3*(this.Target-this.Last)/this.Gap;var e=this.Last+t;if(this.Stopped)return this.Delta=this.Delta+t,Math.abs(this.Delta)>this.Threshold?(this.Stopped=!1,this.Delta=0,this.Last=e,e):this.Stop;var i=this.GetStop(this.Last,e);return i<this.Last&&i<e?(this.Delta=0,this.Last=e,e):i>this.Last&&i>e?(this.Delta=0,this.Last=e,e):(this.Delta=e-i,this.Last=i,this.Stop=i,this.Stopped=!0,i)},v.prototype.GetStop=function(t,e){var i=t*this.Divisions/this.Size,o=e*this.Divisions/this.Size;if(o<i){var s=i;i=o,o=s}var n=Math.floor(o);return n=n*this.Size/this.Divisions},jQuery.prototype.saFullWindowOption=function(t){this.addClass("sa-full-window-option");for(var e=0;e<this.length;++e){if(!this[e].saFullWindowOption){var i=new S($(this[e]));this[e].saFullWindowOption=i}"off"===t&&this[e].saFullWindowOption.SetFullWindow($(this[e]),!1)}return this},S.prototype.SetFullWindow=function(t,e){e?(l(t[0]),this.FullWindowOptionOffButton.show(),this.FullWindowOptionButton.hide(),this.Left=t[0].style.left,this.Width=t[0].style.width,this.Top=t[0].style.top,this.Height=t[0].style.height,this.ZIndex=t[0].style.zIndex,t.css({left:"0px",width:"100%",top:"0px",height:"100%","z-index":"10"})):(d(t[0]),this.FullWindowOptionOffButton.hide(),this.FullWindowOptionButton.show(),t.css({left:this.Left,width:this.Width,top:this.Top,height:this.Height,"z-index":this.ZIndex})),$(window).trigger("resize")},jQuery.prototype.saDeletable=function(t){this.addClass("sa-deletable");for(var e=0;e<this.length;++e){var i=this[e];i.saDeletable||(i.saDeletable=new y(i))}return this},w.prototype.StartDrag=function(){this.Dragging=!0;var t=this;this.TmpDrag=function(e){return t.ResizeDrag(e)},this.TmpStop=function(e){return t.ResizeStopDrag(e)},$("body").on("mousemove",this.TmpDrag),$("body").on("mouseup",this.TmpStop),$("body").css({cursor:"col-resize"})},w.prototype.ResizeDrag=function(t){return this.SetWidth(t.pageX-1),this.Width<200&&(this.ResizeStopDrag(),this.SetVisibility(!1)),!1},w.prototype.ResizeStopDrag=function(){return $("body").off("mousemove",this.TmpDrag),$("body").off("mouseup",this.TmpDrag),$("body").css({cursor:"auto"}),!1},w.prototype.SetWidth=function(t){this.Width=t,this.PanelDiv.css({width:this.Width+"px"}),this.MainDiv.css({left:this.Width+"px"}),this.ResizeEdge.css({left:this.Width-2+"px"}),$(window).trigger("resize")},w.prototype.AnimateNotesWindow=function(){var t=(new Date).getTime()-this.AnimationStartTime;if(t>this.AnimationDuration||this.AnimationDuration<=0)return this.SetWidth(this.AnimationTarget),this.Visibility?(this.CloseButton.show(),this.OpenButton.hide(),this.PanelDiv.fadeIn()):(this.CloseButton.hide(),this.OpenButton.show()),clearInterval(this.AnimationId),delete this.AnimationId,delete this.AnimationStartTime,delete this.AnimationDuration,void delete this.AnimationTarget;var e=t/this.AnimationDuration;this.SetWidth(this.Width+(this.AnimationTarget-this.Width)*e)},w.prototype.SetVisibility=function(t,e){if(void 0===e&&(e=1e3),this.Visibility!==t){this.Visibility=t,this.AnimationCurrent=this.Width,this.Visibility?this.AnimationTarget=353:(this.PanelDiv.hide(),this.AnimationTarget=0),this.AnimationDuration=e,this.AnimationStartTime=(new Date).getTime();var i=this;this.AnimationLastTime=(new Date).getTime(),this.AnimationId=setInterval(function(){i.AnimateNotesWindow()},10)}},w.prototype.Show=function(){this.Visibility=!0,this.ResizeEdge.show(),this.Visibility?(this.Visibility=!1,this.SetVisibility(!0)):this.OpenButton.show()},w.prototype.Hide=function(){this.Visibility=!1,this.PanelDiv.hide(),this.SetWidth(0),this.OpenButton.hide(),this.CloseButton.hide(),this.ResizeEdge.hide(),$(window).trigger("resize")},jQuery.prototype.saMenuButton=function(t){if(0===this.length)return this;var e=this[0];return e.saMenuButton||(e.saMenuButton=new C(t,this)),this},C.prototype.AddMenuItem=function(t,e){var i=this;this[t]=$("<li>").appendTo(this.InsertMenu).text(t).addClass("saButton").on("click touchstart",function(){return e(),i.InsertMenu.hide(),!1})},C.prototype.ShowInsertMenu=function(){this.InsertMenuTimer&&(clearTimeout(this.InsertMenuTimer),this.InsertMenuTimer=0),this.InsertMenu.show()},C.prototype.EventuallyHideInsertMenu=function(){this.InsertMenuTimer&&(clearTimeout(this.InsertMenuTimer),this.InsertMenuTimer=0);var t=this;this.InsertMenuTimer=setTimeout(function(){t.InsertMenuTimer=0,t.InsertMenu.fadeOut(),this.InsertMenuTimer=0},500)},jQuery.prototype.saAnnotationWidget=function(t){for(var e=0;e<this.length;++e){var i=this[e];if(!i.saViewer)return this;i.saAnnotationWidget||($(i).addClass("sa-annotation-widget"),i.saAnnotationWidget=new SA.AnnotationWidget(i.saViewer),i.saAnnotationWidget.SetVisibility(2)),"hide"===t?i.saAnnotationWidget.hide():"show"===t&&i.saAnnotationWidget.show()}return this},SA.FillDiv=function(t){t.saOnResize(function(){var e=t.parent().height()-t.position().top;t.height(e)})},SA.ResizePanel=w,SA.SAFullHeight=b,SA.SAViewer=T,SA.SAFullScreenButton=function(t){var e=!1,i="auto",o=t,s=$("<img>").appendTo(t).prop("title","full screen").addClass("sa-view-button").attr("src",SA.ImagePathUrl+"fullScreen32.png").css({position:"absolute",height:"24px","z-index":"300"}),n=s[0];return s.on("click touchend",function(n){n.preventDefault();var a=t[0];if("iPad"===SAM.MOBILE_DEVICE){if(e=!e){i=t.css("height");var r=window.innerHeight;$(a).appendTo("body"),$(a).css({"z-index":"100","background-color":"#fff",position:"fixed",left:"0",top:"0",width:"100%",height:r+"px"}),s.attr("src",SA.ImagePathUrl+"fullScreenOff32.png")}else $(a).appendTo(o).css({position:"static",height:i}),console.log(i),s.attr("src",SA.ImagePathUrl+"fullScreen32.png");$(window).trigger("resize")}else(e=!e)?(a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen).call(a):document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();$(window).trigger("resize")}),t.on("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(o){document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen?(i=t.css("height"),e=!0,s.attr("src",SA.ImagePathUrl+"fullScreenOff32.png"),t.css({height:"100%"})):($(n).show(),e=!1,s.attr("src",SA.ImagePathUrl+"fullScreen32.png"),t.css({height:i}),console.log(i)),$(window).trigger("resize")}),s},SA.AccordianDiv=function(t,e){var i=$("<div>").appendTo(t).css({display:"block"}),o=$("<img>").appendTo(i).attr("src",SA.ImagePathUrl+"plus.png"),s=$("<span>").appendTo(i).css({"padding-left":"5px"}).text(e),n=$("<div>").appendTo(t).css({display:"block","padding-left":"17px"}).hide(),a=!1;return n[0].open=function(){a=!0,n.slideDown(),o.attr("src",SA.ImagePathUrl+"minus.png"),this.openCallback&&this.openCallback()},n[0].setOpenCallback=function(t){this.openCallback=t},n[0].close=function(){a=!1,n.slideUp(),o.attr("src",SA.ImagePathUrl+"plus.png")},n[0].getOpen=function(){return a},n[0].getLabel=function(){return s},o.on("click touchstart",function(){a?n[0].close():n[0].open()}),n}}(),function(){"use strict";function t(t,e){var n=this;this.RootNote=t,this.Edit=e,this.FullScreen=!1,void 0===t.TypeData&&(t.TypeData={}),t.TypeData.Background||(t.TypeData.Background="#EEEEEE"),t.TypeData.AspectRatio||(t.TypeData.AspectRatio=1.3333),$("body").css({"overflow-x":"hidden"}),this.WindowDiv=$("<div>").appendTo("body").css({position:"fixed",left:"0px",width:"100%"}).saFullHeight(),SA.VIEW_BROWSER=new SA.ViewBrowser(this.WindowDiv),this.ResizePanel=new SA.ResizePanel(this.WindowDiv),this.PresentationDiv=this.ResizePanel.MainDiv,this.WindowDiv.on("swipeleft",function(t){if(n.ResizePanel.Visibility&&t.swipestop.coords[0]<n.ResizePanel.Width)return n.ResizePanel.SetVisibility(!1),!1;n.GotoSlide(n.Index+1)}),this.WindowDiv.on("swiperight",function(t){if(!n.ResizePanel.Visibility&&t.swipestart.coords[0]<10)return n.ResizePanel.Show(),!1;n.GotoSlide(n.Index-1)}),this.AspectDiv=$("<div>").css({border:"1px solid #AAA"}).appendTo(this.PresentationDiv).saPresentation({aspectRatio:this.RootNote.TypeData.AspectRatio}),this.LeftPanel=this.ResizePanel.PanelDiv,this.InitializeLeftPanel(this.LeftPanel),SAM.detectMobile()&&this.ResizePanel.Hide(),this.ShowButton=$("<img>").appendTo(this.PresentationDiv).prop("title","present").addClass("editButton").attr("src",SA.ImagePathUrl+"slide_show.png").css({position:"absolute",top:"2px",right:"20px",width:"20px","z-index":"5"}).click(function(){n.StartFullScreen()}),this.TimerButton=$("<img>").appendTo(this.PresentationDiv).prop("title","present timed").addClass("editButton").attr("src",SA.ImagePathUrl+"timer.png").css({position:"absolute",top:"2px",right:"46px",width:"20px","z-index":"5"}).click(function(){n.StartTimerShow()}),e&&(this.DeleteSlideButton=$("<img>").appendTo(this.AspectDiv).attr("src",SA.ImagePathUrl+"remove.png").prop("title","delete slide").addClass("editButton").css({position:"absolute",width:"12px",height:"12px",left:"0px",top:"0px","z-index":"5"}).click(function(){n.DeleteCurentSlide()})),this.TitlePage=new o(this.AspectDiv,e),this.SlidePage=new i(this.AspectDiv,e),this.HtmlPage=new s(this.AspectDiv,e,t.TypeData.Background),this.GotoSlide(0),document.oncontextmenu=SA.cancelContextMenu,$("body").on("keydown",function(t){return n.HandleKeyDown(t)}),this.UpdateSlidesTab()}function e(t){this.Modified=!1,this.UpdateTimer=null,this.ParentNote=null,this.TextEditor=$("<div>").appendTo(t).css({display:"inline-block",position:"absolute","overflow-y":"auto",padding:"5px",fontFamily:"Verdana,sans-serif",left:"2px",right:"2px",top:"20px",bottom:"2px"});var e=this;this.TextEditor.attr("contenteditable","false").bind("input",function(){e.Modified=!0,e.EventuallyUpdate()}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1,e.UpdateNote()}).mouseleave(function(){e.UpdateNote()}),this.TextEditor.change(function(){e.UpdateNote()})}function i(t,e){var i=this;if(this.FullWindowView=null,this.Edit=e,this.Note=null,this.Records=[],this.Div=$("<div>").appendTo(t).hide().addClass("sa-resize").css({position:"absolute",width:"100%",height:"100%",border:"1px solid #AAA"}),this.Div[0].onresize=function(){i.ResizeViews()},this.ViewPanel=$("<div>").appendTo(this.Div).css({background:"#FFF",position:"absolute",top:"0px",bottom:"300px",left:"0px",width:"100%",height:"auto"}),this.BottomDiv=$("<div>").appendTo(this.Div).css({position:"absolute",bottom:"0px",width:"100%",height:"300px"}),this.TitleBar=$("<div>").appendTo(this.BottomDiv).css({position:"absolute",top:"0px",height:"80px","line-height":"80px",width:"100%","padding-left":"3.3em",color:"white","font-size":"160%",background:"#444","font-family":"Arial"}),this.Title=$("<span>").appendTo(this.TitleBar).css({display:"inline-block","vertical-align":"middle","line-height":"normal"}).text("Slide: 1"),this.TextDiv=$("<div>").appendTo(this.BottomDiv).css({position:"absolute","padding-left":"2em",height:"210px",bottom:"5px",width:"100%"}),this.List=new SA.TextEditor(this.TextDiv,SA.VIEWERS),e||this.List.EditOff(),this.ViewerDiv1=$("<div>").appendTo(this.ViewPanel).css({position:"absolute","box-shadow":"10px 10px 5px #AAA"}),this.ViewerDiv1.saViewer(),this.ViewerDiv2=$("<div>").appendTo(this.ViewPanel).css({position:"absolute","box-shadow":"10px 10px 5px #AAA"}),this.ViewerDiv2.saViewer(),this.Edit){var o=this.ViewerDiv1[0].saViewer;this.AnnotationWidget1=new SA.AnnotationWidget(o.GetAnnotationLayer(),o),this.AnnotationWidget1.SetVisibility(2),o=this.ViewerDiv2[0].saViewer,this.AnnotationWidget2=new SA.AnnotationWidget(o.GetAnnotationLayer(),o),this.AnnotationWidget2.SetVisibility(2),this.ViewerDiv1[0].saViewer.OnInteraction(function(){i.RecordView1()}),this.ViewerDiv2[0].saViewer.OnInteraction(function(){i.RecordView2()}),this.RemoveView1Button=$("<img>").appendTo(this.ViewerDiv1).attr("src",SA.ImagePathUrl+"remove.png").prop("title","remove view").addClass("editButton").css({position:"absolute",right:"0px",top:"0px",width:"12px",height:"12px","z-index":"5"}).click(function(){SA.presentation.Note.ViewerRecords.splice(0,1),i.DisplayNote(i.Note,SA.presentation.Index)}),this.RemoveView2Button=$("<img>").appendTo(this.ViewerDiv2).attr("src",SA.ImagePathUrl+"remove.png").prop("title","remove view").addClass("editButton").css({position:"absolute",right:"0px",top:"0px",width:"12px",height:"12px","z-index":"5"}).click(function(){SA.presentation.Note.ViewerRecords.splice(1,1),i.DisplayNote(i.Note,SA.presentation.Index)}),this.ViewerDiv1.resizable(),this.ViewerDiv1.mouseup(function(){this.saViewer.EnableInteraction(),i.UpdateEdits(),$(window).trigger("resize")}),this.ViewerDiv1.resize(function(){this.saViewer.DisableInteraction();var t=this.saViewer.GetViewport();return t[2]=$(this).width(),t[3]=$(this).height(),this.saViewer.SetViewport(t),this.saViewer.EventuallyRender(!0),!1}),this.ViewerDiv2.resizable(),this.ViewerDiv2.mouseup(function(){this.saViewer.EnableInteraction(),i.UpdateEdits(),$(window).trigger("resize")}),this.ViewerDiv2.resize(function(){this.saViewer.DisableInteraction();var t=this.saViewer.GetViewport();return t[2]=$(this).width(),t[3]=$(this).height(),this.saViewer.SetViewport(t),this.saViewer.EventuallyRender(!0),!1})}this.FullWindowView1Button=$("<img>").appendTo(this.ViewerDiv1).attr("src",SA.ImagePathUrl+"fullscreenOn.png").prop("title","full window").css({position:"absolute",width:"12px",left:"-5px",top:"-5px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){i.SetFullWindowView(i.ViewerDiv1)}),this.FullWindowView2Button=$("<img>").appendTo(this.ViewerDiv2).attr("src",SA.ImagePathUrl+"fullscreenOn.png").prop("title","full window").css({position:"absolute",width:"12px",left:"-5px",top:"-5px",opacity:"0.5","z-index":"-1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){i.SetFullWindowView(i.ViewerDiv2)}),this.FullWindowViewOffButton=$("<img>").appendTo(this.ViewPanel).hide().attr("src",SA.ImagePathUrl+"fullscreenOff.png").prop("title","full window off").css({position:"absolute",background:"#FFF",width:"16px",left:"1px",top:"1px",opacity:"0.5","z-index":"1"}).hover(function(){$(this).css({opacity:"1.0"})},function(){$(this).css({opacity:"0.5"})}).click(function(){i.SetFullWindowView(null)})}function o(t,e){this.Edit=e,this.Note=null,this.Div=$("<div>").appendTo(t).css({background:"#FFF",position:"absolute",width:"100%",height:"100%",border:"1px solid #AAA"}),this.TopBar=$("<div>").appendTo(this.Div).css({position:"absolute",top:"0%",height:"2%",left:"13%",right:"3%",background:"#DDF1FD"}),this.Image=$("<img>").appendTo(this.Div).attr("src","https://slide-atlas.org/static/img/SlideAtlas_home.jpg").css({position:"absolute",top:"46%",height:"50%",left:"13%","box-shadow":"10px 10px 5px #888"}),this.TitleBar=$("<div>").appendTo(this.Div).css({position:"absolute",top:"18%",bottom:"58%",left:"0%",right:"3%",background:"#073E87",color:"#FFF"}),this.Title=$("<span>").appendTo(this.TitleBar).attr("contenteditable","true").css({position:"absolute",top:"1em",left:"13%"}).saScalableFont({scale:"0.3"}),this.AuthorBar=$("<div>").appendTo(this.Div).css({position:"absolute",top:"42%",bottom:"0%",left:"62%",right:"3%",background:"#E9F5FE",color:"#888","padding-left":"2em"}),this.AuthorText=$("<span>").appendTo(this.AuthorBar).attr("contenteditable","true").css({position:"absolute",top:"2em"}).saScalableFont({scale:"0.1"}),this.Edit&&(this.Title.focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}),this.AuthorText.focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}))}function s(t,e,i){this.Edit=e,this.Note=null,this.Div=$("<div>").appendTo(t).hide().css({"background-color":i,position:"absolute",width:"100%",height:"100%"})}function n(t,e){var i=this;this.UserCallback=e,this.Parent=t,this.SearchData=[],t.css({overflow:"auto","text-align":"left",color:"#303030","font-size":"18px"}),this.SearchForm=$("<form>").appendTo(t).css({width:"100%",display:"table"}).submit(function(t){return i.SearchCallback(),!1}),this.SearchLabel=$("<span>").appendTo(this.SearchForm).css({display:"table-cell",padding:"8px",width:"3.5em"}).text("Search:"),this.SearchInput=$("<input>").appendTo(this.SearchForm).css({width:"95%",display:"table-cell",border:"2px inset #CCC"}).focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}),this.SearchResults=$("<div>").appendTo(t).css({position:"absolute",top:"2em",bottom:"0px",width:"100%","overflow-y":"auto"})}function a(t,e){var i=this;this.UserCallback=e,t.css({overflow:"auto","text-align":"left",color:"#303030","font-size":"18px"}),this.ClearButton=$("<button>").appendTo(t).click(function(){i.ClipboardDeleteAll()}).text("Remove All"),this.ClipboardDiv=$("<div>").css({overflow_y:"auto"}).appendTo(t),$.ajax({type:"get",url:"webgl-viewer/getfavoriteviews",success:function(t,e){"success"===e?i.LoadClipboardCallback(t):SA.Debug("ajax failed - get favorite views 2")},error:function(){SA.Debug("AJAX - error() : getfavoriteviews 2")}})}t.prototype.StartTimerShow=function(){var t=this;SA.ContentEditableHasFocus=!0;var e=$("<div>").dialog({modal:!1,resizable:!1,position:{my:"left top",at:"left top",of:window},beforeClose:function(){SA.ContentEditableHasFocus=!1},buttons:{Start:function(){t.StartFullScreen();var e=1e3*parseInt(t.DurationInput.val());setTimeout(function(){t.TimerCallback(e)},e),$(this).dialog("destroy")}}});this.DurationLabel=$("<label>").appendTo(e).text("Seconds:"),this.DurationInput=$('<input type="number" min="1" step="1">').appendTo(e).val(30).css({width:"4em"})},t.prototype.StartFullScreen=function(){var t=document.body;this.ResizePanel.Hide(),this.EditOff(),$(window).trigger("resize"),this.ShowButton.hide(),this.TimerButton.hide(),t.requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(),this.FullScreen=!0;var e=this;$(t).bind("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(t){var i=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen;e.FullScreen=i,e.FullScreen||(e.ResizePanel.Show(),e.EditOn(),e.ShowButton.show(),e.TimerButton.show())})},t.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.SaveButton.hide(),this.InsertMenuButton.hide(),this.DeleteSlideButton.hide(),this.EditTabs.DisableTabDiv(this.BrowserDiv),this.EditTabs.DisableTabDiv(this.SearchDiv),this.EditTabs.DisableTabDiv(this.ClipboardDiv),this.TitlePage.EditOff(),this.SlidePage.EditOff(),this.HtmlPage.EditOff())},t.prototype.EditOn=function(){this.FullScreen||SA.Edit&&!this.Edit&&(this.Edit=!0,this.SaveButton.show(),this.InsertMenuButton.show(),this.DeleteSlideButton.show(),this.EditTabs.EnableTabDiv(this.BrowserDiv),this.EditTabs.EnableTabDiv(this.SearchDiv),this.EditTabs.EnableTabDiv(this.ClipboardDiv),this.TitlePage.EditOn(),this.SlidePage.EditOn(),this.HtmlPage.EditOn(),this.DeleteSlideButton.show())},t.prototype.InitializeLeftPanel=function(t){if(this.EditTabs=new SA.TabbedDiv(t),this.EditTabs.Div.css({width:"100%",height:"100%"}),this.SlidesDiv=this.EditTabs.NewTabDiv("Slides"),this.SlidesDiv.css({"text-align":"left",color:"#303030","font-size":"18px"}),this.SlideList=$("<div>").appendTo(this.SlidesDiv).css({position:"absolute",width:"100%",top:"32px",bottom:"3px","overflow-y":"auto"}),SA.Edit){this.BrowserDiv=this.EditTabs.NewTabDiv("Browse"),this.SearchDiv=this.EditTabs.NewTabDiv("Search"),this.ClipboardDiv=this.EditTabs.NewTabDiv("Clipboard");var i=this;this.SaveButton=$("<img>").appendTo(this.SlidesDiv).prop("title","save").addClass("editButton").attr("src",SA.ImagePathUrl+"save22.png").css({float:"right"}).click(function(){i.Save()}),this.InsertMenuButton=$("<div>").appendTo(this.SlidesDiv).addClass("editButton").css({float:"right",position:"relative"}).saMenuButton({"New Slide":function(){i.InsertNewSlide("HTML")},"Copy Slide":function(){i.InsertSlideCopy()},"Insert Text":function(){i.HtmlPage.InsertTextBox().css({height:"25%"})},"Insert Question":function(){i.HtmlPage.InsertQuestion()},"Insert Rectangle":function(){i.HtmlPage.InsertRectangle("#073E87","0%","60%","97.5%","14%")},"Insert Image":function(){i.InsertImage()},"Insert MP4":function(){i.InsertVideo()},"Embed Youtube":function(){i.InsertYoutube()}}),$("<img>").appendTo(this.InsertMenuButton).attr("src",SA.ImagePathUrl+"new_window.png"),this.QuizMenu=$('<select name="quiz" id="quiz">').appendTo(this.SlidesDiv).css({float:"right",margin:"3px"}).change(function(){"review"===this.value?i.RootNote.Mode="answer-show":"hidden"===this.value?i.RootNote.Mode="answer-hide":"interactive"===this.value&&(i.RootNote.Mode="answer-interactive"),i.UpdateQuestionMode()}),$("<option>").appendTo(this.QuizMenu).text("review"),$("<option>").appendTo(this.QuizMenu).text("hidden"),$("<option>").appendTo(this.QuizMenu).text("interactive"),this.QuizLabel=$("<div>").appendTo(this.SlidesDiv).css({float:"right","font-size":"small","margin-top":"4px"}).text("quiz"),"answer-hide"===this.RootNote.Mode?this.QuizMenu.val("hidden"):"answer-interactive"===this.RootNote.Mode?this.QuizMenu.val("interactive"):(this.RootNote.Mode="answer-show",this.QuizMenu.val("review")),this.BrowserPanel=new SA.BrowserPanel(this.BrowserDiv,function(t){i.AddViewCallback(t)}),this.BrowserDiv.css({"overflow-y":"auto"}),this.SearchPanel=new SA.SearchPanel(this.SearchDiv,function(t){i.AddImageCallback(t)}),this.ClipboardPanel=new SA.ClipboardPanel(this.ClipboardDiv,function(t){i.AddViewCallback(t)})}this.UserTextDiv=this.EditTabs.NewTabDiv("Notes","private notes"),this.UserNoteEditor=new e(this.UserTextDiv),this.EditTabs.ShowTabDiv(this.SlidesDiv)},e.prototype.EventuallyUpdate=function(){this.UpdateTimer&&(clearTimeout(this.UpdateTimer),this.UpdateTimer=null);var t=this;this.UpdateTimer=setTimeout(function(){t.UpdateNote()},5e3)},e.prototype.UpdateNote=function(){if(this.ParentNote&&this.ParentNote.UserNote){var t=this.ParentNote.UserNote;if(t.Text=this.TextEditor.html(),this.ParentNote.Id&&this.Modified){var e=this;t.Save(function(){e.Modified=!1})}}},e.prototype.SetNote=function(t){if(this.ParentNote!==t&&(this.UpdateNote(),this.ParentNote=null,this.TextEditor.html(""),this.TextEditor.attr("contenteditable","false").css("border",""),t))if(this.ParentNote=t,t.UserNote)this.TextEditor.html(t.UserNote.Text).attr("contenteditable","true").css({border:"2px inset #DDD"});else{if(!t.Id)return t.SetUserNote(new SA.Note),void this.TextEditor.attr("contenteditable","true").css({border:"2px inset #DDD"});var e=this;$.ajax({type:"get",url:"/webgl-viewer/getusernotes",data:{parentid:t.Id},success:function(i,o){e.LoadUserNote(i,t.Id)},error:function(){SA.Debug("AJAX - error() : getusernotes")}})}},e.prototype.LoadUserNote=function(t,e){if(this.ParentNote&&this.ParentNote.Id===e){var i=this.ParentNote;if(i.SetUserNote(new SA.Note),t.Notes&&t.Notes.length>0){t.Notes.length>1&&SA.Debug("Warning: Only showing the first user note.");var o=t.Notes[0];i.UserNote.Load(o)}this.TextEditor.html(i.UserNote.Text),this.TextEditor.attr("contenteditable","true").css({border:"2px inset #DDD"})}},t.prototype.UpdateQuestionMode=function(){if(this.RootNote){if($(".sa-question").saQuestion("SetMode",this.RootNote.Mode),"answer-hide"===this.RootNote.Mode&&0!==this.Index){var t=$(".sa-presentation-title"),e=t.clone();t.hide(),e.appendTo(t.parent()).html("#"+this.Index).addClass("sa-standin").attr("contenteditable","false").saScalableFont()}else $(".sa-standin").remove(),$(".sa-presentation-title").show();this.UpdateSlidesTab()}},t.prototype.TimerCallback=function(t){if(this.Index===this.GetNumberOfSlides()-1)return this.GotoSlide(0),void(SA.ContentEditableHasFocus=!1);this.GotoSlide(this.Index+1);var e=this.SlidePage.List.TextEntry[0];$(e).attr("contenteditable","true");var i=window.getSelection(),o=document.createRange();o.selectNodeContents(e),i.removeAllRanges(),i.addRange(o),document.execCommand("bold",!1,null),document.execCommand("bold",!1,null),this.SlidePage.AnnotationWidget1&&this.SlidePage.AnnotationWidget1.SetVisibility(!1),this.SlidePage.AnnotationWidget2&&this.SlidePage.AnnotationWidget2.SetVisibility(!1),o.collapse(!1),i.removeAllRanges(),i.addRange(o),$(e).attr("contenteditable","false");var s=this;setTimeout(function(){s.TimerCallback(t)},t)},t.prototype.AddViewCallback=function(t){if("HTML"===t.Type){var e=this.Index+1,i=new SA.Note;return i.Load(t),this.HtmlPage.UpdateEdits(),this.RootNote.Children.splice(e-1,0,i),this.GotoSlide(e),void this.UpdateSlidesTab()}if("HTML"!==this.Note.Type){var o=new SA.ViewerRecord;o.Load(t.ViewerRecords[0]),this.Note.ViewerRecords.push(o),this.SlidePage.DisplayNote(this.Note,SA.presentation.Index)}else this.HtmlPage.InsertView(t)},t.prototype.AddImageCallback=function(t){var e=new SA.ViewerRecord;if(e.OverViewBounds=t.bounds,e.Image=t,e.Camera={FocalPoint:[(t.bounds[0]+t.bounds[1])/2,(t.bounds[2]+t.bounds[3])/2,0],Roll:0,Height:t.bounds[3]-t.bounds[2],Width:t.bounds[1]-t.bounds[0]},"HTML"!==this.Note.Type){if(this.Note!==this.RootNote){var i=new SA.Note;return i.ViewerRecords[0]=e,void this.SlidePage.InsertViewNote(i)}0===this.RootNote.ViewerRecords.length&&this.RootNote.ViewerRecords.push(e)}else this.HtmlPage.InsertViewerRecord(e)},t.prototype.HandleKeyDown=function(t){return!!SA.ContentEditableHasFocus||("32"===t.keyCode||"34"===t.keyCode||"78"===t.keyCode||"39"===t.keyCode||"40"===t.keyCode||"13"===t.keyCode?(this.GotoSlide(this.Index+1),!1):"80"===t.keyCode||"37"===t.keyCode||"38"===t.keyCode||"33"===t.keyCode?(this.GotoSlide(this.Index-1),!1):"36"===t.keyCode?(this.GotoSetSlide(0),!1):"35"===t.keyCode?(this.GotoSlide(this.GetNumberOfSlides()-1),!1):void 0)},t.prototype.Save=function(){this.HtmlPage.Div.find(".sa-answer").css({color:"#000"}),this.TitlePage.UpdateEdits(),this.SlidePage.UpdateEdits(),this.HtmlPage.UpdateEdits();for(var t=0;t<SA.Notes.length;++t){var e=SA.Notes[t];"UserNote"===e.Type&&(e.LoadState||""!==e.Text)&&e.Save()}var i=this.RootNote;if(i.ViewerRecords.length<1){var o=new SA.ViewerRecord;o.Load({AnnotationVisibility:2,Annotations:[],Camera:{FocalPoint:[510,519],Height:1009,Roll:0,Width:1066},Database:"507f34a902e31010bcdb1366",Image:{TileWidth:256,TileHeight:256,_id:"55b4e5c03ed65909a84cd938",bounds:[0,1020,15,1024],components:3,database:"507f34a902e31010bcdb1366",dimensions:[1020,1009],filename:"projection-screen.jpg",label:"projection-screen.jpg",levels:3,origin:[0,0,0],spacing:[1,1,1],NumberOfLevels:3,OverViewBounds:[0,1020,15,1024]}}),i.ViewerRecords.push(o)}this.RootNote.Save();var s=!1,n=SA.Session.session.views;for(t=0;t<n.length&&!s;++t)n[t].id===this.RootNote.Id&&(s=!0);s||(n.splice(0,0,{id:this.RootNote.Id}),$.ajax({type:"post",data:{to:SA.SessionId,view:this.RootNote.Id},url:"webgl-viewer/move-view",success:function(t,e){"Success"!==e&&SA.Debug(t)},error:function(){SA.Debug("AJAX - error() : session-add-view")}}))},t.prototype.DeleteSlide=function(t){var e=this.GetNumberOfSlides()-1;t<1||t>e||(this.RootNote.Children.splice(t-1,1),this.Index>t&&(this.Index-=1),t===this.Index&&(t===e&&--t,this.Index=-1,this.GotoSlide(t)),this.UpdateSlidesTab())},t.prototype.DeleteCurentSlide=function(){this.DeleteSlide(this.Index)},t.prototype.InsertNewSlide=function(t){var e=this.Index+1,i=new SA.Note;t&&(i.Type=t),this.RootNote.Children.splice(e-1,0,i),i.Parent=this.RootNote,this.GotoSlide(e),this.UpdateSlidesTab(),"HTML"===t&&this.HtmlPage.InitializeSlidePage(),this.UpdateQuestionMode()},t.prototype.InsertSlideCopy=function(t){var e=this.Index+1,i=new SA.Note;this.HtmlPage.UpdateEdits(),i.DeepCopy(this.Note),this.RootNote.Children.splice(e-1,0,i),this.GotoSlide(e),this.UpdateSlidesTab()},t.prototype.InsertImage=function(){var t=prompt("Image URL","https://slide-atlas.org/static/img/SlideAtlas_home.jpg");this.HtmlPage.InsertImage(t)},t.prototype.InsertVideo=function(){var t=prompt("Video URL","https://slide-atlas.org/api/v2/sessions/53ac02d5a7a14110d929adcc/attachments/55fef0e6a7a14162dfb4da32");this.HtmlPage.InsertVideo(t)},t.prototype.InsertYoutube=function(){var t=prompt("Video IFrame URL",'<iframe width="420" height="315" src="https://www.youtube.com/embed/9tCafgGZtxQ" frameborder="0" allowfullscreen></iframe>');this.HtmlPage.InsertIFrame(t)},t.prototype.GotoSlide=function(t){if(!(t<0||t>=this.GetNumberOfSlides()||t===this.Index)){if(this.TitlePage.ClearNote(),this.SlidePage.ClearNote(),this.HtmlPage.ClearNote(),this.AspectDiv.show(),this.Index=t,0===t?(this.Note=this.RootNote,"Presentation"===this.Note.Type?(this.SlidePage.Div.hide(),this.HtmlPage.Div.hide(),this.TitlePage.DisplayNote(this.Note)):"HTML"===this.Note.Type&&(this.TitlePage.Div.hide(),this.SlidePage.Div.hide(),this.HtmlPage.Div.show(),this.HtmlPage.DisplayNote(this.Note),""===this.Note.Text&&this.HtmlPage.InitializeTitlePage()),this.UserNoteEditor.SetNote(this.Note)):(this.Note=this.GetSlide(t),"HTML"===this.Note.Type?(this.TitlePage.Div.hide(),this.SlidePage.Div.hide(),this.HtmlPage.Div.show(),this.HtmlPage.DisplayNote(this.Note),this.UserNoteEditor.SetNote(this.Note)):(this.TitlePage.Div.hide(),this.HtmlPage.Div.hide(),this.SlidePage.DisplayNote(this.Note,t))),t<this.RootNote.Children.length){var e=this.RootNote.Children[t];e.ViewerRecords.length>0&&e.ViewerRecords[0].LoadTiles([0,0,400,300]),e.ViewerRecords.length>1&&e.ViewerRecords[1].LoadTiles([0,0,400,300])}this.UpdateSlidesTab(),this.UpdateQuestionMode(),$(window).trigger("resize")}},t.prototype.GetNumberOfSlides=function(){return this.RootNote.Children.length+1},t.prototype.GetSlide=function(t){return t<0||t>this.RootNote.Children.length?null:0===t?this.RootNote:this.RootNote.Children[t-1]},t.prototype.SortCallback=function(){for(var t=this.SlideList.find("div"),e=[],i=0,o=0;o<t.length;++o){var s=parseInt($(t[o]).data("index"));0!==s&&e.push(this.GetSlide(s)),this.Index===s&&(i=e.length)}this.RootNote.Children=e,this.Index=i,this.UpdateSlidesTab()},t.prototype.UpdateSlidesTab=function(){var t=this;if(this.SlideList){this.SlideList.empty(),SA.Edit&&this.SlideList.sortable({update:function(e,i){t.SortCallback()},handle:".ui-icon"});for(var e=0;e<this.GetNumberOfSlides();++e){var i=this.GetSlide(e),o=i.Text,s=o.indexOf("sa-presentation-text");if(-1===s)""===(o=i.Title)&&(o="Slide "+e);else{for(s=(o=o.substring(s)).indexOf(">"),s=(o=o.substring(s+1)).indexOf("<");0===s;)s=o.indexOf(">"),s=(o=o.substring(s+1)).indexOf("<");o=o.substring(0,s),""===i.Title&&(i.Title=o)}"answer-hide"===this.RootNote.Mode&&(o="#"+e);var n=$("<div>").appendTo(this.SlideList).css({position:"relative","padding-left":"1.5em","padding-right":"1.5em",margin:"5px",color:"#29C",cursor:"pointer"}).hover(function(){$(this).css("color","blue")},function(){$(this).css("color","#29C")}).text(o).data("index",e).click(function(){SA.presentation.GotoSlide($(this).data("index"))}),a=$("<span>").appendTo(n).css({position:"absolute",left:"7px",top:"2px",opacity:"0.5"}).addClass("ui-icon ui-icon-bullet");SA.Edit&&a.addClass("sa-sort-handle"),this.Note===i&&n.css({background:"#EEE"})}}},i.prototype.SetFullWindowView=function(t){t?(SA.presentation.EditOff(),this.FullWindowViewOffButton.show(),this.FullWindowView1Button.hide(),this.FullWindowView2Button.hide(),this.BottomDiv.hide(),this.ViewPanel.css({height:"100%"})):(this.FullWindowViewOffButton.hide(),this.FullWindowView1Button.show(),this.FullWindowView2Button.show(),this.BottomDiv.show(),this.ViewPanel.css({bottom:"300px",height:"auto"}),SA.Edit&&SA.presentation.EditOn()),this.FullWindowView=t,this.ResizeViews()},i.prototype.RecordView1=function(){this.Edit&&this.Note&&this.Note.ViewerRecords.length>0&&this.Note.ViewerRecords[0]&&this.Note.ViewerRecords[0].CopyViewer(this.ViewerDiv1[0].saViewer)},i.prototype.RecordView2=function(){this.Edit&&this.Note&&this.Note.ViewerRecords.length>1&&this.Note.ViewerRecords[1]&&this.Note.ViewerRecords[1].CopyViewer(this.ViewerDiv2[0].saViewer)},i.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.Div.css({width:"100%",left:"0px"}),this.AnnotationWidget1.hide(),this.AnnotationWidget2.hide(),this.ViewerDiv1[0].saViewer.OnInteraction(),this.ViewerDiv2[0].saViewer.OnInteraction(),this.RemoveView1Button.hide(),this.RemoveView2Button.hide(),this.List.EditOff())},i.prototype.EditOn=function(){if(SA.Edit&&!this.Edit){this.Edit=!0,this.AnnotationWidget1.show(),this.AnnotationWidget2.show();var t=this;this.ViewerDiv1[0].saViewer.OnInteraction(function(){t.RecordView1()}),this.ViewerDiv2[0].saViewer.OnInteraction(function(){t.RecordView2()}),this.RemoveView1Button.show(),this.RemoveView2Button.show(),this.List.EditOn()}},i.prototype.PlaceViewer=function(t,e,i){var o=.8*i[2],s=.8*i[3],n=e.Camera,a=s/n.Height;(o=a*n.Width)>.8*i[2]&&(s=(a=(o=.8*i[2])/n.Width)*n.Height);var r=i[0]+(i[2]-o)/2,h=i[1]+(i[3]-s)/2;t&&(t[0].saViewer.SetViewport([r,h,o,s]),t[0].saViewer.EventuallyRender(!1))},i.prototype.ResizeViews=function(){var t=this.ViewPanel.width(),e=this.ViewPanel.height();if(this.FullWindowView)return this.ViewerDiv1[0].saViewer.SetViewport([0,0,0,e]),this.ViewerDiv2[0].saViewer.SetViewport([0,0,0,e]),this.FullWindowView[0].saViewer.SetViewport([0,0,t,e]),void this.FullWindowView[0].saViewer.EventuallyRender(!1);var i,o=this.Records.length;if(0===o&&(this.ViewerDiv1[0].saViewer.SetViewport([0,0,0,e]),this.ViewerDiv2[0].saViewer.SetViewport([0,0,0,e])),1===o&&(i=this.Records[0],this.PlaceViewer(this.ViewerDiv1,i,[0,0,t,e]),this.ViewerDiv2[0].saViewer.SetViewport([0,0,0,e])),o>1){var s=t/2;i=this.Records[0],this.PlaceViewer(this.ViewerDiv1,i,[0,0,s,e]),i=this.Records[1],this.PlaceViewer(this.ViewerDiv2,i,[s,0,s,e])}this.Edit&&(0===o&&(this.AnnotationWidget1.hide(),this.AnnotationWidget2.hide()),1===o&&(this.AnnotationWidget1.show(),this.AnnotationWidget2.hide()),2===o&&(this.AnnotationWidget1.show(),this.AnnotationWidget2.show()))},i.prototype.ClearNote=function(){this.Edit&&this.Note&&this.UpdateEdits(),this.Note=null},i.prototype.DisplayNote=function(t,e){this.Div.show(),this.Note=t,this.ViewerDiv1[0].saViewer.Reset(),this.ViewerDiv2[0].saViewer.Reset(),this.Records=t.ViewerRecords,this.Title.text("Slide: "+e),this.List.LoadNote(t),this.Records.length>0&&this.ViewerDiv1[0].saViewer.SetViewerRecord(this.Records[0]),this.Records.length>1&&this.ViewerDiv2[0].saViewer.SetViewerRecord(this.Records[1]),this.ViewerDiv1[0].saViewer.CopyrightWrapper.hide(),this.ViewerDiv2[0].saViewer.CopyrightWrapper.hide(),this.ResizeViews()},i.prototype.UpdateEdits=function(){this.Note&&this.Note.ViewerRecords.length>0&&this.Note.ViewerRecords[0]&&this.Note.ViewerRecords[0].CopyViewer(this.ViewerDiv1[0].saViewer),this.Note&&this.Note.ViewerRecords.length>1&&this.Note.ViewerRecords[1]&&this.Note.ViewerRecords[1].CopyViewer(this.ViewerDiv2[0].saViewer)},i.prototype.InsertViewNote=function(t){if(!(t.ViewerRecords.length<1)){var e=t.ViewerRecords[0];this.Note.ViewerRecords.push(e),1===this.Note.ViewerRecords.length?this.ViewerDiv1[0].saViewer.SetViewerRecord(this.Note.viewerRecords[0]):2===this.Note.ViewerRecords.length&&this.ViewerDiv2[0].saViewer.SetViewerRecord(this.Note.viewerRecords[1]),this.DisplayNote(this.Note,SA.presentation.Index)}},o.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.Div.css({width:"100%",left:"0px"}),this.Title.attr("readonly","readonly").attr("spellcheck","false").unbind("focusin").unbind("focusout").blur(),this.AuthorText.attr("readonly","readonly").attr("readonly","readonly").attr("spellcheck","false").unbind("focusin").unbind("focusout").blur())},o.prototype.EditOn=function(){SA.Edit&&!this.Edit&&(this.Edit=!0,this.Title.attr("contenteditable","true").attr("spellcheck","true").focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}),this.AuthorText.attr("readonly","readonly").attr("contenteditable","true").attr("spellcheck","true").focusin(function(){SA.ContentEditableHasFocus=!0}).focusout(function(){SA.ContentEditableHasFocus=!1}))},o.prototype.ClearNote=function(){this.Edit&&this.Note&&this.UpdateEdits(),this.Note=null},o.prototype.DisplayNote=function(t){this.Note=t,this.Div.show(),this.Title.html(t.HiddenTitle),this.AuthorText.html(t.Text);var e,i=window.getSelection();(e=document.createRange()).noCursor=!0,e.selectNodeContents(this.Title[0]),i.removeAllRanges(),i.addRange(e),document.execCommand("foreColor",!1,"#FFF"),document.execCommand("fontSize",!1,"6"),document.execCommand("fontName",!1,"Arial"),e.selectNodeContents(this.AuthorText[0]),i.removeAllRanges(),i.addRange(e),document.execCommand("fontSize",!1,"5"),document.execCommand("fontName",!1,"Arial"),i.removeAllRanges(),this.Title.blur(),this.AuthorText.blur()},o.prototype.UpdateEdits=function(){this.Note&&(this.Note.Text=this.AuthorText.html(),this.Note.HiddenTitle=this.Title.html())},s.prototype.EditOff=function(){SA.Edit&&this.Edit&&(this.Edit=!1,this.Div.css({width:"100%",left:"0px"}),this.SaEditOff())},s.prototype.EditOn=function(){SA.Edit&&!this.Edit&&(this.Edit=!0,this.SaEditOn())},s.prototype.SaEditOff=function(){$(".sa-edit-gui").saButtons("disable"),$(".sa-presentation-text").attr("contenteditable","false"),$(".sa-presentation-rectangle").saElement({editable:!1,interactive:!1}),$(".sa-light-box").saLightBox({editable:!1,interactive:!0})},s.prototype.SaEditOn=function(){$(".sa-edit-gui").saButtons("enable"),$(".sa-presentation-text").attr("contenteditable","true"),$(".sa-presentation-rectangle").saElement({editable:!0,interactive:!0}),$(".sa-light-box").saLightBox({editable:!0,interactive:!0})},s.prototype.ClearNote=function(){this.Edit&&this.Note&&this.UpdateEdits(),this.Note=null},s.prototype.DisplayNote=function(t){this.DefaultViewerPositions=[];for(var e=$(".sa-lightbox-viewer"),i=0;i<e.length;++i)this.DefaultViewerPositions.push({left:e[i].style.left,top:e[i].style.top,width:e[i].style.width,height:e[i].style.height});this.Note=t,this.Div.show(),this.Div.saHtml(t.Text),this.Edit?this.SaEditOn():this.SaEditOff(),SA.Edit||$(".sa-text-editor").attr("contenteditable","false");var o=this;this.Div.find(".sa-presentation-image").saLightBox({editable:SA.Edit,aspectRatio:!0}),this.Div.find(".sa-lightbox-viewer").saLightBoxViewer({editable:SA.Edit,delete:function(t){o.ViewDeleteCallback(t)}}),this.Div.find(".sa-presentation-rectangle").saRectangle({editable:SA.Edit}),$("sa-draggable").saDraggable(),this.BindElements()},s.prototype.InitializeTitlePage=function(){this.Div.empty(),this.Div[0].className="sa-presentation-title-page",this.InsertRectangle("#073E87","0%","31%","97.5%","25%"),this.InsertTextBox(50).addClass("sa-presentation-title").css({color:"white",left:"10%",width:"88%",top:"40%"}).text("Title"),this.InsertTextBox(28).css({left:"10%",width:"88%",top:"59%"}).text("Author"),this.UpdateEdits(),this.BindElements()},s.prototype.InitializeSlidePage=function(){this.Div.empty(),this.Div[0].className="sa-presentation-slide-page",this.InsertRectangle("#073E87","0%","6%","97.5%","14%"),this.InsertTextBox(42).css({color:"white",left:"18%",width:"70%",top:"7.25%",height:"11.5%"}).text("Title").addClass("sa-presentation-title"),this.UpdateEdits(),this.BindElements()},s.prototype.InsertImage=function(t){var e,i=5+Math.floor(10*Math.random()),o=20+Math.floor(10*Math.random());e=$("<div>").appendTo(this.Div).css({position:"absolute",left:i+"%",top:o+"%","z-index":"1"}).saLightBox({aspectRatio:!0,editable:SA.Edit}).addClass("sa-presentation-image");var s=$("<img>").appendTo(e).css({width:"100%",height:"100%"});return s[0].onload=function(){this.parentNode.style.width=this.width+"px",this.parentNode.style.height=this.height+"px",this.parentNode.saElement.ConvertToPercentages()},s.attr("src",t),e},s.prototype.InsertVideo=function(t){var e=$("<div>").appendTo(this.Div).css({position:"absolute",left:"10%",top:"30%","z-index":"1"}).addClass("sa-presentation-video").saDraggable().saDeletable(),i=$("<video controls>").appendTo(e);return t=$('<source type="video/mp4">').appendTo(i).attr("src",t),i[0].addEventListener("loadeddata",function(){var t=$(this).width()/$(this).height();e.saResizable({aspectRatio:t}),i.css({height:"100%",width:"100%"})},!1),e},s.prototype.InsertRectangle=function(t,e,i,o,s){$("<div>").appendTo(this.Div).css({"background-color":t,border:"1px solid rgba(255, 255, 255, 0)",position:"absolute",left:e,width:o,top:i,height:s}).saRectangle({editable:SA.Edit})},s.prototype.Paste=function(){var t=$("<div>").appendTo(this.Div).css({position:"absolute",left:"5%",top:"25%"}).text("paste here").saDraggable().saDeletable();t.attr("contenteditable","true").focus();var e=window.getSelection(),i=document.createRange();i.noCursor=!0,i.selectNodeContents(t[0]),e.removeAllRanges(),e.addRange(i),document.execCommand("paste",!1,null)},s.prototype.InsertIFrame=function(t){var e,i,o,s,n,a=t.indexOf("width");return-1!==a&&(s=(o=t.substring(a+7)).indexOf('"'),n=o.substr(0,s),e=parseInt(n)/(800*1.333),e=Math.round(100*e),e+="%",t=t.replace(n,e)),-1!==(a=t.indexOf("height"))&&(s=(o=t.substring(a+8)).indexOf('"'),n=o.substr(0,s),i=parseInt(n)/800,i=Math.round(100*i),i+="%",t=t.replace(n,i)),$(t).appendTo(this.Div).css({position:"absolute",display:"block",left:"5%",top:"5%","z-index":"1"}).saDraggable().saDeletable()},s.prototype.InsertURL=function(t){var e=$("<div>").appendTo(this.Div).css({position:"absolute",left:"5%",right:"2.5%",top:"25%",bottom:"10%","z-index":"1"}).saDraggable().saDeletable().resizable(),i=$("<iframe>").appendTo(e).css({position:"absolute",display:"block",width:"100%",height:"100%"}).attr("src",t).attr("scrolling","no").addClass("sa-presentation-iframe");return this.BindElements(),i},s.prototype.InsertTextBox=function(t){var e=(t=t||30)/800,i=$("<div>").appendTo(this.Div).css({display:"inline-block",position:"absolute",overflow:"visible",fontFamily:"Verdana,sans-serif",border:"1px solid rgba(255, 255, 255, 0)","box-sizing":"border-box",left:"5%",width:"50%",top:"30%",height:"10%",padding:"2% 1% 1% 1%","z-index":"1"}).addClass("sa-presentation-text").saScalableFont({scale:e,editable:SA.Edit}).text("Text");return this.Edit&&i.saTextEditor({dialog:!0,editable:!0}),i},s.prototype.ShuffleQuestion=function(){for(var t=this.Div.find('.sa-q [type="multiple-choice"]'),e=0;e<t.length;++e)for(var i=t[e],o=i.childNodes.length;o>0;--o){var s=Math.floor(Math.random()*o);i.appendChild(i.removeChild(i.childNodes[s]))}},s.prototype.InsertQuestion=function(){var t=$("<div>").css({position:"absolute",left:"2%",width:"92%",top:"75%",height:"22.5%",background:"#FFF",border:"1px solid #AAA",padding:"1% 1% 1% 1%","z-index":"1"}).saScalableFont({scale:"0.03"}).saQuestion({editable:SA.Edit}),e=this;t.saQuestion("OpenDialog",function(){t.appendTo(e.Div),t.trigger("resize")})},s.prototype.InsertView=function(t){if(this.Note){var e=new SA.Note,i=e.Id;e.Load(t),delete e.Id,e.Id=i,0===e.ViewerRecords.length?SA.Debug("Insert failed: Note has no viewer records."):this.Note.Parent?(this.Note.Children.push(e),e.Parent=this.Note,this.InsertView2(e)):this.InsertViewerRecord(e.ViewerRecords[0])}},s.prototype.InsertViewerRecord=function(t){if(this.Note){var e=this.Note.ViewerRecords.length;this.Note.ViewerRecords.push(t);var i={left:"5%",top:"25%",width:"40%",height:"40%"};if(this.DefaultViewerPositions.length>0)i=this.DefaultViewerPositions.splice(0,1)[0];else{var o=5*this.Div.children().length;i.left=o.toString()+"%",i.top=(o+15).toString()+"%"}var s=this;return $("<div>").appendTo(this.Div).css({position:"absolute","box-shadow":"10px 10px 5px #AAA","background-color":"#FFF",opacity:"1.0",left:i.left,width:i.width,top:i.top,height:i.height}).saLightBoxViewer({note:this.Note,viewerIndex:e,hideCopyright:!0,editable:SA.Edit,delete:function(t){s.ViewDeleteCallback(t)}})}},s.prototype.InsertView2=function(t){if(this.Note){var e={left:"5%",top:"25%",width:"45%",height:"45%"};this.DefaultViewerPositions.length>0&&(e=this.DefaultViewerPositions.splice(0,1)[0]);var i=this;return $("<div>").appendTo(this.Div).css({position:"absolute","box-shadow":"10px 10px 5px #AAA","background-color":"#FFF",opacity:"1.0",left:e.left,width:e.width,top:e.top,height:e.height}).saLightBoxViewer({note:t,dual:!0,hideCopyright:!0,delete:function(t){i.ViewDeleteCallback(t)},editable:SA.Edit})}},s.prototype.InsertViewId2=function(t){if(this.Note){var e={left:"5%",top:"25%",width:"45%",height:"45%"};return this.DefaultViewerPositions.length>0&&(e=this.DefaultViewerPositions.splice(0,1)[0]),$("<div>").appendTo(this.Div).css({position:"absolute","box-shadow":"10px 10px 5px #AAA","background-color":"#FFF",opacity:"1.0",left:e.left,width:e.width,top:e.top,height:e.height}).saLightBoxViewer({viewId:t,dual:!0,hideCopyright:!0,editable:SA.Edit})}},s.prototype.ViewDeleteCallback=function(t){if(this.DefaultViewerPositions.push({left:t.style.left,top:t.style.top,width:t.style.width,height:t.style.height}),t.saViewer.saNote!==this.Note){var e=this.Note.Children.indexOf(t.saViewer.saNote);e>=0&&this.Note.Children.splice(e,1)}},s.prototype.BindElements=function(){var t=$(".sa-presentation-iframe");t.addClass("sa-resize");for(var e=0;e<t.length;++e){var i=t[e];i.onresize=function(){var t=$(this).parent().width(),e=$(this).parent().height(),i=Math.min(e,t/1.62)/700,o=i.toString();t=Math.floor(t/i).toString(),e=Math.floor(e/i).toString(),$(this).css({"-ms-zoom":o,"-ms-transform-origin":"0 0","-moz-transform":"scale("+o+")","-moz-transform-origin":"0px 50px","-o-transform":"scale("+o+")","-o-transform-origin":"0px 50px","-webkit-transform":"scale("+o+")","-webkit-transform-origin":"0 0",width:t+"px",height:e+"px"})},i.onresize()}},s.prototype.UpdateEdits=function(){if(this.Note){this.Div.find(".sa-lightbox-viewer").saRecordViewer();for(var t=this.Div,e=this.Note,i=[],o=0;o<this.Note.ViewerRecords.length;++o){var s=this.Note.ViewerRecords[o],n=o.toString(),a=$("[sa-viewer-index="+n+"]");a.length>0&&(a.attr("sa-viewer-index",i.length),i.push(s))}this.Note.ViewerRecords=i,e.Text=t.saHtml()}},n.prototype.SearchCallback=function(){var t=this,e=this.SearchInput.val();this.Parent.css({cursor:"progress"}),$.ajax({type:"get",url:"/webgl-viewer/query",data:{terms:e},success:function(e,i){t.LoadSearchResults(e),t.Parent.css({cursor:"default"})},error:function(){SA.Debug("AJAX - error() : query"),t.Parent.css({cursor:"default"})}})},n.prototype.LoadSearchResults=function(t){var e=this;this.SearchResults.empty(),this.SearchData=t.images;for(var i=0;i<t.images.length;++i){var o=t.images[i],s=$("<div>").appendTo(this.SearchResults).css({float:"left",margin:"5px",border:"1px solid #AAA"}).attr("id",o._id).data("index",i).hover(function(){$(this).css({"border-color":"#00F"})},function(){$(this).css({"border-color":"#AAA"})}).click(function(){e.SelectCallback($(this).data("index"))}),n={img:o._id,db:o.database,levels:o.levels,tile_width:o.TileWidth,tile_height:o.TileHeight,bounds:o.bounds,label:o.label};n.bounds||(n.bounds=[0,o.dimensions[0],0,o.dimensions[1]]),new SA.CutoutThumb(n,100).Div.appendTo(s),$("<div>").css({"font-size":"50%"}).appendTo(s).text(o.label)}},n.prototype.SelectCallback=function(t){this.UserCallback&&t>=0&&t<this.SearchData.length&&this.UserCallback(this.SearchData[t])},a.prototype.LoadClipboardCallback=function(t){var e=this;this.ClipboardDiv.empty(),this.ClipboardViews=t.viewArray;for(var i=0;i<this.ClipboardViews.length;++i){var o=this.ClipboardViews[i];"http:/"===o.Thumb.substring(0,6)&&(o.Thumb=o.Thumb.substring(6)),$("<img>").appendTo(this.ClipboardDiv).attr("src",o.Thumb).prop("title",o.Title).css({float:"left",margin:"5px",border:"1px solid #AAA",height:"60px"}).attr("index",i).hover(function(){$(this).css({"border-color":"#00F"})},function(){$(this).css({"border-color":"#AAA"})}).click(function(){e.ClickViewCallback(parseInt(this.getAttribute("index")))})}},a.prototype.ClickViewCallback=function(t){this.UserCallback&&t>=0&&t<this.ClipboardViews.length&&this.UserCallback(this.ClipboardViews[t])},a.prototype.ClipboardDeleteAll=function(){this.ClipboardDiv.empty();for(var t=0;t<this.ClipboardViews.length;++t)$.ajax({type:"post",url:"/webgl-viewer/deleteusernote",data:{noteId:this.ClipboardViews[t]._id,col:"views"},success:function(t,e){},error:function(){SA.Debug("AJAX - error() : deleteusernote")}})},SA.SearchPanel=n,SA.ClipboardPanel=a,SA.Presentation=t}(),function(){"use strict";SA.TileLoader="http",SA.LoadQueue=[],SA.LoadingCount=0,SA.LoadingMaximum=10,SA.LoadTimeoutId=0,SA.TimeStamp=0,SA.NumberOfTiles=0,SA.NumberOfTextures=0,SA.MaximumNumberOfTiles=3e3,SA.MaximumNumberOfTextures=5e3,SA.PruneTimeTiles=0,SA.PruneTimeTextures=0,SA.MOBILE_DEVICE&&(SA.MaximumNumberOfTiles=5e3),SA.LoadProgressMax=0,SA.ProgressBar=null,SA.FinishedLoadingCallbacks=[],SA.InitProgressBar=function(){SA.ProgressBar||(SA.ProgressBar=$("<div>").appendTo("body").addClass("sa-view-progress-bar"))},SA.AdvanceTimeStamp=function(){++SA.TimeStamp},SA.GetCurrentTime=function(){return SA.TimeStamp},SA.Prune=function(){var t=!1;if(SA.NumberOfTiles>=SA.MaximumNumberOfTiles&&(SA.PruneTimeTiles>SA.TimeStamp&&(SA.PruneTimeTiles=0),SA.PruneTimeTiles+=.05*(SA.TimeStamp-SA.PruneTimeTiles),t=!0),SA.NumberOfTextures>=SA.MaximumNumberOfTextures&&(SA.PruneTimeTextures>SA.TimeStamp&&(SA.PruneTimeTextures=0),SA.PruneTimeTextures+=.05*(SA.TimeStamp-SA.PruneTimeTextures),t=!0),t){console.log("prune !!!!!!");for(var e in SA.Caches)SA.Caches[e].PruneTiles()}},SA.ClearQueue=function(){for(var t=0;t<SA.LoadQueue.length;++t){var e=SA.LoadQueue[t];e&&(e.LoadState=0)}SA.LoadQueue=[],SA.LoadQueueUpdate()},SA.LoadQueueAddTile=function(t){0!==t.LoadState&&4!==t.LoadState||(t.LoadState=1,SA.LoadQueue.push(t))};var t=function(){for(var t=SA.LoadQueue[0],e=1;e<SA.LoadQueue.length;++e){var i=SA.LoadQueue[e],o=!1;null!==i&&(null===t?o=!0:t.TimeStamp>i.TimeStamp?o=!0:t.TimeStamp===i.TimeStamp&&t.Level<i.Level&&(o=!0)),o?(SA.LoadQueue[e]=t,SA.LoadQueue[e-1]=i):t=i}};SA.LoadQueueRemove=function(t){for(var e=SA.LoadQueue.length,i=0;i<e;++i)if(SA.LoadQueue[i]===t)return t.LoadState=0,void(SA.LoadQueue[i]=null)};var e=function(){SA.LoadingCount=0,SA.LoadQueueUpdate()};SA.LoadQueueUpdate=function(){for(SA.LoadingCount<0&&(SA.LoadingCount=0);SA.LoadingCount<SA.LoadingMaximum&&SA.LoadQueue.length>0;){t();var i=SA.LoadQueue.pop();null!==i&&1===i.LoadState&&(i.StartLoad(i.Cache),i.LoadState=2,++SA.LoadingCount)}if(SA.LoadTimeoutId&&(clearTimeout(SA.LoadTimeoutId),SA.LoadTimeoutId=0),SA.LoadingCount&&(SA.LoadTimeoutId=setTimeout(function(){e()},1e3)),SA.ProgressBar){SA.LoadProgressMax<SA.LoadQueue.length&&(SA.LoadProgressMax=SA.LoadQueue.length);var o=(100*SA.LoadQueue.length/SA.LoadProgressMax).toFixed();o+="%",SA.ProgressBar.css({width:o}),0===SA.LoadQueue.length&&(SA.LoadProgressMax=0)}if(SA.FinishedLoadingCallbacks.length>0&&0===SA.LoadQueue.length&&0===SA.LoadingCount){var s=SA.FinishedLoadingCallbacks.slice(0);SA.FinishedLoadingCallbacks=[];for(var n=0;n<s.length;++n)s[n]()}},SA.AddFinishedLoadingCallback=function(t){SA.FinishedLoadingCallbacks.push(t),SA.LoadQueueUpdate()},SA.ClearFinishedLoadingCallbacks=function(){SA.FinishedLoadingCallbacks=[]},SA.LoadQueueLoaded=function(t){--SA.LoadingCount,t.LoadState=3,t.Cache.LoadTileCallback&&(t.Cache.LoadTileCallback(),t.Cache.LoadTileCallback=void 0),SA.LoadQueueUpdate()},SA.LoadQueueError=function(t){t.LoadState=4,--SA.LoadingCount,SA.LoadQueueUpdate()}}(),window.SAM=window.SAM||{},function(){"use strict";function t(){this.WorldToImageTransform=[1,0,0,1,0,0],this.ZRange=[-1,1],this.WorldRoll=0,this.WorldMatrix=mat4.create(),this.ImageMatrix=mat4.create(),this.Height=16e3,this.Width=1.62*this.Height,this.WorldFocalPoint=[8192,8192],this.ComputeMatrix(),this.Points=[],this.Buffer=null,this.CreateBuffer(),this.Mirror=!1,this.RollStopFlag=!1,this.RollStopCounter=0,this.ViewportWidth=162,this.ViewportHeight=100}t.prototype.GetImageToViewerTransform=function(){var t=[1,0,0,-1,0,this.ViewportHeight],e=[.5*this.ViewportWidth,0,0,.5*this.ViewportHeight,.5*this.ViewportWidth,.5*this.ViewportHeight],i=this.GetImageMatrix(),o=1/i[15],s=[i[0]*o,i[1]*o,i[4]*o,i[5]*o,i[12]*o,i[13]*o],n=SAM.MultiplyTransforms(t,e);return n=SAM.MultiplyTransforms(n,s)},t.prototype.SetWorldToImageTransform=function(t){this.WorldToImageTransform=t,this.ComputeMatrix()},t.prototype.GetViewportHeight=function(){return this.ViewportHeight},t.prototype.GetViewportWidth=function(){return this.ViewportWidth},t.prototype.GetSpacing=function(){return this.GetHeight()/this.ViewportHeight},t.prototype.WorldCopy=function(t){t.ZRange&&(this.ZRange=t.ZRange.slice(0)),this.WorldRoll=t.WorldRoll,this.Height=t.Height,this.Width=t.Width,this.SetWorldFocalPoint(t.WorldFocalPoint),t.ViewportWidth&&(this.ViewportWidth=t.ViewportWidth),t.ViewportHeight&&(this.ViewportHeight=t.ViewportHeight),this.ComputeMatrix()},t.prototype.DeepCopy=function(t){this.WorldToImageTransform=t.WorldToImageTransform.slice(0),this.WorldCopy(t)},t.prototype.SetViewport=function(t){10*t[3]<t[2]||(this.ViewportWidth=t[2],this.ViewportHeight=t[3],this.Width=this.Height*this.ViewportWidth/this.ViewportHeight,this.ComputeMatrix())},t.prototype.Serialize=function(){var t={};return t.WorldFocalPoint=[this.WorldFocalPoint[0],this.WorldFocalPoint[1]],t.WorldRoll=this.WorldRoll,t.Height=this.GetHeight(),t.Width=this.GetWidth(),t},t.prototype.Load=function(t){this.SetWorldFocalPoint(t.FocalPoint),this.WorldRoll=t.Roll,this.Height=t.Height,t.Width?this.Width=t.Width:this.Width=this.Height*this.ViewportWidth/this.ViewportHeight,this.ComputeMatrix()},t.prototype.GetWorldRotation=function(){return 180*this.WorldRoll/3.1415926535},t.prototype.GetImageRotation=function(){return 180*this.GetImageRoll()/3.1415926535},t.prototype.GetWorldRoll=function(){return this.WorldRoll},t.prototype.GetImageRoll=function(){var t=Math.cos(this.WorldRoll),e=Math.sin(this.WorldRoll),i=this.WorldToImageTransform,o=i[0]*t+i[2]*e,s=i[1]*t+i[3]*e,n=Math.sqrt(o*o+s*s);return o/=n,s/=n,Math.atan2(s,o)},t.prototype.GetWorldFocalPoint=function(){return[this.WorldFocalPoint[0],this.WorldFocalPoint[1]]},t.prototype.GetImageFocalPoint=function(){return SAM.ApplyTransform(this.WorldToImageTransform,this.WorldFocalPoint)},t.prototype.SetWorldFocalPoint=function(t){isNaN(t[0])||isNaN(t[1])||(this.WorldFocalPoint[0]=t[0],this.WorldFocalPoint[1]=t[1])},t.prototype.ConvertPointViewerToImage=function(t,e){var i=this.ImageMatrix;t/=this.ViewportWidth,e/=this.ViewportHeight,t=(2*t-1)*i[15],e=(1-2*e)*i[15];var o=i[0]*i[5]-i[1]*i[4];return[(t*i[5]-e*i[4]+i[4]*i[13]-i[5]*i[12])/o,(e*i[0]-t*i[1]-i[0]*i[13]+i[1]*i[12])/o]},t.prototype.ConvertPointViewerToWorld=function(t,e){var i=this.WorldMatrix;t/=this.ViewportWidth,e/=this.ViewportHeight,t=(2*t-1)*i[15],e=(1-2*e)*i[15];var o=i[0]*i[5]-i[1]*i[4];return[(t*i[5]-e*i[4]+i[4]*i[13]-i[5]*i[12])/o,(e*i[0]-t*i[1]-i[0]*i[13]+i[1]*i[12])/o]},t.prototype.ConvertPointWorldToViewer=function(t,e){var i=this.WorldMatrix,o=t*i[3]+e*i[7]+i[15],s=(t*i[0]+e*i[4]+i[12])/o,n=(t*i[1]+e*i[5]+i[13])/o;return s=.5*(1+s)*this.ViewportWidth,n=.5*(1-n)*this.ViewportHeight,[s,n]},t.prototype.ConvertScaleViewerToImage=function(t){return 2*t*this.ImageMatrix[15]/this.ViewportWidth},t.prototype.ConvertScaleWorldToViewer=function(t){var e=this.WorldMatrix;return t*this.ViewportWidth/(2*e[15])},t.prototype.HandleTranslate=function(t,e){var i=Math.sin(this.WorldRoll),o=Math.cos(this.WorldRoll),s=this.GetWidth();this.Mirror&&(e=-e);var n=(t*=s)*o+(e*=s)*i,a=e*o-t*i;this.Translate(n,a,0)},t.prototype.HandleRoll=function(t,e,i,o){if(0!==t||0!==e){var s=-e*i+t*o;s/=t*t+e*e,this.Mirror&&(s=-s),this.IncrementRollWithStops(s)}},t.prototype.IncrementRollWithStops=function(t){var e=this.WorldRoll+t,i=.5*Math.PI,o=i/9,s=(Math.floor(this.WorldRoll/i)%4+4)%4,n=(Math.floor(e/i)%4+4)%4;if(!this.RollStopFlag&&s!==n){var a=0;Math.abs(s-n)<2&&(a=((s+n)/2+.5)*i),this.RollStopFlag=!0,t-=this.WorldRoll-a;for(var r=2*Math.PI;t>Math.PI;)t-=r;for(;t<-Math.PI;)t+=r;this.WorldRoll=a,this.RollStopCounter=t>0?0:o,t=0}this.RollStopFlag&&(this.RollStopCounter+=t,console.log("roll stop counter: "+this.RollStopCounter),t=0,this.RollStopCounter<0&&(this.RollStopFlag=!1,t=this.RollStopCounter),this.RollStopCounter>o&&(this.RollStopFlag=!1,t=this.RollStopCounter-o)),this.WorldRoll+=t,this.ComputeMatrix()},t.prototype.Translate=function(t,e,i){isNaN(t)||isNaN(e)||isNaN(i)||(this.WorldFocalPoint[0]+=t,this.WorldFocalPoint[1]+=e,this.ComputeMatrix())},t.prototype.GetHeight=function(){return this.Height},t.prototype.SetHeight=function(t){isNaN(t)||(this.Height=t,this.Width=t*this.ViewportWidth/this.ViewportHeight)},t.prototype.GetWidth=function(){return this.Width},t.prototype.SetWidth=function(t){isNaN(t)||(this.Width=t,this.Height=t*this.ViewportHeight/this.ViewportWidth)},t.prototype.SetWorldRoll=function(t){this.WorldRoll=t},t.prototype.GetImageBounds=function(){var t=this.ViewportWidth,e=this.ViewportHeight,i=this.ConvertPointViewerToImage(0,0),o=[i[0],i[0],i[1],i[1]];return i=this.ConvertPointViewerToImage(t,e),o[0]=Math.min(o[0],i[0]),o[1]=Math.max(o[1],i[0]),o[2]=Math.min(o[2],i[1]),o[3]=Math.max(o[3],i[1]),o},t.prototype.GetWorldMatrix=function(){return this.WorldMatrix},t.prototype.GetImageMatrix=function(){return this.ImageMatrix},t.prototype.ComputeMatrix=function(){var t=this.GetWorldFocalPoint(),e=this.GetWorldRoll(),i=Math.sin(e),o=Math.cos(e),s=t[0],n=t[1],a=this.GetWidth(),r=this.Height;if(!(a<0)){this.Mirror&&(r=-r),mat4.identity(this.WorldMatrix),this.WorldMatrix[0]=o,this.WorldMatrix[1]=-i*a/r,this.WorldMatrix[4]=-i,this.WorldMatrix[5]=-o*a/r,this.WorldMatrix[9]=0,this.WorldMatrix[10]=.5*(this.ZRange[1]-this.ZRange[0]),this.WorldMatrix[12]=-o*s+i*n,this.WorldMatrix[13]=-a/r*(-i*s-o*n),this.WorldMatrix[14]=.25*(this.ZRange[1]+this.ZRange[0])*a-10,this.WorldMatrix[15]=.5*a;var h=SAM.InvertTransform(this.WorldToImageTransform);mat4.identity(this.ImageMatrix),this.ImageMatrix[0]=this.WorldMatrix[0],this.ImageMatrix[1]=this.WorldMatrix[1],this.ImageMatrix[4]=this.WorldMatrix[4],this.ImageMatrix[5]=this.WorldMatrix[5],this.ImageMatrix[9]=this.WorldMatrix[9],this.ImageMatrix[10]=this.WorldMatrix[10],this.ImageMatrix[12]=this.WorldMatrix[12],this.ImageMatrix[13]=this.WorldMatrix[13],this.ImageMatrix[14]=this.WorldMatrix[14],this.ImageMatrix[15]=this.WorldMatrix[15];var l=this.ImageMatrix[0],d=this.ImageMatrix[1],u=this.ImageMatrix[4],p=this.ImageMatrix[5];this.ImageMatrix[0]=l*h[0]+u*h[1],this.ImageMatrix[1]=d*h[0]+p*h[1],this.ImageMatrix[4]=l*h[2]+u*h[3],this.ImageMatrix[5]=d*h[2]+p*h[3],this.ImageMatrix[12]+=l*h[4]+u*h[5],this.ImageMatrix[13]+=d*h[4]+p*h[5]}},t.prototype.DisplayToWorld=function(t,e,i){var o=this.Height/this.ViewportHeight;t-=.5*this.ViewportWidth,e-=.5*this.ViewportHeight;var s=[];return s[0]=this.WorldFocalPoint[0]+t*o,s[1]=this.WorldFocalPoint[1]+e*o,s[2]=10+i*this.Height*.5,s},t.prototype.AddPoint=function(t,e,i){this.Points.push(t),this.Points.push(e),this.Points.push(i)},t.prototype.CreateBuffer=function(t){t&&(null!==this.Buffer&&t.deleteBuffer(this.Buffer),this.Buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.Buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.Points),t.STATIC_DRAW))},t.prototype.UpdateBuffer=function(){this.Points=[];var t=this.WorldFocalPoint[0],e=this.WorldFocalPoint[1],i=.5*this.GetWidth(),o=.5*this.GetHeight();this.AddPoint(t-i,e-o),this.AddPoint(t+i,e-o),this.AddPoint(t+i,e+o),this.AddPoint(t-i,e+o),this.AddPoint(t-i,e-o),this.CreateBuffer()},t.prototype.Draw=function(t,e){var i=t.Camera,o=t.Viewport,s=this.GetWorldFocalPoint(),n=.5*this.GetWidth(),a=.5*this.GetHeight(),r=(s[0]*i.WorldMatrix[0]+s[1]*i.WorldMatrix[4]+i.WorldMatrix[12])/i.WorldMatrix[15],h=(s[0]*i.WorldMatrix[1]+s[1]*i.WorldMatrix[5]+i.WorldMatrix[13])/i.WorldMatrix[15];if(e);else{r=(1+r)*o[2]*.5,h=(1-h)*o[3]*.5,n=n*o[3]/i.GetHeight(),a=a*o[3]/i.GetHeight();var l=t.Context2d;l.save();var d=Math.cos(this.WorldRoll),u=Math.sin(this.WorldRoll);l.setTransform(d,-u,+u,d,(1-d)*r-u*h,(1-d)*h+u*r),l.strokeStyle="#4011E5",l.beginPath(),l.rect(r-n,h-a,2*n,2*a),l.stroke(),l.restore()}},SAM.Camera=t,SAM.ApplyTransform=function(t,e){return[t[0]*e[0]+t[2]*e[1]+t[4],t[1]*e[0]+t[3]*e[1]+t[5]]},SAM.TransformBounds=function(t,e){var i,o;return i=SAM.ApplyTransform(t,[e[0],e[2]]),o=[i[0],i[0],i[1],i[1]],i=SAM.ApplyTransform(t,[e[1],e[2]]),o[0]=Math.min(o[0],i[0]),o[1]=Math.max(o[1],i[0]),o[2]=Math.min(o[2],i[1]),o[3]=Math.max(o[3],i[1]),i=SAM.ApplyTransform(t,[e[0],e[3]]),o[0]=Math.min(o[0],i[0]),o[1]=Math.max(o[1],i[0]),o[2]=Math.min(o[2],i[1]),o[3]=Math.max(o[3],i[1]),i=SAM.ApplyTransform(t,[e[1],e[3]]),o[0]=Math.min(o[0],i[0]),o[1]=Math.max(o[1],i[0]),o[2]=Math.min(o[2],i[1]),o[3]=Math.max(o[3],i[1]),o},SAM.MultiplyTransforms=function(t,e){return[t[0]*e[0]+t[2]*e[1],t[1]*e[0]+t[3]*e[1],t[0]*e[2]+t[2]*e[3],t[1]*e[2]+t[3]*e[3],t[0]*e[4]+t[2]*e[5]+t[4],t[1]*e[4]+t[3]*e[5]+t[5]]},SAM.InvertTransform=function(t){var e=t[0]*t[3]-t[1]*t[2],i=t[2]*t[5]-t[3]*t[4],o=t[0]*t[5]-t[1]*t[4];return[t[3]/e,-t[1]/e,-t[2]/e,t[0]/e,i/e,-o/e]}}(),function(){"use strict";SA.DownloadImageData=function(t,e){var i=t.width,o=t.height,s=[0,0,i,o],n=new SA.TileView;n.InitializeViewport(s,1,!0),n.Canvas.attr("width",i),n.Canvas.attr("height",o),n.Context2d.putImageData(t,0,0),n.Canvas[0].toBlob(function(t){saveAs(t,e)},"image/png")},SA.GetCutoutImage=function(t,e,i,o,s,n,a){var r=e[0],h=e[1],l=[0,0,r,h],d=new SA.TileView;d.SetCache(t),d.SetViewport(l);var u=d.Camera;u.SetWorldFocalPoint(i),u.SetWorldRoll(s),u.SetHeight(h*o),u.ComputeMatrix();for(var p=t.ChooseTiles(u,0,[]),c=0;c<p.length;++c)SA.LoadQueueAddTile(p[c]);SA.AddFinishedLoadingCallback(function(){SA.GetCutoutImage2(d,n,a)}),SA.LoadQueueUpdate(),console.log("trigger "+SA.LoadQueue.length+" "+SA.LoadingCount)},SA.GetCutoutImage2=function(t,e,i){t.DrawTiles(),e&&""!==e&&t.Canvas[0].toBlob(function(t){saveAs(t,e)},"image/png"),i&&i(t.GetImageData())};var t=function(t,e,i){i||(i=t.bounds),this.ImageData=t,this.Height=e,this.Width=Math.ceil(e*(i[1]-i[0])/(i[3]-i[2])),this.Div=$("<div>").css({width:this.Width+"px",height:this.Height+"px"}).addClass("sa-view-cutout-thumb-div");var o;o=t.bounds?[Math.max(i[0],t.bounds[0]),Math.min(i[1],t.bounds[1]),Math.max(i[2],t.bounds[2]),Math.min(i[3],t.bounds[3])]:[Math.max(i[0],0),i[1],Math.max(i[2],0),i[3]];var s=256;for(t.tile_size&&(s=t.tile_size),this.Level=0;o[3]-o[2]>this.Height&&this.Level<t.levels-1;)this.Level+=1,o[0]*=.5,o[1]*=.5,o[2]*=.5,o[3]*=.5;s=256,t.tile_size&&(s=t.tile_size),this.ScreenPixelSpacing=(i[3]-i[2])/this.Height;var n=(s<<this.Level)/this.ScreenPixelSpacing;this.GridReq=[Math.floor(o[0]/s),Math.floor(o[1]/s),Math.floor(o[2]/s),Math.floor(o[3]/s)],this.ScreenPixelOrigin=[this.GridReq[0]*(s<<this.Level),this.GridReq[2]*(s<<this.Level)];for(var a=this.GridReq[2];a<=this.GridReq[3];++a)for(var r=this.GridReq[0];r<=this.GridReq[1];++r){for(var h=r,l=a,d=this.Level,u="";d<t.levels-1;)0==(1&h)&&0==(1&l)&&(u="q"+u),1==(1&h)&&0==(1&l)&&(u="r"+u),0==(1&h)&&1==(1&l)&&(u="t"+u),1==(1&h)&&1==(1&l)&&(u="s"+u),h>>=1,l>>=1,++d;var p=((r<<this.Level)*s-i[0])/this.ScreenPixelSpacing,c=((a<<this.Level)*s-i[2])/this.ScreenPixelSpacing;$("<img>").appendTo(this.Div).attr("width",n).attr("height",n).attr("src","/tile?img="+t.img+"&db="+t.db+"&name=t"+u+".jpg").attr("alt",t.label).css({left:p.toString()+"px",top:c.toString()+"px"}).addClass("sa-view-cutout-thumb-tile")}};t.prototype.AppendTo=function(t){return this.Div.appendTo(t),this},t.prototype.Click=function(t){var e=this;return this.ClickCallback=t,this.Div.click(function(t){var i=t.pageX,o=t.pageY,s=e.Div.offset();i-=s.left,o-=s.top,console.log("click: "+i+", "+o),e.SlideX=i*e.ScreenPixelSpacing+e.ScreenPixelOrigin[0],e.SlideY=o*e.ScreenPixelSpacing+e.ScreenPixelOrigin[1],e.ClickCallback(e)}),this},SA.CutoutThumb=t}(),window.SA=window.SA||{},function(){"use strict";function t(t,e){this.Tile=t,this.Cache=e}function e(){this.tiles=[]}function i(t){return function(){t.HandleLoadedImage()}}function o(t){return function(){t.HandleErrorImage()}}function s(t,e,i,o,s,n){if(this.Cache=n,this.X=t,this.Y=e,this.Z=i,this.Level=o,this.Children=[null,null,null,null],this.Parent=null,this.LoadState=0,this.Name=s,this.Texture=null,this.TimeStamp=SA.TimeStamp,this.BranchTimeStamp=SA.TimeStamp,this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.Matrix[14]=i*n.RootSpacing[2]-.1*this.Level,!n.Warp){var a=n.TileDimensions[0]*n.RootSpacing[0]/(1<<this.Level),r=n.TileDimensions[1]*n.RootSpacing[1]/(1<<this.Level);this.Matrix[0]=a,this.Matrix[5]=-r,this.Matrix[12]=this.X*a,this.Matrix[13]=(this.Y+1)*r,this.Matrix[15]=1;var h=n.Image.bounds.slice(0),l=n.RootSpacing[0]/(1<<this.Level),d=n.RootSpacing[1]/(1<<this.Level),u=this.X*n.TileDimensions[0],p=this.Y*n.TileDimensions[1];h[0]=h[0]/l-u,h[1]=h[1]/l-u,h[2]=h[2]/d-p,h[3]=h[3]/d-p,(h[0]>0||h[1]<n.TileDimensions[0]||h[1]>0||h[3]<n.TileDimensions[1])&&(this.Crop=[],this.Crop[0]=Math.max(h[0],0),this.Crop[1]=Math.max(h[2],0),this.Crop[2]=Math.min(h[1],n.TileDimensions[0])-this.Crop[0],this.Crop[3]=Math.min(h[3],n.TileDimensions[1])-this.Crop[1])}++SA.NumberOfTiles}t.prototype.HandleLoadedImage=function(){var t=(new Date).getTime();n.add({name:this.Tile.Name,loadtime:t-this.Tile.starttime}),SA.LoadQueueLoaded(this.Tile)},t.prototype.HandleErrorImage=function(){console.log("LoadTile error "+this.Tile.Name),SA.LoadQueueError(this.Tile)},e.prototype.add=function(t){this.tiles.push(t)},e.prototype.report=function(){for(var t=0,e=0;e<this.tiles.length;e++)t+=this.tiles[e].loadtime;var i={};i.count=this.tiles.length,i.average=t/this.tiles.length,i.total=t,console.log(i)};var n=new e;s.prototype.destructor=function(t){--SA.NumberOfTiles,t&&this.DeleteTexture(t),delete this.Matrix,this.Matrix=null,this.Image&&(delete this.Image,this.Image=0);for(var e=0;e<4;++e)null!==this.Children[e]&&(this.Children[e].delete(t),this.Children[e]=null);delete this.Children,delete this.Parent,delete this.Cache},s.prototype.LoadQueueAdd=function(){for(var t=this;t&&t.TimeStamp!==SA.TimeStamp;)t.TimeStamp=SA.TimeStamp,t=t.Parent;if(0===this.LoadState){if(this.Parent){if(0===this.Parent.LoadState)return this.Parent.LoadQueueAdd();if(1===this.Parent.LoadState)return}SA.LoadQueueAddTile(this)}},s.prototype.CreateWarpBuffer=function(t,e){var i=this.Cache.TileDimensions,o=this.Cache.RootSpacing,s=1<<this.Level,n=[o[0]*i[0]/s,o[1]*i[1]/s],a=[n[0]*this.X,n[0]*(this.X+1),n[1]*this.Y,n[1]*(this.Y+1),this.Level,this.Level],r=[],h=[],l=[];t.CreateMeshFromBounds(a,r,h,l),this.VertexTextureCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.VertexTextureCoordBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(h),e.STATIC_DRAW),this.VertexTextureCoordBuffer.itemSize=2,this.VertexTextureCoordBuffer.numItems=h.length/2,this.VertexPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.VertexPositionBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW),this.VertexPositionBuffer.itemSize=3,this.VertexPositionBuffer.numItems=r.length/3,this.CellBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.CellBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),e.STATIC_DRAW),this.CellBuffer.itemSize=1,this.CellBuffer.numItems=l.length},s.prototype.StartLoad=function(e){if(!(this.LoadState>=2)){this.Image=new Image,this.starttime=(new Date).getTime();var s=new t(this,e);this.Image.onload=i(s),this.Image.onerror=o(s),this.LoadHttp(e)}},s.prototype.LoadHttp=function(t){if(t.TileSource)return this.Name=t.TileSource.getTileUrl(this.Level,this.X,this.Y,this.Z),void(this.Image.src=this.Name);var e;if(e=t.Image.type&&"stack"===t.Image.type?t.GetSource()+this.Name+".png":t.GetSource()+this.Name+".jpg",t.UseIIP){var i=this.Level+2,o=Math.ceil(t.Image.dimensions[0]/(t.Image.TileWidth<<t.Image.levels-this.Level-1)),s=this.Y*o+this.X;e="http://iip.slide-atlas.org/iipsrv.fcgi?FIF="+t.Image.filename+"&jtl="+i+","+s}this.Image.src=e},s.prototype.Draw=function(t,e){if(3===this.LoadState)if(e.gl)null===this.Texture&&this.CreateTexture(e.gl),e.gl.bindBuffer(e.gl.ARRAY_BUFFER,e.tileVertexPositionBuffer),e.gl.vertexAttribPointer(e.ShaderProgram.vertexPositionAttribute,e.tileVertexPositionBuffer.itemSize,e.gl.FLOAT,!1,0,0),e.gl.bindBuffer(e.gl.ARRAY_BUFFER,e.tileVertexTextureCoordBuffer),e.gl.vertexAttribPointer(e.ShaderProgram.textureCoordAttribute,e.tileVertexTextureCoordBuffer.itemSize,e.gl.FLOAT,!1,0,0),e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,e.tileCellBuffer),e.gl.activeTexture(e.gl.TEXTURE0),e.gl.bindTexture(e.gl.TEXTURE_2D,this.Texture),e.gl.uniform1i(t.samplerUniform,0),e.gl.uniformMatrix4fv(t.mvMatrixUniform,!1,this.Matrix),e.gl.drawElements(e.gl.TRIANGLES,e.tileCellBuffer.numItems,e.gl.UNSIGNED_SHORT,0);else{e.Context2d.save(),e.Context2d.transform(this.Matrix[0],this.Matrix[1],this.Matrix[4],this.Matrix[5],this.Matrix[12],this.Matrix[13]),e.Context2d.transform(1,0,0,-1,0,1);var i=this.Cache.Image.TileWidth;void 0===i&&(i=256);var o=this.Cache.Image.TileHeight;if(void 0===o&&(o=256),e.Context2d.transform(1/i,0,0,1/o,0,0),this.Crop?e.Context2d.drawImage(this.Image,this.Crop[0],this.Crop[1],this.Crop[2],this.Crop[3],this.Crop[0],this.Crop[1],this.Crop[2],this.Crop[3]):e.Context2d.drawImage(this.Image,0,0),SA.WaterMark){var s=(this.X+1)*(this.Y+1)*4;e.Context2d.translate(128,128),e.Context2d.rotate(s),e.Context2d.translate(-128,-128),e.Context2d.fillStyle="rgba(0, 0, 0, 0.016)",e.Context2d.strokeStyle="rgba(50,50,50, 0.05)",e.Context2d.font="30px Comic Sans MS",e.Context2d.fillText("SlideAtlas",10,10)}e.Context2d.restore()}},s.prototype.CreateTexture=function(t){if(t){if(null===this.Texture){++SA.NumberOfTextures,this.Texture=t.createTexture();var e=this.Texture;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.Image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)}}else alert("Textures need a gl instance")},s.prototype.DeleteTexture=function(t){this.Texture&&(t?(--SA.NumberOfTextures,t.deleteTexture(this.Texture),this.Texture=null):alert("Textures need a gl instance"))},SA.Tile=s}(),function(){"use strict";function t(){this.UseIIP=!1,this.Levels=[],SA.Caches.push(this),this.NumberOfSections=1}var e=function(t,e){this.GridDims=[t,e]};e.prototype.SetTile=function(t){return void 0===this.Tiles&&(this.Tiles=new Array(this.GridDims[0]*this.GridDims[1])),this.Tiles[t.X+t.Y*this.GridDims[0]]=t,t},e.prototype.GetTile=function(t,e){if(void 0===this.Tiles)return null;var i=t+e*this.GridDims[0],o=this.Tiles[i];if(!o||o.Matrix)return o;this.Tiles[i]=void 0},e.prototype.StartIteration=function(){void 0===this.Tiles||0===this.Tiles.length?this.IteratorIndex=void 0:this.IteratorIndex=0},e.prototype.Next=function(){if(void 0===this.IteratorIndex)return this.IteratorIndex=void 0,null;for(var t=this.IteratorIndex;null===this.Tiles[t];)if((t+=1)>=this.Tiles.length)return this.IteratorIndex=void 0,null;return this.Tiles[t]},SA.SlideAtlasSource=function(){this.Prefix=void 0,this.getTileUrl=function(t,e,i,o){for(var s=this.Prefix+"t";t>0;){var n=(e>>--t&1)+2*(i>>t&1);0===n&&(s+="q"),1===n&&(s+="r"),2===n&&(s+="t"),3===n&&(s+="s")}return s+=".jpg"}},SA.GigamacroSource=function(){this.Prefix="http://www.gigamacro.com/content/AMNH/unit_box_test2_05-01-2015/zoomify/",this.GridSizeDebug=[[1,1],[2,2],[4,3],[7,5],[14,9],[28,17],[56,34]],this.setDimensions=function(t,e){for(this.Dimensions=[t,e],this.GridSize=[],this.Levels=0;;){var i=[Math.ceil(t/256),Math.ceil(e/256)];if(this.GridSize.splice(0,0,i),this.Levels+=1,1===i[0]&&1===i[1])return;t/=2,e/=2}},this.getTileUrl=function(t,e,i,o){var s=this.GridSize[t];if(e<0||e>=s[0]||i<0||i>=s[1])return"";for(var n=i*s[0]+e,a=0;a<t;++a)n+=(s=this.GridSize[a])[0]*s[1];var r=Math.floor(n/256);return this.Prefix+"TileGroup"+r+"/"+t+"-"+e+"-"+i+".jpg"}},SA.IIIFSource=function(){this.Prefix="http://ids.lib.harvard.edu/ids/view/Converter?id=834753&c=jpgnocap",alert("Hard coded tile size"),this.TileWidth=this.TileHeight=256,this.setDimensions=function(t,e){for(this.Dimensions=[t,e],this.GridSize=[],this.Levels=0;;){var i=[Math.ceil(t/256),Math.ceil(e/256)];if(this.Levels+=1,1===i[0]&&1===i[1])return;t/=2,e/=2}},this.getTileUrl=function(t,e,i,o){var s=256*e,n=256*i,a=s+256,r=n+256,h=this.Levels-t-1,l=this.Dimensions[0]>>h,d=this.Dimensions[1]>>h;return a>l&&(a=l),r>d&&(r=d),l=a-s,d=r-n,h=1/(1<<h),this.Prefix+"&s="+h+"&r=0&x="+s+"&y="+n+"&w="+l+"&h="+d}},SA.DanielSource=function(){this.Prefix="http://dragon.krash.net:2009/data/1",this.MinLevel=0,this.MaxLevel=7,this.getTileUrl=function(t,e,i,o){return o<this.MinLevel?"":o>this.MaxLevel?"":this.Prefix+t+"-"+e+"-"+i}},SA.FindCache=function(t){for(var e=0;e<SA.Caches.length;++e)if(SA.Caches[e].Image._id===t._id)return SA.Caches[e];var i=new SA.Cache;return i.SetImageData(t),i},t.prototype.destructor=function(){},t.prototype.GetImageData=function(){return this.Image},t.prototype.SetImageData=function(t){t.TileWidth||(t.TileWidth=256),t.TileHeight||(t.TileHeight=t.TileWidth),this.Image=t,void 0===t.copyright&&(t.copyright="Copyright 2019. All Rights Reserved."),this.Levels=new Array(t.levels);for(var i=0;i<t.levels;++i){var o=t.levels-1-i;this.Levels[i]=new e(Math.ceil(t.dimensions[0]/(t.TileWidth<<o)),Math.ceil(t.dimensions[1]/(t.TileHeight<<o)))}if(this.TileSource||(this.TileSource=new SA.SlideAtlasSource,this.TileSource.Prefix="/tile?img="+t._id+"&db="+t.database+"&name="),this.Warp=null,this.RootSpacing=[1<<t.levels-1,1<<t.levels-1,10],t.type&&"stack"===t.type){this.NumberOfSections=t.dimensions[2],this.TileDimensions=[t.dimensions[0],t.dimensions[1]];for(var s=1;s<=this.NumberOfSections;++s)this.GetTile(s,0,0).LoadQueueAdd();SA.LoadQueueUpdate()}else this.TileDimensions=[t.TileWidth,t.TileHeight],this.NumberOfSections=1},t.prototype.SetTileSource=function(t){var e=t.width,i=t.height;this.TileSource=t;var o={levels:t.maxLevel+1,dimensions:[e,i],bounds:[0,e-1,0,i-1]};t.bounds&&(o.bounds=t.bounds),t.TileWidth&&(o.TileWidth=t.TileWidth),t.TileHeight&&(o.TileHeight=t.TileHeight),t.filename&&(o.filename=t.filename,o.label=t.filename),this.SetImageData(o)},t.prototype.GetLeafSpacing=function(){return this.RootSpacing[0]/(1<<this.Image.levels-1)},t.prototype.GetBounds=function(){return this.Image&&this.Image.bounds?this.Image.bounds:[0,1e4,0,1e4]},t.prototype.ImageToWorld=function(t){return this.Warp?this.Warp.ImageToWorld(t):[t[0]+this.Origin[0],t[1]+this.Origin[1]]},t.prototype.WorldToImage=function(t){return this.Warp?this.Warp.WorldToImage(t):[t[0]-this.Origin[0],t[1]-this.Origin[1]]},t.prototype.GetSource=function(){return this.Source},t.prototype.LoadRoots=function(t){if(void 0!==this.Image.dimensions){if(this.LoadTileCallback=t,this.Image.dimensions.length<3)this.GetTile(0,0,0).LoadQueueAdd();else for(var e=1;e<=this.Image.dimensions[2];++e)this.GetTile(e,0,0).LoadQueueAdd();SA.LoadQueueUpdate()}},t.prototype.ChooseTiles=function(t,e,i){SA.AdvanceTimeStamp(),SA.Prune();var o=t.GetViewportHeight(),s=this.TileDimensions[1]*this.RootSpacing[1]/t.GetHeight();s=s*o/this.TileDimensions[1];for(var n=0;s>1;)++n,s*=.5;n>=this.Image.levels&&(n=this.Image.levels-1);var a,r,h=t.GetImageBounds();i=[];for(var l=n;l>=0;--l){r=this.GetVisibleTileIds(l,h);for(var d=0;d<r.length;++d)(a=this.GetTile(e,l,r[d]))&&(a.LoadQueueAdd(),i.push(a))}return SA.LoadQueueUpdate(),i},t.prototype.GetVisibleTileIds=function(t,e){this.Image.bounds&&(e[0]=Math.max(e[0],this.Image.bounds[0]),e[1]=Math.min(e[1],this.Image.bounds[1]),e[2]=Math.max(e[2],this.Image.bounds[2]),e[3]=Math.min(e[3],this.Image.bounds[3]));var i=[],o=1<<t,s=[];s[0]=Math.floor(e[0]*o/(this.TileDimensions[0]*this.RootSpacing[0])),s[1]=Math.ceil(e[1]*o/(this.TileDimensions[0]*this.RootSpacing[0]))-1,s[2]=Math.floor(e[2]*o/(this.TileDimensions[1]*this.RootSpacing[1])),s[3]=Math.ceil(e[3]*o/(this.TileDimensions[1]*this.RootSpacing[1]))-1;for(var n,a,r,h=Math.floor(.5*(s[0]+s[1])),l=Math.floor(.5*(s[2]+s[3])),d=Math.max(h-s[0],s[1]-h,l-s[2],s[3]-l);d>0;){for(r=-d;r<d;++r)a=l-r,(n=h-d)>=s[0]&&n<=s[1]&&a>=s[2]&&a<=s[3]&&i.push(n|a<<t),a=l-d,(n=h+r)>=s[0]&&n<=s[1]&&a>=s[2]&&a<=s[3]&&i.push(n|a<<t),a=l+r,(n=h+d)>=s[0]&&n<=s[1]&&a>=s[2]&&a<=s[3]&&i.push(n|a<<t),a=l+d,(n=h-r)>=s[0]&&n<=s[1]&&a>=s[2]&&a<=s[3]&&i.push(n|a<<t);d-=1}return i.push(h|l<<t),i},t.prototype.GetTileIdContainingPoint=function(t,e){var i=1<<t,o=Math.floor(e[0]*i),s=Math.floor(e[1]*i);return o<0&&(o=0),o>=i&&(o=i-1),s<0&&(s=0),s>=i&&(s=i-1),o|s<<t},t.prototype.UpdateBranchTimeStamp=function(t){var e=SA.GetCurrentTime();null!==t.Children[0]&&t.Children[0].BranchTimeStamp<e&&(e=t.Children[0].BranchTimeStamp),null!==t.Children[1]&&t.Children[1].BranchTimeStamp<e&&(e=t.Children[1].BranchTimeStamp),null!==t.Children[2]&&t.Children[2].BranchTimeStamp<e&&(e=t.Children[2].BranchTimeStamp),null!==t.Children[3]&&t.Children[3].BranchTimeStamp<e&&(e=t.Children[3].BranchTimeStamp),e===SA.GetCurrentTime()&&(e=t.TimeStamp),e!==t.BranchTimeStamp&&(t.BranchTimeStamp=e,null!==t.Parent&&this.UpdateBranchTimeStamp(t.Parent))},t.prototype.GetTile=function(t,e,i){var o=i&(1<<e)-1,s=i>>e;return this.RecursiveGetTile(e,o,s,t)},t.prototype.RecursiveGetTile=function(t,e,i,o){if(!this.Levels[t])return null;var s=this.Levels[t].GetTile(e,i);if(s)return s;if(s=new SA.Tile(e,i,o,t,this.TileSource.getTileUrl(t,e,i,o),this),this.Levels[t].SetTile(s),t>0){var n=this.RecursiveGetTile(t-1,e>>1,i>>1,o);null===n.Children[0]&&null===n.Children[1]&&null===n.Children[2]&&null===n.Children[3]&&(n.BranchTimeStamp=SA.GetCurrentTime());var a=(1&e)+2*(1&i);n.Children[a]=s,s.Parent=n}return s},t.prototype.PruneTiles=function(){this.Levels[0].StartIteration();var t=this.Levels[0].Next();if(3===t.LoadState&&(t.BranchTimeStamp<SA.PruneTimeTiles||t.BranchTimeStamp<SA.PruneTimeTextures)){var e=this.RecursivePruneTiles(t);e>0&&console.log("prune "+e+" from "+this.Image.label)}},t.prototype.RecursivePruneTiles=function(t){for(var e=!0,i=0,o=0;o<4;++o){var s=t.Children[o];null!==s&&(e=!1,(s.BranchTimeStamp<SA.PruneTimeTiles||s.BranchTimeStamp<SA.PruneTimeTextures)&&(i+=this.RecursivePruneTiles(s)))}if(e&&null!==t.Parent&&(t.BranchTimeStamp<SA.PruneTimeTextures&&t.DeleteTexture(),t.BranchTimeStamp<SA.PruneTimeTiles)){1===t.LoadState&&SA.LoadQueueRemove(t);var n=t.Parent;n.Children[0]===t?n.Children[0]=null:n.Children[1]===t?n.Children[1]=null:n.Children[2]===t?n.Children[2]=null:n.Children[3]===t&&(n.Children[3]=null),t.Parent=null,this.UpdateBranchTimeStamp(n),t.destructor(),i+=1}return i},SA.Cache=t}(),function(){"use strict";function t(){this.Matrix=mat4.create(),mat4.identity(this.Matrix),this.Caches=[],this.Markers=[],this.Transform=[1,0,0,1,0,0]}t.prototype.GetNumberOfCaches=function(){return this.Caches.length},t.prototype.GetCache=function(t){if(!(t<0||t>=this.Caches.length))return this.Caches[t]},t.prototype.SetCache=function(t){this.Caches=void 0===t?[]:[t],this.Bounds=void 0},t.prototype.SetTransform=function(t){this.Transform=t.slice(0)},t.prototype.AddCache=function(t){t&&(this.Caches.push(t),this.Bounds=void 0)},t.prototype.GetBounds=function(){return void 0===this.Bounds&&this.ComputeBounds(),this.Bounds},t.prototype.ComputeBounds=function(){this.Bounds=[0,1e4,0,1e4];for(var t=0;t<this.Caches.length;++t){var e=this.Caches[t].GetBounds();0===t?this.Bounds=[e[0],e[1],e[2],e[3]]:(e[0]<this.Bounds[0]&&(this.Bounds[0]=e[0]),e[1]>this.Bounds[1]&&(this.Bounds[1]=e[1]),e[2]<this.Bounds[2]&&(this.Bounds[2]=e[2]),e[3]<this.Bounds[3]&&(this.Bounds[3]=e[3]))}},t.prototype.GetLeafSpacing=function(){if(!this.LeafSpacing)for(var t=0;t<this.Caches.length;++t){var e=this.Caches[t].GetLeafSpacing();(!this.LeafSpacing||e<this.LeafSpacing)&&(this.LeafSpacing=e)}return this.LeafSpacing},t.prototype.LoadRoots=function(){for(var t=0;t<this.Caches.length;++t){var e=this.Caches[t];e&&e.LoadRoots()}},t.prototype.FindImage=function(t){for(var e=0;e<this.Caches.length;++e){var i=this.Caches[e];if(i.Image._id===t)return i}return null},t.prototype.Draw=function(t){var e=!0;if(t.Camera.SetWorldToImageTransform(this.Transform),t.gl){var i=t.ShaderProgram;t.gl.viewport(t.Viewport[0],t.Viewport[1],t.Viewport[2],t.Viewport[3])}else{var o=t.Camera.GetImageToViewerTransform();t.Context2d.setTransform(o[0],o[1],o[2],o[3],o[4],o[5])}for(var s=0;s<this.Caches.length;++s){var n=this.Caches[s];this.Tiles=n.ChooseTiles(t.Camera,0,t.Tiles),this.Tiles.length>1&&t.ClearPending&&(t.Clear(),t.ClearPending=void 0);for(var a=this.Tiles.slice(0),r=[],h=0;h<a.length;){var l=a[h];3===l.LoadState?r.push(l):a[h].LoadState<3&&(e=!1),++h}for(h=r.length-1;h>=0;--h)r[h].Draw(i,t)}return e},t.prototype.LoadTilesInView=function(t){for(var e=0;e<this.Caches.length;++e){var i=this.Caches[e];this.Tiles=i.ChooseTiles(t.Camera,0,t.Tiles)}},t.prototype.LoadTilesInView2=function(t){for(var e=0;e<this.Caches.length;++e)for(var i=this.Caches[e].ChooseTiles(t.Camera,0),o=0;o<i.length;++o)i[o].LoadState=1,SA.LoadQueue.push(i[o]);SA.LoadQueueUpdate()},t.prototype.LoadTilesInView=function(t){for(var e=0;e<this.Caches.length;++e)this.Caches[e].ChooseTiles(t.Camera,0)},SA.Section=t}(),function(){"use strict";function t(t,e){SAM.View.call(this,t,e),this.DefaultSection=new SA.Section,this.Section=this.DefaultSection,this.Tiles=[],e&&(this.gl=this.Canvas[0].getContext("webgl")||this.Canvas[0].getContext("experimental-webgl")),this.gl?SA.initWebGL(this):this.Context2d=this.Canvas[0].getContext("2d")}(t.prototype=new SAM.View).GetBounds=function(){return this.Section.GetBounds()},t.prototype.GetLeafSpacing=function(){return this.Section.GetLeafSpacing()},t.prototype.SetSection=function(t){this.Section=t,t.Transform?this.GetCamera().SetWorldToImageTransform(t.Transform):this.GetCamera().SetWorldToImageTransform([1,0,0,1,0,0])},t.prototype.AddCache=function(t){void 0!==t&&(void 0===this.Section&&(this.Section=this.DefaultSection),this.Section.Caches.push(t))},t.prototype.SetCache=function(t){this.Section=this.DefaultSection,this.Section.Caches=t?[t]:[]},t.prototype.GetCache=function(){return this.Section.Caches[0]},t.prototype.Draw=function(t){if(t){var e=t.Camera;this.Transform?this.Transform.ForwardTransformCamera(e,this.Camera):this.Camera.WorldCopy(e)}if(this.gl){var i=this.gl;i.clear(SA.GL.COLOR_BUFFER_BIT|SA.GL.DEPTH_BUFFER_BIT);var o=SA.imageProgram;i.useProgram(o),i.clearColor(1,1,1,1),i.disable(i.DEPTH_TEST),i.enable(i.BLEND)}return this.DrawTiles()},t.prototype.DrawTiles=function(){return this.gl?this.Section.Draw(this):(this.ClearPending=!0,this.Context2d.resetTransform(),this.Context2d.clearRect(0,0,this.Canvas[0].width,this.Canvas[0].height),this.Section.Draw(this))},SA.TileView=t}(),function(t){t.each(["show","hide"],function(e,i){var o=t.fn[i];t.fn[i]=function(){return this.trigger(i),o.apply(this,arguments)}})}(jQuery),function(){"use strict";function t(t){var e=this;this.Parent=t,t.addClass("sa-viewer"),SA.VIEWER=this,this.Div=$("<div>").appendTo(this.Parent).css({position:"relative","border-width":"0px",width:"100%",height:"100%","box-sizing":"border-box","z-index":"49"}).addClass("sa-resize"),this.Div.saOnResize(function(){e.UpdateSize()}),this.Div.addClass("ViewerDiv"),this.Div.attr("tabindex","1"),this.Drawing=!1,this.RenderPending=!1,this.Rotatable=!0,this.HistoryFlag=!1,this.MinPixelSize=.25,this.InteractionEnabled=!1,this.InteractionState=i,this.InteractionListeners=[],this.AnimateLast=null,this.AnimateDuration=0,this.TranslateTarget=[0,0],this.MainView=new SA.TileView(this.Div,!1),this.MainView.OutlineColor=[0,0,0],this.MainView.Camera.ZRange=[0,1],this.MainView.Camera.ComputeMatrix(),this.MainView.Parent.attr("tabindex","1"),this.Layers=[],SAM.detectMobile()&&"iPad"!==SAM.MOBILE_DEVICE||(this.OverViewVisibility=!0,this.OverViewScale=.02,this.OverViewport=[80,20,180,180],this.OverViewDiv=$("<div>").appendTo(this.Div),this.OverView=new SA.TileView(this.OverViewDiv),this.OverView.Camera.ZRange=[-1,0],this.OverView.Camera.SetWorldFocalPoint([13e3,11e3]),this.OverView.Camera.SetHeight(22e3),this.OverView.Camera.ComputeMatrix(),this.RotateIconHover=!1,this.RotateIconDrag=!1,this.RotateIcon=$("<img>").appendTo(this.OverView.Parent).attr("src",SA.ImagePathUrl+"rotate.png").addClass("sa-view-rotate").mouseenter(function(t){return e.RollEnter(t)}).mouseleave(function(t){return e.RollLeave(t)}).mousedown(function(t){return e.RollDown(t)}).attr("draggable","false").on("dragstart",function(){return!1}),this.OverViewDiv.css({"z-index":"49"})),this.ZoomTarget=this.MainView.Camera.GetHeight(),this.RollTarget=this.MainView.Camera.GetWorldRoll(),this.DoubleClickX=0,this.DoubleClickY=0,this.StackCorrelations=void 0,this.RecordIndex=0,this.InteractionOn(),this.CopyrightWrapper=$("<div>").appendTo(this.MainView.Parent).addClass("sa-view-copyright"),SA.Session&&"560b5127a7a1412195d13685"===SA.Session.sessid&&(this.Icon=$("<img>").appendTo(this.MainView.Parent).attr("src","http://static1.squarespace.com/static/5126bbb4e4b08c2e6d1cb6e4/t/54e66f05e4b0440df79a5729/1424387847915/").prop("title","UC Davis").css({position:"absolute",bottom:"80px",left:"7px",width:"128px","z-index":"4"})),SA.Session&&"57504ba7a7a1411310dd2637"===SA.Session.sessid&&(this.Icon=$("<img>").appendTo(this.MainView.Parent).attr("src","https://slide-atlas.org/api/v2/sessions/53d9230fdd98b54fd71e8ed7/attachments/57518ce4a7a14113156b8166").prop("title","Philips").css({position:"absolute",bottom:"90px",left:"7px",width:"100px","z-index":"4"})),this.WheelSensitivity=0,this.WheelAcceleration=.025,this.WheelTimeConstant=1e3}var e=!1,i=0;t.prototype.GetParentDiv=function(){return this.Div},t.prototype.GetParent=function(){return this.Parent},t.prototype.ScaleOn=function(){this.ScaleWidget||(this.ScaleWidget=new SAM.ScaleWidget)},t.prototype.InteractionOn=function(){if(!this.InteractionEnabled){this.InteractionEnabled=!0;var t=this,e=this.Div;e.on("mousedown.viewer",function(e){return t.FirefoxWhich=e.which,t.HandleMouseDown(e)}),e.on("mousemove.viewer",function(e){return this.focus(),void 0===e.which&&(e.which=t.FirefoxWhich),void 0===e.which&&(e.which=t.FirefoxWhich),t.HandleMouseMove(e)}),$(document.body).on("mouseup.viewer",function(e){return t.FirefoxWhich=0,void 0===e.which&&(e.which=0),t.HandleMouseUp(e),!0}),e.on("wheel.viewer",function(e){return t.HandleMouseWheel(e.originalEvent)}),e.on("touchstart.viewer",function(e){return t.HandleTouchStart(e.originalEvent)}),e.on("touchmove.viewer",function(e){return void 0===e.which&&(e.which=0),e.which=t.FirefoxWhich,t.HandleTouchMove(e.originalEvent)}),e.on("touchend.viewer",function(e){return t.HandleTouchEnd(e.originalEvent),!0}),e.on("keydown.viewer",function(e){return t.HandleKeyDown(e)}),e.on("keyup.viewer",function(e){return t.HandleKeyUp(e)}),this.OverView&&((e=this.OverViewDiv).on("mousedown.viewer",function(e){return SA.FirefoxWhich(e),t.FirefoxWhich=e.which,t.HandleOverViewMouseDown(e)}),e.on("mouseup.viewer",function(e){return t.FirefoxWhich=0,t.FirefoxWhich=0,void 0===e.which&&(e.which=0),t.HandleOverViewMouseUp(e)}),e.on("mousemove.viewer",function(e){return void 0===e.which&&(e.which=t.FirefoxWhich),t.HandleOverViewMouseMove(e)}),e.on("mousewheel.viewer",function(e){return t.HandleOverViewMouseWheel(e.originalEvent)}))}},t.prototype.InteractionOff=function(){this.InteractionEnabled=!1;var t=this.Div;t.off("mousedown.viewer"),t.off("mousemove.viewer"),$(document.body).off("mouseup.viewer"),t.off("wheel.viewer"),t.off("touchstart.viewer"),t.off("touchmove.viewer"),t.off("touchend.viewer"),t.off("keydown.viewer"),t.off("keyup.viewer"),this.OverView&&((t=this.OverViewDiv).off("mousedown.viewer"),t.off("mouseup.viewer"),t.off("mousemove.viewer"),t.off("mousewheel.viewer"))},t.prototype.Focus=function(){this.MainView.Parent.focus()},t.prototype.SetRotatable=function(t){this.Rotatable=t,t?this.RotateIcon.show():this.RotateIcon.hide()},t.prototype.Delete=function(){},t.prototype.AddLayer=function(t){this.Layers.push(t)},t.prototype.Record=function(t,e){e=e||0,t.ViewerRecords[e].CopyViewer(this)},t.prototype.ProcessArguments=function(t){if(void 0!==t.overview&&this.SetOverViewVisibility(t.overview),void 0!==t.zoomWidget&&this.SetZoomWidgetVisibility(t.zoomWidget),void 0!==t.rotatable&&this.SetRotatable(t.rotatable),void 0!==t.menu&&(this.Menu||(this.Menu=new SA.ViewEditMenu(this,null)),this.Menu.SetVisibility(t.menu)),t.tileSource&&(t.note=SA.TileSourceToNote(t.tileSource)),t.note){this.saNote=t.note;var e=this.saViewerIndex=t.viewerIndex||0;this.SetViewerRecord(t.note.ViewerRecords[e]),this.Parent.attr("sa-note-id",t.note.Id||t.note.TempId),this.Parent.attr("sa-viewer-index",this.saViewerIndex)}void 0!==t.hideCopyright&&this.SetCopyrightVisibility(!t.hideCopyright),void 0!==t.interaction&&this.SetInteractionEnabled(t.interaction),this.UpdateSize()},t.prototype.SetViewerRecord=function(t,e){this.ActiveWidget&&this.ActiveWidget.SetActive(!1),e||this.Reset();var i=this.GetCache();if(!i||t.Image._id!==i.Image._id){var o=SA.FindCache(t.Image);this.SetCache(o)}if(!e&&(this.SetOverViewBounds(t.OverViewBounds),void 0!==t.Camera&&void 0===t.Transform)){var s=t.Camera;this.GetCamera().Load(s),this.OverView&&(this.OverView.Camera.SetWorldRoll(s.Roll),this.OverView.Camera.ComputeMatrix()),this.UpdateZoomGui(),this.UpdateCamera()}this.AnnotationWidget&&void 0!==t.AnnotationVisibility&&this.AnnotationWidget.SetVisibility(t.AnnotationVisibility),this.UpdateSize()},t.prototype.SetNote=function(t,e,i){!t||e<0||e>=t.ViewerRecords.length?console.log("Cannot set viewer record of note"):(this.SetViewerRecord(t.ViewerRecords[e],i),this.saNote=t,this.saViewerIndex=e)},t.prototype.SetNoteFromId=function(t,e){var i=this,o=SA.GetNoteFromId(t);return o?(this.SetNote(o,e),o):((o=new SA.Note).LoadViewId(t,function(){i.SetNote(o,e)}),o)},t.prototype.SetOverViewVisibility=function(t){this.OverViewVisibility=t,this.OverViewDiv&&(t?this.OverViewDiv.show():this.OverViewDiv.hide())},t.prototype.GetOverViewVisibility=function(){return this.OverViewVisibility},t.prototype.Hide=function(){this.MainView.Parent.hide(),this.OverView&&this.OverView.Parent.hide()},t.prototype.Show=function(){this.MainView.Parent.show(),this.OverView&&this.OverViewVisibility&&this.OverView.Parent.show()},t.prototype.EventuallyRender=function(t){if(!this.RenderPending){this.RenderPending=!0;var e=this;window.requestAnimationFrame(function(){e.RenderPending=!1,e.Draw(),t&&e.TriggerInteraction()})}},t.prototype.RollEnter=function(t){this.Rotatable&&(this.RotateIconHover=!0,this.RotateIcon.addClass("sa-active"))},t.prototype.RollLeave=function(t){this.RotateIconDrag||(this.RotateIconHover=!1,this.RotateIconDrag||this.RotateIcon.removeClass("sa-active"))},t.prototype.RollDown=function(t){if(this.OverView&&this.Rotatable){this.FirefoxWhich=t.which,this.RotateIconDrag=!0;var e=this.OverViewport[0]+.5*this.OverViewport[2],i=this.OverViewport[1]+.5*this.OverViewport[3],o=this.MainView.Parent.offset(),s=t.pageX-o.left-e,n=t.pageY-o.top-i,a=Math.sqrt(s*s+n*n);return this.RotateIconX=s/a,this.RotateIconY=n/a,SA.FirefoxWhich(event),this.FirefoxWhich=event.which,!1}},t.prototype.RollMove=function(t){if(this.OverView&&this.RotateIconDrag&&this.Rotatable){if(1===t.which){var e=this.OverViewport[0]+.5*this.OverViewport[2],i=this.OverViewport[1]+.5*this.OverViewport[3],o=this.MainView.Parent.offset(),s=t.pageX-o.left-e,n=t.pageY-o.top-i,a=Math.sqrt(s*s+n*n);n/=a;var r=(s/=a)*this.RotateIconY-n*this.RotateIconX,h=this.MainView.Camera.GetWorldRoll()-r;return this.MainView.Camera.SetWorldRoll(h),this.UpdateCamera(),this.EventuallyRender(!0),this.RotateIconX=s,this.RotateIconY=n,!1}this.RotateIconDrag=!1}},t.prototype.UpdateSize=function(){if(this.MainView){this.MainView.UpdateCanvasSize()&&this.EventuallyRender();for(var t=0;t<this.Layers.length;++t){var e=this.Layers[t];e&&e.UpdateSize&&e.UpdateSize()}if(this.OverView){var i=this.MainView.GetWidth(),o=this.MainView.GetHeight(),s=i*o,n=this.GetOverViewBounds(),a=(n[1]-n[0])/(n[3]-n[2]),r=Math.sqrt(s*this.OverViewScale/a),h=r*a;r>o/2&&(h=(r=o/2)*a,this.OverViewScale=h*r/s);var l=Math.sqrt(r*r+h*h)/2;this.OverViewport=[i-l-h/2,l-r/2,h,r],this.OverViewDiv.css({left:this.OverViewport[0]+"px",width:this.OverViewport[2]+"px",top:this.OverViewport[1]+"px",height:this.OverViewport[3]+"px"}),this.OverView.UpdateCanvasSize()}}},t.prototype.RollUp=function(t){return this.RotateIconDrag=!1,this.RotateIconHover||this.RotateIcon.addClass("sa-active"),!1},t.prototype.GetMainCanvas=function(){return this.MainView.Canvas},t.prototype.OnInteraction=function(t){t?this.InteractionListeners.push(t):this.InteractionListeners=[]},t.prototype.TriggerInteraction=function(){for(var t=0;t<this.InteractionListeners.length;++t)(0,this.InteractionListeners[t])()},t.prototype.GetDiv=function(){return this.MainView.Parent},t.prototype.InitializeZoomGui=function(){this.ShareTab=new SA.Tab(this.GetDiv(),SA.ImagePathUrl+"share.png","shareTab"),this.ShareTab.Div.css({"box-sizing":"border-box",position:"absolute",bottom:"0px",right:"47px","z-index":"49"}),this.ShareTab.Panel.css({"box-sizing":"border-box",left:"-400px",width:"480px","z-index":"500",padding:"0 2px"});var t=this;this.ShareDisplay=$("<div>").appendTo(this.ShareTab.Panel).addClass("sa-view-share-text").html("").attr("contenteditable","true").css({tabindex:"1","z-index":"501",width:"100%","-webkit-user-select":"all","user-select":"all"}),this.ShareTab.Panel.on("show",function(){t.TriggerEndInteraction(),t.ShareDisplay.focus()}),this.ShareDisplay.on("mouseenter",function(){t.InteractionOff(),t.ShareDisplay.focus()}),this.ShareDisplay.on("mouseleave",function(){t.InteractionOn(),t.ShareDisplay.blur()}),this.ZoomTab=new SA.Tab(this.GetDiv(),SA.ImagePathUrl+"mag.png","zoomTab"),this.ZoomTab.Div.css({"box-sizing":"border-box",position:"absolute",bottom:"0px",right:"7px","z-index":"49"}),this.ZoomTab.Panel.addClass("sa-view-zoom-panel"),this.ZoomDisplay=$("<div>").appendTo(this.ZoomTab.Div).addClass("sa-view-zoom-text").html(""),this.ZoomDiv=$("<div>").appendTo(this.ZoomTab.Panel).addClass("sa-view-zoom-panel-div"),this.ZoomInButton=$("<img>").appendTo(this.ZoomDiv).addClass("sa-view-zoom-button sa-zoom-in").attr("type","image").attr("src",SA.ImagePathUrl+"zoomin2.png").on("click touchstart",function(){t.AnimateZoom(.5)}).attr("draggable","false").on("dragstart",function(){return!1}),this.ZoomOutButton=$("<img>").appendTo(this.ZoomDiv).addClass("sa-view-zoom-button sa-zoom-out").attr("type","image").attr("src",SA.ImagePathUrl+"zoomout2.png").on("click touchstart",function(){t.AnimateZoom(2)}).attr("draggable","false").on("dragstart",function(){return!1}),this.ZoomInButton.addClass("sa-active"),this.ZoomOutButton.addClass("sa-active")},t.prototype.UpdateZoomGui=function(){if(this.ZoomDisplay){var t=this.GetCamera().GetHeight(),e=40*this.GetViewport()[3]/t;e=e<2?e.toFixed(2):e<4?e.toFixed(1):Math.round(e),this.ZoomDisplay.html("x"+e),this.ZoomTarget=t}},t.prototype.SaveImage=function(t){this.MainView.Canvas[0].toBlob(function(e){saveAs(e,t)},"image/png")},t.prototype.CancelLargeImage=function(){SA.ClearFinishedLoadingCallbacks(),SA.ClearQueue(),this.EventuallyRender(!1)},t.prototype.SaveLargeImage=function(t,e,i,o,s){var n=this,a=this.GetCache(),r=this.GetCamera(),h=new SA.TileView;h.SetCache(a),h.Canvas.attr("width",e),h.Canvas.attr("height",i),h.SetViewport([0,0,e,i]);var l=h.Camera;l.SetWorldFocalPoint(r.GetWorldFocalPoint()),l.SetWorldRoll(r.GetWorldRoll()),l.Height=r.GetHeight(),l.Width=r.GetWidth(),l.ViewportWidth=e,l.ViewportHeight=i,l.ComputeMatrix();for(var d=a.ChooseTiles(l,0,[]),u=0;u<d.length;++u)SA.LoadQueueAddTile(d[u]);SA.LoadQueueUpdate(),SA.AddFinishedLoadingCallback(function(){n.SaveLargeImage2(h,t,e,i,o,s)})},t.prototype.SaveLargeImage2=function(t,e,i,o,s,n){var a,r=e;if(s){a=SA.display.GetNote();var h=e.indexOf(".");r=h<0?e+SA.ZERO_PAD(a.StartIndex,4)+".png":e.substring(0,h)+SA.ZERO_PAD(a.StartIndex,4)+e.substring(h,e.length)}console.log(r+" "+SA.LoadQueue.length+" "+SA.LoadingCount),t.Draw()||console.log("Sanity check failed. Not all tiles were available."),this.MainView.DrawShapes();for(var l=0;l<this.Layers.length;++l)this.Layers[l].Draw&&this.Layers[l].Draw(t);if(console.log(JSON.stringify(this.GetCamera().Serialize())),t.Canvas[0].toBlob(function(t){saveAs(t,r)},"image/png"),s&&(a=SA.display.GetNote()).StartIndex<a.ViewerRecords.length-1){SA.display.NavigationWidget.NextNote();var d=this;setTimeout(function(){d.SaveLargeImage(e,i,o,s,n)},1e3)}else n()},t.prototype.EventuallySaveImage=function(t,e){var i=this;SA.AddFinishedLoadingCallback(function(){i.SaveImage(t),e&&e()}),this.EventuallyRender(!1)},t.prototype.SaveStackImages=function(t){var e=this;SA.AddFinishedLoadingCallback(function(){e.SaveStackImage(t)}),this.EventuallyRender(!1)},t.prototype.SaveStackImage=function(t){var e=this,i=SA.display.GetNote(),o=t+SA.ZERO_PAD(i.StartIndex,4);console.log(JSON.stringify(this.GetCamera().Serialize())),this.SaveImage(o),i.StartIndex<i.ViewerRecords.length-1&&(SA.display.NavigationWidget.NextNote(),SA.AddFinishedLoadingCallback(function(){e.SaveStackImage(t)}),this.EventuallyRender(!1))},t.prototype.SetOverViewBounds=function(t){this.OverViewBounds=t,this.OverView&&(this.OverView.Camera.SetHeight(t[3]-t[2]),this.OverView.Camera.SetWorldFocalPoint([.5*(t[0]+t[1]),.5*(t[2]+t[3])]),this.OverView.Camera.ComputeMatrix())},t.prototype.GetOverViewBounds=function(){if(this.OverViewBounds)return this.OverViewBounds;var t=this.GetCache();if(t&&t.Image){if(t.Image.bounds)return t.Image.bounds;if(t.Image.dimensions){var e=t.Image.dimensions;return[0,e[0],0,e[1]]}}if(this.OverView){var i=this.OverView.Camera,o=i.GetHeight()/2,s=i.GetWidth()/2,n=i.GetWorldFocalPoint();return this.OverViewBounds=[n[0]-s,n[0]+s,n[1]-o,n[1]+o],this.OverViewBounds}return[0,1e4,0,1e4]},t.prototype.SetSection=function(t){if(null!==t){if(t.Bounds&&this.SetOverViewBounds(t.Bounds),t.Caches.length>0&&this.CopyrightWrapper.html(t.Caches[0].Image.copyright),this.MainView.SetSection(t),this.OverView){this.OverView.SetSection(t);var e=t.Bounds;if(e){this.OverView.Camera.SetWorldFocalPoint([(e[0]+e[1])/2,(e[2]+e[3])/2]);var i=e[3]-e[2],o=(e[1]-e[0])*this.OverView.Viewport[3]/this.OverView.Viewport[2];o>i&&(i=o),this.OverView.Camera.SetHeight(i),this.OverView.Camera.ComputeMatrix()}}this.UpdateSize()}},t.prototype.SetCache=function(t){if(t&&t.Image&&(t.Image.bounds&&this.SetOverViewBounds(t.Image.bounds),this.CopyrightWrapper.html(t.Image.copyright)),this.MainView.SetCache(t),this.OverView&&(this.OverView.SetCache(t),t)){var e=t.GetBounds();if(e){this.OverView.Camera.SetWorldFocalPoint([(e[0]+e[1])/2,(e[2]+e[3])/2]);var i=e[3]-e[2],o=(e[1]-e[0])*this.OverView.Viewport[3]/this.OverView.Viewport[2];o>i&&(i=o),this.OverView.Camera.SetHeight(i),this.OverView.Camera.ComputeMatrix()}}this.UpdateSize()},t.prototype.GetCache=function(){return this.MainView.GetCache()},t.prototype.SetViewport=function(t){if(this.OverView){var e=t[2]*t[3],i=this.GetOverViewBounds(),o=(i[1]-i[0])/(i[3]-i[2]),s=Math.sqrt(e*this.OverViewScale/o),n=s*o;s>t[3]/2&&(n=(s=t[3]/2)*o,this.OverViewScale=n*s/e);var a=Math.sqrt(s*s+n*n)/2;this.OverViewport=[t[2]-a-n/2,t[1]+a-s/2,n,s],this.OverViewDiv.css({left:this.OverViewport[0]+"px",width:this.OverViewport[2]+"px",top:this.OverViewport[1]+"px",height:this.OverViewport[3]+"px"}),this.OverView.UpdateCanvasSize()}},t.prototype.GetViewport=function(){return this.MainView.Viewport},t.prototype.ToggleMirror=function(){this.MainView.Camera.Mirror=!this.MainView.Camera.Mirror,this.OverView&&(this.OverView.Camera.Mirror=!this.OverView.Camera.Mirror)},t.prototype.AnimateCamera=function(t,e,i){this.ZoomTarget=i,this.TranslateTarget[0]=t[0],this.TranslateTarget[1]=t[1],this.RollTarget=e,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},t.prototype.UpdateCamera=function(){var t=this.MainView.Camera;this.ZoomTarget=t.Height;var e=t.GetWorldFocalPoint();this.TranslateTarget[0]=e[0],this.TranslateTarget[1]=e[1],this.RollTarget=t.GetWorldRoll(),this.OverView&&(this.OverView.Parent.css({transform:"rotate("+this.RollTarget+"rad"}),this.OverView.Camera.SetWorldRoll(0),this.OverView.Camera.ComputeMatrix()),this.MainView.Camera.ComputeMatrix(),this.UpdateZoomGui()},t.prototype.SetCamera=function(t,e,i){this.MainView.Camera.SetHeight(i),this.MainView.Camera.SetWorldFocalPoint([t[0],t[1]]),this.MainView.Camera.SetWorldRoll(3.14159265359*e/180),this.ZoomTarget=i,this.TranslateTarget[0]=t[0],this.TranslateTarget[1]=t[1],this.RollTarget=e,this.UpdateCamera(),this.EventuallyRender(!0)},t.prototype.GetCamera=function(){return this.MainView.Camera},t.prototype.AnimateZoomTo=function(t,e){if(!(this.AnimateDuration>0)){SA.StackCursorFlag=!1,this.ZoomTarget=this.MainView.Camera.GetHeight()*t,this.ZoomTarget<.9/32&&(this.ZoomTarget=.9/32);var i=this.GetViewport()[3],o=Math.round(Math.log(32*i/this.ZoomTarget)/Math.log(2));this.ZoomTarget=32*i/Math.pow(2,o),t=this.ZoomTarget/this.MainView.Camera.GetHeight();var s=this.MainView.Camera.GetWorldFocalPoint();this.TranslateTarget[0]=e[0]-t*(e[0]-s[0]),this.TranslateTarget[1]=e[1]-t*(e[1]-s[1]),this.RollTarget=this.MainView.Camera.GetWorldRoll(),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)}},t.prototype.AnimateZoom=function(t){if(this.MouseUpTime-=1e3,!(this.AnimateDuration>0)){var e=this.GetCamera().GetWorldFocalPoint();this.AnimateZoomTo(t,e)}},t.prototype.AnimateTranslate=function(t,e){var i=this.MainView.Camera.WorldFocalPoint();this.TranslateTarget[0]=i[0]+t,this.TranslateTarget[1]=i[1]+e,this.ZoomTarget=this.MainView.Camera.GetHeight(),this.RollTarget=this.MainView.Camera.GetWorldRoll(),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},t.prototype.AnimateRoll=function(t){t*=Math.PI/180,this.RollTarget=this.MainView.Camera.GetWorldRoll()+t,this.ZoomTarget=this.MainView.Camera.GetHeight();var e=this.MainView.Camera.GetWorldFocalPoint();this.TranslateTarget[0]=e[0],this.TranslateTarget[1]=e[1],this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},t.prototype.AnimateTransform=function(t,e,i){var o=this.MainView.Camera.GetWorldFocalPoint();this.TranslateTarget[0]=o[0]+t,this.TranslateTarget[1]=o[1]+e,this.RollTarget=this.MainView.Camera.GetWorldRoll()+i,this.ZoomTarget=this.MainView.Camera.GetHeight(),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0)},t.prototype.DegToRad=function(t){return t*Math.PI/180},t.prototype.Draw=function(){if(SA&&SA.RootNote&&SA.RootNote.WaterMark?SA.WaterMark=!0:SA.WaterMark=!1,!this.Drawing&&(this.Drawing=!0,this.Animate(),this.MainView&&this.MainView.Section)){this.MainView.Draw()||this.EventuallyRender();for(var t=0;t<this.Layers.length;++t)this.Layers[t].Draw&&this.Layers[t].Draw(this.MainView);this.MainView.DrawShapes(),this.OverView&&(this.OverView.Draw(),this.OverView.DrawOutline(!0)),this.OverView&&(this.MainView.Camera.Draw(this.OverView),this.HistoryFlag&&this.OverView.DrawHistory(this.MainView.Viewport[3])),this.ScaleWidget&&this.ScaleWidget.Draw(this.MainView),SA.StackCursorFlag&&SA.Edit&&(this.MainView.DrawFocalPoint(),this.StackCorrelations&&this.MainView.DrawCorrelations(this.StackCorrelations,this.RecordIndex)),SA.LoadQueueUpdate(),this.Drawing=!1}},t.prototype.Reset=function(){this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=0,this.MomentumScale=0,this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0),this.StartTouchTime=0,this.SetCache(null),this.MainView.ShapeList=[];for(var t=0;t<this.Layers.length;++t)this.Layers[t].Reset&&this.Layers[t].Reset(),this.Layers[t].Remove&&this.Layers[t].Remove();this.Layers=[]},t.prototype.AddShape=function(t){this.MainView.AddShape(t)},t.prototype.Animate=function(){var t;if(!(this.AnimateDuration<=0)){var e=(new Date).getTime();if(e>=this.AnimateLast+this.AnimateDuration)this.AnimateDuration=0,this.MainView.Camera.SetHeight(this.ZoomTarget),this.MainView.Camera.SetWorldRoll(this.RollTarget),this.MainView.Camera.SetWorldFocalPoint([this.TranslateTarget[0],this.TranslateTarget[1]]),this.ConstrainCamera(),this.OverView&&(t=this.RollTarget,this.OverView.Parent.css({transform:"rotate("+t+"rad"}),this.OverView.Camera.SetWorldRoll(0),this.OverView.Camera.ComputeMatrix()),this.TriggerEndInteraction();else{var i=this.MainView.Camera.GetHeight(),o=this.MainView.Camera.GetWorldFocalPoint(),s=this.MainView.Camera.GetWorldRoll();this.MainView.Camera.SetHeight(i+(this.ZoomTarget-i)*(e-this.AnimateLast)/this.AnimateDuration),this.MainView.Camera.SetWorldRoll(s+(this.RollTarget-s)*(e-this.AnimateLast)/this.AnimateDuration),this.MainView.Camera.SetWorldFocalPoint([o[0]+(this.TranslateTarget[0]-o[0])*(e-this.AnimateLast)/this.AnimateDuration,o[1]+(this.TranslateTarget[1]-o[1])*(e-this.AnimateLast)/this.AnimateDuration]),this.ConstrainCamera(),this.OverView&&(t=this.MainView.Camera.GetWorldRoll(),this.OverView.Parent.css({transform:"rotate("+t+"rad"}),this.OverView.Camera.SetWorldRoll(0),this.OverView.Camera.ComputeMatrix()),this.AnimateDuration-=e-this.AnimateLast,this.EventuallyRender(!0)}this.MainView.Camera.ComputeMatrix(),this.OverView&&this.OverView.Camera.ComputeMatrix(),this.AnimateLast=e}},t.prototype.OverViewPlaceCameraPt=function(t,e){if(this.OverView){t/=this.OverView.Viewport[2],e/=this.OverView.Viewport[3];var i=this.OverView.Camera.GetWorldMatrix();t=(2*t-1)*i[15],e=(1-2*e)*i[15];var o=i[0]*i[5]-i[1]*i[4],s=(t*i[5]-e*i[4]+i[4]*i[13]-i[5]*i[12])/o,n=(e*i[0]-t*i[1]-i[0]*i[13]+i[1]*i[12])/o;this.TranslateTarget[0]=s,this.TranslateTarget[1]=n,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=100,this.EventuallyRender(!0)}},t.prototype.SetInteractionEnabled=function(t){console.log("Get rid of this"),this.InteractionEnabled=t},t.prototype.EnableInteraction=function(){console.log("Get rid of this"),this.InteractionEnabled=!0},t.prototype.DisableInteraction=function(){console.log("Get rid of this"),this.InteractionEnabled=!1},t.prototype.RecordMouseDown=function(t){if(this.LastMouseX=this.MouseX||0,this.LastMouseY=this.MouseY||0,this.LastMouseTime=this.MouseTime||0,!this.SetMousePositionFromEvent(t))return!1;var e=new Date;this.MouseDownTime=e.getTime()},t.prototype.SetMousePositionFromEvent=function(t){var e=this.GetMousePosition(t);return void 0!==e&&(this.MouseX=e[0],this.MouseY=e[1],t.MouseX=e[0],t.MouseY=e[1],this.MouseTime=(new Date).getTime(),!0)},t.prototype.RecordMouseMove=function(t){return this.LastMouseX=this.MouseX,this.LastMouseY=this.MouseY,this.LastMouseTime=this.MouseTime,!!this.SetMousePositionFromEvent(t)&&(this.MouseDeltaX=this.MouseX-this.LastMouseX,this.MouseDeltaY=this.MouseY-this.LastMouseY,this.MouseDeltaTime=this.MouseTime-this.LastMouseTime,0!==this.MouseDeltaX||0!==this.MouseDeltaY)},t.prototype.RecordMouseUp=function(t){if(!this.SetMousePositionFromEvent(t))return!1;this.MouseDown=!1;var e=new Date;this.MouseUpTime=e.getTime(),this.DoubleClick=!1},t.prototype.HandleTouch=function(t,e){var i=(new Date).getTime();if(i-this.Time<20&&!e)return!1;this.LastTime=this.Time,this.Time=i,t||(t=event),this.LastTouches=this.Touches,this.Touches=[];for(var o=0;o<t.targetTouches.length;++o){var s=this.MainView.Canvas.offset(),n=t.targetTouches[o].pageX-s.left,a=t.targetTouches[o].pageY-s.top;this.Touches.push([n,a])}this.LastMouseX=this.MouseX,this.LastMouseY=this.MouseY;var r=this.Touches.length;for(this.MouseX=this.MouseY=0,o=0;o<r;++o)this.MouseX+=this.Touches[o][0],this.MouseY+=this.Touches[o][1];return this.MouseX=this.MouseX/r,this.MouseY=this.MouseY/r,this.offsetX=this.MouseX,this.offsetY=this.MouseY,!0},t.prototype.HandleTouchStart=function(t){if(!this.InteractionEnabled)return!0;this.HandleTouch(t,!0),this.StartTouchTime=this.Time;for(var e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleTouchStart&&!i.HandleTouchStart(t))return!1}if(SA.TriggerStartInteraction(),this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=0,this.MomentumScale=0,this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0),this.Touches.length>=4){var o=this.GetCamera(),s=this.MainView.Section.GetBounds();return o.SetWorldFocalPoint([.5*(s[0]+s[1]),.5*(s[2]+s[3])]),o.SetWorldRoll(0),o.SetHeight(s[3]-s[2]),o.ComputeMatrix(),this.EventuallyRender(),!0}return!1},t.prototype.HandleTouchMove=function(t){if(0===this.StartTouchTime)return!1;if(this.HandleTouch(t,!1)){for(var e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleTouchMove&&!i.HandleTouchMove(event))return!1}var o=this.MainView.Parent.width(),s=1e3*(this.MouseX-this.LastMouseX)/((this.Time-this.LastTime)*o);if(SA.display&&SA.display.NavigationWidget){if(s>4)return SA.display.NavigationWidget.PreviousNote(),!1;if(s<-4)return SA.display.NavigationWidget.NextNote(),!1}1===this.Touches.length?this.HandleTouchPan(this):2===this.Touches.length?this.HandleTouchPinch(this):this.Rotatable&&3===this.Touches.length&&this.HandleTouchRotate(this)}},t.prototype.HandleTouchPan=function(t){if(!this.InteractionEnabled)return!0;if(1===this.Touches.length&&1===this.LastTouches.length){for(var e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleTouchPan&&!i.HandleTouchPan(t))return!1}this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var o=this.ConvertPointViewerToWorld(this.LastMouseX,this.LastMouseY),s=this.ConvertPointViewerToWorld(this.MouseX,this.MouseY),n=s[0]-o[0],a=s[1]-o[1],r=t.Time-this.LastTime,h=n/r,l=a/r,d=Math.min(this.Time-this.LastTime,250)/250;this.MomentumX+=(h-this.MomentumX)*d,this.MomentumY+=(l-this.MomentumY)*d,this.MomentumRoll=0,this.MomentumScale=0;var u=this.GetCamera();u.Translate(-n,-a,0),u.ComputeMatrix(),this.EventuallyRender(!0)}},t.prototype.HandleTouchRotate=function(t){if(!this.InteractionEnabled)return!0;if(!this.Rotatable)return!0;var e=this.Touches.length;if(this.LastTouches.length===e&&3===e){this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);for(var i,o,s=this.ConvertPointViewerToWorld(this.LastMouseX,this.LastMouseY),n=this.ConvertPointViewerToWorld(this.MouseX,this.MouseY),a=t.Time-this.LastTime,r=0,h=0;h<e;++h){i=this.LastTouches[h][0]-this.LastMouseX,o=this.LastTouches[h][1]-this.LastMouseY;var l=Math.atan2(o,i);i=this.Touches[h][0]-this.MouseX,o=this.Touches[h][1]-this.MouseY,(l-=Math.atan2(o,i))>Math.PI&&(l-=2*Math.PI),l<-Math.PI&&(l+=2*Math.PI),r+=l}r/=e;var d=this.GetCamera(),u=d.GetWorldFocalPoint();s[0]=u[0]-n[0],s[1]=u[1]-n[1];var p=Math.cos(r),c=Math.sin(r);i=n[0]+(s[0]*p-s[1]*c),o=n[1]+(s[0]*c+s[1]*p);var f=r/a;if(this.MomentumX=0,this.MomentumY=0,this.MomentumRoll=.5*(this.MomentumRoll+f),this.MomentumScale=0,d.SetWorldRoll(d.GetWorldRoll()-r),d.ComputeMatrix(),this.OverView){var g=this.OverView.Camera;g.SetWorldRoll(d.GetWorldRoll()),g.ComputeMatrix()}this.EventuallyRender(!0)}},t.prototype.HandleTouchPinch=function(t){if(!this.InteractionEnabled)return!0;var e=this.Touches.length;if(this.LastTouches.length===e&&2===e){this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var i=this.ConvertPointViewerToWorld(this.LastMouseX,this.LastMouseY),o=this.ConvertPointViewerToWorld(this.MouseX,this.MouseY),s=o[0]-i[0],n=o[1]-i[1],a=t.Time-this.LastTime;if(0!==a){for(var r,h,l=1,d=0,u=0,p=0;p<e;++p)r=this.LastTouches[p][0]-this.LastMouseX,h=this.LastTouches[p][1]-this.LastMouseY,d+=Math.sqrt(r*r+h*h),r=this.Touches[p][0]-this.MouseX,h=this.Touches[p][1]-this.MouseY,u+=Math.sqrt(r*r+h*h);if(!(d<2||u<2)){l=u/d;var c=this.GetCamera(),f=c.GetWorldFocalPoint();i[0]=f[0]-o[0]-s,i[1]=f[1]-o[1]-n,r=o[0]+i[0]/l,h=o[1]+i[1]/l;var g=(l-1)/a;this.MomentumX=s/a,this.MomentumY=n/a,this.MomentumRoll=0,this.MomentumScale=.5*(this.MomentumScale+g),c.SetWorldFocalPoint([r,h]),c.SetHeight(c.GetHeight()/l),c.ComputeMatrix(),this.EventuallyRender(!0)}}}},t.prototype.HandleTouchEnd=function(t){if(!this.InteractionEnabled)return!0;if((new Date).getTime()-this.StartTouchTime<200)return this.InteractionState=i,this.HandleMouseClick(t);for(var e=0;e<this.Layers.length;++e){var o=this.Layers[e];if(o.HandleTouchEnd&&!o.HandleTouchEnd(t))return!1}var s=(new Date).getTime();this.LastTime=this.Time,this.Time=s;var n=Math.min(this.Time-this.LastTime,250)/250;if(this.MomentumX=this.MomentumX*(1-n),this.MomentumY=this.MomentumY*(1-n),this.MomentumRoll=this.MomentumRoll*(1-n),this.MomentumScale=this.MomentumScale*(1-n),s-=this.StartTouchTime,0===t.targetTouches.length&&SAM.MOBILE_DEVICE){if(this.StartTouchTime=0,s<90)return SA.display&&SA.display.NavigationWidget&&SA.display.NavigationWidget.ToggleVisibility(),void(void 0!==SA.MOBILE_ANNOTATION_WIDGET&&SA.MOBILE_ANNOTATION_WIDGET.ToggleVisibility());if(void 0!==this.ActiveWidget)return void this.ActiveWidget.HandleTouchEnd(t);this.HandleMomentum()}this.HandleMomentum(t),this.StartTouchTime=0},t.prototype.HandleMomentum=function(){var t=this;this.MomentumTimerId&&(window.cancelAnimationFrame(this.MomentumTimerId),this.MomentumTimerId=0);var e=(new Date).getTime();if(e-this.LastTime<50)this.MomentumTimerId=window.requestAnimationFrame(function(){t.HandleMomentum()});else{this.LastTime=this.Time,this.Time=e;var o=this.Time-this.LastTime,s=Math.exp(-o/200),n=-200*s+200,a=this.MainView.Camera;if(a.Translate(-this.MomentumX*n,-this.MomentumY*n,0),a.SetHeight(a.Height/(this.MomentumScale*n+1)),a.SetWorldRoll(a.GetWorldRoll()-this.MomentumRoll*n),a.ComputeMatrix(),this.OverView){var r=this.OverView.Camera;r.SetWorldRoll(a.GetWorldRoll()),r.ComputeMatrix()}this.Draw(),this.MomentumX*=s,this.MomentumY*=s,this.MomentumScale*=s,this.MomentumRoll*=s,Math.abs(this.MomentumX)<.01&&Math.abs(this.MomentumY)<.01&&Math.abs(this.MomentumRoll)<2e-4&&Math.abs(this.MomentumScale)<5e-5?(this.MomentumTimerId=0,this.InteractionState!==i&&(this.InteractionState=i,this.TriggerEndInteraction())):this.MomentumTimerId=window.requestAnimationFrame(function(){t.HandleMomentum()})}},t.prototype.ConstrainCamera=function(){var t=this.GetOverViewBounds();if(t){var e=this.MainView.GetLeafSpacing(),i=this.MainView.GetViewport(),o=this.MainView.Camera,s=!1,n=o.GetWorldFocalPoint();n[0]<t[0]&&(o.SetWorldFocalPoint([t[0],n[1]]),s=!0),n[0]>t[1]&&(o.SetWorldFocalPoint([t[1],n[1]]),s=!0),n[1]<t[2]&&(o.SetWorldFocalPoint([n[0],t[2]]),s=!0),n[1]>t[3]&&(o.SetWorldFocalPoint([n[0],t[3]]),s=!0);var a=2*(t[3]-t[2]);o.GetHeight()>a&&(o.SetHeight(a),s=!0);var r=i[3]*e*this.MinPixelSize;o.GetHeight()<r&&(o.SetHeight(r),s=!0),s&&o.ComputeMatrix()}},t.prototype.HandleMouseClick=function(t){if(!this.InteractionEnabled)return!0;for(var e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleMouseClick&&!i.HandleMouseClick(t))return!1}return!0},t.prototype.HandleMouseDown=function(t){if(this.Shift=t.shiftKey,this.MouseDownFlag=!0,!this.InteractionEnabled)return!0;if(this.FirefoxWhich=t.which,t.preventDefault(),this.RecordMouseDown(t),this.RotateIconDrag&&(this.RotateIconDrag=!1),this.DoubleClick)return t.preventDefault(),this.HandleDoubleClick(t);for(var e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleMouseDown&&!i.HandleMouseDown(t))return!1}return 1===t.which?(t.ctrlKey?this.Rotatable&&(this.InteractionState=2):t.altKey?this.InteractionState=3:this.InteractionState=1,!1):2!==t.which||!this.Rotatble||(this.InteractionState=2,!1)},t.prototype.HandleDoubleClick=function(t){if(!this.InteractionEnabled)return!0;for(var e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleDoubleClick&&!i.HandleDoubleClick(t))return!1}var o=this.ConvertPointViewerToWorld(t.offsetX,t.offsetY);return 1===t.which?this.AnimateZoomTo(.5,o):3===t.which&&this.AnimateZoomTo(2,o),!0},t.prototype.HandleMouseUp=function(t){if(this.MouseDownFlag){if(this.MouseDownFlag=!1,!this.InteractionEnabled)return!0;var e=new Date;if(this.MouseUpTime=e.getTime(),e.getTime()-this.MouseDownTime<200)return this.InteractionState=i,this.HandleMouseClick(t);if(this.FirefoxWhich=0,this.RecordMouseUp(t),this.RotateIconDrag)return this.RollUp(t),!1;for(var o=0;o<this.Layers.length;++o){var s=this.Layers[o];if(s.HandleMouseUp&&!s.HandleMouseUp(t))return this.InteractionState=i,!1}return 4===this.InteractionState||5===this.InteractionState?this.HandleOverViewMouseUp(t):(this.InteractionState!==i&&(this.InteractionState=i,this.TriggerEndInteraction()),!1)}},t.prototype.GetEventOffset=function(t){return t.offsetX&&t.offsetY?[t.offsetX,t.offsetY]:t.layerX&&t.layerY?[t.layerX,t.layerY]:void 0},t.prototype.GetMousePosition=function(t){var e=this.GetEventOffset(t);if(void 0!==e){var i=t.target;return i===this.Div[0]?e:(e[0]+=i.offsetLeft,e[1]+=i.offsetTop,(i=i.parentElement)===this.Div[0]?e:(e[0]+=i.offsetLeft,e[1]+=i.offsetTop,(i=i.parentElement)===this.Div[0]?e:void 0))}},t.prototype.HandleMouseMove=function(t){if(!this.InteractionEnabled)return!0;var e=this.GetMousePosition(t);if(void 0===e)return!0;if(!this.RecordMouseMove(t))return!0;if(1===t.which&&this.Rotatable&&this.RotateIconDrag)return this.RollMove(t),!1;for(var o=0;o<this.Layers.length;++o){var s=this.Layers[o];if(s.HandleMouseMove&&!s.HandleMouseMove(t))return!1}if(0===t.which)return this.InteractionState=i,!0;if(4===this.InteractionState||5===this.InteractionState)return this.HandleOverViewMouseMove(t);if(this.InteractionState===i)return!0;var n,a,r=e[0],h=e[1];if(2===this.InteractionState){var l=r-.5*this.MainView.Viewport[2],d=h-.5*this.MainView.Viewport[3];this.MainView.Camera.HandleRoll(l,d,this.MouseDeltaX,this.MouseDeltaY),this.RollTarget=this.MainView.Camera.GetWorldRoll(),this.UpdateCamera()}else if(3===this.InteractionState)a=this.MouseDeltaY/this.MainView.Viewport[2],this.MainView.Camera.SetHeight(this.MainView.Camera.GetHeight()/(1+5*a)),this.ZoomTarget=this.MainView.Camera.GetHeight(),this.UpdateCamera();else if(1===this.InteractionState){n=-this.MouseDeltaX/this.MainView.Viewport[2],a=-this.MouseDeltaY/this.MainView.Viewport[2];var u=Math.sqrt(n*n+a*a)/this.MouseDeltaTime;(u=1+1e3*u)>3&&(u=3),n*=u,a*=u,this.MainView.Camera.HandleTranslate(n,a,0),this.ConstrainCamera()}return this.TriggerInteraction(),this.EventuallyRender(!0),r=t.offsetX,h=t.offsetY,!1},t.prototype.HandleMouseWheel=function(t){if(!this.InteractionEnabled)return!0;if(this.MouseTime=(new Date).getTime(),this.LastMouseTime){var e=this.MouseTime-this.LastMouseTime;this.WheelSensitivity*=Math.exp(-e/this.WheelTimeConstant)}this.LastMouseTime=this.MouseTime,this.WheelSensitivity+=this.WheelAcceleration,this.WheelSensitivity>.2&&(this.WheelSensitivity=.2),t.offsetX||(t.offsetX=t.layerX,t.offsetY=t.layerY);for(var i=0;i<this.Layers.length;++i){var o=this.Layers[i];if(o.HandleMouseWheel&&!o.HandleMouseWheel(t))return!1}var s=0;t.deltaY?s=t.deltaY:t.wheelDelta&&(s=t.wheelDelta),s>0?this.ZoomTarget*=1+this.WheelSensitivity:s<0&&(this.ZoomTarget/=1+this.WheelSensitivity);var n=this.ConvertPointViewerToWorld(t.offsetX,t.offsetY),a=this.ZoomTarget/this.MainView.Camera.GetHeight(),r=this.MainView.Camera.GetWorldFocalPoint();return this.TranslateTarget[0]=n[0]-a*(n[0]-r[0]),this.TranslateTarget[1]=n[1]-a*(n[1]-r[1]),this.RollTarget=this.MainView.Camera.GetWorldRoll(),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1},t.prototype.HandleKeyDown=function(t){if(SAM.ShiftKey=t.shiftKey,SAM.ControlKey=t.ctrlKey,!this.InteractionEnabled)return!0;for(var i=0;i<this.Layers.length;++i)if(this.Layers[i].HandleKeyDown&&!this.Layers[i].HandleKeyDown(t))return!1;if(83===t.keyCode&&t.ctrlKey)return e||((e=new SAM.Dialog).Title.text("Saving"),e.Body.css({margin:"1em 2em"}),e.WaitingImage=$("<img>").appendTo(e.Body).attr("src",SA.ImagePathUrl+"circular.gif").attr("alt","waiting...").addClass("sa-view-save"),e.ApplyButton.hide(),e.SavingFlag=!1,e.Count=0),e.SavingFlag||(e.SavingFlag=!0,e.Show(1),this.EventuallySaveImage("slideAtlas"+SA.ZERO_PAD(e.Count,3),function(){e.SavingFlag=!1,e.Count+=1,e.Hide()})),!1;if(t.keyCode,"R"===String.fromCharCode(t.keyCode))return this.MainView.Camera.ComputeMatrix(),this.ZoomTarget=this.MainView.Camera.GetHeight(),this.EventuallyRender(!0),!1;var o,s,n,a,r,h,l=(o=this.GetCamera()).GetWorldRoll(),d=o.GetWorldFocalPoint(),u=Math.cos(l),p=-Math.sin(l);return 38===t.keyCode?(t.ctrlKey?(s=this.MainView.Camera.GetWorldRoll()/(.5*Math.PI)-.01,s=Math.floor(s),this.RollTarget=s*Math.PI*.5):(r=(n=0)*u-(a=-.5*o.GetHeight())*p,h=n*p+a*u,this.TranslateTarget[0]=d[0]+r,this.TranslateTarget[1]=d[1]+h),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1):40===t.keyCode?(t.ctrlKey?(s=this.MainView.Camera.GetWorldRoll()/(.5*Math.PI)+.01,s=Math.ceil(s),this.RollTarget=s*Math.PI*.5):(r=(n=0)*u-(a=.5*o.GetHeight())*p,h=n*p+a*u),this.TranslateTarget[0]=d[0]+r,this.TranslateTarget[1]=d[1]+h,this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1):37===t.keyCode?(t.ctrlKey?this.RollTarget=this.MainView.Camera.GetWorldRoll()-Math.PI/2:(r=(n=-.5*o.GetWidth())*u-(a=0)*p,h=n*p+a*u,this.TranslateTarget[0]=d[0]+r,this.TranslateTarget[1]=d[1]+h),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1):39===t.keyCode?(t.ctrlKey?this.RollTarget=this.MainView.Camera.GetWorldRoll()+Math.PI/2:(r=(n=.5*o.GetWidth())*u-(a=0)*p,h=n*p+a*u,this.TranslateTarget[0]=d[0]+r,this.TranslateTarget[1]=d[1]+h),this.AnimateLast=(new Date).getTime(),this.AnimateDuration=200,this.EventuallyRender(!0),!1):(27===t.keyCode&&this.EscapeCallback&&this.EscapeCallback(),!0)},t.prototype.HandleKeyUp=function(t){if(SAM.ShiftKey=t.shiftKey,SAM.ControlKey=t.ctrlKey,!this.InteractionEnabled)return!0;var e;for(e=0;e<this.Layers.length;++e){var i=this.Layers[e];if(i.HandleKeyUp&&!i.HandleKeyUp(t))return!1}return!0},t.prototype.GetPixelsPerUnit=function(){return this.MainView.GetPixelsPerUnit()},t.prototype.GetMetersPerUnit=function(){return this.MainView.GetMetersPerUnit()},t.prototype.ConvertPointWorldToViewer=function(t,e){return this.MainView.Camera.ConvertPointWorldToViewer(t,e)},t.prototype.ConvertPointViewerToWorld=function(t,e){return this.MainView.Camera.ConvertPointViewerToWorld(t,e)},t.prototype.OverViewCheckActive=function(t){if(!this.OverView)return!1;var e=t.offsetX,i=t.offsetY,o=this.OverViewport[2]/2,s=this.OverViewport[3]/2;e-=this.OverViewport[0]+o,i-=this.OverViewport[1]+s;var n=this.MainView.Camera.GetWorldRoll(),a=Math.cos(n),r=Math.sin(n),h=Math.abs(a*e+r*i),l=Math.abs(a*i-r*e);Math.abs(o-h)<5&&l<s||Math.abs(s-l)<5&&h<o?(this.OverViewActive=!0,this.OverView.Parent.addClass("sa-view-overview-canvas sa-active")):(this.OverViewActive=!1,this.OverView.Parent.removeClass("sa-view-overview-canvas sa-active"))},t.prototype.HandleOverViewMouseDown=function(t){if(!this.InteractionEnabled)return!0;if(!this.RotateIconDrag)return this.InteractionState=4,this.OverViewEventX=t.pageX,this.OverViewEventY=t.pageY,this.OverViewPlaceCamera(t),!1},t.prototype.HandleOverViewMouseUp=function(t){if(!this.InteractionEnabled)return!0;if(!this.RotateIconDrag)return this.RollTarget=this.MainView.Camera.GetWorldRoll(),this.OverViewPlaceCamera(t),this.InteractionState=i,!1},t.prototype.OverViewPlaceCamera=function(t){if(1===t.which){var e=t.offsetX,i=t.offsetY;void 0===e&&(e=t.layerX),void 0===i&&(i=t.layerY),this.OverViewPlaceCameraPt(e,i)}},t.prototype.HandleOverViewMouseWheel=function(t){this.InteractionState=6;var e=0;t.deltaY?e=t.deltaY:t.wheelDelta&&(e=t.wheelDelta),e>0?this.OverViewScale*=1.2:e<0&&(this.OverViewScale/=1.2);var i=this.MainView.GetWidth()*this.MainView.GetHeight(),o=this.GetOverViewBounds(),s=(o[1]-o[0])/(o[3]-o[2]);return Math.sqrt(i*this.OverViewScale/s)*s<60?this.RotateIcon.hide():this.Rotatable&&this.RotateIcon.show(),this.UpdateSize(),!1},t.prototype.HandleOverViewMouseMove=function(t){return!this.InteractionEnabled||(1===t.which&&this.RotateIconDrag?(this.RollMove(t),!1):(this.OverViewPlaceCamera(t),!1))},t.prototype.SetZoomWidgetVisibility=function(t){t?(this.ZoomTab||this.InitializeZoomGui(),this.ZoomTab.show()):this.ZoomTab&&this.ZoomTab.hide()},t.prototype.SetCopyrightVisibility=function(t){t?this.CopyrightWrapper.show():this.CopyrightWrapper.hide()},t.prototype.GetNumberOfLayers=function(){return this.Layers.length},t.prototype.GetLayer=function(t){return t>=0&&t<this.Layers.length?this.Layers[t]:null},t.prototype.RemoveLayer=function(t){var e=this.Layers.indexOf(t);e<0||this.Layers.splice(e,1)},t.prototype.NewAnnotationLayer=function(){var t=new SAM.AnnotationLayer(this.Div);return t.SetViewer(this),t.SetCamera(this.GetCamera()),this.AddLayer(t),t.ScaleWidget.View=this.MainView,t.Viewer=this,t.UpdateSize(),t},t.prototype.NewViewLayer=function(){var t=new SA.TileView(this.Div,!1);return this.AddLayer(t),t.UpdateSize(),t},t.prototype.TriggerEndInteraction=function(){this.UpdateZoomGui(),SA.RECORDER_WIDGET&&SA.RECORDER_WIDGET.RecordState();var t=this.GetCamera(),e=t.GetWorldFocalPoint(),i=Math.round(t.GetWidth()),o=Math.round(t.GetHeight()),s=Math.round(e[0]-i/2),n=Math.round(e[1]-o/2),a=Math.round(t.GetWorldRotation()),r=this.GetCache().TileSource.getTileUrl(0,0,0,0),h=r.split("/")[3],l=(r=window.location.href).indexOf("item/");r=(r=r.substr(0,l+4))+"/"+h+"?bounds="+s+","+n+","+(s+i)+","+(n+o),0!==a&&(r+="&rotate="+a),this.ShareDisplay.text(r)},SA.Viewer=t}(),function(){"use strict";function t(){this.point0=[0,0],this.point1=[0,0],this.Roll=0,this.Height=0}function e(){this.Correlations=[]}t.prototype.Serialize=function(){return{point0:[this.point0[0],this.point0[1]],point1:[this.point1[0],this.point1[1]],roll:this.Roll,height:this.Height}},t.prototype.Load=function(t){this.point0[0]=t.point0[0],this.point0[1]=t.point0[1],this.point1[0]=t.point1[0],this.point1[1]=t.point1[1],t.roll&&(this.Roll=t.roll),t.height&&(this.Height=t.height)},t.prototype.GetRoll=function(t){return void 0!==t&&0===t?-this.Roll:this.Roll},t.prototype.GetPoint=function(t){return 0===t?this.GetPoint0():1===t?this.GetPoint1():(alert("Bad correlation point index: "+t),[0,0])},t.prototype.GetPoint0=function(){return[this.point0[0],this.point0[1]]},t.prototype.SetPoint0=function(t){this.point0[0]=t[0],this.point0[1]=t[1]},t.prototype.GetPoint1=function(){return[this.point1[0],this.point1[1]]},t.prototype.SetPoint1=function(t){this.point1[0]=t[0],this.point1[1]=t[1]},t.prototype.SetRoll=function(t){this.Roll=t},t.prototype.SetHeight=function(t){this.Height=t},e.prototype.Serialize=function(){return JSON.parse(JSON.stringify(this))},e.prototype.Load=function(t){for(var e in t)this[e]=t[e]},e.prototype.AddCorrelation=function(t,e){var i=this.Correlations.length,o=new SA.PairCorrelation;return o.SetPoint0(t),o.SetPoint1(e),this.Correlations.push(o),i},e.prototype.Load=function(t){t.View0&&(this.View0=t.View0),t.View1&&(this.View1=t.View1);for(var e=0;e<t.Correlations.length;++e){var i=new SA.PairCorrelation;i.Load(t.Correlations[e]),this.Correlations.push(i)}},e.prototype.WeightedTransform=function(t,e,i,o){var s=[i[0],i[1]];if(0===this.Correlations.length)return s;if(void 0===o&&(o=2e4),0===this.Correlations.length)return s[0]=i[0],s[1]=i[1],this.DeltaRoll=0,s;var n,a,r,h,l;if(this.Correlations.length<=1){n=this.Correlations[0],this.DeltaRoll=n.GetRoll(e),h=n.GetPoint(t);var d=i[0]-h[0],u=i[1]-h[1];return a=Math.cos(this.DeltaRoll),r=Math.sin(this.DeltaRoll),l=n.GetPoint(e),s[0]=a*d+r*u+l[0],s[1]=a*u-r*d+l[1],s}for(var p,c,f,g=o*o,v=0,S=[0,0],y=[0,0],m=0;m<this.Correlations.length;++m){h=(n=this.Correlations[m]).GetPoint(t),l=n.GetPoint(e);var w=(p=h[0]-i[0])*p+(c=h[1]-i[1])*c;v+=f=Math.max(Math.exp(-w/g),1e-7),S[0]+=f*h[0],S[1]+=f*h[1],y[0]+=f*l[0],y[1]+=f*l[1]}S[0]=S[0]/v,S[1]=S[1]/v,y[0]=y[0]/v,y[1]=y[1]/v,this.DeltaRoll=0;var C=0;v=0;var A=0;for(m=0;m<this.Correlations.length;++m){h=(n=this.Correlations[m]).GetPoint(t),l=n.GetPoint(e);var T=(p=h[0]-i[0])*p+(c=h[1]-i[1])*c;f=Math.max(Math.exp(-T/g),1e-7),p=h[0]-S[0],c=h[1]-S[1];var b=Math.atan2(p,c),D=p*p+c*c;p=l[0]-y[0],c=l[1]-y[1];var x=Math.atan2(p,c),P=p*p+c*c;f*=Math.sqrt(Math.min(D,P));for(var M=x-b,I=2*Math.PI;M>Math.PI;)M-=I;for(;M<-Math.PI;)M+=I;A+=M*f,v+=f}return v>0&&(C=A/v),this.DeltaRoll=A/v,s[0]-=S[0],s[1]-=S[1],a=Math.cos(C),r=Math.sin(C),p=a*s[0]+r*s[1],c=a*s[1]-r*s[0],s[0]=p+y[0],s[1]=c+y[1],s},e.prototype.ForwardTransform=function(t,e){return this.DeltaRoll=0,0===this.Correlations.length?t:this.WeightedTransform(0,1,t,e)},e.prototype.ReverseTransform=function(t,e){return this.DeltaRoll=0,0===this.Correlations.length?t:this.WeightedTransform(1,0,t,e)},e.prototype.ForwardTransformCamera=function(t,e){e.SetWorldFocalPoint(this.ForwardTransform(t.GetWorldFocalPoint(),t.Height/2)),e.SetWorldRoll(t.GetWorldRoll()+this.DeltaRoll),e.SetHeight(t.GetHeight()),e.SetWidth(e.GetHeight()*e.GetViewportWidth()/e.GetViewportHeight())},e.prototype.ReverseTransformCamera=function(t,e){e.FocalPoint=this.ReverseTransform(t.FocalPoint,t.Height/2),e.Roll=t.Roll+this.DeltaRoll,e.Height=t.Height,e.SetWidth(e.GetHeight()*e.GetViewportWidth()/e.GetViewportHeight())},SA.PairCorrelation=t,SA.PairTransformation=e}(),function(){"use strict";function t(t){this.Thumb=null,this.Active=!1,this.Color=[0,1,0],this.Shapes=[],this.Bounds=null,t&&(this.Viewer=t,this.Viewer.AddWidget(this))}t.prototype.IsEmpty=function(){return 0===this.Shapes.length},t.prototype.Union=function(t){for(var e=0;e<t.Shapes.length;++e)this.Shapes.push(t.Shapes[e]);this.Bounds=null},t.prototype.ContainedInBounds=function(t){var e=this.GetBounds();if(e[0]>t[0]&&e[1]<t[1]&&e[2]>t[2]&&e[3]<t[3])return 2;if(e[1]<t[0]||e[0]>t[1]||e[3]<t[2]||e[2]>t[3])return 0;for(var i=!1,o=!1,s=0;s<this.Shapes.length;++s){var n=this.Shapes[s].ContainedInBounds(t);if(1===n)return 1;if(0===n&&(o=!0),2===n&&(i=!0),i&&o)return 1}return i?2:0},t.prototype.GetViewCenter=function(t){var e=this.GetBounds();return t.Camera.ConvertPointWorldToViewer(.5*(e[0]+e[1]),.5*(e[2]+e[3]))},t.prototype.GetViewBounds=function(t){if(0===this.Shapes.length)return[0,0,0,0];for(var e=this.GetViewCenter(t),i=[e[0],e[0],e[1],e[1]],o=0;o<this.Shapes.length;++o)for(var s=this.Shapes[o],n=0;n<s.Points.length;++n){var a=s.Points[n];(a=t.Camera.ConvertPointWorldToViewer(a[0],a[1]))[0]<i[0]&&(i[0]=a[0]),a[0]>i[1]&&(i[1]=a[0]),a[1]<i[2]&&(i[2]=a[1]),a[1]>i[3]&&(i[3]=a[1])}return i},t.prototype.ComputeViewUpperRight=function(t){var e=this.GetBounds(),i=t.Camera.ConvertPointWorldToViewer(e[0],e[2]),o=t.Camera.ConvertPointWorldToViewer(e[0],e[3]),s=t.Camera.ConvertPointWorldToViewer(e[1],e[3]),n=t.Camera.ConvertPointWorldToViewer(e[1],e[2]);this.ViewUpperRight=i;var a=i[0]-i[1],r=o[0]-o[1];r>a&&(a=r,this.ViewUpperRight=o),(r=s[0]-s[1])>a&&(a=r,this.ViewUpperRight=s),(r=n[0]-n[1])>a&&(a=r,this.ViewUpperRight=n)},t.prototype.Draw=function(t){this.ComputeViewUpperRight(t);for(var e=0;e<this.Shapes.length;++e)this.Active?this.Shapes[e].OutlineColor=[1,1,0]:this.Shapes[e].OutlineColor=this.Color,this.Shapes[e].Draw(t)},t.prototype.Serialize=function(){if(this.Thumb)return null;var t={};t.type="stack_section",t.color=this.Color,t.shapes=[];for(var e=0;e<this.Shapes.length;++e){for(var i=this.Shapes[e],o={closedloop:i.Closed,points:[]},s=0;s<i.Points.length;++s)o.points.push([i.Points[s][0],i.Points[s][1]]);t.shapes.push(o)}return t},t.prototype.Load=function(t){if(t.color&&(this.Color[0]=parseFloat(t.color[0]),this.Color[1]=parseFloat(t.color[1]),this.Color[2]=parseFloat(t.color[2])),t.shapes)for(var e=0;e<t.shapes.length;e++){var i=t.shapes[e];if(i.points){var o=i.points,s=new SAM.Polyline;s.OutlineColor=this.Color,s.FixedSize=!1,s.LineWidth=0,i.closedloop&&(s.Closed=i.closedloop),this.Shapes.push(s);for(var n=0;n<o.length;++n)s.Points[n]=[o[n][0],o[n][1]];s.UpdateBuffers()}}},t.prototype.GetCenter=function(){var t=this.GetBounds();return[.5*(t[0]+t[1]),.5*(t[2]+t[3])]},t.prototype.GetBounds=function(){if(this.Thumb){var t=this.Thumb.Height*this.Thumb.ScreenPixelSpacing/4,e=this.ThumbX,i=this.ThumbY;return[e-t,e+t,i-t,i+t]}if(0===this.Shapes.length)return this.Bounds;if(!this.Bounds){this.Bounds=this.Shapes[0].GetBounds();for(var o=1;o<this.Shapes.length;++o){var s=this.Shapes[o].GetBounds();s[0]<this.Bounds[0]&&(this.Bounds[0]=s[0]),s[1]>this.Bounds[1]&&(this.Bounds[1]=s[1]),s[2]<this.Bounds[2]&&(this.Bounds[2]=s[2]),s[3]>this.Bounds[3]&&(this.Bounds[3]=s[3])}}return this.Bounds.slice(0)},t.prototype.Deactivate=function(){this.Viewer.DeactivateWidget(this);for(var t=0;t<this.Shapes.length;++t)this.Shapes[t].Active=!1;this.Viewer.EventuallyRender()},t.prototype.HandleKeyPress=function(t,e){return!0},t.prototype.HandleMouseDown=function(t){return!0},t.prototype.HandleMouseUp=function(t){return!0},t.prototype.HandleDoubleClick=function(t){return!0},t.prototype.HandleMouseMove=function(t){return!0},t.prototype.CheckActive=function(t){return!1},t.prototype.GetActive=function(){return!1},t.prototype.SetActive=function(t){if(t){this.Viewer.ActivateWidget(this);for(var e=0;e<this.Shapes.length;++e)this.Shapes[e].Active=!0;this.Viewer.EventuallyRender()}else this.Deactivate(),this.Viewer.DeactivateWidget(this)},t.prototype.RemoveFromViewer=function(){this.Viewer&&this.Viewer.RemoveWidget(this)},t.prototype.RigidAlign=function(t,e){var i=this.GetCenter(),o=t.GetCenter();if(e[0]=o[0]-i[0],e[1]=o[1]-i[1],this.Thumb||t.Thumb)e[2]=0;else{var s=this.GetBounds();s[0]+=e[0],s[1]+=e[0],s[2]+=e[1],s[3]+=e[1];var n=t.GetBounds();n[0]=Math.min(s[0],n[0]),n[1]=Math.max(s[1],n[1]),n[2]=Math.min(s[2],n[2]),n[3]=Math.max(s[3],n[3]);var a=.5*(n[0]+n[1]),r=.5*(n[2]+n[3]);n[0]=a+1.1*(s[0]-a),n[1]=a+1.1*(s[1]-a),n[2]=r+1.1*(s[2]-r),n[3]=r+1.1*(s[3]-r);for(var h=Math.sqrt((n[1]-n[0])*(n[3]-n[2])/16e4),l=new SA.DistanceMap(n,h),d=0;d<t.Shapes.length;++d)l.AddPolyline(t.Shapes[d]);l.Update(),this.ViewerEventuallyRender(),this.RigidAlignWithMap(l,e)}},t.prototype.RigidAlignWithMap=function(t,e){for(var i,o=this.GetCenter(),s=[0,0,0],n=null,a=-1,r=-180;r<180;r+=30){s=[e[0],e[1],Math.PI*r/180];var h;for(i=0;i<5;++i)h=this.RigidDecentStep(s,o,t,2e5);h*=1+Math.abs(r/180),(a<0||h<a)&&(a=h,n=s.slice(0))}s=n;var l=2e5;for(i=0;i<100;++i)l=this.RigidDecentStep(s,o,t,l);e[0]=s[0],e[1]=s[1],e[2]=s[2]},t.prototype.RigidDecentStep=function(t,e,i,o){for(var s,n,a,r,h=Math.sin(t[2]),l=Math.cos(t[2]),d=0,u=0,p=0,c=0,f=0,g=0;g<this.Shapes.length;++g)for(var v=this.Shapes[g],S=0;S<v.Points.length;++S){var y=v.Points[S],m=y[0],w=y[1];r=-h*(s=m-e[0])+l*(n=w-e[1]),m=m+((a=l*s+h*n)-s)+t[0],w=w+(r-n)+t[1];var C=i.GetDistance(m,w)*i.Spacing;p+=C;var A=1;o>0&&(A=Math.exp(C*C*-.69/(o*o))),C*=A;var T=i.GetGradient(m,w),b=Math.sqrt(T[0]*T[0]+T[1]*T[1]);b>0&&(++f,T[0]=-T[0]*C/b,T[1]=-T[1]*C/b,d+=T[0],u+=T[1],c+=(r*T[0]-a*T[1])/(a*a+r*r))}var D=p/f;return t[0]+=d/f,t[1]+=u/f,t[2]+=c/f,D},t.prototype.Transform=function(t,e,i){this.Bounds=null;for(var o=0;o<this.Shapes.length;++o){var s=this.Shapes[o];s.Trans=null;for(var n=0;n<s.Points.length;++n){var a=s.Points[n],r=a[0],h=a[1],l=r-e[0],d=h-e[1],u=Math.sin(i),p=Math.cos(i),c=p*l+u*d,f=-u*l+p*d;a[0]=r+(c-l)+t[0],a[1]=h+(f-d)+t[1]}s.UpdateBuffers(this.Layer.AnnotationView)}},t.prototype.Translate=function(t){this.Bounds=null;for(var e=0;e<this.Shapes.length;++e){for(var i=this.Shapes[e],o=0;o<i.Points.length;++o){var s=i.Points[o];s[0]+=t[0],s[1]+=t[1]}i.UpdateBuffers(this.Layer.AnnotationView)}},t.prototype.RemoveDuplicatePoints=function(t){void 0===t&&(t=0);for(var e=0;e<this.Shapes.length;++e){for(var i=this.Shapes[e],o=i.Points[i.Points.length-1],s=0;s<i.Points.length;){var n=i.Points[s],a=n[0]-o[0],r=n[1]-o[1];Math.sqrt(a*a+r*r)<=t?i.Points.splice(s,1):(++s,o=n)}i.UpdateBuffers(this.Layer.AnnotationView)}},t.prototype.Decimate=function(){for(var t=this.GetBounds(),e=(t[1]-t[0]+t[3]-t[2])/400,i=0;i<this.Shapes.length;++i)this.Shapes[i].Decimate(e)},SA.StackSectionWidget=t}(),function(){"use strict";function t(t,e){this.Layers=[],this.Label=e,this.Color=[Math.random(),Math.random(),Math.random()],this.Initialize(t,e),this.SetSizeScale(1),this.Changeflag=!1}t.prototype.AddLayer=function(t){var e=this;t.LoadCallbacks.push(function(){e.UpdateLayer(t)}),this.Layers.push(t),this.VisibilityCheckBox&&this.Slider&&this.UpdateLayer(t)},t.prototype.Initialize=function(t,e){var i=this,o=$("<div>").appendTo(t).css({border:"1px solid #CCC",width:"100%"}),s=$("<div>").appendTo(o).css({width:"80%","border-right":"1px solid #CCC",height:"100%",display:"inline-block"}),n=$("<div>").appendTo(s).css({"border-bottom":"1px solid #CCC",width:"100%",float:"top"});this.VisibilityCheckBox=$('<input type="checkbox">').appendTo(n).css({display:"inline-block"}).on("change",function(){i.VisibilityCheckCallback()}).prop("checked",!0),$("<div>").appendTo(n).css({display:"inline-block","margin-left":"1em"}).html(e),this.ChangeCheckBox=$('<input type="checkbox">').appendTo(n).css({display:"inline-block",float:"right"}).on("change",function(){i.ChangeCheckCallback()}).prop("checked",!1);var a=$("<div>").appendTo(s).css({width:"100%"});this.Slider=$('<input type="range" min="0" max="100">').appendTo(a).on("input",function(){i.SliderCallback()}),$("<div>").appendTo(a).html("0%").css({float:"left"}),$("<div>").appendTo(a).html("100%").css({float:"right"});var r=$("<div>").appendTo(o).css({padding:"5px",height:"100%",width:"20%",display:"inline-block"});this.ColorInput=$('<input type="color">').appendTo(r).css({width:"100%"}).val(SAM.ConvertColorToHex(this.Color)).change(function(){i.ColorCallback()}),this.SizeScaleInput=$('<input type="number">').appendTo(r).css({width:"100%"}).prop("title","Change the size of the detections").on("change",function(){i.SizeScaleCallback()})},t.prototype.SetSizeScale=function(t){this.SizeScaleInput.val(Math.round(100*t).toString()),this.SizeScaleCallback()},t.prototype.SizeScaleCallback=function(){this.Color=SAM.ConvertColor(this.ColorInput.val()),this.UpdateLayers()},t.prototype.ColorCallback=function(){this.Color=SAM.ConvertColor(this.ColorInput.val()),this.UpdateLayers()},t.prototype.VisibilityCheckCallback=function(){this.UpdateLayers()},t.prototype.ChangeCheckCallback=function(){if(this.ChangeFlag=this.ChangeCheckBox.prop("checked"),this.UpdateLayers(),this.ChangeFlag){var t=this.Layers[0].WidgetList[0].Shape,e=this.Layers[1].WidgetList[0].Shape;t.ChangeDetectionVisibilities(t,e),t.SetOutlineColor("#FF0000"),e.SetOutlineColor("#0000FF")}},t.prototype.SliderCallback=function(){this.UpdateLayers()},t.prototype.UpdateLayer=function(t){for(var e=this.VisibilityCheckBox.prop("checked"),i=parseInt(this.SizeScaleInput.val()/100),o=parseInt(this.Slider.val())/100,s=0;s<t.WidgetList.length;s++){var n=t.WidgetList[s];void 0!==n.Label&&n.Label!==this.Label||(n.Visibility=e,n.SetThreshold(o),n.Shape.SetOutlineColor(this.Color),n.Shape.SetScale(i),n.ComputeVisibilities())}t.EventuallyDraw()},t.prototype.UpdateLayers=function(){for(var t=0;t<this.Layers.length;++t){var e=this.Layers[t];this.UpdateLayer(e)}},SA.LayerView=t}(),function(){"use strict";function t(t){this.HeatMapDiv=$("<div>").appendTo(t).css({position:"absolute",left:"0px",top:"0px","border-width":"0px",width:"100%",height:"100%","box-sizing":"border-box","z-index":"150"}).addClass("sa-resize"),this.View=new SA.TileView(this.HeatMapDiv,!0);var e=this.View.gl;this.Color=[0,.4,0],this.Window=1,this.Level=.5,this.Gamma=1;var i=this;this.HeatMapDiv.saOnResize(function(){i.View.UpdateCanvasSize()});var o=SA.createWebGlProgram("precision highp float;varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 uColor;uniform vec2 uWindowLevel;uniform float uGamma;void main(void) {  vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgba;  float alpha = textureColor[0];  if (uWindowLevel[0] !== 1.0 || uWindowLevel[1] !== 0.5) {    alpha = ((alpha-0.5)/uWindowLevel[0]) + uWindowLevel[1];  }  if (uGamma !== 1.0) {    if (uGamma < 0.0) {      alpha = pow((1.0-alpha), -uGamma);    } else {      alpha = pow(alpha, uGamma);    }  }  textureColor = vec4(uColor, alpha);  gl_FragColor = textureColor;}","attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;uniform mat3 uNMatrix;varying vec2 vTextureCoord;void main(void) {  gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);  vTextureCoord = aTextureCoord;}",e);o.textureCoordAttribute=e.getAttribLocation(o,"aTextureCoord"),e.enableVertexAttribArray(o.textureCoordAttribute),o.samplerUniform=e.getUniformLocation(o,"uSampler"),o.colorUniform=e.getUniformLocation(o,"uColor"),o.gamaUniform=e.getUniformLocation(o,"uGamma"),o.windowLevelUniform=e.getUniformLocation(o,"uWindowLevel"),this.View.ShaderProgram=o}t.prototype.SetCache=function(t){this.View.SetCache(t);var e=t.GetImageData();e.spacing||(e.spacing=[1,1,1]),e.origin||(e.origin=[0,0,0]);var i=e.dimensions[0]*e.spacing[0],o=e.dimensions[1]*e.spacing[1];this.View.Camera.Load({FocalPoint:[i/2,o/2],Roll:0,Height:o}),this.View.Camera.ComputeMatrix(),this.View.UpdateCanvasSize()},t.prototype.SetImageData=function(t){t.spacing=t.spacing||[1,1,1],t.origin=t.origin||[0,0,0];var e=new SA.SlideAtlasSource;e.Prefix=t.prefix;var i=new SA.Cache;i.TileSource=e,i.SetImageData(t),this.View.SetCache(i)},t.prototype.Draw=function(t,e){if(e=e||t.Camera)if(this.Transform)this.Transform.ForwardTransformCamera(e,this.View.GetCamera());else{var i=this.View.Camera,o=this.View.GetCache().Image;i.DeepCopy(e);var s=i.GetWorldFocalPoint();i.SetWorldFocalPoint([(s[0]-o.origin[0])/o.spacing[0],(s[1]-o.origin[1])/o.spacing[1]]),i.SetWidth(i.GetWidth()/o.spacing[0]),i.SetHeight(i.GetHeight()/o.spacing[0]),i.ComputeMatrix(),this.Camera.DeepCopy(i)}if(this.View.gl){var n=this.View.gl,a=this.View.ShaderProgram;n.useProgram(a),n.clearColor(1,1,1,1),n.disable(n.DEPTH_TEST),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ZERO),n.uniform3f(a.colorUniform,this.Color[0],this.Color[1],this.Color[2]),n.uniform1f(a.gamaUniform,this.Gamma),n.uniform2f(a.windowLevelUniform,this.Window,this.Level)}this.View.DrawTiles()},t.prototype.Reset=function(){},SA.HeatMap=t}(),function(){"use strict";function t(t){this.OverlayViewDiv=$("<div>").appendTo(t).css({position:"absolute",left:"0px",top:"0px","border-width":"0px",width:"100%",height:"100%","box-sizing":"border-box","z-index":"150"}).addClass("sa-resize"),this.View=new SA.TileView(this.OverlayViewDiv,!0);var e=this.View.gl;this.Color=[1,0,1],this.Center=[500,500],this.Radius=0,this.Opacity=1;var i=this;this.OverlayViewDiv.saOnResize(function(){i.View.UpdateCanvasSize()});var o=SA.createWebGlProgram("precision highp float;varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 uColor;uniform vec2 uCenter;uniform float uOpacity;void main(void) {  float alpha = uOpacity;  float dx = gl_FragCoord.x - uCenter.x;  float dy = gl_FragCoord.y - uCenter.y;  if ((dx * dx) + (dy * dy) < 40000.0) { alpha = 0.0;}  vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgba;  float intensity = textureColor[0];  textureColor[0] = intensity * uColor[0];  textureColor[1] = intensity * uColor[1];  textureColor[2] = intensity * uColor[2];  textureColor[3] = alpha;  gl_FragColor = textureColor;}","attribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;uniform mat3 uNMatrix;varying vec2 vTextureCoord;varying vec4 vPos;void main(void) {  gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);  vTextureCoord = aTextureCoord;}",e);o.textureCoordAttribute=e.getAttribLocation(o,"aTextureCoord"),e.enableVertexAttribArray(o.textureCoordAttribute),o.samplerUniform=e.getUniformLocation(o,"uSampler"),o.colorUniform=e.getUniformLocation(o,"uColor"),o.opacityUniform=e.getUniformLocation(o,"uOpacity"),o.centerUniform=e.getUniformLocation(o,"uCenter"),this.View.ShaderProgram=o,this.OverlayViewDiv.on("mousemove.overlay",function(t){return i.Center[0]=t.offsetX,i.Center[1]=i.OverlayViewDiv.height()-t.offsetY,i.EventuallyDraw(),!0})}t.prototype.EventuallyDraw=function(){if(!this.RenderPending){this.RenderPending=!0;var t=this;window.requestAnimationFrame(function(){t.RenderPending=!1,t.Draw()})}},t.prototype.SetCache=function(t){this.View.SetCache(t);var e=t.GetImageData();e.spacing||(e.spacing=[1,1,1]),e.origin||(e.origin=[0,0,0]);var i=e.dimensions[0]*e.spacing[0],o=e.dimensions[1]*e.spacing[1];this.View.Camera.Load({FocalPoint:[i/2,o/2],Roll:0,Height:o}),this.View.Camera.ComputeMatrix(),this.View.UpdateCanvasSize()},t.prototype.SetImageData=function(t){t.spacing=t.spacing||[1,1,1],t.origin=t.origin||[0,0,0];var e=new SA.SlideAtlasSource;e.Prefix=t.prefix;var i=new SA.Cache;i.TileSource=e,i.SetImageData(t),this.View.SetCache(i)},t.prototype.Draw=function(t,e){if(t&&(e=e||t.Camera),e)if(this.Transform)this.Transform.ForwardTransformCamera(e,this.View.GetCamera());else{var i=this.View.Camera,o=this.View.GetCache().Image;i.DeepCopy(e);var s=i.GetWorldFocalPoint();i.SetWorldFocalPoint([(s[0]-o.origin[0])/o.spacing[0],(s[1]-o.origin[1])/o.spacing[1]]),i.SetWidth(i.GetWidth()/o.spacing[0]),i.SetHeight(i.GetHeight()/o.spacing[0]),i.ComputeMatrix(),this.Camera.DeepCopy(i)}if(this.View.gl){var n=this.View.gl,a=this.View.ShaderProgram;n.useProgram(a),n.clearColor(1,1,1,1),n.disable(n.DEPTH_TEST),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ZERO),n.uniform3f(a.colorUniform,this.Color[0],this.Color[1],this.Color[2]),n.uniform1f(a.opacityUniform,this.Opacity),n.uniform2f(a.centerUniform,this.Center[0],this.Center[1])}this.View.DrawTiles()},t.prototype.Reset=function(){},SA.OverlayView=t}();