<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
    <bean class="com.epam.pipeline.dao.tool.ToolVulnerabilityDao" id="toolVulnerabilityDao" autowire="byName">
        <property name="insertVulnerabilitiesQuery">
            <value>
                <![CDATA[
                    INSERT INTO pipeline.tool_vulnerability (
                        tool_id,
                        version,
                        vulnerability_name,
                        feature,
                        feature_version,
                        description,
                        link,
                        severity,
                        fixed_by,
                        created_date
                    ) VALUES (
                        :TOOL_ID,
                        :VERSION,
                        :VULNERABILITY_NAME,
                        :FEATURE,
                        :FEATURE_VERSION,
                        :DESCRIPTION,
                        :LINK,
                        :SEVERITY,
                        :FIXED_BY,
                        :CREATED_DATE
                    )
                ]]>
            </value>
        </property>
        <property name="loadVulnerabilitiesByToolAndVersionQuery">
            <value>
                <![CDATA[
                    SELECT
                        tv.vulnerability_name,
                        tv.feature,
                        tv.feature_version,
                        tv.description,
                        tv.link,
                        tv.severity,
                        tv.fixed_by,
                        tv.created_date
                    FROM
                        pipeline.tool_vulnerability tv
                    WHERE
                        tv.tool_id = :TOOL_ID
                        AND tv.version = :VERSION
                ]]>
            </value>
        </property>
        <property name="loadVulnerabilitiesByToolQuery">
            <value>
                <![CDATA[
                    SELECT
                        tv.version,
                        tv.vulnerability_name,
                        tv.feature,
                        tv.feature_version,
                        tv.description,
                        tv.link,
                        tv.severity,
                        tv.fixed_by,
                        tv.created_date
                    FROM
                        pipeline.tool_vulnerability tv
                    WHERE
                        tv.tool_id = ?
                ]]>
            </value>
        </property>
        <property name="loadVulnerabilityCountQuery">
            <value>
                <![CDATA[
                    SELECT
                        tv.version,
                        tv.severity,
                        count(*)
                    FROM
                        pipeline.tool_vulnerability tv
                    WHERE
                        tv.tool_id = :TOOL_ID AND tv.version IN (:VERSIONS)
                    GROUP BY tv.version, tv.severity
                ]]>
            </value>
        </property>
        <property name="deleteVulnerabilitiesQuery">
            <value>
                <![CDATA[
                    DELETE FROM pipeline.tool_vulnerability
                    WHERE
                        tool_id = :TOOL_ID
                        AND version = :VERSION
                ]]>
            </value>
        </property>
        <property name="insertToolDependencyQuery">
            <value>
                <![CDATA[
                    INSERT INTO pipeline.tool_dependency (
                        tool_id,
                        tool_version,
                        dependency_name,
                        dependency_version,
                        dependency_ecosystem,
                        dependency_description
                    ) VALUES (
                        :TOOL_ID,
                        :TOOL_VERSION,
                        :DEPENDENCY_NAME,
                        :DEPENDENCY_VERSION,
                        :DEPENDENCY_ECOSYSTEM,
                        :DEPENDENCY_DESCRIPTION
                    )
                ]]>
            </value>
        </property>
        <property name="loadDependencyByToolAndVersionQuery">
            <value>
                <![CDATA[
                    SELECT
                        d.tool_id,
                        d.tool_version,
                        d.dependency_name,
                        d.dependency_version,
                        d.dependency_ecosystem,
                        d.dependency_description
                    FROM
                        pipeline.tool_dependency d
                    WHERE
                        d.tool_id = :TOOL_ID
                        AND d.tool_version = :TOOL_VERSION
                ]]>
            </value>
        </property>
        <property name="loadDependencyByToolQuery">
            <value>
                <![CDATA[
                    SELECT
                        d.tool_id,
                        d.tool_version,
                        d.dependency_name,
                        d.dependency_version,
                        d.dependency_ecosystem,
                        d.dependency_description
                    FROM
                        pipeline.tool_dependency d
                    WHERE
                        d.tool_id = ?
                ]]>
            </value>
        </property>
        <property name="deleteDependencyQuery">
            <value>
                <![CDATA[
                    DELETE FROM pipeline.tool_dependency
                    WHERE
                        tool_id = :TOOL_ID
                        AND tool_version = :TOOL_VERSION
                ]]>
            </value>
        </property>
        <property name="insertToolVersionScanQuery">
            <value>
                <![CDATA[
                    INSERT INTO pipeline.tool_version_scan (
                        tool_id,
                        version,
                        layer_reference,
                        digest,
                        scan_status,
                        scan_date,
                        success_scan_date,
                        os_name,
                        os_version,
                        vulnerabilities_count,
                        default_cmd,
                        layers_count
                    ) VALUES (
                        :TOOL_ID,
                        :VERSION,
                        :LAYER_REFERENCE,
                        :DIGEST,
                        :SCAN_STATUS,
                        :SCAN_DATE,
                        :SUCCESS_SCAN_DATE,
                        :OS_NAME,
                        :OS_VERSION,
                        :VULNERABILITIES_COUNT,
                        :DEFAULT_CMD,
                        :LAYERS_COUNT
                    )
                ]]>
            </value>
        </property>
        <property name="updateToolVersionScanQuery">
            <value>
                <![CDATA[
                    UPDATE pipeline.tool_version_scan
                    SET
                        layer_reference=:LAYER_REFERENCE,
                        digest=:DIGEST,
                        scan_status=:SCAN_STATUS,
                        scan_date=:SCAN_DATE,
                        white_list=:WHITE_LIST,
                        os_name=:OS_NAME,
                        os_version=:OS_VERSION,
                        vulnerabilities_count=:VULNERABILITIES_COUNT,
                        default_cmd=:DEFAULT_CMD,
                        layers_count=:LAYERS_COUNT
                    WHERE
                        tool_id=:TOOL_ID
                        AND version=:VERSION
                ]]>
            </value>
        </property>
        <property name="updateWhiteListWithToolVersionQuery">
            <value>
                <![CDATA[
                    UPDATE pipeline.tool_version_scan
                    SET
                        white_list=:WHITE_LIST
                    WHERE
                        tool_id=:TOOL_ID
                        AND version=:VERSION
                ]]>
            </value>
        </property>
        <property name="updateToolVersionScanWithSuccessQuery">
            <value>
                <![CDATA[
                    UPDATE pipeline.tool_version_scan
                    SET
                        layer_reference=:LAYER_REFERENCE,
                        digest=:DIGEST,
                        scan_status=:SCAN_STATUS,
                        scan_date=:SCAN_DATE,
                        success_scan_date=:SUCCESS_SCAN_DATE,
                        white_list=:WHITE_LIST,
                        os_name=:OS_NAME,
                        os_version=:OS_VERSION,
                        vulnerabilities_count=:VULNERABILITIES_COUNT,
                        default_cmd=:DEFAULT_CMD,
                        layers_count=:LAYERS_COUNT
                    WHERE
                        tool_id=:TOOL_ID
                        AND version=:VERSION
                ]]>
            </value>
        </property>
        <property name="loadToolVersionScanQuery">
            <value>
                <![CDATA[
                    SELECT
                        tool_id,
                        version,
                        layer_reference,
                        digest,
                        scan_date,
                        success_scan_date,
                        scan_status,
                        white_list,
                        os_name,
                        os_version,
                        vulnerabilities_count,
                        default_cmd,
                        layers_count
                    FROM
                        pipeline.tool_version_scan
                    WHERE
                        tool_id = :TOOL_ID
                        AND version = :VERSION
                ]]>
            </value>
        </property>
        <property name="loadToolAllVersionScansQuery">
            <value>
                <![CDATA[
                    SELECT
                        tool_id,
                        version,
                        layer_reference,
                        digest,
                        scan_date,
                        success_scan_date,
                        scan_status,
                        white_list,
                        os_name,
                        os_version,
                        vulnerabilities_count,
                        default_cmd,
                        layers_count
                    FROM
                        pipeline.tool_version_scan
                    WHERE
                        tool_id = :TOOL_ID
                ]]>
            </value>
        </property>
        <property name="loadToolListVersionsScanQuery">
            <value>
                <![CDATA[
                    SELECT
                        tool_id,
                        version,
                        layer_reference,
                        digest,
                        scan_date,
                        success_scan_date,
                        scan_status,
                        white_list,
                        os_name,
                        os_version,
                        vulnerabilities_count,
                        default_cmd,
                        layers_count
                    FROM
                        pipeline.tool_version_scan
                    WHERE
                        tool_id = :TOOL_ID AND version in (:VERSIONS)
                ]]>
            </value>
        </property>
        <property name="deleteToolVersionScansQuery">
            <value>
                <![CDATA[
                    DELETE FROM pipeline.tool_version_scan
                    WHERE
                        tool_id = :TOOL_ID
                        AND version = :VERSION
                ]]>
            </value>
        </property>
    </bean>
</beans>